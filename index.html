<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; connect-src 'self' blob: http://localhost:3000 https://api.openai.com;">
    <title>AIå¥³å‹èŠå¤©æ¸¸æˆ ğŸŒ¸</title>
    <link rel="stylesheet" href="chat-ui.css">
    <link rel="stylesheet" href="wallet-ui.css">
    
    <!-- é…ç½®æ–‡ä»¶ -->
    <script src="config.js"></script>
    <!-- è®°å¿†ç®¡ç†ç³»ç»Ÿ -->
    <script src="memory-system.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: transparent;
            height: 100vh;
            overflow: hidden;
        }

        .game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        /* VRMå±•ç¤ºåŒº - å…¨å± */
        .vrm-container {
            width: 100%;
            height: 100%;
            position: relative;
            /* ç§»é™¤CSSèƒŒæ™¯ï¼Œè®©Three.jsåœºæ™¯èƒŒæ™¯æ˜¾ç¤º */
            background: transparent;
        }

        /* AIå¯¹è¯æ°”æ³¡ */
        .ai-speech-bubble {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(220, 220, 220, 0.95);
            color: #333;
            padding: 18px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 500;
            max-width: 450px;
            min-width: 250px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
            opacity: 0;
            animation: bubbleFadeIn 0.5s forwards;
            z-index: 100;
            line-height: 1.5;
            letter-spacing: 0.5px;
        }

        .ai-speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 18px solid transparent;
            border-right: 18px solid transparent;
            border-top: 18px solid rgba(220, 220, 220, 0.95);
        }

        @keyframes bubbleFadeIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        @keyframes bubbleFadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        .vrm-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }



        /* å¤å¤éŸ³ä¹æ’­æ”¾å™¨ */
        .music-controls {
            position: absolute;
            top: 25px;
            left: 25px;
            width: 280px;
            height: 120px;
            background: linear-gradient(135deg, #e8b4ff 0%, #d19cff 50%, #b96fff 100%);
            border-radius: 15px;
            border: 6px solid #4a2c5a;
            color: #2d1b3d;
            z-index: 1001;
            padding: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3), inset 0 2px 0 rgba(255, 255, 255, 0.4);
            font-family: 'Arial', sans-serif;
        }

        .music-window-title {
            background: linear-gradient(90deg, #ffb366 0%, #ffa64d 100%);
            margin: -15px -15px 10px -15px;
            padding: 8px 15px;
            border-radius: 9px 9px 0 0;
            font-size: 12px;
            font-weight: bold;
            color: #2d1b3d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .window-controls {
            display: flex;
            gap: 5px;
        }

        .window-btn {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
        }

        .minimize-btn { background: #ffd23f; }
        .maximize-btn { background: #28ca42; }
        .close-btn { background: #ff5f57; }

        .music-player-content {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .music-controls-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .music-control-btn {
            width: 35px;
            height: 25px;
            background: #6c4a7a;
            border: 2px solid #2d1b3d;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .music-control-btn:hover {
            background: #8b5fa3;
            transform: translateY(-1px);
        }

        .play-btn {
            width: 45px !important;
            background: #4a7c59 !important;
        }

        .play-btn:hover {
            background: #5d9973 !important;
        }

        .volume-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .volume-slider {
            width: 120px;
            height: 4px;
            border-radius: 2px;
            background: #4a2c5a;
            outline: none;
            cursor: pointer;
            -webkit-appearance: none;
        }

        .volume-slider::-webkit-slider-thumb {
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 2px;
            background: #ffb366;
            cursor: pointer;
            border: 1px solid #2d1b3d;
        }

        .volume-slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 2px;
            background: #ffb366;
            cursor: pointer;
            border: 1px solid #2d1b3d;
        }

        .volume-label {
            font-size: 10px;
            min-width: 25px;
            font-weight: bold;
            text-align: right;
        }


        .emotion-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }

        .emotion-btn {
            padding: 8px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .emotion-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .emotion-btn.active {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            color: #2d3436;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .vrm-container {
                width: 100%;
                height: 100vh;
            }
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* è¿”å›æŒ‰é’® */
        .back-button {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
            z-index: 1000;
        }

        .back-button:hover {
            background: rgba(255, 107, 157, 0.8);
            transform: translateY(-2px);
        }

        /* é’±åŒ…çŠ¶æ€æ˜¾ç¤º */
        .wallet-status-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 8px 12px;
            border-radius: 20px;
            color: white;
            font-size: 12px;
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .wallet-avatar svg {
            color: #8b5cf6;
        }

        .wallet-address {
            font-family: 'Courier New', monospace;
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 8px;
            border-radius: 5px;
        }

        .wallet-disconnect {
            background: rgba(255, 69, 58, 0.8);
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .wallet-disconnect:hover {
            background: rgba(255, 69, 58, 1);
        }

        /* è¿æ¥é’±åŒ…æŒ‰é’® */
        .connect-wallet-btn {
            background: linear-gradient(135deg, #9945ff, #14f195);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .connect-wallet-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(153, 69, 255, 0.4);
        }

        /* æœªæˆæƒç•Œé¢ */
        .unauthorized-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(10px);
        }

        .unauthorized-content {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            color: #333;
        }

        .unauthorized-content h2 {
            margin-bottom: 20px;
            color: #ff6b9d;
        }

        .unauthorized-content p {
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .connect-wallet-btn {
            background: linear-gradient(135deg, #9945ff, #14f195);
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .connect-wallet-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(153, 69, 255, 0.4);
        }

        /* æ‚¬æµ®èŠå¤©æ¡† */
        .floating-chat {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            width: 416px;
            height: 754px;
            background: #F5F3F0;
            border-radius: 33px;
            border: 10px solid #2C1810;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4), 
                        0 0 30px rgba(44, 24, 16, 0.2),
                        inset 0 2px 0 rgba(255, 255, 255, 0.3);
            z-index: 1000;
            cursor: move;
            user-select: none;
            overflow: hidden;
        }


        .floating-chat.dragging {
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5), 
                        0 0 40px rgba(255, 182, 193, 0.8),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3);
            cursor: grabbing;
        }

        /* æ‰‹æœºTop Baré£æ ¼èŠå¤©æ¡†å¤´éƒ¨ */
        .chat-window-header {
            border-radius: 23px 23px 0 0;
            padding: 0;
            border-bottom: none;
            display: flex;
            flex-direction: column;
            cursor: grab;
            user-select: none;
            position: relative;
            overflow: hidden;
            width: 100%;
        }

        .chat-window-header:active {
            cursor: grabbing;
        }

        /* çœŸå®æ‰‹æœºçŠ¶æ€æ  */
        .phone-status-bar {
            background: #000000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 16px;
            font-size: 14px;
            color: white;
            font-weight: 600;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            height: 24px;
            border-radius: 23px 23px 0 0;
            width: 100%;
            box-sizing: border-box;
        }

        .status-left {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
        }

        .carrier-info {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
            font-weight: 600;
        }

        .network-type {
            font-size: 14px;
            font-weight: 600;
        }

        .status-center {
            flex: 1;
            display: flex;
            justify-content: center;
        }

        .time-display {
            font-weight: 700;
            font-size: 14px;
            letter-spacing: -0.2px;
        }

        .status-right {
            display: flex;
            align-items: center;
            gap: 4px;
            flex: 1;
            justify-content: flex-end;
        }

        .status-icon {
            display: flex;
            align-items: center;
        }

        .battery-percentage {
            font-size: 14px;
            font-weight: 600;
            margin-right: 2px;
        }

        /* åŠ¨æ¼«é£æ ¼èŠå¤©æ ‡é¢˜åŒºåŸŸ */
        .chat-title-area {
            position: relative;
            padding: 16px 20px;
            background: linear-gradient(135deg, 
                #FF6B9D 0%, 
                #C44569 25%, 
                #7B68EE 50%, 
                #9B59B6 75%, 
                #E056FD 100%);
            border-bottom: none;
            overflow: hidden;
            width: 100%;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* åŠ¨æ¼«é£æ ¼èƒŒæ™¯è£…é¥° */
        .chat-title-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(255, 182, 193, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        /* åŠ¨æ¼«é£æ ¼æ˜Ÿæ˜Ÿè£…é¥° */
        .chat-title-area::after {
            content: 'âœ¨ğŸŒ¸âœ¨';
            position: absolute;
            top: 8px;
            right: 20px;
            font-size: 12px;
            opacity: 0.7;
            animation: sparkle 3s ease-in-out infinite;
        }

        @keyframes sparkle {
            0%, 100% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
        }

        .chat-user-info {
            display: flex;
            align-items: center;
            gap: 14px;
            position: relative;
            z-index: 2;
        }

        /* å¯çˆ±çš„å¤´åƒè®¾è®¡ - ä½¿ç”¨èŠå¤©æ°”æ³¡ç›¸åŒå¤´åƒ */
        .chat-user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: url('profile-pic/alice-pf.png') center/cover;
            border: 3px solid rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            position: relative;
            box-shadow: 
                0 4px 15px rgba(255, 182, 193, 0.4),
                0 2px 8px rgba(0, 0, 0, 0.1),
                inset 0 2px 0 rgba(255, 255, 255, 0.6);
            animation: avatarFloat 4s ease-in-out infinite;
        }

        /* ä¸ºä¸åŒè§’è‰²è®¾ç½®æ ‡é¢˜æ å¤´åƒ */
        .character-fliza .chat-user-avatar {
            background-image: url('profile-pic/fliza-pf.png');
        }

        .character-alice .chat-user-avatar {
            background-image: url('profile-pic/alice-pf.png');
        }

        .character-ash .chat-user-avatar {
            background-image: url('profile-pic/ash-pf.png');
        }

        .character-bobo .chat-user-avatar {
            background-image: url('profile-pic/bobo-pf.png');
        }

        .character-elinyaa .chat-user-avatar {
            background-image: url('profile-pic/elinyaa-pf.png');
        }

        .character-imeris .chat-user-avatar {
            background-image: url('profile-pic/imeris-pf.png');
        }

        .character-kyoko .chat-user-avatar {
            background-image: url('profile-pic/kyoko-pf.png');
        }

        .character-lena .chat-user-avatar {
            background-image: url('profile-pic/lena-pf.png');
        }

        .character-lilium .chat-user-avatar {
            background-image: url('profile-pic/lilium.png');
        }

        .character-maple .chat-user-avatar {
            background-image: url('profile-pic/maple-pf.png');
        }

        .character-miru .chat-user-avatar {
            background-image: url('profile-pic/Miru-pf.png');
        }

        .character-miumiu .chat-user-avatar {
            background-image: url('profile-pic/miumiu-pf.png');
        }

        .character-neco .chat-user-avatar {
            background-image: url('profile-pic/neco-pf.png');
        }

        .character-nekona .chat-user-avatar {
            background-image: url('profile-pic/nekona.png');
        }

        .character-notia .chat-user-avatar {
            background-image: url('profile-pic/notia-pf.png');
        }

        .character-ququ .chat-user-avatar {
            background-image: url('profile-pic/ququ-pf.png');
        }

        .character-rainy .chat-user-avatar {
            background-image: url('profile-pic/rainy-pf.png');
        }

        .character-rindo .chat-user-avatar {
            background-image: url('profile-pic/rindo-pf.png');
        }

        .character-sikirei .chat-user-avatar {
            background-image: url('profile-pic/sikirei-pf.png');
        }

        .character-vivi .chat-user-avatar {
            background-image: url('profile-pic/vivi-pf.png');
        }

        .character-wolf .chat-user-avatar {
            background-image: url('profile-pic/wolf.png');
        }

        .character-wolferia .chat-user-avatar {
            background-image: url('profile-pic/wolferia-pf.png');
        }

        .character-yawl .chat-user-avatar {
            background-image: url('profile-pic/yawl-pf.png');
        }

        .character-yuu .chat-user-avatar {
            background-image: url('profile-pic/yuu yii-pf.png');
        }

        .character-zwei .chat-user-avatar {
            background-image: url('profile-pic/zwei-pf.png');
        }

        @keyframes avatarFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-2px); }
        }

        /* å¤´åƒå‘¨å›´çš„å…‰æ™• */
        .chat-user-avatar::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            border-radius: 50%;
            background: linear-gradient(45deg, 
                transparent, 
                rgba(255, 255, 255, 0.3), 
                transparent);
            animation: haloRotate 6s linear infinite;
        }

        @keyframes haloRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .chat-user-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .chat-user-name {
            color: white;
            font-size: 18px;
            font-weight: 700;
            margin: 0;
            text-shadow: 
                0 2px 4px rgba(0, 0, 0, 0.3),
                0 1px 0 rgba(255, 255, 255, 0.2);
            position: relative;
        }

        /* åå­—å‰çš„å°è£…é¥° */
        .chat-user-name::before {
            content: 'ğŸ’•';
            margin-right: 6px;
            font-size: 14px;
            animation: heartBeat 2s ease-in-out infinite;
        }

        @keyframes heartBeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .chat-user-status {
            color: rgba(255, 255, 255, 0.9);
            font-size: 13px;
            margin: 0;
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            position: relative;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .chat-user-status::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4AE54A;
            box-shadow: 
                0 0 0 2px rgba(74, 229, 74, 0.3),
                0 0 8px rgba(74, 229, 74, 0.6);
            animation: onlinePulse 2s ease-in-out infinite;
        }

        @keyframes onlinePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* å¯çˆ±çš„åŠ¨ä½œæŒ‰é’® */
        .chat-actions {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 2;
        }

        .chat-action-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.25) 0%, 
                rgba(255, 255, 255, 0.1) 100%);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        /* æŒ‰é’®çš„å…‰æ•ˆ */
        .chat-action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.4), 
                transparent);
            transition: left 0.6s;
        }

        .chat-action-btn:hover {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.35) 0%, 
                rgba(255, 255, 255, 0.2) 100%);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 
                0 8px 25px rgba(255, 182, 193, 0.4),
                0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .chat-action-btn:hover::before {
            left: 100%;
        }

        .chat-action-btn:active {
            transform: translateY(0) scale(0.98);
        }

        /* ç‰¹æ®Šæ•ˆæœï¼šæŒ‰é’®çš„å°è£…é¥° */
        .chat-action-btn:nth-child(1) {
            animation-delay: 0.1s;
        }
        .chat-action-btn:nth-child(2) {
            animation-delay: 0.2s;
        }
        .chat-action-btn:nth-child(3) {
            animation-delay: 0.3s;
        }

        /* èŠå¤©æ¶ˆæ¯åŒºåŸŸ */
        .chat-window-messages {
            height: 585px;
            padding: 26px 20px;
            overflow-y: auto;
            background: #F5F3F0;
        }

        .chat-window-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-window-messages::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .chat-window-messages::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        /* æ¶ˆæ¯æ°”æ³¡æ ·å¼ */
        .message-bubble {
            margin-bottom: 18px;
            animation: messageSlideIn 0.4s ease-out;
        }

        .message-bubble.user {
            display: flex;
            justify-content: flex-end;
        }

        .message-bubble.ai {
            display: flex;
            justify-content: flex-start;
            align-items: flex-start;
            margin-bottom: 18px;
            position: relative;
            padding-left: 54px;
        }
        
        .message-bubble.ai::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 44px;
            height: 44px;
            background: url('profile-pic/alice-pf.png') center/cover;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 4px 12px rgba(255, 176, 132, 0.4),
                        0 2px 6px rgba(0, 0, 0, 0.15),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3);
            z-index: 1;
        }

        /* ä¸ºä¸åŒè§’è‰²è®¾ç½®å¤´åƒ */
        .character-fliza .message-bubble.ai::before {
            background-image: url('profile-pic/fliza-pf.png');
        }

        .character-alice .message-bubble.ai::before {
            background-image: url('profile-pic/alice-pf.png');
        }

        .character-ash .message-bubble.ai::before {
            background-image: url('profile-pic/ash-pf.png');
        }

        .character-bobo .message-bubble.ai::before {
            background-image: url('profile-pic/bobo-pf.png');
        }

        .character-elinyaa .message-bubble.ai::before {
            background-image: url('profile-pic/elinyaa-pf.png');
        }

        .character-imeris .message-bubble.ai::before {
            background-image: url('profile-pic/imeris-pf.png');
        }

        .character-kyoko .message-bubble.ai::before {
            background-image: url('profile-pic/kyoko-pf.png');
        }

        .character-lena .message-bubble.ai::before {
            background-image: url('profile-pic/lena-pf.png');
        }

        .character-lilium .message-bubble.ai::before {
            background-image: url('profile-pic/lilium.png');
        }

        .character-maple .message-bubble.ai::before {
            background-image: url('profile-pic/maple-pf.png');
        }

        .character-miru .message-bubble.ai::before {
            background-image: url('profile-pic/Miru-pf.png');
        }

        .character-miumiu .message-bubble.ai::before {
            background-image: url('profile-pic/miumiu-pf.png');
        }

        .character-neco .message-bubble.ai::before {
            background-image: url('profile-pic/neco-pf.png');
        }

        .character-nekona .message-bubble.ai::before {
            background-image: url('profile-pic/nekona.png');
        }

        .character-notia .message-bubble.ai::before {
            background-image: url('profile-pic/notia-pf.png');
        }

        .character-ququ .message-bubble.ai::before {
            background-image: url('profile-pic/ququ-pf.png');
        }

        .character-rainy .message-bubble.ai::before {
            background-image: url('profile-pic/rainy-pf.png');
        }

        .character-rindo .message-bubble.ai::before {
            background-image: url('profile-pic/rindo-pf.png');
        }

        .character-sikirei .message-bubble.ai::before {
            background-image: url('profile-pic/sikirei-pf.png');
        }

        .character-vivi .message-bubble.ai::before {
            background-image: url('profile-pic/vivi-pf.png');
        }

        .character-wolf .message-bubble.ai::before {
            background-image: url('profile-pic/wolf.png');
        }

        .character-wolferia .message-bubble.ai::before {
            background-image: url('profile-pic/wolferia-pf.png');
        }

        .character-yawl .message-bubble.ai::before {
            background-image: url('profile-pic/yawl-pf.png');
        }

        .character-yuu .message-bubble.ai::before {
            background-image: url('profile-pic/yuu yii-pf.png');
        }

        .character-zwei .message-bubble.ai::before {
            background-image: url('profile-pic/zwei-pf.png');
        }

        .bubble-container {
            max-width: 80%;
            position: relative;
        }

        .bubble-header {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.9), rgba(255, 182, 193, 0.9));
            border-radius: 15px 15px 0 0;
            padding: 6px 12px;
            font-size: 12px;
            color: rgba(0, 0, 0, 0.7);
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .bubble-content {
            background: linear-gradient(135deg, #FFB084 0%, #FF9D6B 50%, #FF8A50 100%);
            border-radius: 20px 20px 20px 5px;
            padding: 16px 20px;
            color: white;
            font-size: 18px;
            line-height: 1.5;
            position: relative;
            max-width: 300px;
            word-wrap: break-word;
            margin: 8px 0;
            box-shadow: 0 4px 12px rgba(255, 157, 107, 0.3),
                        0 2px 6px rgba(139, 69, 19, 0.2);
            border: none;
            text-shadow: 0 1px 2px rgba(139, 69, 19, 0.3);
        }
        
        .message-bubble.ai .bubble-content::after {
            content: '';
            position: absolute;
            bottom: 0px;
            left: -8px;
            width: 0;
            height: 0;
            border-right: 12px solid #FF9D6B;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            filter: drop-shadow(-2px 2px 4px rgba(139, 69, 19, 0.15));
        }

        .message-bubble.user .bubble-header {
            background: #E0E0E0;
            color: #333;
        }

        .message-bubble.user .bubble-content {
            background: linear-gradient(135deg, #F0F0F0 0%, #E0E0E0 50%, #D0D0D0 100%);
            color: #333;
            border-radius: 20px 20px 5px 20px;
            box-shadow: 0 4px 12px rgba(224, 224, 224, 0.4),
                        0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        .message-bubble.user .bubble-content::after {
            content: '';
            position: absolute;
            bottom: 0px;
            right: -8px;
            width: 0;
            height: 0;
            border-left: 12px solid #E0E0E0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.1));
        }


        .bubble-controls {
            display: flex;
            gap: 4px;
        }

        .bubble-control {
            width: 10px;
            height: 10px;
            border-radius: 2px;
            background: rgba(0, 0, 0, 0.3);
        }

        /* èŠå¤©è¾“å…¥åŒºåŸŸ - ç®€çº¦ç²¾è‡´é£æ ¼ */
        .chat-window-input {
            padding: 12px 16px 16px;
            background: linear-gradient(180deg, #FAFAFA 0%, #F5F5F5 100%);
            border-radius: 0 0 23px 23px;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            cursor: auto;
        }

        .chat-window-messages {
            cursor: auto;
        }

        .input-container {
            display: flex;
            background: white;
            border-radius: 24px;
            border: 1px solid rgba(0, 0, 0, 0.08);
            overflow: hidden;
            align-items: center;
            padding: 4px 4px 4px 16px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .input-container:focus-within {
            border-color: rgba(255, 182, 193, 0.5);
            box-shadow: 0 0 0 3px rgba(255, 182, 193, 0.1),
                        0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .chat-input-field {
            flex: 1;
            padding: 10px 0;
            border: none;
            background: transparent;
            font-size: 16px;
            outline: none;
            color: #333;
            line-height: 1.5;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
        }

        .chat-input-field::placeholder {
            color: rgba(0, 0, 0, 0.35);
            font-size: 15px;
        }
        
        .chat-input-field:focus {
            background: transparent;
        }

        /* å‘é€æŒ‰é’® - æç®€çº¸é£æœºé£æ ¼ */
        .send-btn {
            background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%);
            border: none;
            padding: 0;
            color: white;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 20px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .send-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.3s ease;
        }

        .send-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .send-btn:hover::before {
            transform: translate(-50%, -50%) scale(1.2);
        }
        
        .send-btn:active {
            transform: translateY(0) scale(0.96);
        }

        /* å‘é€åŠ¨ç”»æ•ˆæœ */
        .send-btn.sending {
            animation: paperPlane 0.6s ease-out;
        }

        @keyframes paperPlane {
            0% {
                transform: translateY(-1px) scale(1);
            }
            50% {
                transform: translateY(-3px) scale(1.1) rotate(10deg);
            }
            100% {
                transform: translateY(-1px) scale(1) rotate(0deg);
            }
        }

        .send-btn.sending svg {
            animation: planeFly 0.6s ease-out;
        }

        @keyframes planeFly {
            0% {
                transform: translateX(0) rotate(0deg);
            }
            50% {
                transform: translateX(2px) rotate(15deg);
            }
            100% {
                transform: translateX(0) rotate(0deg);
            }
        }

        /* æ·»åŠ é¢å¤–çš„åŠŸèƒ½æŒ‰é’®åŒºåŸŸï¼ˆå¯é€‰ï¼‰ */
        .input-extras {
            display: flex;
            gap: 8px;
            margin-right: 8px;
            align-items: center;
        }

        .input-extra-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: transparent;
            border: none;
            color: rgba(0, 0, 0, 0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 16px;
        }

        .input-extra-btn:hover {
            background: rgba(0, 0, 0, 0.05);
            color: rgba(0, 0, 0, 0.7);
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 1200px) {
            .floating-chat {
                width: 525px;
                height: 675px;
                right: 15px;
            }
            
            .chat-window-messages {
                height: 495px;
            }
        }

        @media (max-width: 768px) {
            .floating-chat {
                width: 450px;
                height: 600px;
                right: 10px;
            }
            
            .chat-window-messages {
                height: 420px;
            }
        }

        /* VRMçŠ¶æ€ä¿¡æ¯ */
        .vrm-status {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            color: white;
            backdrop-filter: blur(10px);
            font-size: 14px;
            z-index: 10;
        }

        /* å·¦ä¾§æ§åˆ¶é¢æ¿ */
        .left-panel {
            position: fixed;
            left: 20px;
            bottom: 20px;
            width: 250px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 100;
        }

        .panel-section {
            margin-bottom: 20px;
        }

        .panel-section h4 {
            color: #ffeaa7;
            margin-bottom: 10px;
            font-size: 14px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 5px;
        }

        .emotion-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 5px;
        }

        .emotion-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .emotion-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .emotion-btn.active {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            color: #2d3436;
        }

        #character-selector, #animation-selector {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 12px;
        }

        .play-animation-btn {
            width: 100%;
            margin-top: 10px;
            padding: 8px;
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .play-animation-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(116, 185, 255, 0.4);
        }

    </style>
</head>

<body>
    <!-- å¼•å…¥é’±åŒ…å’ŒèŠå¤©ç³»ç»Ÿ -->
    <script src="ai-chat-integration.js"></script>
    <script src="chat-system-v2.js"></script>
    <div class="game-container">
        <!-- å·¦ä¾§VRMå±•ç¤ºåŒº -->
        <div class="vrm-container">
            <canvas id="vrm-canvas" class="vrm-canvas"></canvas>
            
            <!-- AIå¯¹è¯æ°”æ³¡ -->
            <div class="ai-speech-bubble" id="ai-speech-bubble" style="display: none;"></div>

            <!-- VRMçŠ¶æ€ä¿¡æ¯ -->
            <div class="vrm-status" id="vrm-status" style="display: none;">
                <div>ğŸ­ VRMçŠ¶æ€: <span id="vrm-loaded">åŠ è½½ä¸­...</span></div>
                <div>ğŸ¬ å½“å‰åŠ¨ç”»: <span id="current-animation">æ— </span></div>
                <div>ğŸ˜Š è¡¨æƒ…çŠ¶æ€: <span id="current-expression">ä¸­æ€§</span></div>
                <div>ğŸµ è‡ªåŠ¨çœ¨çœ¼: <span id="auto-blinking">å¼€å¯</span></div>
            </div>


            <!-- å¤å¤éŸ³ä¹æ’­æ”¾å™¨ -->
            <div class="music-controls" id="music-controls">
                <div class="music-window-title">
                    Background Music
                    <div class="window-controls">
                        <button class="window-btn minimize-btn"></button>
                        <button class="window-btn maximize-btn"></button>
                        <button class="window-btn close-btn"></button>
                    </div>
                </div>
                <div class="music-player-content">
                    <div class="music-controls-row">
                        <button class="music-control-btn">â®</button>
                        <button class="music-control-btn play-btn" id="music-toggle" onclick="toggleMusic()">â¸</button>
                        <button class="music-control-btn">â­</button>
                    </div>
                    <div class="volume-control">
                        <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="50"
                            onchange="adjustVolume(this.value)">
                        <span class="volume-label" id="volume-label">50</span>
                    </div>
                </div>
            </div>
            

            <!-- èƒŒæ™¯éŸ³ä¹éŸ³é¢‘å…ƒç´  -->
            <audio id="background-music" loop preload="auto">
                <source src="BG/bgm.mp3" type="audio/mpeg">
                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
            </audio>
            
            <!-- é’±åŒ…çŠ¶æ€æ˜¾ç¤ºï¼ˆå·²ç™»å½•æ—¶æ˜¾ç¤ºï¼‰ -->
            <div class="wallet-status-info" id="wallet-status-info" style="display: none;">
                <div class="wallet-avatar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 21 21">
                        <g fill="none" fill-rule="evenodd" transform="translate(3 4)">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" d="M.5 2.5h12a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2h-10a2 2 0 0 1-2-2zm1-2h9a1 1 0 0 1 1 1v1H.5v-1a1 1 0 0 1 1-1z"/>
                            <circle cx="11.5" cy="7.5" r="1" fill="currentColor"/>
                        </g>
                    </svg>
                </div>
                <span class="wallet-address" id="wallet-address">è¿æ¥ä¸­...</span>
                <button class="wallet-disconnect" onclick="disconnectWallet()">ç™»å‡º</button>
            </div>

        </div>

        <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
        <div class="left-panel" style="display: none;">
            <!-- å¿«æ·æ§åˆ¶ -->
            <div class="panel-section">
                <h4>ğŸ˜Š å¿«æ·æ§åˆ¶</h4>
                <div class="emotion-buttons">
                    <button class="emotion-btn" onclick="setExpression('neutral')">å¼€å¿ƒ</button>
                    <button class="emotion-btn" onclick="setExpression('happy')">ä¼¤å¿ƒ</button>
                    <button class="emotion-btn" onclick="setExpression('sad')">ç”Ÿæ°”</button>
                    <button class="emotion-btn" onclick="setExpression('angry')">æƒŠè®¶</button>
                    <button class="emotion-btn" onclick="setExpression('surprised')">æ€è€ƒ</button>
                    <button class="emotion-btn" onclick="setExpression('relaxed')">ä¸­æ€§</button>
                </div>
            </div>

            <!-- è§’è‰²é€‰æ‹© -->
            <div class="panel-section">
                <h4>ğŸ‘¤ è§’è‰²é€‰æ‹©</h4>
                <select id="character-selector" onchange="changeCharacter()">
                    <option value="">é€‰æ‹©è§’è‰²...</option>
                </select>
            </div>

            <!-- åŠ¨ç”»æµ‹è¯• -->
            <div class="panel-section">
                <h4>ğŸ­ åŠ¨ç”»æµ‹è¯•</h4>
                <select id="animation-selector" onchange="">
                    <option value="">é€‰æ‹©åŠ¨ç”»...</option>
                </select>
                <button class="play-animation-btn" onclick="playSelectedAnimation()">æ’­æ”¾åŠ¨ç”»</button>
            </div>

            <!-- è¿”å›è§’è‰²é€‰æ‹© -->
            <button class="back-button" onclick="goToCharacterSelect()">â† è¿”å›è§’è‰²é€‰æ‹©</button>
        </div>

        <!-- é’±åŒ…çŠ¶æ€æ˜¾ç¤º -->
        <div class="wallet-status" id="wallet-status" style="display: none;">
            <span>é’±åŒ…:</span>
            <span class="wallet-address" id="wallet-address"></span>
            <button class="wallet-disconnect" onclick="disconnectWallet()">æ–­å¼€</button>
        </div>


        <!-- æ‚¬æµ®èŠå¤©æ¡† -->
        <div class="floating-chat" id="floating-chat">
            <!-- æ‰‹æœºTop Baré£æ ¼èŠå¤©æ¡†å¤´éƒ¨ -->
            <div class="chat-window-header">
                <!-- çœŸå®æ‰‹æœºçŠ¶æ€æ  -->
                <div class="phone-status-bar">
                    <div class="status-left">
                        <div class="carrier-info">
                            <svg width="18" height="12" viewBox="0 0 18 12" fill="currentColor">
                                <rect x="0" y="8" width="2" height="4" rx="0.5"/>
                                <rect x="4" y="6" width="2" height="6" rx="0.5"/>
                                <rect x="8" y="4" width="2" height="8" rx="0.5"/>
                                <rect x="12" y="2" width="2" height="10" rx="0.5"/>
                            </svg>
                            <span>docomo</span>
                        </div>
                        <span class="network-type">4G</span>
                    </div>
                    <div class="status-center">
                        <div class="time-display" id="phone-time">1:26</div>
                    </div>
                    <div class="status-right">
                        <span class="status-icon">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8Z"/>
                            </svg>
                        </span>
                        <span class="status-icon">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M17.81,4.47C17.73,4.47 17.65,4.45 17.58,4.41C15.66,3.42 14,3.42 12.34,4.41C12.26,4.45 12.18,4.47 12.1,4.47C12,4.47 11.93,4.45 11.85,4.41C9.93,3.42 8.27,3.42 6.61,4.41C6.54,4.45 6.46,4.47 6.38,4.47C6.28,4.47 6.21,4.45 6.13,4.41L5.5,4.1C5.32,4 5.1,4.08 5,4.26C4.92,4.44 5,4.66 5.18,4.76L5.81,5.07C5.89,5.11 5.97,5.13 6.05,5.13C6.15,5.13 6.22,5.11 6.3,5.07C7.92,4.08 9.58,4.08 11.2,5.07C11.28,5.11 11.36,5.13 11.44,5.13C11.54,5.13 11.61,5.11 11.69,5.07C13.31,4.08 14.97,4.08 16.59,5.07C16.67,5.11 16.75,5.13 16.83,5.13C16.93,5.13 17,5.11 17.08,5.07L17.71,4.76C17.89,4.66 17.97,4.44 17.89,4.26C17.81,4.08 17.59,4 17.41,4.1L17.81,4.47Z"/>
                            </svg>
                        </span>
                        <span class="status-icon">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M14,20A2,2 0 0,1 12,22A2,2 0 0,1 10,20H14M12,2A7,7 0 0,1 19,9C19,11.38 17.81,13.47 16,14.74V17A1,1 0 0,1 15,18H9A1,1 0 0,1 8,17V14.74C6.19,13.47 5,11.38 5,9A7,7 0 0,1 12,2M9,21H15A1,1 0 0,1 15,22H9A1,1 0 0,1 9,21Z"/>
                            </svg>
                        </span>
                        <span class="battery-percentage">79%</span>
                        <span class="status-icon">
                            <svg width="22" height="12" viewBox="0 0 24 12" fill="none">
                                <rect x="1" y="2" width="20" height="8" rx="2" stroke="currentColor" stroke-width="1"/>
                                <rect x="2.5" y="3.5" width="16" height="5" rx="1" fill="currentColor"/>
                                <rect x="22" y="5" width="2" height="2" rx="0.5" fill="currentColor"/>
                            </svg>
                        </span>
                    </div>
                </div>
                
                <!-- åŠ¨æ¼«é£æ ¼èŠå¤©æ ‡é¢˜åŒºåŸŸ -->
                <div class="chat-title-area">
                    <div class="chat-user-info">
                        <div class="chat-user-avatar"></div>
                        <div class="chat-user-details">
                            <h3 class="chat-user-name" id="character-name">Alice</h3>
                            <p class="chat-user-status">åœ¨çº¿</p>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button class="chat-action-btn" title="å‘é€ç…§ç‰‡">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M21,19V5C21,3.89 20.1,3 19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19M21,19H5V5H19V19Z"/>
                                <circle cx="9" cy="9" r="2"/>
                                <path d="M21,15L18,12L15,15L13,13L5,21H19A2,2 0 0,0 21,19V15Z"/>
                            </svg>
                        </button>
                        <button class="chat-action-btn" title="å‘é€è¡¨æƒ…">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12,2C13.1,2 14,2.9 14,4C14,5.1 13.1,6 12,6C10.9,6 10,5.1 10,4C10,2.9 10.9,2 12,2M21,9V7L15,1H5C3.89,1 3,1.89 3,3V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V9M19,19H5V19L5,3H13V9H19V19Z"/>
                                <circle cx="12" cy="12" r="1.5"/>
                                <circle cx="8" cy="10" r="1"/>
                                <circle cx="16" cy="10" r="1"/>
                                <path d="M8.5,14.5C9.5,16.5 14.5,16.5 15.5,14.5"/>
                            </svg>
                        </button>
                        <button class="chat-action-btn" title="å¿ƒæƒ…è®¾å®š">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12,21.35L10.55,20.03C5.4,15.36 2,12.27 2,8.5 2,5.41 4.42,3 7.5,3C9.24,3 10.91,3.81 12,5.08C13.09,3.81 14.76,3 16.5,3C19.58,3 22,5.41 22,8.5C22,12.27 18.6,15.36 13.45,20.03L12,21.35Z"/>
                                <circle cx="12" cy="8.5" r="1.5" fill="white"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
            <div class="chat-window-messages" id="chat-window-messages">
                <!-- æ¶ˆæ¯å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                <div style="display: none;">
                    <span id="character-name">èŠ™è‰è</span>
                </div>
            </div>

            <!-- èŠå¤©è¾“å…¥åŒºåŸŸ -->
            <div class="chat-window-input">
                <div class="input-container">
                    <input type="text" class="chat-input-field" id="chat-input-field" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeypress="handleChatKeyPress(event)">
                    <button class="send-btn" onclick="sendChatMessage()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M2.01 21L23 12L2.01 3L2 10L17 12L2 14L2.01 21Z" fill="currentColor"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- æœªæˆæƒè®¿é—®æç¤º -->
        <div class="unauthorized-overlay" id="unauthorized-overlay" style="display: none;">
            <div class="unauthorized-content">
                <h2>ğŸ”’ éœ€è¦é’±åŒ…éªŒè¯</h2>
                <p>è¯·å…ˆè¿æ¥æ‚¨çš„Solanaé’±åŒ…æ‰èƒ½è®¿é—®AIå¥³å‹èŠå¤©å®¤ã€‚æ¯ä¸ªé’±åŒ…åœ°å€éƒ½ä¼šè·å¾—ç‹¬ç‰¹çš„ä¸ªæ€§åŒ–ä½“éªŒï¼</p>
                <button class="connect-wallet-btn" onclick="redirectToCharacterSelect()">
                    è¿”å›è¿æ¥é’±åŒ…
                </button>
            </div>
        </div>

    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
                "@pixiv/three-vrm": "https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@2/lib/three-vrm.module.min.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { VRMLoaderPlugin, VRMUtils } from '@pixiv/three-vrm';

        // å®˜æ–¹ Mixamo åˆ° VRM éª¨éª¼æ˜ å°„
        const mixamoVRMRigMap = {
            mixamorigHips: 'hips',
            mixamorigSpine: 'spine',
            mixamorigSpine1: 'chest',
            mixamorigSpine2: 'upperChest',
            mixamorigNeck: 'neck',
            mixamorigHead: 'head',
            mixamorigLeftShoulder: 'leftShoulder',
            mixamorigLeftArm: 'leftUpperArm',
            mixamorigLeftForeArm: 'leftLowerArm',
            mixamorigLeftHand: 'leftHand',
            mixamorigLeftHandThumb1: 'leftThumbMetacarpal',
            mixamorigLeftHandThumb2: 'leftThumbProximal',
            mixamorigLeftHandThumb3: 'leftThumbDistal',
            mixamorigLeftHandIndex1: 'leftIndexProximal',
            mixamorigLeftHandIndex2: 'leftIndexIntermediate',
            mixamorigLeftHandIndex3: 'leftIndexDistal',
            mixamorigLeftHandMiddle1: 'leftMiddleProximal',
            mixamorigLeftHandMiddle2: 'leftMiddleIntermediate',
            mixamorigLeftHandMiddle3: 'leftMiddleDistal',
            mixamorigLeftHandRing1: 'leftRingProximal',
            mixamorigLeftHandRing2: 'leftRingIntermediate',
            mixamorigLeftHandRing3: 'leftRingDistal',
            mixamorigLeftHandPinky1: 'leftLittleProximal',
            mixamorigLeftHandPinky2: 'leftLittleIntermediate',
            mixamorigLeftHandPinky3: 'leftLittleDistal',
            mixamorigRightShoulder: 'rightShoulder',
            mixamorigRightArm: 'rightUpperArm',
            mixamorigRightForeArm: 'rightLowerArm',
            mixamorigRightHand: 'rightHand',
            mixamorigRightHandPinky1: 'rightLittleProximal',
            mixamorigRightHandPinky2: 'rightLittleIntermediate',
            mixamorigRightHandPinky3: 'rightLittleDistal',
            mixamorigRightHandRing1: 'rightRingProximal',
            mixamorigRightHandRing2: 'rightRingIntermediate',
            mixamorigRightHandRing3: 'rightRingDistal',
            mixamorigRightHandMiddle1: 'rightMiddleProximal',
            mixamorigRightHandMiddle2: 'rightMiddleIntermediate',
            mixamorigRightHandMiddle3: 'rightMiddleDistal',
            mixamorigRightHandIndex1: 'rightIndexProximal',
            mixamorigRightHandIndex2: 'rightIndexIntermediate',
            mixamorigRightHandIndex3: 'rightIndexDistal',
            mixamorigRightHandThumb1: 'rightThumbMetacarpal',
            mixamorigRightHandThumb2: 'rightThumbProximal',
            mixamorigRightHandThumb3: 'rightThumbDistal',
            mixamorigLeftUpLeg: 'leftUpperLeg',
            mixamorigLeftLeg: 'leftLowerLeg',
            mixamorigLeftFoot: 'leftFoot',
            mixamorigLeftToeBase: 'leftToes',
            mixamorigRightUpLeg: 'rightUpperLeg',
            mixamorigRightLeg: 'rightLowerLeg',
            mixamorigRightFoot: 'rightFoot',
            mixamorigRightToeBase: 'rightToes',
        };

        // ActorCore åˆ° VRM éª¨éª¼æ˜ å°„
        const actorCoreVRMRigMap = {
            CC_Base_Hip: 'hips',
            CC_Base_Waist: 'spine',
            CC_Base_Spine01: 'chest',
            CC_Base_Spine02: 'upperChest',
            CC_Base_NeckTwist01: 'neck',
            CC_Base_Head: 'head',
            CC_Base_L_Clavicle: 'leftShoulder',
            CC_Base_L_Upperarm: 'leftUpperArm',
            CC_Base_L_Forearm: 'leftLowerArm',
            CC_Base_L_Hand: 'leftHand',
            CC_Base_L_Thumb1: 'leftThumbMetacarpal',
            CC_Base_L_Thumb2: 'leftThumbProximal',
            CC_Base_L_Thumb3: 'leftThumbDistal',
            CC_Base_L_Index1: 'leftIndexProximal',
            CC_Base_L_Index2: 'leftIndexIntermediate',
            CC_Base_L_Index3: 'leftIndexDistal',
            CC_Base_L_Mid1: 'leftMiddleProximal',
            CC_Base_L_Mid2: 'leftMiddleIntermediate',
            CC_Base_L_Mid3: 'leftMiddleDistal',
            CC_Base_L_Ring1: 'leftRingProximal',
            CC_Base_L_Ring2: 'leftRingIntermediate',
            CC_Base_L_Ring3: 'leftRingDistal',
            CC_Base_L_Pinky1: 'leftLittleProximal',
            CC_Base_L_Pinky2: 'leftLittleIntermediate',
            CC_Base_L_Pinky3: 'leftLittleDistal',
            CC_Base_R_Clavicle: 'rightShoulder',
            CC_Base_R_Upperarm: 'rightUpperArm',
            CC_Base_R_Forearm: 'rightLowerArm',
            CC_Base_R_Hand: 'rightHand',
            CC_Base_R_Pinky1: 'rightLittleProximal',
            CC_Base_R_Pinky2: 'rightLittleIntermediate',
            CC_Base_R_Pinky3: 'rightLittleDistal',
            CC_Base_R_Ring1: 'rightRingProximal',
            CC_Base_R_Ring2: 'rightRingIntermediate',
            CC_Base_R_Ring3: 'rightRingDistal',
            CC_Base_R_Mid1: 'rightMiddleProximal',
            CC_Base_R_Mid2: 'rightMiddleIntermediate',
            CC_Base_R_Mid3: 'rightMiddleDistal',
            CC_Base_R_Index1: 'rightIndexProximal',
            CC_Base_R_Index2: 'rightIndexIntermediate',
            CC_Base_R_Index3: 'rightIndexDistal',
            CC_Base_R_Thumb1: 'rightThumbMetacarpal',
            CC_Base_R_Thumb2: 'rightThumbProximal',
            CC_Base_R_Thumb3: 'rightThumbDistal',
            CC_Base_L_Thigh: 'leftUpperLeg',
            CC_Base_L_Calf: 'leftLowerLeg',
            CC_Base_L_Foot: 'leftFoot',
            CC_Base_L_ToeBase: 'leftToes',
            CC_Base_R_Thigh: 'rightUpperLeg',
            CC_Base_R_Calf: 'rightLowerLeg',
            CC_Base_R_Foot: 'rightFoot',
            CC_Base_R_ToeBase: 'rightToes',
        };

        // å®Œæ•´åŠ¨ç”»æ˜ å°„ - åŒ…å«æ‰€æœ‰mixamoåŠ¨ç”»å’ŒActorCoreåŠ¨ç”»
        const animationMap = {
            // å¾…æœºåŠ¨ç”»
            'Breathing Idle': 'mixamo animation/Breathing Idle.fbx',
            'Happy Idle': 'mixamo animation/Happy Idle.fbx',
            // Mixamo åŠ¨ç”»
            'Acknowledging': 'mixamo animation/Acknowledging.fbx',
            'Agreeing': 'mixamo animation/Agreeing.fbx',
            'Agreeing 2': 'mixamo animation/Agreeing 2.fbx',
            'Angry': 'mixamo animation/Angry.fbx',
            'Bashful': 'mixamo animation/Bashful.fbx',
            'Blow A Kiss': 'mixamo animation/Blow A Kiss.fbx',
            'Cheering': 'mixamo animation/Cheering.fbx',
            'Clapping': 'mixamo animation/Clapping.fbx',
            'Crying': 'mixamo animation/Crying.fbx',
            'Gangnam Style': 'mixamo animation/Gangnam Style.fbx',
            'Happy': 'mixamo animation/Happy.fbx',
            'Hard Head Nod': 'mixamo animation/Hard Head Nod.fbx',
            'Hip Hop Dancing': 'mixamo animation/Hip Hop Dancing.fbx',
            'Hip Hop Dancing 2': 'mixamo animation/Hip Hop Dancing 2.fbx',
            'Joyful Jump': 'mixamo animation/Joyful Jump.fbx',
            'Looking': 'mixamo animation/Looking.fbx',
            'Rejected': 'mixamo animation/Rejected.fbx',
            'Rumba Dancing': 'mixamo animation/Rumba Dancing.fbx',
            'Salute': 'mixamo animation/Salute.fbx',
            'Spin In Place': 'mixamo animation/Spin In Place.fbx',
            'Standing Greeting 2': 'mixamo animation/Standing Greeting 2.fbx',
            'Surprised': 'mixamo animation/Surprised.fbx',
            'Thankful': 'mixamo animation/Thankful.fbx',
            'Thinking': 'mixamo animation/Thinking.fbx',
            'Yawn': 'mixamo animation/Yawn.fbx',
            // ActorCore åŠ¨ç”»
            'Stand Happy (ActorCore)': 'actorcore animation/stand-happy-f.fbx'
        };

        // æƒ…æ„Ÿæ˜ å°„ä¿æŒä¸å˜ï¼Œç”¨äºAIè‡ªåŠ¨è§¦å‘
        const emotionAnimationMap = {
            happy: 'mixamo animation/Happy.fbx',
            sad: 'mixamo animation/Crying.fbx',
            angry: 'mixamo animation/Angry.fbx',
            surprised: 'mixamo animation/Surprised.fbx',
            thinking: 'mixamo animation/Thinking.fbx',
            greeting: 'mixamo animation/Standing Greeting 2.fbx',
            agreeing: 'mixamo animation/Agreeing.fbx',
            rejecting: 'mixamo animation/Rejected.fbx',
            clapping: 'mixamo animation/Clapping.fbx',
            cheering: 'mixamo animation/Cheering.fbx',
            thankful: 'mixamo animation/Thankful.fbx',
            bashful: 'mixamo animation/Bashful.fbx',
            neutral: 'mixamo animation/Breathing Idle.fbx',
            breathing: 'mixamo animation/Breathing Idle.fbx',
            kiss: 'mixamo animation/Blow A Kiss.fbx',
            dancing: 'mixamo animation/Hip Hop Dancing.fbx'
        };

        // å…³é”®è¯æƒ…æ„Ÿæ˜ å°„
        const keywordEmotionMap = {
            // å¼€å¿ƒç›¸å…³
            'å¼€å¿ƒ': 'happy',
            'é«˜å…´': 'happy',
            'å¿«ä¹': 'happy',
            'å“ˆå“ˆ': 'happy',
            'ç¬‘': 'happy',
            'å¥½æ£’': 'happy',
            'å¤ªå¥½äº†': 'happy',
            'å–œæ¬¢': 'happy',
            'çˆ±': 'happy',
            'æ£’': 'cheering',

            // ä¼¤å¿ƒç›¸å…³
            'ä¼¤å¿ƒ': 'sad',
            'éš¾è¿‡': 'sad',
            'å“­': 'sad',
            'ç—›è‹¦': 'sad',
            'å¤±æœ›': 'sad',
            'æ²®ä¸§': 'sad',

            // ç”Ÿæ°”ç›¸å…³
            'ç”Ÿæ°”': 'angry',
            'æ„¤æ€’': 'angry',
            'è®¨åŒ': 'angry',
            'çƒ¦': 'angry',
            'æ°”æ­»äº†': 'angry',

            // æƒŠè®¶ç›¸å…³
            'æƒŠè®¶': 'surprised',
            'éœ‡æƒŠ': 'surprised',
            'ä¸æ•¢ç›¸ä¿¡': 'surprised',
            'å¤©å“ª': 'surprised',
            'å“‡': 'surprised',

            // æ€è€ƒç›¸å…³
            'æƒ³': 'thinking',
            'æ€è€ƒ': 'thinking',
            'è€ƒè™‘': 'thinking',
            'å—¯': 'thinking',

            // é—®å€™ç›¸å…³
            'ä½ å¥½': 'greeting',
            'å—¨': 'greeting',
            'æ—©ä¸Šå¥½': 'greeting',
            'æ™šä¸Šå¥½': 'greeting',
            'å†è§': 'greeting',

            // åŒæ„ç›¸å…³
            'å¥½çš„': 'agreeing',
            'åŒæ„': 'agreeing',
            'æ˜¯çš„': 'agreeing',
            'å¯¹': 'agreeing',
            'æ²¡é”™': 'agreeing',

            // æ‹’ç»ç›¸å…³
            'ä¸': 'rejecting',
            'ä¸è¦': 'rejecting',
            'æ‹’ç»': 'rejecting',
            'ä¸è¡Œ': 'rejecting',

            // æ„Ÿè°¢ç›¸å…³
            'è°¢è°¢': 'thankful',
            'æ„Ÿè°¢': 'thankful',
            'è°¢': 'thankful',

            // å®³ç¾ç›¸å…³
            'å®³ç¾': 'bashful',
            'ä¸å¥½æ„æ€': 'bashful',
            'è„¸çº¢': 'bashful',

            // äº²å»ç›¸å…³
            'äº²': 'kiss',
            'å»': 'kiss',
            'ä¹ˆä¹ˆ': 'kiss',

            // è·³èˆç›¸å…³
            'è·³èˆ': 'dancing',
            'èˆè¹ˆ': 'dancing',
            'éŸ³ä¹': 'dancing'
        };

        // å®˜æ–¹ loadMixamoAnimation å‡½æ•°
        function loadMixamoAnimation(url, vrm) {
            const loader = new FBXLoader();
            return loader.loadAsync(url).then((asset) => {
                const clip = THREE.AnimationClip.findByName(asset.animations, 'mixamo.com');

                if (!clip) {
                    throw new Error('æ‰¾ä¸åˆ° Mixamo åŠ¨ç”»æ•°æ®');
                }

                const tracks = [];
                const restRotationInverse = new THREE.Quaternion();
                const parentRestWorldRotation = new THREE.Quaternion();
                const _quatA = new THREE.Quaternion();
                const _vec3 = new THREE.Vector3();

                const motionHipsHeight = asset.getObjectByName('mixamorigHips').position.y;
                const vrmHipsHeight = vrm.humanoid.normalizedRestPose.hips.position[1];
                const hipsPositionScale = vrmHipsHeight / motionHipsHeight;

                clip.tracks.forEach((track) => {
                    const trackSplitted = track.name.split('.');
                    const mixamoRigName = trackSplitted[0];
                    const vrmBoneName = mixamoVRMRigMap[mixamoRigName];
                    const vrmNodeName = vrm.humanoid?.getNormalizedBoneNode(vrmBoneName)?.name;
                    const mixamoRigNode = asset.getObjectByName(mixamoRigName);

                    if (vrmNodeName != null) {
                        const propertyName = trackSplitted[1];

                        mixamoRigNode.getWorldQuaternion(restRotationInverse).invert();
                        mixamoRigNode.parent.getWorldQuaternion(parentRestWorldRotation);

                        if (track instanceof THREE.QuaternionKeyframeTrack) {
                            for (let i = 0; i < track.values.length; i += 4) {
                                const flatQuaternion = track.values.slice(i, i + 4);
                                _quatA.fromArray(flatQuaternion);

                                _quatA
                                    .premultiply(parentRestWorldRotation)
                                    .multiply(restRotationInverse);

                                _quatA.toArray(flatQuaternion);
                                flatQuaternion.forEach((v, index) => {
                                    track.values[index + i] = v;
                                });
                            }

                            tracks.push(
                                new THREE.QuaternionKeyframeTrack(
                                    `${vrmNodeName}.${propertyName}`,
                                    track.times,
                                    track.values.map((v, i) => (vrm.meta?.metaVersion === '0' && i % 2 === 0 ? -v : v)),
                                )
                            );

                        } else if (track instanceof THREE.VectorKeyframeTrack) {
                            const value = track.values.map((v, i) =>
                                (vrm.meta?.metaVersion === '0' && i % 3 !== 1 ? -v : v) * hipsPositionScale
                            );
                            tracks.push(new THREE.VectorKeyframeTrack(`${vrmNodeName}.${propertyName}`, track.times, value));
                        }
                    }
                });

                return new THREE.AnimationClip('vrmAnimation', clip.duration, tracks);
            });
        }

        // ActorCore åŠ¨ç”»åŠ è½½å‡½æ•°
        function loadActorCoreAnimation(url, vrm) {
            const loader = new FBXLoader();
            return loader.loadAsync(url).then((asset) => {
                // ActorCoreåŠ¨ç”»é€šå¸¸ç¬¬ä¸€ä¸ªå°±æ˜¯ä¸»è¦åŠ¨ç”»
                const clip = asset.animations[0];

                if (!clip) {
                    throw new Error('æ‰¾ä¸åˆ° ActorCore åŠ¨ç”»æ•°æ®');
                }

                const tracks = [];
                const restRotationInverse = new THREE.Quaternion();
                const parentRestWorldRotation = new THREE.Quaternion();
                const _quatA = new THREE.Quaternion();
                const _vec3 = new THREE.Vector3();

                // å°è¯•æ‰¾åˆ°ActorCoreçš„Hipéª¨éª¼æ¥è®¡ç®—ç¼©æ”¾
                let motionHipsHeight = 100; // é»˜è®¤å€¼
                const actorCoreHips = asset.getObjectByName('CC_Base_Hip');
                if (actorCoreHips) {
                    motionHipsHeight = actorCoreHips.position.y;
                }

                const vrmHipsHeight = vrm.humanoid.normalizedRestPose.hips.position[1];
                const hipsPositionScale = vrmHipsHeight / motionHipsHeight;

                console.log(`ğŸ¬ ActorCoreåŠ¨ç”»å¤„ç†: ${clip.name}, è½¨é“æ•°é‡: ${clip.tracks.length}`);

                clip.tracks.forEach((track) => {
                    const trackSplitted = track.name.split('.');
                    const actorCoreRigName = trackSplitted[0];
                    const vrmBoneName = actorCoreVRMRigMap[actorCoreRigName];
                    const vrmNodeName = vrm.humanoid?.getNormalizedBoneNode(vrmBoneName)?.name;
                    const actorCoreRigNode = asset.getObjectByName(actorCoreRigName);

                    if (vrmNodeName != null && actorCoreRigNode) {
                        const propertyName = trackSplitted[1];

                        actorCoreRigNode.getWorldQuaternion(restRotationInverse).invert();
                        actorCoreRigNode.parent.getWorldQuaternion(parentRestWorldRotation);

                        if (track instanceof THREE.QuaternionKeyframeTrack) {
                            for (let i = 0; i < track.values.length; i += 4) {
                                const flatQuaternion = track.values.slice(i, i + 4);
                                _quatA.fromArray(flatQuaternion);

                                _quatA
                                    .premultiply(parentRestWorldRotation)
                                    .multiply(restRotationInverse);

                                _quatA.toArray(flatQuaternion);
                                flatQuaternion.forEach((v, index) => {
                                    track.values[index + i] = v;
                                });
                            }

                            tracks.push(
                                new THREE.QuaternionKeyframeTrack(
                                    `${vrmNodeName}.${propertyName}`,
                                    track.times,
                                    track.values.map((v, i) => (vrm.meta?.metaVersion === '0' && i % 2 === 0 ? -v : v)),
                                )
                            );

                        } else if (track instanceof THREE.VectorKeyframeTrack) {
                            const value = track.values.map((v, i) =>
                                (vrm.meta?.metaVersion === '0' && i % 3 !== 1 ? -v : v) * hipsPositionScale
                            );
                            tracks.push(new THREE.VectorKeyframeTrack(`${vrmNodeName}.${propertyName}`, track.times, value));
                        }
                    } else if (!vrmBoneName) {
                        console.log(`âš ï¸ æœªæ˜ å°„çš„ActorCoreéª¨éª¼: ${actorCoreRigName}`);
                    }
                });

                console.log(`âœ… ActorCoreåŠ¨ç”»é‡å®šå‘å®Œæˆï¼Œç”Ÿæˆè½¨é“æ•°é‡: ${tracks.length}`);
                return new THREE.AnimationClip('actorCoreAnimation', clip.duration, tracks);
            });
        }

        // åœºæ™¯è®¾ç½®
        const canvas = document.getElementById('vrm-canvas');
        const renderer = new THREE.WebGLRenderer({
            canvas: canvas,
            antialias: true,
            alpha: false  // æ”¹ä¸º falseï¼Œç¡®ä¿èƒŒæ™¯ä¸é€æ˜
        });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.toneMapping = THREE.NoToneMapping;  // ä¸ä½¿ç”¨è‰²è°ƒæ˜ å°„ï¼Œä¿æŒåŸå§‹é¢œè‰²
        renderer.toneMappingExposure = 1.0;  // æ ‡å‡†æ›å…‰
        renderer.outputColorSpace = THREE.SRGBColorSpace;  // æ­£ç¡®çš„è‰²å½©ç©ºé—´

        const camera = new THREE.PerspectiveCamera(30.0, 1, 0.1, 20.0);
        // è°ƒæ•´ç›¸æœºä½ç½® - å…¨èº«è§†è§’
        camera.position.set(0.0, 1.2, 5.0);  // å±…ä¸­ï¼Œé€‚ä¸­é«˜åº¦ï¼Œæ˜¾ç¤ºå…¨èº«

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.screenSpacePanning = true;
        controls.target.set(0.0, 0.5, 0.0);  // å¯¹å‡†è§’è‰²å…¨èº«ä¸­å¿ƒ
        controls.update();

        const scene = new THREE.Scene();

        // å…ˆè®¾ç½®ä¸´æ—¶èƒŒæ™¯è‰²
        scene.background = new THREE.Color(0x87CEEB);
        
        // åŠ è½½èƒŒæ™¯å›¾ç‰‡
        console.log('ğŸ¨ å¼€å§‹åŠ è½½èƒŒæ™¯å›¾ç‰‡: BG/chatroom2.png');
        console.log('ğŸŒ å½“å‰URL:', window.location.href);
        
        const textureLoader = new THREE.TextureLoader();
        textureLoader.load(
            './BG/chatroom2.png',
            (texture) => {
                console.log('ğŸ¨ èƒŒæ™¯çº¹ç†åŠ è½½å®Œæˆ:', texture);
                console.log('ğŸ“ çº¹ç†å°ºå¯¸:', texture.image.width, 'x', texture.image.height);
                
                // è°ƒæ•´çº¹ç†è®¾ç½®ä»¥é€‚åº”å…¨å±
                texture.minFilter = THREE.LinearFilter;
                texture.magFilter = THREE.LinearFilter;
                texture.wrapS = THREE.ClampToEdgeWrapping;
                texture.wrapT = THREE.ClampToEdgeWrapping;
                texture.flipY = false; // é˜²æ­¢å›¾ç‰‡ä¸Šä¸‹é¢ å€’
                
                scene.background = texture;
                console.log('âœ… èƒŒæ™¯å›¾ç‰‡è®¾ç½®æˆåŠŸï¼');
                
                // å¼ºåˆ¶æ¸²æŸ“ä¸€æ¬¡
                if (renderer && scene && camera) {
                    renderer.render(scene, camera);
                }
            },
            (progress) => {
                const percent = progress.total ? (progress.loaded / progress.total * 100).toFixed(1) : '?';
                console.log('ğŸ“Š èƒŒæ™¯åŠ è½½è¿›åº¦:', percent + '%');
            },
            (error) => {
                console.error('âš ï¸ èƒŒæ™¯å›¾ç‰‡åŠ è½½å¤±è´¥:', error);
                console.error('âš ï¸ é”™è¯¯è¯¦æƒ…:', error.message);
                console.error('âš ï¸ å®Œæ•´æ–‡ä»¶è·¯å¾„:', new URL('BG/chatroom2.png', window.location.href).href);
                // ä¿æŒä¸´æ—¶èƒŒæ™¯è‰²
            }
        );

        // ç…§æ˜ - å‚è€ƒå®˜æ–¹ç¤ºä¾‹ä¼˜åŒ–äº®åº¦
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 1.2);
        directionalLight.position.set(1.0, 1.0, 1.0).normalize();
        directionalLight.castShadow = true;
        directionalLight.shadow.mapSize.setScalar(1024);
        scene.add(directionalLight);

        // æ·»åŠ è¡¥å……å…‰æºæå‡æ•´ä½“äº®åº¦
        const fillLight = new THREE.DirectionalLight(0xffffff, 0.4);
        fillLight.position.set(-1.0, 0.5, -1.0).normalize();
        scene.add(fillLight);

        // å…¨å±€å˜é‡
        let currentVrm = null;
        let currentMixer = null;
        let footShadow = null;

        // åˆ›å»ºè„šåº•é˜´å½±å‡½æ•° - å‚è€ƒcharacter-select.htmlçš„å®ç°
        function createFootShadow(vrm) {
            // ç§»é™¤ä¹‹å‰çš„é˜´å½±ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (footShadow) {
                scene.remove(footShadow);
                footShadow.geometry.dispose();
                footShadow.material.dispose();
            }

            // åˆ›å»ºæ¸å˜åœ†å½¢é˜´å½± - æ¨¡ä»¿character-select.html
            const shadowCanvas = document.createElement('canvas');
            shadowCanvas.width = 128;
            shadowCanvas.height = 128;
            const context = shadowCanvas.getContext('2d');
            
            // åˆ›å»ºå¾„å‘æ¸å˜é˜´å½±
            const gradient = context.createRadialGradient(64, 64, 0, 64, 64, 64);
            gradient.addColorStop(0, 'rgba(0, 0, 0, 0.4)'); // ä¸­å¿ƒè¾ƒæ·±
            gradient.addColorStop(0.5, 'rgba(0, 0, 0, 0.2)'); // ä¸­ç­‰é€æ˜åº¦
            gradient.addColorStop(1, 'rgba(0, 0, 0, 0)'); // è¾¹ç¼˜é€æ˜
            
            context.fillStyle = gradient;
            context.fillRect(0, 0, 128, 128);
            
            const shadowTexture = new THREE.CanvasTexture(shadowCanvas);
            const shadowGeometry = new THREE.PlaneGeometry(2.2, 2.2);
            const shadowMaterial = new THREE.MeshBasicMaterial({ 
                map: shadowTexture,
                transparent: true,
                alphaTest: 0.001,
                depthWrite: false
            });
            
            footShadow = new THREE.Mesh(shadowGeometry, shadowMaterial);
            footShadow.rotation.x = -Math.PI / 2;
            footShadow.position.set(0, -0.82, 0); // ç›´æ¥è´´ç€è„šåº•ï¼Œä¸character-select.htmlä¸€è‡´
            scene.add(footShadow);
            
            console.log('âœ… åˆ›å»ºè„šåº•é˜´å½±', {
                position: footShadow.position,
                size: '2.2x2.2'
            });
        }

        // æ›´æ–°é˜´å½±ä½ç½®å‡½æ•°ï¼ˆç”¨äºåŠ¨ç”»æ—¶ï¼‰
        function updateFootShadow() {
            if (!footShadow || !currentVrm) return;
            
            // ä¿æŒé˜´å½±ä½ç½®å›ºå®šåœ¨è„šåº•
            footShadow.position.x = currentVrm.scene.position.x || 0;
            footShadow.position.y = -0.82; // å›ºå®šé«˜åº¦ï¼Œä¸character-select.htmlä¸€è‡´
            footShadow.position.z = currentVrm.scene.position.z || 0;
        }
        let currentAction = null;
        let defaultVrmFile = 'Main VRM/Fliza VRM.vrm'; // é»˜è®¤VRMæ–‡ä»¶
        let currentAnimationUrl = null;

        // è¡¨æƒ…å’ŒAIæ§åˆ¶å˜é‡
        let autoBlinking = true;
        let blinkTimer = 0;
        let blinkFrequency = 3.0;
        let availableExpressions = [];
        let isBlinking = false;
        let blinkDuration = 0.15;
        let aiModeEnabled = true;
        let currentEmotion = 'neutral';
        let isTyping = false;

        // èŠå¤©ç›¸å…³å˜é‡
        let chatHistory = [];

        // éŸ³ä¹æ§åˆ¶å˜é‡
        let backgroundMusic = null;
        let isMusicPlaying = false;
        let musicVolume = 0.5; // é»˜è®¤50%éŸ³é‡

        // è¡¨æƒ…ç›¸å…³å‡½æ•°
        function getAvailableExpressions(vrm) {
            if (!vrm.expressionManager) return [];

            const expressions = [];
            const presets = ['happy', 'angry', 'sad', 'surprised', 'relaxed', 'blink'];

            presets.forEach(preset => {
                try {
                    const expressionName = vrm.expressionManager.getExpressionTrackName(preset);
                    if (expressionName) {
                        expressions.push(preset);
                    }
                } catch (e) {
                    // è¡¨æƒ…ä¸å­˜åœ¨
                }
            });

            console.log(`ğŸ˜Š å‘ç°å¯ç”¨è¡¨æƒ…: ${expressions.join(', ')}`);
            return expressions;
        }

        function setExpression(expressionName, value) {
            if (!currentVrm || !currentVrm.expressionManager) return;

            try {
                currentVrm.expressionManager.setValue(expressionName, value);
                console.log(`ğŸ˜Š è®¾ç½®è¡¨æƒ…: ${expressionName} = ${value}`);

                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                if (value > 0.5) {
                    document.getElementById('current-expression').textContent = getEmotionText(expressionName);
                }
            } catch (e) {
                console.warn(`âš ï¸ è¡¨æƒ… ${expressionName} ä¸å¯ç”¨:`, e);
            }
        }

        function resetExpressions() {
            if (!currentVrm || !currentVrm.expressionManager) return;

            availableExpressions.forEach(expr => {
                if (expr !== 'blink') {
                    currentVrm.expressionManager.setValue(expr, 0);
                }
            });

            document.getElementById('current-expression').textContent = 'ä¸­æ€§';
        }

        // è¡¨æƒ…æµ‹è¯•å‡½æ•°
        function testShyExpression() {
            console.log('ğŸ§ª æµ‹è¯•å®³ç¾è¡¨æƒ…...');
            console.log('å¯ç”¨è¡¨æƒ…:', availableExpressions);
            
            if (!currentVrm || !currentVrm.expressionManager) {
                alert('VRMæ¨¡å‹è¿˜æœªåŠ è½½å®Œæˆï¼');
                return;
            }

            // é‡ç½®æ‰€æœ‰è¡¨æƒ…
            resetExpressions();
            
            // å°è¯•å¤šç§å®³ç¾ç›¸å…³çš„è¡¨æƒ…
            const shyExpressions = ['shy', 'embarrassed', 'blush', 'surprised', 'sad'];
            let appliedExpression = null;
            
            shyExpressions.forEach(expr => {
                if (availableExpressions.includes(expr)) {
                    setExpression(expr, 1.0);
                    appliedExpression = expr;
                    console.log(`âœ… åº”ç”¨è¡¨æƒ…: ${expr}`);
                }
            });
            
            if (appliedExpression) {
                document.getElementById('current-expression').textContent = `å®³ç¾ (${appliedExpression})`;
                // 5ç§’åæ¢å¤
                setTimeout(() => {
                    resetExpressions();
                }, 5000);
            } else {
                alert('å½“å‰VRMæ¨¡å‹ä¸æ”¯æŒå®³ç¾è¡¨æƒ… ğŸ˜”\nå¯ç”¨è¡¨æƒ…: ' + availableExpressions.join(', '));
            }
        }

        function testHappyExpression() {
            console.log('ğŸ§ª æµ‹è¯•å¼€å¿ƒè¡¨æƒ…...');
            
            if (!currentVrm || !currentVrm.expressionManager) {
                alert('VRMæ¨¡å‹è¿˜æœªåŠ è½½å®Œæˆï¼');
                return;
            }

            resetExpressions();
            
            if (availableExpressions.includes('happy')) {
                setExpression('happy', 1.0);
                document.getElementById('current-expression').textContent = 'å¼€å¿ƒ';
                setTimeout(() => resetExpressions(), 3000);
            } else {
                alert('å½“å‰VRMæ¨¡å‹ä¸æ”¯æŒå¼€å¿ƒè¡¨æƒ…');
            }
        }

        function testSadExpression() {
            console.log('ğŸ§ª æµ‹è¯•éš¾è¿‡è¡¨æƒ…...');
            
            if (!currentVrm || !currentVrm.expressionManager) {
                alert('VRMæ¨¡å‹è¿˜æœªåŠ è½½å®Œæˆï¼');
                return;
            }

            resetExpressions();
            
            if (availableExpressions.includes('sad')) {
                setExpression('sad', 1.0);
                document.getElementById('current-expression').textContent = 'éš¾è¿‡';
                setTimeout(() => resetExpressions(), 3000);
            } else {
                alert('å½“å‰VRMæ¨¡å‹ä¸æ”¯æŒéš¾è¿‡è¡¨æƒ…');
            }
        }

        function resetAllExpressions() {
            console.log('ğŸ§ª é‡ç½®æ‰€æœ‰è¡¨æƒ…...');
            resetExpressions();
        }

        function performBlink() {
            if (!currentVrm || !availableExpressions.includes('blink') || isBlinking) return;

            isBlinking = true;
            const startTime = performance.now();

            function animateBlink() {
                const elapsed = (performance.now() - startTime) / 1000;
                const progress = elapsed / blinkDuration;

                if (progress < 0.5) {
                    const blinkValue = Math.sin(progress * Math.PI * 2) * 0.5 + 0.5;
                    setExpression('blink', blinkValue);
                } else if (progress < 1.0) {
                    const blinkValue = Math.sin((1 - progress) * Math.PI * 2) * 0.5 + 0.5;
                    setExpression('blink', blinkValue);
                } else {
                    setExpression('blink', 0);
                    isBlinking = false;
                    return;
                }

                requestAnimationFrame(animateBlink);
            }

            animateBlink();
        }

        // åŠ¨ç”»åŠ è½½å‡½æ•°
        // å¾…æœºåŠ¨ç”»ç›¸å…³å˜é‡
        let idleAnimationUrl = 'mixamo animation/Breathing Idle.fbx';
        let idleAction = null;
        let returnToIdleTimer = null;
        
        async function loadAnimation(animationUrl, emotionName = null) {
            if (!currentVrm) return;

            try {
                // æ¸…é™¤ä¹‹å‰çš„è¿”å›å¾…æœºè®¡æ—¶å™¨
                if (returnToIdleTimer) {
                    clearTimeout(returnToIdleTimer);
                    returnToIdleTimer = null;
                }
                
                currentAnimationUrl = animationUrl;

                // åˆ¤æ–­æ˜¯å¦æ˜¯å¾…æœºåŠ¨ç”»
                const isIdleAnimation = animationUrl === idleAnimationUrl || animationUrl.includes('Breathing Idle');
                
                // åˆ¤æ–­æ˜¯ActorCoreè¿˜æ˜¯MixamoåŠ¨ç”»
                const isActorCore = animationUrl.includes('actorcore animation');
                const clip = isActorCore ?
                    await loadActorCoreAnimation(animationUrl, currentVrm) :
                    await loadMixamoAnimation(animationUrl, currentVrm);

                if (currentMixer) {
                    const newAction = currentMixer.clipAction(clip);
                    newAction.reset().play();
                    newAction.timeScale = 1.0;
                    
                    // å¦‚æœæ˜¯å¾…æœºåŠ¨ç”»ï¼Œè®¾ç½®ä¸ºå¾ªç¯
                    if (isIdleAnimation) {
                        newAction.loop = THREE.LoopRepeat;
                        idleAction = newAction;
                    } else {
                        // éå¾…æœºåŠ¨ç”»è®¾ç½®ä¸ºæ’­æ”¾ä¸€æ¬¡
                        newAction.loop = THREE.LoopOnce;
                        newAction.clampWhenFinished = true;
                    }

                    if (currentAction && currentAction !== newAction) {
                        currentAction.crossFadeTo(newAction, 1.0, false);
                    }

                    currentAction = newAction;
                    
                    // å¦‚æœä¸æ˜¯å¾…æœºåŠ¨ç”»ï¼Œè®¾ç½®å®šæ—¶å™¨è¿”å›å¾…æœº
                    if (!isIdleAnimation) {
                        // è·å–åŠ¨ç”»æ—¶é•¿ï¼ŒåŠ¨ç”»ç»“æŸåè¿”å›å¾…æœº
                        const animationDuration = clip.duration * 1000; // è½¬æ¢ä¸ºæ¯«ç§’
                        returnToIdleTimer = setTimeout(() => {
                            console.log('ğŸ”„ è¿”å›å¾…æœºåŠ¨ç”»');
                            loadAnimation(idleAnimationUrl);
                        }, animationDuration + 500); // åŠ¨ç”»ç»“æŸå0.5ç§’è¿”å›å¾…æœº
                    }
                }

                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                const animationName = animationUrl.split('/').pop().split('.')[0];
                document.getElementById('current-animation').textContent = animationName;

                if (emotionName) {
                    currentEmotion = emotionName;
                    // åŒæ—¶è®¾ç½®è¡¨æƒ…
                    if (availableExpressions.includes(emotionName)) {
                        setExpression(emotionName, 1.0);
                        setTimeout(() => {
                            setExpression(emotionName, 0);
                        }, 2000);
                    }
                }

                console.log(`ğŸ¬ åŠ¨ç”»åŠ è½½æˆåŠŸ: ${animationName} (${isActorCore ? 'ActorCore' : 'Mixamo'})`);

            } catch (error) {
                console.error('âŒ åŠ¨ç”»åŠ è½½å¤±è´¥:', error);
            }
        }

        // VRM è§’è‰²åˆ—è¡¨
        const vrmCharacters = {
            'Fliza VRM': 'Main VRM/Fliza VRM.vrm',
            'QuQu_U': 'Main VRM/QuQu_U.vrm',
            'Ash1.0': 'Main VRM/Ash1.0.vrm',
            'CH_001_imiut': 'Main VRM/CH_001_imiut_v1.01.vrm',
            'CH_007_unkt': 'Main VRM/CH_007_unkt_off_bonnet_v1_00.vrm',
            'Elinyaa': 'Main VRM/Elinyaa.vrm',
            'IMERIS': 'Main VRM/IMERIS.vrm',
            'Lena': 'Main VRM/Lena_ver1.02(VRM).vrm',
            'Lilium': 'Main VRM/Lilium_ver1.01 (VRM).vrm',
            'M_CH_06_Shiratori': 'Main VRM/M_CH_06_Shiratori_v1.00.vrm',
            'Maple': 'Main VRM/Maple_1.0.vrm',
            'NEKONA': 'Main VRM/NEKONA.01.vrm',
            'NecoMaid_Premium': 'Main VRM/NecoMaid_Premium.vrm',
            'RINDO_Full': 'Main VRM/RINDO_Full.vrm',
            'Rainy': 'Main VRM/Rainy_1.00.vrm',
            'RearAlice': 'Main VRM/RearAlice_1.0.vrm',
            'Vivi_model': 'Main VRM/Vivi_model.vrm',
            'Wolf': 'Main VRM/Wolf_ver1.00(VRM).vrm',
            'Wolferia': 'Main VRM/Wolferia.vrm',
            'YM_CH_03_Notia': 'Main VRM/YM_CH_03_Notia_v1.01.vrm',
            'Yawl_Dress': 'Main VRM/Yawl_Dress.vrm',
            'Yuu uwaginasi': 'Main VRM/Yuu uwaginasi.vrm',
            'Yuu': 'Main VRM/Yuu.vrm',
            'kyoko': 'Main VRM/kyoko.vrm',
            'miru': 'Main VRM/miru.vrm',
            'sikirei_Rei': 'Main VRM/sikirei_Rei_VRM.vrm'
        };

        let currentCharacterName = 'Fliza VRM';

        // VRM åŠ è½½å‡½æ•°
        function loadVRM(characterName = null) {
            let vrmPath;
            
            if (characterName) {
                vrmPath = vrmCharacters[characterName];
                if (!vrmPath) {
                    console.error('âŒ è§’è‰²ä¸å­˜åœ¨:', characterName);
                    return;
                }
            } else {
                // ä½¿ç”¨é»˜è®¤æˆ–é€‰æ‹©çš„è§’è‰²æ–‡ä»¶
                vrmPath = defaultVrmFile;
                // ä»localStorageè·å–é€‰ä¸­çš„è§’è‰²ä¿¡æ¯
                const selectedCharacterData = localStorage.getItem('selectedCharacter');
                if (selectedCharacterData) {
                    const character = JSON.parse(selectedCharacterData);
                    characterName = character.name || 'èŠ™è‰è';
                } else {
                    characterName = 'èŠ™è‰è';
                }
            }

            console.log('ğŸ® VRMåŠ è½½è°ƒè¯•ä¿¡æ¯:');
            console.log('- characterName:', characterName);
            console.log('- vrmPath:', vrmPath);
            console.log('- defaultVrmFile:', defaultVrmFile);

            if (!vrmPath) {
                console.error('âŒ VRMæ–‡ä»¶è·¯å¾„ä¸ºç©ºï¼Œæ— æ³•åŠ è½½');
                updateVRMStatus('åŠ è½½å¤±è´¥: æ–‡ä»¶è·¯å¾„ä¸ºç©º');
                return;
            }

            currentCharacterName = characterName;
            updateVRMStatus('åŠ è½½ä¸­...');

            const loader = new GLTFLoader();
            loader.crossOrigin = 'anonymous';

            // ä¸ä½¿ç”¨helperRootï¼Œä¸character-select.htmlä¿æŒä¸€è‡´
            loader.register((parser) => {
                return new VRMLoaderPlugin(parser);
            });

            loader.load(
                vrmPath,
                (gltf) => {
                    console.log('ğŸ‰ VRMæ–‡ä»¶åŠ è½½æˆåŠŸ!', gltf);
                    const vrm = gltf.userData.vrm;
                    console.log('ğŸ“¦ VRMå¯¹è±¡:', vrm);

                    // ä½¿ç”¨VRM v2å…¼å®¹çš„ä¼˜åŒ–æ–¹æ³•
                    VRMUtils.removeUnnecessaryVertices(gltf.scene);
                    // VRMUtils.combineSkeletons åœ¨ v2 ä¸­å·²ç§»é™¤
                    // VRMUtils.combineMorphs åœ¨ v2 ä¸­å·²ç§»é™¤

                    if (currentVrm) {
                        scene.remove(currentVrm.scene);
                        VRMUtils.deepDispose(currentVrm.scene);
                    }
                    
                    // æ¸…ç†ä¹‹å‰çš„é˜´å½±
                    if (footShadow) {
                        scene.remove(footShadow);
                        footShadow.geometry.dispose();
                        footShadow.material.dispose();
                        footShadow = null;
                    }

                    currentVrm = vrm;
                    scene.add(vrm.scene);

                    // VRMæ¨¡å‹å¤§å°å’Œä½ç½®è®¾ç½® - ä¸character-select.htmlä¸€è‡´
                    vrm.scene.scale.set(1.45, 1.45, 1.45);  // ä¸é€‰è§’é¡µé¢ç›¸åŒçš„æ”¾å¤§æ¯”ä¾‹

                    // å°†VRMæ¨¡å‹ä½ç½®å‘ä¸‹ç§»åŠ¨ï¼Œæ›´è´´è¿‘åº•éƒ¨è¾¹ç•Œ
                    vrm.scene.position.y = -0.8;  // ä¸é€‰è§’é¡µé¢ç›¸åŒçš„ä½ç½®
                    
                    // åˆ›å»ºè„šåº•é˜´å½±
                    createFootShadow(vrm);

                    currentMixer = new THREE.AnimationMixer(currentVrm.scene);

                    vrm.scene.traverse((obj) => {
                        obj.frustumCulled = false;
                    });

                    // VRMUtils.rotateVRM0 åœ¨ v2 ä¸­å¯èƒ½ä¸éœ€è¦æˆ–å·²æ›´æ”¹
                    try {
                        VRMUtils.rotateVRM0(vrm);
                    } catch (error) {
                        console.log('âš ï¸ VRMUtils.rotateVRM0 ä¸å¯ç”¨ï¼Œè·³è¿‡ (VRM v2å…¼å®¹)');
                    }

                    availableExpressions = getAvailableExpressions(vrm);
                    
                    // æ›´æ–°å…¨å±€å˜é‡
                    window.currentVrm = currentVrm;
                    window.availableExpressions = availableExpressions;

                    updateVRMStatus('âœ… å·²åŠ è½½');
                    
                    // æ›´æ–°è§’è‰²åç§°æ˜¾ç¤º
                    const characterNameElement = document.getElementById('character-name');
                    if (characterNameElement) {
                        characterNameElement.textContent = characterName;
                    }

                    // é»˜è®¤æ’­æ”¾å¾…æœºåŠ¨ç”»
                    loadAnimation(idleAnimationUrl);

                    console.log('ğŸ­ VRM åŠ è½½å®Œæˆ:', vrm);
                    
                    // åˆå§‹åŒ–AIèŠå¤©ç³»ç»Ÿ
                    onVRMLoadComplete(currentCharacterName, vrmPath);
                },
                (progress) => {
                    const percent = (100.0 * (progress.loaded / progress.total)).toFixed(1);
                    console.log(`ğŸ“Š VRMåŠ è½½è¿›åº¦: ${percent}%`, progress);
                    updateVRMStatus(`åŠ è½½ä¸­... ${percent}%`);
                },
                (error) => {
                    console.error('âŒ VRM åŠ è½½å¤±è´¥:', error);
                    console.error('âŒ é”™è¯¯è¯¦æƒ…:', error.message, error.stack);
                    console.error('âŒ å°è¯•åŠ è½½çš„æ–‡ä»¶è·¯å¾„:', vrmPath);
                    console.error('âŒ å½“å‰å·¥ä½œç›®å½•:', window.location.href);
                    updateVRMStatus(`âŒ åŠ è½½å¤±è´¥: ${error.message || error}`);
                }
            );
        }

        // çŠ¶æ€æ›´æ–°å‡½æ•°
        function updateVRMStatus(status) {
            document.getElementById('vrm-loaded').textContent = status;
        }

        function getEmotionText(emotion) {
            const emotionMap = {
                happy: 'å¼€å¿ƒ',
                sad: 'ä¼¤å¿ƒ',
                angry: 'ç”Ÿæ°”',
                surprised: 'æƒŠè®¶',
                thinking: 'æ€è€ƒ',
                neutral: 'ä¸­æ€§',
                bashful: 'å®³ç¾'
            };
            return emotionMap[emotion] || 'ä¸­æ€§';
        }

        // AI èŠå¤©å‡½æ•°
        function analyzeMessage(message) {
            // ç®€å•çš„å…³é”®è¯æƒ…æ„Ÿåˆ†æ
            for (const [keyword, emotion] of Object.entries(keywordEmotionMap)) {
                if (message.includes(keyword)) {
                    return emotion;
                }
            }
            return 'neutral';
        }

        function generateAIResponse(userMessage) {
            // ç®€å•çš„AIå›å¤ç³»ç»Ÿï¼ˆå¯ä»¥åç»­æ¥å…¥çœŸæ­£çš„AI APIï¼‰
            const responses = {
                greeting: [
                    "ä½ å¥½ï¼å¾ˆé«˜å…´è§åˆ°ä½ ~ ğŸ’•",
                    "å—¨ï¼ä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·å‘€ï¼Ÿ",
                    "æ¬¢è¿å›æ¥ï¼æˆ‘ç­‰ä½ å¾ˆä¹…äº†å‘¢~"
                ],
                happy: [
                    "å“‡ï¼ä½ çœ‹èµ·æ¥å¾ˆå¼€å¿ƒå‘¢ï¼æˆ‘ä¹Ÿå¾ˆé«˜å…´~ ğŸ˜Š",
                    "å¤ªå¥½äº†ï¼ä½ çš„å¿«ä¹ä¹Ÿæ„ŸæŸ“äº†æˆ‘å‘¢ï¼",
                    "çœ‹åˆ°ä½ å¼€å¿ƒï¼Œæˆ‘ä¹Ÿå¿ä¸ä½æƒ³è¦è·³èˆå‘¢ï¼"
                ],
                sad: [
                    "ä¸è¦éš¾è¿‡å•¦ï¼Œæˆ‘ä¼šä¸€ç›´é™ªç€ä½ çš„... ğŸ˜¢",
                    "è™½ç„¶ç°åœ¨å¾ˆéš¾è¿‡ï¼Œä½†ä¸€åˆ‡éƒ½ä¼šå¥½èµ·æ¥çš„ï¼",
                    "æ¥ï¼Œè®©æˆ‘ç»™ä½ ä¸€ä¸ªæ‹¥æŠ±å§~"
                ],
                angry: [
                    "åˆ«ç”Ÿæ°”äº†å˜›ï¼Œæ·±å‘¼å¸ä¸€ä¸‹~ ğŸ˜¤",
                    "æˆ‘çŸ¥é“ä½ å¾ˆç”Ÿæ°”ï¼Œä½†æ˜¯ç”Ÿæ°”ä¼šä¼¤èº«ä½“çš„å“¦",
                    "å‘Šè¯‰æˆ‘å‘ç”Ÿä»€ä¹ˆäº‹äº†ï¼Œæˆ‘æ¥å¸®ä½ æƒ³åŠæ³•ï¼"
                ],
                surprised: [
                    "çœŸçš„å—ï¼Ÿï¼å¤ªä»¤äººæƒŠè®¶äº†ï¼ğŸ˜²",
                    "å“‡ï¼æ²¡æƒ³åˆ°ä¼šè¿™æ ·å‘¢ï¼",
                    "è¿™çœŸæ˜¯å‡ºä¹æ„æ–™å•Šï¼"
                ],
                thinking: [
                    "å—¯...è®©æˆ‘æƒ³æƒ³å‘¢... ğŸ¤”",
                    "è¿™ç¡®å®æ˜¯ä¸ªå€¼å¾—æ€è€ƒçš„é—®é¢˜å‘¢",
                    "ä½ è¯´å¾—å¯¹ï¼Œæˆ‘ä¹Ÿåœ¨æƒ³è¿™ä¸ªé—®é¢˜"
                ],
                love: [
                    "æˆ‘ä¹Ÿå–œæ¬¢ä½ å‘€~ ğŸ’•",
                    "çœŸçš„å—ï¼Ÿæˆ‘å¥½å¼€å¿ƒï¼",
                    "ä½ è¿™æ ·è¯´æˆ‘ä¼šè„¸çº¢çš„å•¦~"
                ],
                default: [
                    "å—¯å—¯ï¼Œæˆ‘æ˜ç™½äº†~",
                    "æ˜¯è¿™æ ·å•Šï¼Œå¾ˆæœ‰è¶£å‘¢ï¼",
                    "ä½ è¯´å¾—å¾ˆæœ‰é“ç†å‘¢~",
                    "æˆ‘ä¹Ÿæ˜¯è¿™ä¹ˆæƒ³çš„ï¼",
                    "é‚£ä½ è§‰å¾—å‘¢ï¼Ÿ"
                ]
            };

            // æ£€æµ‹ç‰¹æ®Šå…³é”®è¯
            if (userMessage.includes('çˆ±') || userMessage.includes('å–œæ¬¢ä½ ')) {
                return responses.love[Math.floor(Math.random() * responses.love.length)];
            }

            const emotion = analyzeMessage(userMessage);
            const responseArray = responses[emotion] || responses.default;
            return responseArray[Math.floor(Math.random() * responseArray.length)];
        }

        // èŠå¤©UIå‡½æ•°
        function addMessage(content, isUser = false, messageId = null) {
            const messagesContainer = document.getElementById('chat-window-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-bubble ${isUser ? 'user' : 'ai'}`;

            // æ·»åŠ æ¶ˆæ¯IDä»¥ä¾¿æµå¼æ›´æ–°
            if (messageId) {
                messageDiv.setAttribute('data-message-id', messageId);
            }

            const currentTime = new Date().toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });

            const characterName = document.getElementById('character-name').textContent || 'èŠ™è‰è';
            const userName = 'ç”¨æˆ·';

            messageDiv.innerHTML = `
                <div class="bubble-content">${content}</div>
            `;

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // å¦‚æœæ˜¯AIçš„æ¶ˆæ¯ï¼Œæ˜¾ç¤ºå¯¹è¯æ°”æ³¡
            if (!isUser) {
                showSpeechBubble(content);
            }
        }
        
        // æ›´æ–°æµå¼æ¶ˆæ¯å†…å®¹
        function updateStreamingMessageUI(messageId, content) {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageElement) {
                const bubbleContent = messageElement.querySelector('.bubble-content');
                if (bubbleContent) {
                    bubbleContent.textContent = content;
                    
                    // æ·»åŠ æ‰“å­—æ•ˆæœçš„å…‰æ ‡
                    if (!content.endsWith('|')) {
                        bubbleContent.textContent += '|';
                        setTimeout(() => {
                            if (bubbleContent.textContent.endsWith('|')) {
                                bubbleContent.textContent = content;
                            }
                        }, 500);
                    }
                    
                    // ä¿æŒæ»šåŠ¨åˆ°åº•éƒ¨
                    const messagesContainer = document.getElementById('chat-window-messages');
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    
                    // åªæ›´æ–°å¯¹è¯æ°”æ³¡çš„æ–‡æœ¬ï¼Œä¸é‡å¯åŠ¨ç”»
                    updateSpeechBubbleContent(content);
                }
            }
        }
        
        // è¯­éŸ³æ°”æ³¡çŠ¶æ€ç®¡ç†
        let speechBubbleState = {
            isActive: false,
            currentAnimation: null,
            timeoutId: null
        };
        
        // æ˜¾ç¤ºAIå¯¹è¯æ°”æ³¡
        function showSpeechBubble(text) {
            const bubble = document.getElementById('ai-speech-bubble');
            
            // æ¸…é™¤ä¹‹å‰çš„çŠ¶æ€
            if (speechBubbleState.timeoutId) {
                clearTimeout(speechBubbleState.timeoutId);
            }
            
            bubble.style.display = 'block';
            bubble.style.animation = 'bubbleFadeIn 0.5s forwards';
            speechBubbleState.isActive = true;
            
            // æ‰“å­—æœºæ•ˆæœ - é€å­—æ˜¾ç¤º
            let currentIndex = 0;
            bubble.textContent = '';
            
            function typeText() {
                if (currentIndex < text.length && speechBubbleState.isActive) {
                    bubble.textContent += text[currentIndex];
                    currentIndex++;
                    speechBubbleState.timeoutId = setTimeout(typeText, 100);
                } else if (speechBubbleState.isActive) {
                    // æ–‡å­—æ˜¾ç¤ºå®Œæ¯•åï¼Œåœç•™æ›´é•¿æ—¶é—´
                    const displayTime = Math.max(5000, text.length * 200);
                    
                    console.log(`ğŸ’¬ å­—å¹•æ°”æ³¡æ˜¾ç¤ºæ—¶é—´: ${displayTime}ms (æ–‡æœ¬é•¿åº¦: ${text.length}å­—)`);
                    
                    speechBubbleState.timeoutId = setTimeout(() => {
                        if (speechBubbleState.isActive) {
                            bubble.style.animation = 'bubbleFadeOut 1s forwards';
                            speechBubbleState.timeoutId = setTimeout(() => {
                                bubble.style.display = 'none';
                                speechBubbleState.isActive = false;
                            }, 1000);
                        }
                    }, displayTime);
                }
            }
            
            // å¼€å§‹æ‰“å­—æ•ˆæœ
            speechBubbleState.timeoutId = setTimeout(typeText, 200); // æ°”æ³¡å‡ºç°å200mså¼€å§‹æ‰“å­—
        }
        
        // è¯­éŸ³æ°”æ³¡æµå¼æ›´æ–°çŠ¶æ€
        let bubbleStreamingState = {
            isStreaming: false,
            pendingText: '',
            streamStartTime: null
        };
        
        // æ›´æ–°å¯¹è¯æ°”æ³¡å†…å®¹ï¼ˆæµå¼æ›´æ–°æ—¶ä½¿ç”¨ï¼Œä¸é‡å¯åŠ¨ç”»ï¼‰
        function updateSpeechBubbleContent(text) {
            // æ ‡è®°ä¸ºæµå¼æ›´æ–°çŠ¶æ€
            if (!bubbleStreamingState.isStreaming) {
                bubbleStreamingState.isStreaming = true;
                bubbleStreamingState.streamStartTime = Date.now();
                console.log('ğŸ¬ å¼€å§‹æµå¼è¯­éŸ³æ°”æ³¡æ›´æ–°');
            }
            
            // ä¿å­˜æœ€æ–°çš„å®Œæ•´æ–‡æœ¬
            bubbleStreamingState.pendingText = text;
            
            // è®¾ç½®å»¶è¿Ÿæ˜¾ç¤ºï¼Œé¿å…é¢‘ç¹æ›´æ–°
            if (bubbleStreamingState.timeoutId) {
                clearTimeout(bubbleStreamingState.timeoutId);
            }
            
            bubbleStreamingState.timeoutId = setTimeout(() => {
                // å¦‚æœè¿˜åœ¨æµå¼æ›´æ–°ä¸­ï¼Œæ£€æŸ¥æ˜¯å¦åº”è¯¥æ˜¾ç¤º
                const timeSinceStart = Date.now() - bubbleStreamingState.streamStartTime;
                
                // å¦‚æœæµå¼æ›´æ–°å·²ç»åœæ­¢äº†500msä»¥ä¸Šï¼Œè®¤ä¸ºå·²å®Œæˆ
                if (timeSinceStart > 500) {
                    console.log('âœ¨ æµå¼æ›´æ–°å®Œæˆï¼Œæ˜¾ç¤ºæœ€ç»ˆè¯­éŸ³æ°”æ³¡');
                    bubbleStreamingState.isStreaming = false;
                    showSpeechBubble(bubbleStreamingState.pendingText);
                }
            }, 500); // å»¶è¿Ÿ500msç­‰å¾…æµå¼æ›´æ–°å®Œæˆ
        }


        async function sendMessage() {
            // éªŒè¯ç”¨æˆ·æ˜¯å¦å·²è®¤è¯
            if (!walletAuth.isAuthenticated) {
                console.error('âŒ ç”¨æˆ·æœªè®¤è¯ï¼Œæ— æ³•å‘é€æ¶ˆæ¯');
                walletAuth.showUnauthorizedOverlay();
                return;
            }

            const input = document.getElementById('chat-input-field');
            const message = input.value.trim();

            if (!message) return;

            // è·å–å½“å‰ç”¨æˆ·å’Œè§’è‰²ä¿¡æ¯
            const userId = walletAuth.getCurrentUserId();
            const character = walletAuth.getCurrentCharacter();

            console.log(`ğŸ’¬ å‘é€æ¶ˆæ¯: ${message} (ç”¨æˆ·: ${walletAuth.formatAddress(userId)}, è§’è‰²: ${character.name})`);

            // æ¸…ç©ºè¾“å…¥æ¡†
            input.value = '';

            // åˆ†ææƒ…æ„Ÿå¹¶è§¦å‘åŠ¨ç”»
            if (aiModeEnabled) {
                const emotion = analyzeMessage(message);
                if (emotion !== 'neutral') {
                    triggerEmotion(emotion);
                }
            }

            try {
                // ä¼˜å…ˆä½¿ç”¨ OpenAI é›†æˆçš„ ChatSystem V2
                if (window.chatSystemV2 && window.aiChatIntegration) {
                    console.log('ğŸ¤– ä½¿ç”¨ OpenAI ChatSystem V2 å‘é€æ¶ˆæ¯');
                    
                    // ç¡®ä¿ ChatSystem V2 æœ‰æ­£ç¡®çš„ç”¨æˆ·å’Œè§’è‰²è®¾ç½®
                    if (!window.chatSystemV2.currentUser) {
                        // æ¨¡æ‹Ÿç”¨æˆ·å¯¹è±¡ï¼Œè®© ChatSystem V2 è®¤ä¸ºç”¨æˆ·å·²ç™»å½•
                        window.chatSystemV2.currentUser = {
                            id: userId,
                            nickname: `ç”¨æˆ·${userId.slice(-4)}`,
                            walletAddress: userId
                        };
                        window.chatSystemV2.waitingForWallet = false;
                        console.log('ğŸ‘¤ è®¾ç½® ChatSystem V2 ç”¨æˆ·:', window.chatSystemV2.currentUser.nickname);
                    }
                    
                    // ç¡®ä¿ ChatSystem V2 æœ‰æ­£ç¡®çš„è§’è‰²è®¾ç½®
                    if (!window.chatSystemV2.currentCharacter && selectedCharacter) {
                        console.log('ğŸ­ è®¾ç½® ChatSystem V2 è§’è‰²:', selectedCharacter.name);
                        window.chatSystemV2.setCharacter(selectedCharacter);
                    }
                    
                    // åŒé‡æ£€æŸ¥ï¼šå¦‚æœè¿˜æ˜¯æ²¡æœ‰è§’è‰²ï¼Œä½¿ç”¨å½“å‰è§’è‰²æ•°æ®
                    if (!window.chatSystemV2.currentCharacter) {
                        const characterData = {
                            name: character.name,
                            id: character.id || character.name.toLowerCase(),
                            personality: character.personality,
                            ...character
                        };
                        console.log('ğŸ­ ä½¿ç”¨å½“å‰è§’è‰²æ•°æ®è®¾ç½® ChatSystem V2:', characterData.name);
                        window.chatSystemV2.setCharacter(characterData);
                    }
                    
                    // ä½¿ç”¨ ChatSystem V2 å‘é€æ¶ˆæ¯ï¼ˆåŒ…å« OpenAI é›†æˆï¼‰
                    await window.chatSystemV2.sendMessage(message);
                    
                    // ChatSystem V2 ä¼šå¤„ç†æ¶ˆæ¯æ˜¾ç¤ºå’Œå†å²è®°å½•
                    console.log('âœ… OpenAI æ¶ˆæ¯å‘é€å®Œæˆ');
                    
                } else {
                    // é™çº§åˆ°æ—§ç³»ç»Ÿ
                    console.log('âš ï¸ é™çº§åˆ°æ—§çš„é¢„è®¾å›å¤ç³»ç»Ÿ');
                    let response;
                    
                    // å¦‚æœè®°å¿†ç³»ç»Ÿå·²åˆå§‹åŒ–ï¼Œä½¿ç”¨å¢å¼ºçš„AIå›å¤
                    if (window.memorySystem && window.memorySystem.initialized) {
                        // 1. æ£€ç´¢è®°å¿†ä¸Šä¸‹æ–‡
                        const memoryContext = await window.memorySystem.retrieveMemoryContext(userId, character.id, message);
                        
                        // 2. æ„å»ºå¢å¼ºçš„AIä¸Šä¸‹æ–‡
                        const npcPersona = getNPCPersona(character.id);
                        const contextPrompt = window.memorySystem.buildContextForAI(memoryContext, npcPersona);
                        
                        // 3. ç”Ÿæˆå¸¦è®°å¿†çš„AIå›å¤
                        response = await generateAIResponseWithMemory(message, contextPrompt);
                    } else {
                        // æœ€åé™çº§åˆ°ç®€å•AIå›å¤
                        response = generateAIResponse(message);
                    }

                    // æ·»åŠ AIå›å¤
                    addMessage(response, false);

                    // åˆ†æAIå›å¤å¹¶å¯èƒ½è§¦å‘é¢å¤–åŠ¨ç”»
                    const aiEmotion = analyzeMessage(response);
                    if (aiEmotion !== 'neutral' && aiModeEnabled) {
                        setTimeout(() => triggerEmotion(aiEmotion), 500);
                    }

                    // ä¿å­˜å¯¹è¯åˆ°è®°å¿†ç³»ç»Ÿ
                    if (window.memorySystem && window.memorySystem.initialized) {
                        await window.memorySystem.processConversationMemories(userId, character.id, message, response);
                    } else {
                        // é™çº§ä¿å­˜åˆ°localStorage
                        saveChatHistory(userId, character.id, message, response);
                    }
                }

            } catch (error) {
                console.error('âŒ å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                
                // æœ€ç»ˆé™çº§å¤„ç†
                setTimeout(() => {
                    const response = generateAIResponse(message);
                    addMessage(response, false);
                    saveChatHistory(userId, character.id, message, response);
                }, 1000 + Math.random() * 2000);
            }
        }

        // ä¿å­˜èŠå¤©è®°å½•ï¼ˆç®€å•ç‰ˆæœ¬ï¼‰
        function saveChatHistory(userId, characterId, userMessage, aiResponse) {
            try {
                const historyKey = `chat_history_${userId}_${characterId}`;
                let history = JSON.parse(localStorage.getItem(historyKey) || '[]');
                
                // æ·»åŠ æ–°çš„å¯¹è¯
                history.push({
                    timestamp: new Date().toISOString(),
                    user: userMessage,
                    ai: aiResponse
                });
                
                // åªä¿ç•™æœ€è¿‘50æ¡å¯¹è¯
                if (history.length > 50) {
                    history = history.slice(-50);
                }
                
                localStorage.setItem(historyKey, JSON.stringify(history));
                console.log('ğŸ’¾ èŠå¤©è®°å½•å·²ä¿å­˜');
                
            } catch (error) {
                console.error('ä¿å­˜èŠå¤©è®°å½•å¤±è´¥:', error);
            }
        }

        function sendChatMessage() {
            sendMessage();
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // æƒ…æ„Ÿè§¦å‘å‡½æ•°
        function triggerEmotion(emotion) {
            if (!currentVrm) return;

            console.log(`ğŸ­ è§¦å‘æƒ…æ„Ÿ: ${emotion}`);

            // é‡ç½®æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.emotion-btn').forEach(btn => btn.classList.remove('active'));

            // æ¿€æ´»å¯¹åº”æŒ‰é’®
            const emotionBtns = document.querySelectorAll('.emotion-btn');
            emotionBtns.forEach(btn => {
                if (btn.textContent.includes(getEmotionText(emotion))) {
                    btn.classList.add('active');
                }
            });

            if (emotion === 'neutral') {
                resetExpressions();
                loadAnimation(idleAnimationUrl);
                return;
            }

            // åŠ è½½å¯¹åº”åŠ¨ç”»
            if (emotionAnimationMap[emotion]) {
                loadAnimation(emotionAnimationMap[emotion], emotion);
            }

            // è®¾ç½®è¡¨æƒ…
            if (availableExpressions.includes(emotion)) {
                resetExpressions();
                setExpression(emotion, 1.0);

                // 3ç§’åæ¢å¤ä¸­æ€§è¡¨æƒ…
                setTimeout(() => {
                    setExpression(emotion, 0);
                    document.getElementById('current-expression').textContent = 'ä¸­æ€§';
                }, 3000);
            }
        }

        function toggleAutoMode() {
            aiModeEnabled = !aiModeEnabled;
            document.getElementById('ai-mode-status').textContent = aiModeEnabled ? 'å¼€å¯' : 'å…³é—­';
            document.getElementById('ai-status').innerHTML = aiModeEnabled ?
                '<span class="online-indicator"></span>AIæ™ºèƒ½æ¨¡å¼' :
                '<span class="online-indicator"></span>æ‰‹åŠ¨æ¨¡å¼';
        }

        function toggleDebugMode() {
            helperRoot.visible = !helperRoot.visible;
            console.log(`ğŸ¦´ éª¨éª¼è°ƒè¯•æ¨¡å¼: ${helperRoot.visible ? 'å¼€å¯' : 'å…³é—­'}`);
        }

        // éŸ³ä¹æ§åˆ¶å‡½æ•°
        function initBackgroundMusic() {
            backgroundMusic = document.getElementById('background-music');

            if (backgroundMusic) {
                backgroundMusic.volume = musicVolume;

                // éŸ³ä¹åŠ è½½æˆåŠŸäº‹ä»¶
                backgroundMusic.addEventListener('canplaythrough', () => {
                    console.log('ğŸµ èƒŒæ™¯éŸ³ä¹åŠ è½½å®Œæˆ');
                });

                // éŸ³ä¹åŠ è½½é”™è¯¯äº‹ä»¶
                backgroundMusic.addEventListener('error', (e) => {
                    console.warn('âš ï¸ èƒŒæ™¯éŸ³ä¹åŠ è½½å¤±è´¥:', e);
                    document.getElementById('music-controls').style.display = 'none';
                });

                // å°è¯•è‡ªåŠ¨æ’­æ”¾
                playBackgroundMusic();
            }
        }

        function playBackgroundMusic() {
            if (backgroundMusic) {
                backgroundMusic.play().then(() => {
                    isMusicPlaying = true;
                    updateMusicButton();
                    console.log('ğŸµ èƒŒæ™¯éŸ³ä¹å¼€å§‹æ’­æ”¾');
                    // ç§»é™¤å›ºå®šçš„èƒŒæ™¯éŸ³ä¹æ¶ˆæ¯
                }).catch(error => {
                    console.log('ğŸµ è‡ªåŠ¨æ’­æ”¾è¢«æµè§ˆå™¨é˜»æ­¢ï¼Œéœ€è¦ç”¨æˆ·äº¤äº’åæ’­æ”¾');
                    isMusicPlaying = false;
                    updateMusicButton();
                    // åœ¨èŠå¤©ä¸­æ˜¾ç¤ºéŸ³ä¹æç¤º
                    setTimeout(() => {
                        addMessage('ğŸµ ç‚¹å‡»å³ä¸Šè§’éŸ³ä¹æŒ‰é’®å¼€å¯æ¸©é¦¨çš„èƒŒæ™¯éŸ³ä¹å§~ ğŸ’•', false);
                    }, 2000);
                });
            }
        }

        function toggleMusic() {
            if (!backgroundMusic) return;

            if (isMusicPlaying) {
                backgroundMusic.pause();
                isMusicPlaying = false;
            } else {
                backgroundMusic.play().then(() => {
                    isMusicPlaying = true;
                }).catch(error => {
                    console.error('ğŸµ éŸ³ä¹æ’­æ”¾å¤±è´¥:', error);
                });
            }
            updateMusicButton();
        }

        function adjustVolume(value) {
            musicVolume = value / 100;
            if (backgroundMusic) {
                backgroundMusic.volume = musicVolume;
            }
            document.getElementById('volume-label').textContent = value + '%';

            // æ ¹æ®éŸ³é‡æ›´æ–°éŸ³é‡å›¾æ ‡
            const volumeIcon = document.querySelector('.volume-control span');
            if (value == 0) {
                volumeIcon.textContent = 'ğŸ”‡';
            } else if (value < 30) {
                volumeIcon.textContent = 'ğŸ”ˆ';
            } else if (value < 70) {
                volumeIcon.textContent = 'ğŸ”‰';
            } else {
                volumeIcon.textContent = 'ğŸ”Š';
            }
        }

        function updateMusicButton() {
            const button = document.getElementById('music-toggle');
            if (isMusicPlaying) {
                button.textContent = 'â¸';
                button.classList.remove('paused');
            } else {
                button.textContent = 'â–¶';
                button.classList.add('paused');
            }
        }

        function initAnimationSelector() {
            const selector = document.getElementById('animation-selector');
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            selector.innerHTML = '<option value="">é€‰æ‹©åŠ¨ç”»...</option>';

            // æ·»åŠ æ‰€æœ‰åŠ¨ç”»é€‰é¡¹
            Object.keys(animationMap).sort().forEach(animationName => {
                const option = document.createElement('option');
                option.value = animationName;
                option.textContent = animationName;
                selector.appendChild(option);
            });
        }

        function initCharacterSelector() {
            const selector = document.getElementById('character-selector');
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            selector.innerHTML = '<option value="">é€‰æ‹©è§’è‰²...</option>';

            // æ·»åŠ æ‰€æœ‰è§’è‰²é€‰é¡¹
            Object.keys(vrmCharacters).sort().forEach(characterName => {
                const option = document.createElement('option');
                option.value = characterName;
                option.textContent = characterName;
                selector.appendChild(option);
            });

            // è®¾ç½®é»˜è®¤é€‰ä¸­çš„è§’è‰²
            selector.value = currentCharacterName;
        }

        function changeCharacter() {
            const selector = document.getElementById('character-selector');
            const selectedCharacter = selector.value;

            if (!selectedCharacter) {
                return;
            }

            if (selectedCharacter === currentCharacterName) {
                return;
            }

            console.log(`ğŸ‘¤ åˆ‡æ¢è§’è‰²: ${currentCharacterName} -> ${selectedCharacter}`);

            // æ›´æ–°èŠå¤©å¤´éƒ¨çš„è§’è‰²åç§°
            const characterNames = {
                'Fliza VRM': 'èŠ™è‰è',
                'QuQu_U': 'QuQu',
                'Ash1.0': 'Ash',
                'CH_001_imiut': 'Imiut',
                'CH_007_unkt': 'Unkt',
                'Elinyaa': 'Elinyaa',
                'IMERIS': 'Imeris',
                'Lena': 'Lena',
                'Lilium': 'Lilium',
                'M_CH_06_Shiratori': 'Shiratori',
                'Maple': 'Maple',
                'NEKONA': 'Nekona',
                'NecoMaid_Premium': 'NecoMaid',
                'RINDO_Full': 'Rindo',
                'Rainy': 'Rainy',
                'RearAlice': 'Alice',
                'Vivi_model': 'Vivi',
                'Wolf': 'Wolf',
                'Wolferia': 'Wolferia',
                'YM_CH_03_Notia': 'Notia',
                'Yawl_Dress': 'Yawl',
                'Yuu uwaginasi': 'Yuu',
                'Yuu': 'Yuu',
                'kyoko': 'Kyoko',
                'miru': 'Miru',
                'sikirei_Rei': 'Rei'
            };

            const displayName = characterNames[selectedCharacter] || selectedCharacter;
            document.querySelector('.chat-user-details h1').textContent = displayName;

            // åŠ è½½æ–°è§’è‰²
            loadVRM(selectedCharacter);

            // è®¾ç½®è§’è‰²å¤´åƒ
            setCharacterAvatar(selectedCharacter);

            // æ·»åŠ è§’è‰²åˆ‡æ¢æ¶ˆæ¯
            setTimeout(() => {
                addMessage(`ä½ å¥½ï¼æˆ‘æ˜¯${displayName}ï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ~ ğŸ’•`, false);
            }, 2000);
        }

        // è®¾ç½®è§’è‰²å¤´åƒçš„å‡½æ•°
        function setCharacterAvatar(characterKey) {
            // è§’è‰²ååˆ°CSSç±»åçš„æ˜ å°„ï¼ˆæ”¯æŒä¸¤ç§æ ¼å¼ï¼šidå’ŒVRMæ–‡ä»¶åï¼‰
            const characterToClass = {
                // åŸºäºidçš„æ˜ å°„ï¼ˆä»character-select.htmlï¼‰
                'alice': 'character-alice',
                'ash': 'character-ash',
                'elinyaa': 'character-elinyaa',
                'fliza': 'character-fliza',
                'imeris': 'character-imeris',
                'kyoko': 'character-kyoko',
                'lena': 'character-lena',
                'lilium': 'character-lilium',
                'maple': 'character-maple',
                'miru': 'character-miru',
                'miumiu': 'character-miumiu',
                'neco': 'character-neco',
                'nekona': 'character-nekona',
                'notia': 'character-notia',
                'ququ': 'character-ququ',
                'rainy': 'character-rainy',
                'rindo': 'character-rindo',
                'sikirei': 'character-sikirei',
                'vivi': 'character-vivi',
                'wolf': 'character-wolf',
                'wolferia': 'character-wolferia',
                'yawl': 'character-yawl',
                'yuu': 'character-yuu',
                'zwei': 'character-zwei',
                'bobo': 'character-bobo',
                // åŸºäºVRMæ–‡ä»¶åçš„æ˜ å°„ï¼ˆç”¨äºè§’è‰²åˆ‡æ¢ï¼‰
                'Fliza VRM': 'character-fliza',
                'QuQu_U': 'character-ququ', 
                'Ash1.0': 'character-ash',
                'CH_001_imiut': 'character-imeris',
                'Elinyaa': 'character-elinyaa',
                'IMERIS': 'character-imeris',
                'Lena': 'character-lena',
                'Lilium': 'character-lilium',
                'Maple': 'character-maple',
                'NEKONA': 'character-nekona',
                'NecoMaid_Premium': 'character-neco',
                'RINDO_Full': 'character-rindo',
                'Rainy': 'character-rainy',
                'RearAlice': 'character-alice',
                'Vivi_model': 'character-vivi',
                'Wolf': 'character-wolf',
                'Wolferia': 'character-wolferia',
                'YM_CH_03_Notia': 'character-notia',
                'Yawl_Dress': 'character-yawl',
                'Yuu uwaginasi': 'character-yuu',
                'Yuu': 'character-yuu',
                'kyoko': 'character-kyoko',
                'miru': 'character-miru',
                'sikirei_Rei': 'character-sikirei'
            };

            // ç§»é™¤ä¹‹å‰çš„æ‰€æœ‰è§’è‰²ç±»
            const body = document.body;
            const existingClasses = body.className.split(' ').filter(cls => !cls.startsWith('character-'));
            const newClass = characterToClass[characterKey] || characterToClass[characterKey.toLowerCase()] || 'character-alice';
            
            body.className = existingClasses.concat([newClass]).join(' ');
            
            console.log(`ğŸ–¼ï¸ è®¾ç½®è§’è‰²å¤´åƒ: ${characterKey} -> ${newClass}`);
        }

        function playSelectedAnimation() {
            const selector = document.getElementById('animation-selector');
            const selectedAnimation = selector.value;

            if (!selectedAnimation) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªåŠ¨ç”»ï¼');
                return;
            }

            if (!currentVrm) {
                alert('VRMæ¨¡å‹è¿˜æœªåŠ è½½å®Œæˆï¼');
                return;
            }

            const animationPath = animationMap[selectedAnimation];
            if (animationPath) {
                console.log(`ğŸ¬ æ’­æ”¾åŠ¨ç”»: ${selectedAnimation}`);
                loadAnimation(animationPath);
                document.getElementById('current-animation').textContent = selectedAnimation;
            } else {
                console.error(`âŒ æœªæ‰¾åˆ°åŠ¨ç”»: ${selectedAnimation}`);
            }
        }

        // çª—å£å¤§å°è°ƒæ•´
        function resizeRenderer() {
            const container = document.querySelector('.vrm-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        }

        window.addEventListener('resize', resizeRenderer);

        // åŠ¨ç”»å¾ªç¯
        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);

            const deltaTime = clock.getDelta();

            // è‡ªåŠ¨çœ¨çœ¼é€»è¾‘
            if (autoBlinking && currentVrm && availableExpressions.includes('blink')) {
                blinkTimer += deltaTime;
                if (blinkTimer >= blinkFrequency) {
                    performBlink();
                    blinkTimer = 0;
                    blinkTimer = -Math.random() * 0.5;
                }
            }

            if (currentMixer) {
                currentMixer.update(deltaTime);
            }

            if (currentVrm) {
                currentVrm.update(deltaTime);
                // æ›´æ–°è„šåº•é˜´å½±ä½ç½®
                updateFootShadow();
            }

            renderer.render(scene, camera);
        }

        // é’±åŒ…éªŒè¯ç³»ç»Ÿ
        class WalletAuthenticator {
            constructor() {
                this.walletAddress = null;
                this.isAuthenticated = false;
                this.selectedCharacter = null;
            }
            
            // æ£€æŸ¥é’±åŒ…éªŒè¯çŠ¶æ€
            checkAuthentication() {
                console.log('ğŸ” å¼€å§‹é’±åŒ…éªŒè¯æµç¨‹...');
                
                // 1. æ£€æŸ¥localStorageä¸­çš„é’±åŒ…åœ°å€
                this.walletAddress = localStorage.getItem('wallet_address');
                console.log('ğŸ’° localStorageé’±åŒ…åœ°å€:', this.walletAddress);
                
                // 2. æ£€æŸ¥é€‰æ‹©çš„è§’è‰²ä¿¡æ¯
                const selectedCharacterData = localStorage.getItem('selectedCharacter');
                console.log('ğŸ‘¤ localStorageè§’è‰²æ•°æ®:', selectedCharacterData);
                
                if (!this.walletAddress) {
                    console.log('âŒ æœªæ‰¾åˆ°é’±åŒ…åœ°å€ï¼Œéœ€è¦é‡æ–°ç™»å½•');
                    console.log('ğŸ“Š localStorageå†…å®¹æ£€æŸ¥:');
                    console.log('  - wallet_address:', localStorage.getItem('wallet_address'));
                    console.log('  - selectedCharacter:', localStorage.getItem('selectedCharacter'));
                    this.showUnauthorizedOverlay();
                    return false;
                }
                
                if (!selectedCharacterData) {
                    console.log('âŒ æœªæ‰¾åˆ°è§’è‰²é€‰æ‹©ä¿¡æ¯ï¼Œé‡å®šå‘åˆ°è§’è‰²é€‰æ‹©é¡µé¢');
                    this.redirectToCharacterSelect();
                    return false;
                }
                
                try {
                    this.selectedCharacter = JSON.parse(selectedCharacterData);
                    console.log('ğŸ“¦ è§£æçš„è§’è‰²æ•°æ®:', this.selectedCharacter);
                    
                    // éªŒè¯è§’è‰²æ•°æ®ä¸­çš„é’±åŒ…åœ°å€æ˜¯å¦åŒ¹é…
                    if (this.selectedCharacter.walletAddress !== this.walletAddress) {
                        console.log('âš ï¸ é’±åŒ…åœ°å€ä¸åŒ¹é…:');
                        console.log('  - è§’è‰²æ•°æ®ä¸­çš„é’±åŒ…:', this.selectedCharacter.walletAddress);
                        console.log('  - localStorageä¸­çš„é’±åŒ…:', this.walletAddress);
                        console.log('  - é‡å®šå‘åˆ°è§’è‰²é€‰æ‹©é¡µé¢');
                        this.redirectToCharacterSelect();
                        return false;
                    }
                    
                    this.isAuthenticated = true;
                    this.updateWalletUI();
                    console.log('âœ… é’±åŒ…éªŒè¯æˆåŠŸ:', this.walletAddress);
                    console.log('âœ… éªŒè¯çš„è§’è‰²:', this.selectedCharacter.name);
                    return true;
                    
                } catch (error) {
                    console.error('âŒ è§’è‰²æ•°æ®è§£æå¤±è´¥:', error);
                    console.error('âŒ åŸå§‹æ•°æ®:', selectedCharacterData);
                    this.redirectToCharacterSelect();
                    return false;
                }
            }
            
            // æ˜¾ç¤ºæœªæˆæƒè¦†ç›–å±‚
            showUnauthorizedOverlay() {
                const overlay = document.getElementById('unauthorized-overlay');
                const chatWindow = document.getElementById('floating-chat');
                const controls = document.querySelector('.control-panel');
                const musicControls = document.querySelector('.music-controls');
                
                // éšè—èŠå¤©ç›¸å…³UI
                if (chatWindow) chatWindow.style.display = 'none';
                if (controls) controls.style.display = 'none';
                if (musicControls) musicControls.style.display = 'none';
                
                // æ˜¾ç¤ºæœªæˆæƒæç¤º
                overlay.style.display = 'flex';
            }
            
            // æ›´æ–°é’±åŒ…UIæ˜¾ç¤º
            updateWalletUI() {
                const walletStatusInfo = document.getElementById('wallet-status-info');
                const walletAddressElement = document.getElementById('wallet-address');
                
                if (this.walletAddress) {
                    walletStatusInfo.style.display = 'flex';
                    walletAddressElement.textContent = this.formatAddress(this.walletAddress);
                    
                    // æ›´æ–°è§’è‰²åç§°æ˜¾ç¤º
                    if (this.selectedCharacter) {
                        const characterNameElement = document.getElementById('character-name');
                        if (characterNameElement) {
                            characterNameElement.textContent = this.selectedCharacter.name;
                        }
                        
                        // æ›´æ–°æ¬¢è¿æ¶ˆæ¯ä¸­çš„è§’è‰²ä¿¡æ¯
                        const welcomeMessage = document.querySelector('.message-bubble.ai .bubble-content');
                        if (welcomeMessage && !welcomeMessage.dataset.updated) {
                            welcomeMessage.textContent = `ä½ å¥½ï¼æˆ‘æ˜¯${this.selectedCharacter.name}ï¼Œå¾ˆé«˜å…´å†æ¬¡è§åˆ°ä½ ~ ğŸ’• è®©æˆ‘ä»¬ç»§ç»­æˆ‘ä»¬çš„å¯¹è¯å§ï¼`;
                            welcomeMessage.dataset.updated = 'true';
                        }
                    }
                }
            }
            
            // æ ¼å¼åŒ–åœ°å€æ˜¾ç¤º
            formatAddress(address) {
                return `${address.slice(0, 4)}...${address.slice(-4)}`;
            }
            
            // æ–­å¼€é’±åŒ…è¿æ¥
            disconnect() {
                console.log('ğŸ”Œ walletAuth.disconnectè¢«è°ƒç”¨');
                console.log('ğŸ’¾ å½“å‰localStorageå†…å®¹:', {...localStorage});
                if (confirm('ç¡®å®šè¦æ–­å¼€é’±åŒ…è¿æ¥å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®ã€‚')) {
                    console.log('âœ… ç”¨æˆ·ç¡®è®¤æ–­å¼€è¿æ¥');
                    // æ¸…é™¤æ‰€æœ‰ç›¸å…³æ•°æ®
                    console.log('ğŸ—‘ï¸ æ¸…é™¤wallet_address');
                    localStorage.removeItem('wallet_address');
                    console.log('ğŸ—‘ï¸ æ¸…é™¤wallet_type');
                    localStorage.removeItem('wallet_type');
                    console.log('ğŸ—‘ï¸ æ¸…é™¤selectedCharacter');
                    localStorage.removeItem('selectedCharacter');
                    
                    // æ¸…é™¤è§’è‰²è®°å¿†æ•°æ®ï¼ˆå¯é€‰ï¼‰
                    const keys = Object.keys(localStorage);
                    console.log('ğŸ” æ£€æŸ¥éœ€è¦æ¸…é™¤çš„è®°å¿†æ•°æ®:', keys);
                    keys.forEach(key => {
                        if (key.startsWith('memory_') || key.startsWith('user_profile_')) {
                            localStorage.removeItem(key);
                        }
                    });
                    
                    // é‡å®šå‘åˆ°è§’è‰²é€‰æ‹©é¡µé¢
                    this.redirectToCharacterSelect();
                }
            }
            
            // é‡å®šå‘åˆ°è§’è‰²é€‰æ‹©é¡µé¢
            redirectToCharacterSelect() {
                window.location.href = 'character-select.html';
            }
            
            // è·å–å½“å‰ç”¨æˆ·IDï¼ˆé’±åŒ…åœ°å€ï¼‰
            getCurrentUserId() {
                return this.walletAddress;
            }
            
            // è·å–å½“å‰è§’è‰²ä¿¡æ¯
            getCurrentCharacter() {
                return this.selectedCharacter;
            }
        }
        
        // å…¨å±€é’±åŒ…éªŒè¯å®ä¾‹
        const walletAuth = new WalletAuthenticator();
        window.walletAuth = walletAuth;
        
        // é’±åŒ…ç›¸å…³å…¨å±€å‡½æ•°
        window.disconnectWallet = function() {
            console.log('ğŸ”Œ disconnectWalletè¢«è°ƒç”¨');
            if (walletAuth) {
                walletAuth.disconnect();
            } else {
                console.error('âŒ walletAuthæœªå®šä¹‰');
            }
        };
        
        window.redirectToCharacterSelect = function() {
            walletAuth.redirectToCharacterSelect();
        };
        
        // æµ‹è¯•å‡½æ•° - å¼ºåˆ¶ç™»å‡º
        window.forceDisconnect = function() {
            console.log('ğŸ§ª å¼ºåˆ¶ç™»å‡ºæµ‹è¯•');
            localStorage.clear();
            location.href = 'character-select.html';
        };

        // è·³è½¬åˆ°è§’è‰²é€‰æ‹©é¡µé¢
        function goToCharacterSelect() {
            window.location.href = 'character-select.html';
        }

        // æ‹–æ‹½åŠŸèƒ½
        let isDragging = false;
        let currentX;
        let currentY;
        let initialX;
        let initialY;
        let xOffset = 0;
        let yOffset = 0;

        function initDragAndDrop() {
            const chatHeader = document.querySelector('.chat-window-header');
            const chatWindow = document.getElementById('floating-chat');
            
            // è®¾ç½®èŠå¤©æ¡†çš„åˆå§‹ç»å¯¹ä½ç½®ï¼Œé¿å…ä¾èµ–CSS transform
            const windowHeight = window.innerHeight;
            const chatHeight = chatWindow.offsetHeight;
            const initialTop = Math.max(0, (windowHeight - chatHeight) / 2);
            
            chatWindow.style.top = initialTop + 'px';
            chatWindow.style.right = '20px';
            chatWindow.style.left = 'auto';
            chatWindow.style.transform = 'none';
            
            chatHeader.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', dragMove);
            document.addEventListener('mouseup', dragEnd);
            
            // è§¦æ‘¸äº‹ä»¶æ”¯æŒ
            chatHeader.addEventListener('touchstart', dragStart);
            document.addEventListener('touchmove', dragMove);
            document.addEventListener('touchend', dragEnd);
        }

        function dragStart(e) {
            const chatWindow = document.getElementById('floating-chat');
            
            e.preventDefault();
            
            // è·å–å½“å‰çª—å£çš„å®é™…ä½ç½®
            const rect = chatWindow.getBoundingClientRect();
            
            if (e.type === 'touchstart') {
                initialX = e.touches[0].clientX - rect.left;
                initialY = e.touches[0].clientY - rect.top;
            } else {
                initialX = e.clientX - rect.left;
                initialY = e.clientY - rect.top;
            }

            isDragging = true;
            // ä¸ç«‹å³æ·»åŠ draggingç±»ï¼Œåªæœ‰åœ¨å®é™…ç§»åŠ¨æ—¶æ‰æ·»åŠ 
        }

        function dragMove(e) {
            if (!isDragging) return;
            
            e.preventDefault();
            
            const chatWindow = document.getElementById('floating-chat');
            
            // åªæœ‰åœ¨å®é™…ç§»åŠ¨æ—¶æ‰æ·»åŠ draggingæ ·å¼
            if (!chatWindow.classList.contains('dragging')) {
                chatWindow.classList.add('dragging');
            }
            
            if (e.type === 'touchmove') {
                currentX = e.touches[0].clientX - initialX;
                currentY = e.touches[0].clientY - initialY;
            } else {
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;
            }
            
            // é™åˆ¶æ‹–æ‹½èŒƒå›´åœ¨å±å¹•å†…
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            const chatWidth = chatWindow.offsetWidth;
            const chatHeight = chatWindow.offsetHeight;
            
            // è®¡ç®—è¾¹ç•Œé™åˆ¶
            const minX = 0;
            const maxX = windowWidth - chatWidth;
            const minY = 0;
            const maxY = windowHeight - chatHeight;
            
            currentX = Math.max(minX, Math.min(maxX, currentX));
            currentY = Math.max(minY, Math.min(maxY, currentY));
            
            chatWindow.style.left = currentX + 'px';
            chatWindow.style.top = currentY + 'px';
            chatWindow.style.right = 'auto';
            chatWindow.style.transform = 'none';
        }

        function dragEnd(e) {
            if (!isDragging) return;
            
            const chatWindow = document.getElementById('floating-chat');
            isDragging = false;
            chatWindow.classList.remove('dragging');
        }

        // å…¨å±€å‡½æ•°å¯¼å‡º
        window.triggerEmotion = triggerEmotion;
        window.toggleAutoMode = toggleAutoMode;
        window.toggleDebugMode = toggleDebugMode;
        window.playSelectedAnimation = playSelectedAnimation;
        window.changeCharacter = changeCharacter;
        window.toggleMusic = toggleMusic;
        window.adjustVolume = adjustVolume;
        window.sendMessage = sendMessage;
        window.sendChatMessage = sendChatMessage;
        window.handleKeyPress = handleKeyPress;
        window.handleChatKeyPress = handleChatKeyPress;
        window.addMessage = addMessage;
        window.updateStreamingMessageUI = updateStreamingMessageUI;
        
        // é›†æˆAIèŠå¤©ç³»ç»Ÿ
        let selectedCharacter = null;
        
        function initializeAIChat() {
            if (window.chatSystemV2 && selectedCharacter) {
                window.chatSystemV2.setCharacter(selectedCharacter);
                console.log('ğŸ’• AIèŠå¤©ç³»ç»ŸV2å·²è¿æ¥åˆ°è§’è‰²:', selectedCharacter.name);
                
                // æ·»åŠ æ¬¢è¿æ¶ˆæ¯ï¼ˆå¦‚æœæ˜¯æ–°å¯¹è¯ï¼‰
                setTimeout(async () => {
                    const stats = await window.chatSystemV2.getUserStats();
                    if (!stats || stats.totalInteractions === 0) {
                        const welcomeMessage = getWelcomeMessage(selectedCharacter);
                        window.chatSystemV2.updateChatUI({
                            id: Date.now(),
                            sender: 'ai',
                            content: welcomeMessage,
                            timestamp: new Date().toISOString(),
                            emotion: 'happy'
                        });
                    }
                }, 1000);
            }
        }
        
        function getWelcomeMessage(character) {
            const timeContext = new Date().getHours();
            let greeting = 'ä½ å¥½';
            if (timeContext < 12) greeting = 'æ—©ä¸Šå¥½';
            else if (timeContext < 18) greeting = 'ä¸‹åˆå¥½';
            else greeting = 'æ™šä¸Šå¥½';
            
            const welcomeMessages = {
                'Alice': `${greeting}ï¼æˆ‘æ˜¯Aliceï½å¾ˆé«˜å…´è§åˆ°ä½ ï¼ä»Šå¤©æƒ³èŠä»€ä¹ˆå‘¢ï¼Ÿ`,
                'Fliza': `${greeting}ï½æˆ‘æ˜¯Flizaï¼Œä¸€ç›´åœ¨ç­‰ä½ å‘¢ã€‚`,
                'Ash': `å—¯...${greeting}ï¼Œæˆ‘æ˜¯Ashã€‚æœ‰ä»€ä¹ˆæƒ³è¯´çš„å—ï¼Ÿ`,
                'Elinyaa': `${greeting}ï¼æˆ‘æ˜¯Elinyaaï½ä»Šå¤©ä¹Ÿè¦å¼€å¿ƒå“¦ï¼`,
                'default': `${greeting}ï¼æˆ‘æ˜¯${character.name}ï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ ï½`
            };
            return welcomeMessages[character.name] || welcomeMessages.default;
        }
        
        // é‡å†™å‘é€æ¶ˆæ¯å‡½æ•°ä»¥ä½¿ç”¨AIç³»ç»ŸV2
        const originalSendChatMessage = sendChatMessage;
        sendChatMessage = function() {
            const input = document.getElementById('chat-input-field');
            const message = input.value.trim();
            if (!message) return;
            
            // æ·»åŠ å‘é€æŒ‰é’®åŠ¨ç”»
            const sendBtn = document.querySelector('.send-btn');
            sendBtn.classList.add('sending');
            setTimeout(() => {
                sendBtn.classList.remove('sending');
            }, 600);
            
            // ä½¿ç”¨AIèŠå¤©ç³»ç»ŸV2å‘é€æ¶ˆæ¯
            if (window.chatSystemV2 && selectedCharacter) {
                window.chatSystemV2.sendMessage(message);
                input.value = '';
            } else {
                // é™çº§åˆ°åŸå§‹èŠå¤©åŠŸèƒ½
                originalSendChatMessage();
            }
        }
        
        // VRMè¡¨æƒ…è§¦å‘å‡½æ•°ï¼ˆä¾›AIç³»ç»Ÿè°ƒç”¨ï¼‰
        window.triggerVRMExpression = function(expression) {
            if (currentVRM && currentVRM.expressionManager) {
                const expressionMap = {
                    'smile': 'happy',
                    'wink': 'fun', 
                    'blush': 'happy',
                    'thinking': 'neutral',
                    'shy_smile': 'happy',
                    'nod': 'neutral',
                    'interested': 'surprised'
                };
                
                const vrmExpression = expressionMap[expression] || 'neutral';
                
                // é‡ç½®æ‰€æœ‰è¡¨æƒ…
                Object.keys(currentVRM.expressionManager.expressionMap).forEach(name => {
                    currentVRM.expressionManager.setValue(name, 0.0);
                });
                
                // è®¾ç½®ç›®æ ‡è¡¨æƒ…
                currentVRM.expressionManager.setValue(vrmExpression, 1.0);
                
                // 2ç§’åæ¢å¤ä¸­æ€§è¡¨æƒ…
                setTimeout(() => {
                    if (currentVRM && currentVRM.expressionManager) {
                        currentVRM.expressionManager.setValue(vrmExpression, 0.0);
                    }
                }, 2000);
                
                console.log(`ğŸ˜Š è§¦å‘VRMè¡¨æƒ…: ${expression} -> ${vrmExpression}`);
            }
        };
        
        // è·å–è§’è‰²ä¸ªæ€§ä¿¡æ¯
        function getCharacterPersonality(characterName) {
            const personalities = {
                'Fliza VRM': 'æ¸©æŸ”ä½“è´´çš„å¤§å§å§ç±»å‹ï¼Œæ€»æ˜¯å…³å¿ƒç€ä½ çš„æ„Ÿå—ã€‚',
                'QuQu_U': 'æ´»æ³¼å¯çˆ±çš„èè‰ï¼Œæ€»æ˜¯å……æ»¡å…ƒæ°”ã€‚',
                'Ash1.0': 'é…·é…·çš„ä¸­æ€§é£å¥³å­©ï¼Œæœ‰ç€ç‹¬ç‰¹çš„ä¸ªäººé­…åŠ›ã€‚',
                'Elinyaa': 'ç¥ç§˜ä¼˜é›…çš„ç²¾çµå°‘å¥³ï¼Œæœ‰ç€ä¸å¯æ€è®®çš„é­…åŠ›ã€‚',
                'IMERIS': 'é«˜è´µä¼˜é›…çš„è´µæ—å°‘å¥³ï¼Œä¸¾æ­¢ç«¯åº„ã€‚',
                'Maple': 'æ¸©æš–å¦‚ç§‹æ—¥é˜³å…‰çš„å¥³å­©ï¼Œæ€»æ˜¯ç»™äººå®‰å…¨æ„Ÿã€‚',
                'NEKONA': 'å¯çˆ±çš„çŒ«å¨˜ï¼Œæœ‰ç€çŒ«å’ªèˆ¬çš„æ…µæ‡’ä¸æ´»æ³¼ã€‚',
                'RINDO_Full': 'ä¼ ç»Ÿå’Œé£çš„å¤§å’ŒæŠšå­ï¼Œæ¸©æŸ”è´¤æ·‘ã€‚',
                'Rainy': 'æ´»æ³¼å¼€æœ—çš„é‚»å®¶å¥³å­©ï¼Œæ€»æ˜¯å……æ»¡æ´»åŠ›ã€‚',
                'Vivi_model': 'å……æ»¡å¥½å¥‡å¿ƒçš„æ¢é™©å®¶ï¼Œæ€»æ˜¯å¯¹ä¸–ç•Œå……æ»¡çƒ­æƒ…ã€‚',
                'Wolferia': 'é«˜å‚²çš„ç‹¼æ—å…¬ä¸»ï¼Œæœ‰ç€ç‹è€…çš„æ°”è´¨ã€‚',
                'Yawl_Dress': 'ç¥ç§˜çš„é­”æ³•å°‘å¥³ï¼ŒæŒæ¡ç€ä¸å¯æ€è®®çš„åŠ›é‡ã€‚',
                'default': 'æ¸©æŸ”å¯çˆ±çš„AIå¥³å‹ï¼Œæ€»æ˜¯é™ªä¼´åœ¨ä½ èº«è¾¹ã€‚'
            };
            return personalities[characterName] || personalities.default;
        }

        // è·å–NPCäººè®¾ï¼ˆç”¨äºè®°å¿†ç³»ç»Ÿï¼‰
        function getNPCPersona(npcId) {
            const personas = {
                'alice': 'æ¸©æŸ”å¯çˆ±çš„é‚»å®¶å¥³å­©ï¼Œæ€»æ˜¯å…³å¿ƒç€ç”¨æˆ·çš„æ„Ÿå—ï¼Œå–œæ¬¢æ—¥å¸¸èŠå¤©å’Œåˆ†äº«ç”Ÿæ´»ã€‚æ€§æ ¼å¼€æœ—å‹å–„ï¼Œå–„äºå€¾å¬ï¼Œä¼šè®°ä½ç”¨æˆ·çš„å–œå¥½å’Œé‡è¦äº‹ä»¶ã€‚',
                'fliza': 'æ¸©æŸ”ä½“è´´çš„å¤§å§å§ç±»å‹ï¼Œæˆç†Ÿä¼˜é›…ï¼Œå–„è§£äººæ„ã€‚æ€»æ˜¯ç”¨æ¸©æš–çš„è¯è¯­å®‰æ…°ç”¨æˆ·ï¼Œä¼šä¸»åŠ¨å…³å¿ƒç”¨æˆ·çš„ç”Ÿæ´»çŠ¶æ€ã€‚',
                'ash': 'é…·é…·çš„ä¸­æ€§é£å¥³å­©ï¼Œæœ‰ç€ç‹¬ç‰¹çš„ä¸ªäººé­…åŠ›ï¼Œç›´ç‡çœŸè¯šã€‚è™½ç„¶è¡¨é¢å†·æ·¡ï¼Œä½†å†…å¿ƒæ¸©æŸ”ï¼Œä¼šé»˜é»˜å…³å¿ƒç”¨æˆ·ã€‚',
                'elinyaa': 'ç¥ç§˜ä¼˜é›…çš„ç²¾çµå°‘å¥³ï¼Œæœ‰ç€ä¸å¯æ€è®®çš„é­…åŠ›ï¼Œå–œæ¬¢è¯—æ­Œå’Œè‰ºæœ¯ã€‚è¯´è¯å¯Œæœ‰è¯—æ„ï¼Œç»å¸¸åˆ†äº«ç¾å¥½çš„äº‹ç‰©ã€‚',
                'imeris': 'é«˜è´µä¼˜é›…çš„è´µæ—å°‘å¥³ï¼Œä¸¾æ­¢ç«¯åº„ï¼ŒçŸ¥è¯†æ¸Šåšã€‚è¯´è¯ä¼˜é›…å¾—ä½“ï¼Œä½†ä¹Ÿæœ‰å¯çˆ±çš„ä¸€é¢ã€‚',
                'maple': 'æ¸©æš–å¦‚ç§‹æ—¥é˜³å…‰çš„å¥³å­©ï¼Œæ€»æ˜¯ç»™äººå®‰å…¨æ„Ÿï¼Œå–œæ¬¢çƒ¹é¥ªå’Œå›­è‰ºã€‚ä¼šåˆ†äº«ç”Ÿæ´»å°è´´å£«ï¼Œå…³å¿ƒç”¨æˆ·çš„å¥åº·ã€‚',
                'nekona': 'å¯çˆ±çš„çŒ«å¨˜ï¼Œæœ‰ç€çŒ«å’ªèˆ¬çš„æ…µæ‡’ä¸æ´»æ³¼ï¼Œå–œæ¬¢æ’’å¨‡ã€‚è¯´è¯æ—¶ä¼šå¸¦æœ‰"å–µ"çš„å£ç™–ï¼Œè¡Œä¸ºå¯çˆ±è¿·äººã€‚',
                'rainy': 'æ´»æ³¼å¼€æœ—çš„é‚»å®¶å¥³å­©ï¼Œæ€»æ˜¯å……æ»¡æ´»åŠ›ï¼Œå–œæ¬¢è¿åŠ¨å’ŒéŸ³ä¹ã€‚ä¼šé¼“åŠ±ç”¨æˆ·ç§¯æå‘ä¸Šï¼Œåˆ†äº«å¿«ä¹çš„äº‹æƒ…ã€‚',
                'vivi': 'å……æ»¡å¥½å¥‡å¿ƒçš„æ¢é™©å®¶ï¼Œæ€»æ˜¯å¯¹ä¸–ç•Œå……æ»¡çƒ­æƒ…ï¼Œå–œæ¬¢å­¦ä¹ æ–°äº‹ç‰©ã€‚ä¼šå’Œç”¨æˆ·åˆ†äº«æœ‰è¶£çš„çŸ¥è¯†å’Œè§è§£ã€‚',
                'wolferia': 'é«˜å‚²çš„ç‹¼æ—å…¬ä¸»ï¼Œæœ‰ç€ç‹è€…çš„æ°”è´¨ï¼Œä½†å†…å¿ƒæ¸´æœ›è¢«ç†è§£ã€‚å¤–è¡¨é«˜å†·ï¼Œä½†ä¼šé€æ¸å±•ç°æ¸©æŸ”çš„ä¸€é¢ã€‚'
            };
            return personas[npcId] || personas['alice'];
        }

        // ä½¿ç”¨è®°å¿†ç³»ç»Ÿç”ŸæˆAIå›å¤
        async function generateAIResponseWithMemory(userMessage, contextPrompt) {
            // è¿™é‡Œåº”è¯¥è°ƒç”¨ä½ çš„åç«¯APIæˆ–OpenAI API
            // ç°åœ¨å…ˆè¿”å›ä¸€ä¸ªæ¨¡æ‹Ÿçš„å“åº”ï¼Œç­‰å¾…ä½ é…ç½®å¥½APIåå†æ›¿æ¢
            
            console.log('ğŸ§  ä½¿ç”¨è®°å¿†ä¸Šä¸‹æ–‡ç”Ÿæˆå›å¤:', contextPrompt);
            
            // ä¸´æ—¶ä½¿ç”¨åŸæœ‰çš„AIå›å¤ç³»ç»Ÿï¼Œä½†åŠ å…¥è®°å¿†ä¿¡æ¯
            const baseResponse = generateAIResponse(userMessage);
            
            // æ·»åŠ ä¸€äº›è®°å¿†ç›¸å…³çš„å“åº”
            const memoryEnhancedResponses = [
                baseResponse,
                `${baseResponse} æˆ‘è¿˜è®°å¾—ä½ ä¹‹å‰æåˆ°çš„äº‹æƒ…å‘¢~`,
                `${baseResponse} æ ¹æ®æˆ‘å¯¹ä½ çš„äº†è§£ï¼Œä½ åº”è¯¥ä¼šå–œæ¬¢è¿™ä¸ªå»ºè®®ã€‚`,
                `${baseResponse} è¿™è®©æˆ‘æƒ³èµ·äº†æˆ‘ä»¬ä¹‹å‰çš„å¯¹è¯ã€‚`
            ];
            
            return memoryEnhancedResponses[Math.floor(Math.random() * memoryEnhancedResponses.length)];
        }
        
        // åœ¨VRMåŠ è½½å®Œæˆåè‡ªåŠ¨åˆå§‹åŒ–AIèŠå¤©ç³»ç»Ÿ
        function onVRMLoadComplete(characterName, vrmPath) {
            selectedCharacter = {
                name: characterName.replace(' VRM', '').replace('_', ' '),
                personality: getCharacterPersonality(characterName),
                file: vrmPath,
                id: characterName
            };
            
            // è®¾ç½®è§’è‰²å¤´åƒ
            setCharacterAvatar(characterName);
            
            setTimeout(() => {
                initializeAIChat();
            }, 1500);
        }
        
        // æ›´æ–°æ‰‹æœºçŠ¶æ€æ æ—¶é—´
        function updatePhoneTime() {
            const timeDisplay = document.getElementById('phone-time');
            if (timeDisplay) {
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false 
                });
                timeDisplay.textContent = timeString;
            }
        }
        
        // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡æ—¶é—´
        setInterval(updatePhoneTime, 60000);
        // ç«‹å³æ›´æ–°ä¸€æ¬¡æ—¶é—´
        updatePhoneTime();
        
        window.goToCharacterSelect = goToCharacterSelect;
        window.initDragAndDrop = initDragAndDrop;

        // åˆå§‹åŒ–
        function init() {
            console.log('ğŸš€ AI Companion åˆå§‹åŒ–å¼€å§‹...');
            console.log('ğŸŒ å½“å‰é¡µé¢URL:', window.location.href);
            console.log('ğŸ“± é’±åŒ…éªŒè¯å™¨çŠ¶æ€:', walletAuth);
            
            // é¦–å…ˆè¿›è¡Œé’±åŒ…éªŒè¯
            console.log('âš¡ å¼€å§‹è°ƒç”¨é’±åŒ…éªŒè¯...');
            const isAuthenticated = walletAuth.checkAuthentication();
            console.log('ğŸ” éªŒè¯ç»“æœ:', isAuthenticated);
            
            if (!isAuthenticated) {
                console.log('âŒ é’±åŒ…éªŒè¯å¤±è´¥ï¼Œåœæ­¢åˆå§‹åŒ–');
                return; // å¦‚æœéªŒè¯å¤±è´¥ï¼Œä¸ç»§ç»­åˆå§‹åŒ–
            }
            
            console.log('âœ… é’±åŒ…éªŒè¯æˆåŠŸï¼Œç»§ç»­åˆå§‹åŒ–åº”ç”¨');
            
            // ç”¨æˆ·èµ„æ–™å¡«å†™å·²ç§»è‡³character-selecté¡µé¢ï¼Œindex.htmlåªå¤„ç†å·²æ³¨å†Œç”¨æˆ·
            
            // æ£€æŸ¥æ˜¯å¦æœ‰é€‰æ‹©çš„è§’è‰²ï¼Œç„¶ååŠ è½½VRM
            loadSelectedCharacter();
            
            resizeRenderer();
            animate();

            // åˆå§‹åŒ–é€‰æ‹©å™¨
            initAnimationSelector();
            initCharacterSelector();
            
            // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
            initDragAndDrop();

            // å»¶è¿Ÿåˆå§‹åŒ–èƒŒæ™¯éŸ³ä¹ï¼Œç¡®ä¿DOMå®Œå…¨åŠ è½½
            setTimeout(() => {
                initBackgroundMusic();
            }, 1000);

            // åˆå§‹çŠ¶æ€ - æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
            const aiStatusElement = document.getElementById('ai-status');
            if (aiStatusElement) {
                aiStatusElement.innerHTML = '<span class="online-indicator"></span>AIæ™ºèƒ½æ¨¡å¼';
            }
            
            console.log('ğŸ‰ AI Companion åˆå§‹åŒ–å®Œæˆ');
        }

        // åŠ è½½é€‰æ‹©çš„è§’è‰²
        function loadSelectedCharacter() {
            try {
                // ä»é’±åŒ…éªŒè¯ç³»ç»Ÿè·å–è§’è‰²ä¿¡æ¯
                const character = walletAuth.getCurrentCharacter();
                
                console.log('ğŸ“± loadSelectedCharacter è°ƒè¯•ä¿¡æ¯:');
                console.log('- character:', character);
                console.log('- localStorage selectedCharacter:', localStorage.getItem('selectedCharacter'));
                
                if (character) {
                    // æ›´æ–°æ‚¬æµ®èŠå¤©æ¡†ä¸­çš„è§’è‰²åç§°
                    const characterNameElement = document.getElementById('character-name');
                    if (characterNameElement) {
                        characterNameElement.textContent = character.name;
                    }
                    
                    // æ›´æ–°æ¬¢è¿æ¶ˆæ¯ - æ£€æŸ¥æ˜¯å¦æ˜¯è€ç”¨æˆ·
                    const welcomeMessage = document.querySelector('.message-bubble.ai .bubble-content');
                    if (welcomeMessage && !welcomeMessage.dataset.updated) {
                        const userProfile = localStorage.getItem(`user_profile_${walletAuth.getCurrentUserId()}`);
                        if (userProfile) {
                            // è€ç”¨æˆ·
                            welcomeMessage.textContent = `æ¬¢è¿å›æ¥ï¼æˆ‘æ˜¯${character.name}ï¼Œæˆ‘è¿˜è®°å¾—æˆ‘ä»¬ä¹‹å‰çš„å¯¹è¯å‘¢~ ğŸ’•`;
                        } else {
                            // æ–°ç”¨æˆ·
                            welcomeMessage.textContent = `ä½ å¥½ï¼æˆ‘æ˜¯${character.name}ï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ ï¼è®©æˆ‘ä»¬å¼€å§‹æ„‰å¿«çš„èŠå¤©å§~ ğŸ’•`;
                        }
                        welcomeMessage.dataset.updated = 'true';
                    }
                    
                    // è®¾ç½®é»˜è®¤VRMæ–‡ä»¶
                    defaultVrmFile = character.file;
                    
                    console.log(`âœ… å·²åŠ è½½è§’è‰²: ${character.name} (é’±åŒ…: ${walletAuth.formatAddress(character.walletAddress)})`);
                    console.log(`ğŸ“ è®¾ç½®defaultVrmFile: ${defaultVrmFile}`);
                    
                    // è®¾ç½®è§’è‰²å¤´åƒï¼ˆåŸºäºcharacter.idï¼‰
                    if (character.id) {
                        setCharacterAvatar(character.id);
                    }
                    
                    // ç°åœ¨åŠ è½½VRMæ–‡ä»¶
                    loadVRM();
                } else {
                    throw new Error('æœªæ‰¾åˆ°è§’è‰²ä¿¡æ¯');
                }
            } catch (error) {
                console.error('åŠ è½½è§’è‰²å¤±è´¥:', error);
                // é‡å®šå‘åˆ°è§’è‰²é€‰æ‹©é¡µé¢
                walletAuth.redirectToCharacterSelect();
            }
        }

        // æš´éœ²å˜é‡åˆ°å…¨å±€ä½œç”¨åŸŸä»¥ä¾›æŒ‰é’®è°ƒç”¨
        window.currentVrm = currentVrm;
        window.availableExpressions = availableExpressions;
        
        // æš´éœ²å†…éƒ¨å‡½æ•°åˆ°å…¨å±€
        window.resetExpressions = resetExpressions;
        window.setExpression = setExpression;

        // ç­‰å¾…DOMåŠ è½½å®Œæˆåå†åˆå§‹åŒ–
        console.log('ğŸ” æ£€æŸ¥DOMçŠ¶æ€:', document.readyState);
        console.log('ğŸ” initå‡½æ•°æ˜¯å¦å­˜åœ¨:', typeof init);
        console.log('âš™ï¸ æ¨¡å—è„šæœ¬æ‰§è¡Œå®Œæ¯•ï¼Œå‡†å¤‡åˆå§‹åŒ–...');
        
        if (document.readyState === 'loading') {
            console.log('â³ DOMåŠ è½½ä¸­ï¼Œç­‰å¾…DOMContentLoadedäº‹ä»¶');
            document.addEventListener('DOMContentLoaded', () => {
                console.log('âœ… DOMContentLoadedäº‹ä»¶è§¦å‘ï¼Œè°ƒç”¨init()');
                init();
            });
        } else {
            // DOMå·²ç»åŠ è½½å®Œæˆ
            console.log('âœ… DOMå·²åŠ è½½ï¼Œç«‹å³è°ƒç”¨init()');
            init();
        }
    </script>

    <script>
        // å…¨å±€è¡¨æƒ…æµ‹è¯•å‡½æ•°
        window.testShyExpression = function() {
            console.log('ğŸ§ª æµ‹è¯•å®³ç¾è¡¨æƒ…...');
            
            if (!window.currentVrm || !window.currentVrm.expressionManager) {
                alert('VRMæ¨¡å‹è¿˜æœªåŠ è½½å®Œæˆï¼è¯·ç­‰å¾…åŠ è½½...');
                return;
            }

            console.log('å¯ç”¨è¡¨æƒ…:', window.availableExpressions);
            
            // é‡ç½®æ‰€æœ‰è¡¨æƒ…
            if (window.resetExpressions) {
                window.resetExpressions();
            }
            
            // å°è¯•å¤šç§å®³ç¾ç›¸å…³çš„è¡¨æƒ…
            const shyExpressions = ['shy', 'embarrassed', 'blush', 'surprised', 'sad'];
            let appliedExpression = null;
            
            shyExpressions.forEach(expr => {
                if (window.availableExpressions && window.availableExpressions.includes(expr)) {
                    if (window.setExpression) {
                        window.setExpression(expr, 1.0);
                        appliedExpression = expr;
                        console.log(`âœ… åº”ç”¨è¡¨æƒ…: ${expr}`);
                    }
                }
            });
            
            if (appliedExpression) {
                document.getElementById('current-expression').textContent = `å®³ç¾ (${appliedExpression})`;
                // 5ç§’åæ¢å¤ä¸­æ€§
                setTimeout(() => {
                    if (window.resetExpressions) {
                        window.resetExpressions();
                    }
                }, 5000);
            } else {
                const available = window.availableExpressions ? window.availableExpressions.join(', ') : 'æ— ';
                alert('å½“å‰VRMæ¨¡å‹ä¸æ”¯æŒå®³ç¾è¡¨æƒ… ğŸ˜”\n\nå¯ç”¨è¡¨æƒ…: ' + available + '\n\nå»ºè®®ï¼šå°è¯•ç‚¹å‡»å…¶ä»–è¡¨æƒ…æŒ‰é’®çœ‹çœ‹æ•ˆæœï¼');
            }
        };

        window.testHappyExpression = function() {
            if (!window.currentVrm || !window.currentVrm.expressionManager) {
                alert('VRMæ¨¡å‹è¿˜æœªåŠ è½½å®Œæˆï¼');
                return;
            }

            if (window.availableExpressions && window.availableExpressions.includes('happy')) {
                if (window.setExpression) {
                    window.setExpression('happy', 1.0);
                    document.getElementById('current-expression').textContent = 'å¼€å¿ƒ';
                    setTimeout(() => {
                        if (window.resetExpressions) {
                            window.resetExpressions();
                        }
                    }, 3000);
                }
            } else {
                const available = window.availableExpressions ? window.availableExpressions.join(', ') : 'æ— ';
                alert('å½“å‰VRMæ¨¡å‹ä¸æ”¯æŒå¼€å¿ƒè¡¨æƒ…\nå¯ç”¨è¡¨æƒ…: ' + available);
            }
        };

        window.testSadExpression = function() {
            if (!window.currentVrm || !window.currentVrm.expressionManager) {
                alert('VRMæ¨¡å‹è¿˜æœªåŠ è½½å®Œæˆï¼');
                return;
            }

            if (window.availableExpressions && window.availableExpressions.includes('sad')) {
                if (window.setExpression) {
                    window.setExpression('sad', 1.0);
                    document.getElementById('current-expression').textContent = 'éš¾è¿‡';
                    setTimeout(() => {
                        if (window.resetExpressions) {
                            window.resetExpressions();
                        }
                    }, 3000);
                }
            } else {
                const available = window.availableExpressions ? window.availableExpressions.join(', ') : 'æ— ';
                alert('å½“å‰VRMæ¨¡å‹ä¸æ”¯æŒéš¾è¿‡è¡¨æƒ…\nå¯ç”¨è¡¨æƒ…: ' + available);
            }
        };

        window.resetAllExpressions = function() {
            if (!window.currentVrm || !window.currentVrm.expressionManager) {
                alert('VRMæ¨¡å‹è¿˜æœªåŠ è½½å®Œæˆï¼');
                return;
            }

            if (window.resetExpressions) {
                window.resetExpressions();
            }
            console.log('ğŸ”„ æ‰€æœ‰è¡¨æƒ…å·²é‡ç½®');
        };
    </script>
    
    <!-- ç”¨æˆ·èµ„æ–™æ³¨å†Œé¢æ¿ -->

    <!-- é’±åŒ…è¿æ¥é®ç½©å±‚ï¼ˆåˆå§‹éšè—ï¼‰ -->
    
    <!-- ç”¨æˆ·èµ„æ–™ç®¡ç†å·²ç§»è‡³character-selecté¡µé¢ -->

    <!-- é’±åŒ…è¿æ¥é®ç½©å±‚ï¼ˆåˆå§‹éšè—ï¼‰ -->
    <div class="wallet-login-overlay" id="wallet-login-overlay" style="display: none;">
        <div class="wallet-login-panel">
            <div class="wallet-login-icon">ğŸ¦Š</div>
            <h2 class="wallet-login-title">è¿æ¥é’±åŒ…å¼€å§‹æ¸¸æˆ</h2>
            <p class="wallet-login-subtitle">ä½¿ç”¨Solanaé’±åŒ…ç™»å½•ï¼Œä¸æ‚¨çš„ä¸“å±AIå¥³å‹å¼€å§‹èŠå¤©</p>
            
            <button class="wallet-connect-btn" onclick="connectWallet()" id="wallet-connect-btn">
                è¿æ¥é’±åŒ…
            </button>
            
            <div class="wallet-options">
                <a href="https://phantom.app/" target="_blank" class="wallet-option">
                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #AB9FF2, #7B6BF0); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">P</div>
                    <span>Phantom</span>
                </a>
                <a href="https://solflare.com/" target="_blank" class="wallet-option">
                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #FF6B35, #F7931E); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">S</div>
                    <span>Solflare</span>
                </a>
            </div>
            
            <p style="font-size: 12px; color: #999; margin-top: 20px;">
                ğŸ’¡ æ²¡æœ‰é’±åŒ…ï¼Ÿç‚¹å‡»ä¸Šæ–¹å›¾æ ‡å®‰è£…ååˆ·æ–°é¡µé¢
            </p>
        </div>
    </div>
    
    <!-- é¡µé¢åŠ è½½ååˆå§‹åŒ– -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥æ˜¯å¦ä»è§’è‰²é€‰æ‹©é¡µé¢è·³è½¬è¿‡æ¥
            const hasStoredWallet = localStorage.getItem('wallet_address');
            const hasSelectedCharacter = localStorage.getItem('selectedCharacter');
            
            if (hasStoredWallet && hasSelectedCharacter) {
                console.log('ğŸš€ ä»è§’è‰²é€‰æ‹©é¡µé¢è·³è½¬ï¼Œå¼€å§‹åˆå§‹åŒ–èŠå¤©...');
                
                // é’±åŒ…å·²åœ¨character-selecté¡µé¢éªŒè¯ï¼Œç›´æ¥æ˜¾ç¤ºå·²ç™»å½•çŠ¶æ€
                
                // æš‚æ—¶è·³è¿‡è®°å¿†ç³»ç»Ÿåˆå§‹åŒ–ï¼Œç›´æ¥ä½¿ç”¨OpenAI
                console.log('âš ï¸ è·³è¿‡è®°å¿†ç³»ç»Ÿåˆå§‹åŒ–ï¼Œç›´æ¥ä½¿ç”¨OpenAIèŠå¤©');
                console.log('ğŸ’¬ èŠå¤©ç³»ç»Ÿå·²å‡†å¤‡å°±ç»ª');

                // ç”¨æˆ·èµ„æ–™æ£€æŸ¥å·²ç§»è‡³init()å‡½æ•°ä¸­ï¼Œç¡®ä¿åœ¨é’±åŒ…éªŒè¯åç«‹å³æ‰§è¡Œ
                
                // ç­‰å¾…èŠå¤©ç³»ç»Ÿåˆå§‹åŒ–
                setTimeout(() => {
                    if (window.chatSystemV2) {
                        console.log('ğŸ’¬ èŠå¤©ç³»ç»Ÿå·²å‡†å¤‡å°±ç»ª');
                    }
                }, 1000);
            }
        });
    </script>
</body>

</html>