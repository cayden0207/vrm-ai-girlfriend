<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; connect-src 'self' blob: http://localhost:3000 https://api.openai.com;">
    <title>AIÂ•≥ÂèãËÅäÂ§©Ê∏∏Êàè üå∏</title>
    <link rel="stylesheet" href="chat-ui.css">
    <link rel="stylesheet" href="wallet-ui.css">
    
    <!-- ÈÖçÁΩÆÊñá‰ª∂ -->
    <script src="config.js"></script>
    <!-- ËÆ∞ÂøÜÁÆ°ÁêÜÁ≥ªÁªü -->
    <script src="memory-system.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: transparent;
            height: 100vh;
            overflow: hidden;
        }

        .game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        /* VRMÂ±ïÁ§∫Âå∫ - ÂÖ®Â±è */
        .vrm-container {
            width: 100%;
            height: 100%;
            position: relative;
            /* ÁßªÈô§CSSËÉåÊôØÔºåËÆ©Three.jsÂú∫ÊôØËÉåÊôØÊòæÁ§∫ */
            background: transparent;
        }

        /* AIÂØπËØùÊ∞îÊ≥° */
        .ai-speech-bubble {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(220, 220, 220, 0.95);
            color: #333;
            padding: 18px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 500;
            max-width: 450px;
            min-width: 250px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
            opacity: 0;
            animation: bubbleFadeIn 0.5s forwards;
            z-index: 100;
            line-height: 1.5;
            letter-spacing: 0.5px;
        }

        .ai-speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 18px solid transparent;
            border-right: 18px solid transparent;
            border-top: 18px solid rgba(220, 220, 220, 0.95);
        }

        @keyframes bubbleFadeIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        @keyframes bubbleFadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        .vrm-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }



        /* Â§çÂè§Èü≥‰πêÊí≠ÊîæÂô® */
        .music-controls {
            position: absolute;
            top: 25px;
            left: 25px;
            width: 280px;
            height: 120px;
            background: linear-gradient(135deg, #e8b4ff 0%, #d19cff 50%, #b96fff 100%);
            border-radius: 15px;
            border: 6px solid #4a2c5a;
            color: #2d1b3d;
            z-index: 1001;
            padding: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3), inset 0 2px 0 rgba(255, 255, 255, 0.4);
            font-family: 'Arial', sans-serif;
        }

        .music-window-title {
            background: linear-gradient(90deg, #ffb366 0%, #ffa64d 100%);
            margin: -15px -15px 10px -15px;
            padding: 8px 15px;
            border-radius: 9px 9px 0 0;
            font-size: 12px;
            font-weight: bold;
            color: #2d1b3d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .window-controls {
            display: flex;
            gap: 5px;
        }

        .window-btn {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
        }

        .minimize-btn { background: #ffd23f; }
        .maximize-btn { background: #28ca42; }
        .close-btn { background: #ff5f57; }

        .music-player-content {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .music-controls-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .music-control-btn {
            width: 35px;
            height: 25px;
            background: #6c4a7a;
            border: 2px solid #2d1b3d;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .music-control-btn:hover {
            background: #8b5fa3;
            transform: translateY(-1px);
        }

        .play-btn {
            width: 45px !important;
            background: #4a7c59 !important;
        }

        .play-btn:hover {
            background: #5d9973 !important;
        }

        .volume-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .volume-slider {
            width: 120px;
            height: 4px;
            border-radius: 2px;
            background: #4a2c5a;
            outline: none;
            cursor: pointer;
            -webkit-appearance: none;
        }

        .volume-slider::-webkit-slider-thumb {
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 2px;
            background: #ffb366;
            cursor: pointer;
            border: 1px solid #2d1b3d;
        }

        .volume-slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 2px;
            background: #ffb366;
            cursor: pointer;
            border: 1px solid #2d1b3d;
        }

        .volume-label {
            font-size: 10px;
            min-width: 25px;
            font-weight: bold;
            text-align: right;
        }


        .emotion-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }

        .emotion-btn {
            padding: 8px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .emotion-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .emotion-btn.active {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            color: #2d3436;
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            .vrm-container {
                width: 100%;
                height: 100vh;
            }
        }

        /* Âä®ÁîªÊïàÊûú */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ËøîÂõûÊåâÈíÆ */
        .back-button {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
            z-index: 1000;
        }

        .back-button:hover {
            background: rgba(255, 107, 157, 0.8);
            transform: translateY(-2px);
        }

        /* Èí±ÂåÖÁä∂ÊÄÅÊòæÁ§∫ */
        .wallet-status-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 8px 12px;
            border-radius: 20px;
            color: white;
            font-size: 12px;
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .wallet-avatar svg {
            color: #8b5cf6;
        }

        .wallet-address {
            font-family: 'Courier New', monospace;
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 8px;
            border-radius: 5px;
        }

        .wallet-disconnect {
            background: rgba(255, 69, 58, 0.8);
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .wallet-disconnect:hover {
            background: rgba(255, 69, 58, 1);
        }

        /* ËøûÊé•Èí±ÂåÖÊåâÈíÆ */
        .connect-wallet-btn {
            background: linear-gradient(135deg, #9945ff, #14f195);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .connect-wallet-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(153, 69, 255, 0.4);
        }

        /* Êú™ÊéàÊùÉÁïåÈù¢ */
        .unauthorized-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(10px);
        }

        .unauthorized-content {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            color: #333;
        }

        .unauthorized-content h2 {
            margin-bottom: 20px;
            color: #ff6b9d;
        }

        .unauthorized-content p {
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .connect-wallet-btn {
            background: linear-gradient(135deg, #9945ff, #14f195);
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .connect-wallet-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(153, 69, 255, 0.4);
        }

        /* ÊÇ¨ÊµÆËÅäÂ§©Ê°Ü */
        .floating-chat {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            width: 416px;
            height: 754px;
            background: #F5F3F0;
            border-radius: 33px;
            border: 10px solid #2C1810;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4), 
                        0 0 30px rgba(44, 24, 16, 0.2),
                        inset 0 2px 0 rgba(255, 255, 255, 0.3);
            z-index: 1000;
            cursor: move;
            user-select: none;
            overflow: hidden;
        }


        .floating-chat.dragging {
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5), 
                        0 0 40px rgba(255, 182, 193, 0.8),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3);
            cursor: grabbing;
        }

        /* ÊâãÊú∫Top BarÈ£éÊ†ºËÅäÂ§©Ê°ÜÂ§¥ÈÉ® */
        .chat-window-header {
            border-radius: 23px 23px 0 0;
            padding: 0;
            border-bottom: none;
            display: flex;
            flex-direction: column;
            cursor: grab;
            user-select: none;
            position: relative;
            overflow: hidden;
            width: 100%;
        }

        .chat-window-header:active {
            cursor: grabbing;
        }

        /* ÁúüÂÆûÊâãÊú∫Áä∂ÊÄÅÊ†è */
        .phone-status-bar {
            background: #000000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 16px;
            font-size: 14px;
            color: white;
            font-weight: 600;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            height: 24px;
            border-radius: 23px 23px 0 0;
            width: 100%;
            box-sizing: border-box;
        }

        .status-left {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
        }

        .carrier-info {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
            font-weight: 600;
        }

        .network-type {
            font-size: 14px;
            font-weight: 600;
        }

        .status-center {
            flex: 1;
            display: flex;
            justify-content: center;
        }

        .time-display {
            font-weight: 700;
            font-size: 14px;
            letter-spacing: -0.2px;
        }

        .status-right {
            display: flex;
            align-items: center;
            gap: 4px;
            flex: 1;
            justify-content: flex-end;
        }

        .status-icon {
            display: flex;
            align-items: center;
        }

        .battery-percentage {
            font-size: 14px;
            font-weight: 600;
            margin-right: 2px;
        }

        /* Âä®Êº´È£éÊ†ºËÅäÂ§©Ê†áÈ¢òÂå∫Âüü */
        .chat-title-area {
            position: relative;
            padding: 16px 20px;
            background: linear-gradient(135deg, 
                #FF6B9D 0%, 
                #C44569 25%, 
                #7B68EE 50%, 
                #9B59B6 75%, 
                #E056FD 100%);
            border-bottom: none;
            overflow: hidden;
            width: 100%;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* Âä®Êº´È£éÊ†ºËÉåÊôØË£ÖÈ•∞ */
        .chat-title-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(255, 182, 193, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        /* Âä®Êº´È£éÊ†ºÊòüÊòüË£ÖÈ•∞ */
        .chat-title-area::after {
            content: '‚ú®üå∏‚ú®';
            position: absolute;
            top: 8px;
            right: 20px;
            font-size: 12px;
            opacity: 0.7;
            animation: sparkle 3s ease-in-out infinite;
        }

        @keyframes sparkle {
            0%, 100% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
        }

        .chat-user-info {
            display: flex;
            align-items: center;
            gap: 14px;
            position: relative;
            z-index: 2;
        }

        /* ÂèØÁà±ÁöÑÂ§¥ÂÉèËÆæËÆ° - ‰ΩøÁî®ËÅäÂ§©Ê∞îÊ≥°Áõ∏ÂêåÂ§¥ÂÉè */
        .chat-user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: url('profile-pic/alice-pf.png') center/cover;
            border: 3px solid rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            position: relative;
            box-shadow: 
                0 4px 15px rgba(255, 182, 193, 0.4),
                0 2px 8px rgba(0, 0, 0, 0.1),
                inset 0 2px 0 rgba(255, 255, 255, 0.6);
            animation: avatarFloat 4s ease-in-out infinite;
        }

        /* ‰∏∫‰∏çÂêåËßíËâ≤ËÆæÁΩÆÊ†áÈ¢òÊ†èÂ§¥ÂÉè */
        .character-fliza .chat-user-avatar {
            background-image: url('profile-pic/fliza-pf.png');
        }

        .character-alice .chat-user-avatar {
            background-image: url('profile-pic/alice-pf.png');
        }

        .character-ash .chat-user-avatar {
            background-image: url('profile-pic/ash-pf.png');
        }

        .character-bobo .chat-user-avatar {
            background-image: url('profile-pic/bobo-pf.png');
        }

        .character-elinyaa .chat-user-avatar {
            background-image: url('profile-pic/elinyaa-pf.png');
        }

        .character-imeris .chat-user-avatar {
            background-image: url('profile-pic/imeris-pf.png');
        }

        .character-kyoko .chat-user-avatar {
            background-image: url('profile-pic/kyoko-pf.png');
        }

        .character-lena .chat-user-avatar {
            background-image: url('profile-pic/lena-pf.png');
        }

        .character-lilium .chat-user-avatar {
            background-image: url('profile-pic/lilium.png');
        }

        .character-maple .chat-user-avatar {
            background-image: url('profile-pic/maple-pf.png');
        }

        .character-miru .chat-user-avatar {
            background-image: url('profile-pic/Miru-pf.png');
        }

        .character-miumiu .chat-user-avatar {
            background-image: url('profile-pic/miumiu-pf.png');
        }

        .character-neco .chat-user-avatar {
            background-image: url('profile-pic/neco-pf.png');
        }

        .character-nekona .chat-user-avatar {
            background-image: url('profile-pic/nekona.png');
        }

        .character-notia .chat-user-avatar {
            background-image: url('profile-pic/notia-pf.png');
        }

        .character-ququ .chat-user-avatar {
            background-image: url('profile-pic/ququ-pf.png');
        }

        .character-rainy .chat-user-avatar {
            background-image: url('profile-pic/rainy-pf.png');
        }

        .character-rindo .chat-user-avatar {
            background-image: url('profile-pic/rindo-pf.png');
        }

        .character-sikirei .chat-user-avatar {
            background-image: url('profile-pic/sikirei-pf.png');
        }

        .character-vivi .chat-user-avatar {
            background-image: url('profile-pic/vivi-pf.png');
        }

        .character-wolf .chat-user-avatar {
            background-image: url('profile-pic/wolf.png');
        }

        .character-wolferia .chat-user-avatar {
            background-image: url('profile-pic/wolferia-pf.png');
        }

        .character-yawl .chat-user-avatar {
            background-image: url('profile-pic/yawl-pf.png');
        }

        .character-yuu .chat-user-avatar {
            background-image: url('profile-pic/yuu yii-pf.png');
        }

        .character-zwei .chat-user-avatar {
            background-image: url('profile-pic/zwei-pf.png');
        }

        @keyframes avatarFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-2px); }
        }

        /* Â§¥ÂÉèÂë®Âõ¥ÁöÑÂÖâÊôï */
        .chat-user-avatar::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            border-radius: 50%;
            background: linear-gradient(45deg, 
                transparent, 
                rgba(255, 255, 255, 0.3), 
                transparent);
            animation: haloRotate 6s linear infinite;
        }

        @keyframes haloRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .chat-user-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .chat-user-name {
            color: white;
            font-size: 18px;
            font-weight: 700;
            margin: 0;
            text-shadow: 
                0 2px 4px rgba(0, 0, 0, 0.3),
                0 1px 0 rgba(255, 255, 255, 0.2);
            position: relative;
        }

        /* ÂêçÂ≠óÂâçÁöÑÂ∞èË£ÖÈ•∞ */
        .chat-user-name::before {
            content: 'üíï';
            margin-right: 6px;
            font-size: 14px;
            animation: heartBeat 2s ease-in-out infinite;
        }

        @keyframes heartBeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .chat-user-status {
            color: rgba(255, 255, 255, 0.9);
            font-size: 13px;
            margin: 0;
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            position: relative;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Áä∂ÊÄÅÊåáÁ§∫Âô® */
        .chat-user-status::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4AE54A;
            box-shadow: 
                0 0 0 2px rgba(74, 229, 74, 0.3),
                0 0 8px rgba(74, 229, 74, 0.6);
            animation: onlinePulse 2s ease-in-out infinite;
        }

        @keyframes onlinePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* ÂèØÁà±ÁöÑÂä®‰ΩúÊåâÈíÆ */
        .chat-actions {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 2;
        }

        .chat-action-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.25) 0%, 
                rgba(255, 255, 255, 0.1) 100%);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        /* ÊåâÈíÆÁöÑÂÖâÊïà */
        .chat-action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.4), 
                transparent);
            transition: left 0.6s;
        }

        .chat-action-btn:hover {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.35) 0%, 
                rgba(255, 255, 255, 0.2) 100%);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 
                0 8px 25px rgba(255, 182, 193, 0.4),
                0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .chat-action-btn:hover::before {
            left: 100%;
        }

        .chat-action-btn:active {
            transform: translateY(0) scale(0.98);
        }

        /* ÁâπÊÆäÊïàÊûúÔºöÊåâÈíÆÁöÑÂ∞èË£ÖÈ•∞ */
        .chat-action-btn:nth-child(1) {
            animation-delay: 0.1s;
        }
        .chat-action-btn:nth-child(2) {
            animation-delay: 0.2s;
        }
        .chat-action-btn:nth-child(3) {
            animation-delay: 0.3s;
        }

        /* ËÅäÂ§©Ê∂àÊÅØÂå∫Âüü */
        .chat-window-messages {
            height: 585px;
            padding: 26px 20px;
            overflow-y: auto;
            background: #F5F3F0;
        }

        .chat-window-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-window-messages::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .chat-window-messages::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        /* Ê∂àÊÅØÊ∞îÊ≥°Ê†∑Âºè */
        .message-bubble {
            margin-bottom: 18px;
            animation: messageSlideIn 0.4s ease-out;
        }

        .message-bubble.user {
            display: flex;
            justify-content: flex-end;
        }

        .message-bubble.ai {
            display: flex;
            justify-content: flex-start;
            align-items: flex-start;
            margin-bottom: 18px;
            position: relative;
            padding-left: 54px;
        }
        
        .message-bubble.ai::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 44px;
            height: 44px;
            background: url('profile-pic/alice-pf.png') center/cover;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 4px 12px rgba(255, 176, 132, 0.4),
                        0 2px 6px rgba(0, 0, 0, 0.15),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3);
            z-index: 1;
        }

        /* ‰∏∫‰∏çÂêåËßíËâ≤ËÆæÁΩÆÂ§¥ÂÉè */
        .character-fliza .message-bubble.ai::before {
            background-image: url('profile-pic/fliza-pf.png');
        }

        .character-alice .message-bubble.ai::before {
            background-image: url('profile-pic/alice-pf.png');
        }

        .character-ash .message-bubble.ai::before {
            background-image: url('profile-pic/ash-pf.png');
        }

        .character-bobo .message-bubble.ai::before {
            background-image: url('profile-pic/bobo-pf.png');
        }

        .character-elinyaa .message-bubble.ai::before {
            background-image: url('profile-pic/elinyaa-pf.png');
        }

        .character-imeris .message-bubble.ai::before {
            background-image: url('profile-pic/imeris-pf.png');
        }

        .character-kyoko .message-bubble.ai::before {
            background-image: url('profile-pic/kyoko-pf.png');
        }

        .character-lena .message-bubble.ai::before {
            background-image: url('profile-pic/lena-pf.png');
        }

        .character-lilium .message-bubble.ai::before {
            background-image: url('profile-pic/lilium.png');
        }

        .character-maple .message-bubble.ai::before {
            background-image: url('profile-pic/maple-pf.png');
        }

        .character-miru .message-bubble.ai::before {
            background-image: url('profile-pic/Miru-pf.png');
        }

        .character-miumiu .message-bubble.ai::before {
            background-image: url('profile-pic/miumiu-pf.png');
        }

        .character-neco .message-bubble.ai::before {
            background-image: url('profile-pic/neco-pf.png');
        }

        .character-nekona .message-bubble.ai::before {
            background-image: url('profile-pic/nekona.png');
        }

        .character-notia .message-bubble.ai::before {
            background-image: url('profile-pic/notia-pf.png');
        }

        .character-ququ .message-bubble.ai::before {
            background-image: url('profile-pic/ququ-pf.png');
        }

        .character-rainy .message-bubble.ai::before {
            background-image: url('profile-pic/rainy-pf.png');
        }

        .character-rindo .message-bubble.ai::before {
            background-image: url('profile-pic/rindo-pf.png');
        }

        .character-sikirei .message-bubble.ai::before {
            background-image: url('profile-pic/sikirei-pf.png');
        }

        .character-vivi .message-bubble.ai::before {
            background-image: url('profile-pic/vivi-pf.png');
        }

        .character-wolf .message-bubble.ai::before {
            background-image: url('profile-pic/wolf.png');
        }

        .character-wolferia .message-bubble.ai::before {
            background-image: url('profile-pic/wolferia-pf.png');
        }

        .character-yawl .message-bubble.ai::before {
            background-image: url('profile-pic/yawl-pf.png');
        }

        .character-yuu .message-bubble.ai::before {
            background-image: url('profile-pic/yuu yii-pf.png');
        }

        .character-zwei .message-bubble.ai::before {
            background-image: url('profile-pic/zwei-pf.png');
        }

        .bubble-container {
            max-width: 80%;
            position: relative;
        }

        .bubble-header {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.9), rgba(255, 182, 193, 0.9));
            border-radius: 15px 15px 0 0;
            padding: 6px 12px;
            font-size: 12px;
            color: rgba(0, 0, 0, 0.7);
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .bubble-content {
            background: linear-gradient(135deg, #FFB084 0%, #FF9D6B 50%, #FF8A50 100%);
            border-radius: 20px 20px 20px 5px;
            padding: 16px 20px;
            color: white;
            font-size: 18px;
            line-height: 1.5;
            position: relative;
            max-width: 300px;
            word-wrap: break-word;
            margin: 8px 0;
            box-shadow: 0 4px 12px rgba(255, 157, 107, 0.3),
                        0 2px 6px rgba(139, 69, 19, 0.2);
            border: none;
            text-shadow: 0 1px 2px rgba(139, 69, 19, 0.3);
        }
        
        .message-bubble.ai .bubble-content::after {
            content: '';
            position: absolute;
            bottom: 0px;
            left: -8px;
            width: 0;
            height: 0;
            border-right: 12px solid #FF9D6B;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            filter: drop-shadow(-2px 2px 4px rgba(139, 69, 19, 0.15));
        }

        .message-bubble.user .bubble-header {
            background: #E0E0E0;
            color: #333;
        }

        .message-bubble.user .bubble-content {
            background: linear-gradient(135deg, #F0F0F0 0%, #E0E0E0 50%, #D0D0D0 100%);
            color: #333;
            border-radius: 20px 20px 5px 20px;
            box-shadow: 0 4px 12px rgba(224, 224, 224, 0.4),
                        0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        .message-bubble.user .bubble-content::after {
            content: '';
            position: absolute;
            bottom: 0px;
            right: -8px;
            width: 0;
            height: 0;
            border-left: 12px solid #E0E0E0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.1));
        }


        .bubble-controls {
            display: flex;
            gap: 4px;
        }

        .bubble-control {
            width: 10px;
            height: 10px;
            border-radius: 2px;
            background: rgba(0, 0, 0, 0.3);
        }

        /* ËÅäÂ§©ËæìÂÖ•Âå∫Âüü - ÁÆÄÁ∫¶Á≤æËá¥È£éÊ†º */
        .chat-window-input {
            padding: 12px 16px 16px;
            background: linear-gradient(180deg, #FAFAFA 0%, #F5F5F5 100%);
            border-radius: 0 0 23px 23px;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            cursor: auto;
        }

        .chat-window-messages {
            cursor: auto;
        }

        .input-container {
            display: flex;
            background: white;
            border-radius: 24px;
            border: 1px solid rgba(0, 0, 0, 0.08);
            overflow: hidden;
            align-items: center;
            padding: 4px 4px 4px 16px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .input-container:focus-within {
            border-color: rgba(255, 182, 193, 0.5);
            box-shadow: 0 0 0 3px rgba(255, 182, 193, 0.1),
                        0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .chat-input-field {
            flex: 1;
            padding: 10px 0;
            border: none;
            background: transparent;
            font-size: 16px;
            outline: none;
            color: #333;
            line-height: 1.5;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
        }

        .chat-input-field::placeholder {
            color: rgba(0, 0, 0, 0.35);
            font-size: 15px;
        }
        
        .chat-input-field:focus {
            background: transparent;
        }

        /* ÂèëÈÄÅÊåâÈíÆ - ÊûÅÁÆÄÁ∫∏È£ûÊú∫È£éÊ†º */
        .send-btn {
            background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%);
            border: none;
            padding: 0;
            color: white;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 20px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .send-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.3s ease;
        }

        .send-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .send-btn:hover::before {
            transform: translate(-50%, -50%) scale(1.2);
        }
        
        .send-btn:active {
            transform: translateY(0) scale(0.96);
        }

        /* ÂèëÈÄÅÂä®ÁîªÊïàÊûú */
        .send-btn.sending {
            animation: paperPlane 0.6s ease-out;
        }

        @keyframes paperPlane {
            0% {
                transform: translateY(-1px) scale(1);
            }
            50% {
                transform: translateY(-3px) scale(1.1) rotate(10deg);
            }
            100% {
                transform: translateY(-1px) scale(1) rotate(0deg);
            }
        }

        .send-btn.sending svg {
            animation: planeFly 0.6s ease-out;
        }

        @keyframes planeFly {
            0% {
                transform: translateX(0) rotate(0deg);
            }
            50% {
                transform: translateX(2px) rotate(15deg);
            }
            100% {
                transform: translateX(0) rotate(0deg);
            }
        }

        /* Ê∑ªÂä†È¢ùÂ§ñÁöÑÂäüËÉΩÊåâÈíÆÂå∫ÂüüÔºàÂèØÈÄâÔºâ */
        .input-extras {
            display: flex;
            gap: 8px;
            margin-right: 8px;
            align-items: center;
        }

        .input-extra-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: transparent;
            border: none;
            color: rgba(0, 0, 0, 0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 16px;
        }

        .input-extra-btn:hover {
            background: rgba(0, 0, 0, 0.05);
            color: rgba(0, 0, 0, 0.7);
        }

        /* Âä®ÁîªÊïàÊûú */
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ÂìçÂ∫îÂºèË∞ÉÊï¥ */
        @media (max-width: 1200px) {
            .floating-chat {
                width: 525px;
                height: 675px;
                right: 15px;
            }
            
            .chat-window-messages {
                height: 495px;
            }
        }

        @media (max-width: 768px) {
            .floating-chat {
                width: 450px;
                height: 600px;
                right: 10px;
            }
            
            .chat-window-messages {
                height: 420px;
            }
        }

        /* VRMÁä∂ÊÄÅ‰ø°ÊÅØ */
        .vrm-status {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            color: white;
            backdrop-filter: blur(10px);
            font-size: 14px;
            z-index: 10;
        }

        /* Â∑¶‰æßÊéßÂà∂Èù¢Êùø */
        .left-panel {
            position: fixed;
            left: 20px;
            bottom: 20px;
            width: 250px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 100;
        }

        .panel-section {
            margin-bottom: 20px;
        }

        .panel-section h4 {
            color: #ffeaa7;
            margin-bottom: 10px;
            font-size: 14px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 5px;
        }

        .emotion-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 5px;
        }

        .emotion-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .emotion-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .emotion-btn.active {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            color: #2d3436;
        }

        #character-selector, #animation-selector {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 12px;
        }

        .play-animation-btn {
            width: 100%;
            margin-top: 10px;
            padding: 8px;
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .play-animation-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(116, 185, 255, 0.4);
        }

    </style>
</head>

<body>
    <!-- ÂºïÂÖ•Èí±ÂåÖÂíåËÅäÂ§©Á≥ªÁªü -->
    <script src="ai-chat-integration.js"></script>
    <script src="chat-system-v2.js"></script>
    <div class="game-container">
        <!-- Â∑¶‰æßVRMÂ±ïÁ§∫Âå∫ -->
        <div class="vrm-container">
            <canvas id="vrm-canvas" class="vrm-canvas"></canvas>
            
            <!-- AIÂØπËØùÊ∞îÊ≥° -->
            <div class="ai-speech-bubble" id="ai-speech-bubble" style="display: none;"></div>

            <!-- VRMÁä∂ÊÄÅ‰ø°ÊÅØ -->
            <div class="vrm-status" id="vrm-status" style="display: none;">
                <div>üé≠ VRMÁä∂ÊÄÅ: <span id="vrm-loaded">Âä†ËΩΩ‰∏≠...</span></div>
                <div>üé¨ ÂΩìÂâçÂä®Áîª: <span id="current-animation">Êó†</span></div>
                <div>üòä Ë°®ÊÉÖÁä∂ÊÄÅ: <span id="current-expression">‰∏≠ÊÄß</span></div>
                <div>üéµ Ëá™Âä®Áú®Áúº: <span id="auto-blinking">ÂºÄÂêØ</span></div>
            </div>


            <!-- Â§çÂè§Èü≥‰πêÊí≠ÊîæÂô® -->
            <div class="music-controls" id="music-controls">
                <div class="music-window-title">
                    Background Music
                    <div class="window-controls">
                        <button class="window-btn minimize-btn"></button>
                        <button class="window-btn maximize-btn"></button>
                        <button class="window-btn close-btn"></button>
                    </div>
                </div>
                <div class="music-player-content">
                    <div class="music-controls-row">
                        <button class="music-control-btn">‚èÆ</button>
                        <button class="music-control-btn play-btn" id="music-toggle" onclick="toggleMusic()">‚è∏</button>
                        <button class="music-control-btn">‚è≠</button>
                    </div>
                    <div class="volume-control">
                        <input type="range" class="volume-slider" id="volume-slider" min="0" max="100" value="50"
                            onchange="adjustVolume(this.value)">
                        <span class="volume-label" id="volume-label">50</span>
                    </div>
                </div>
            </div>
            

            <!-- ËÉåÊôØÈü≥‰πêÈü≥È¢ëÂÖÉÁ¥† -->
            <audio id="background-music" loop preload="auto">
                <source src="BG/bgm.mp3" type="audio/mpeg">
                ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÈü≥È¢ëÊí≠Êîæ„ÄÇ
            </audio>
            
            <!-- Èí±ÂåÖÁä∂ÊÄÅÊòæÁ§∫ÔºàÂ∑≤ÁôªÂΩïÊó∂ÊòæÁ§∫Ôºâ -->
            <div class="wallet-status-info" id="wallet-status-info" style="display: none;">
                <div class="wallet-avatar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 21 21">
                        <g fill="none" fill-rule="evenodd" transform="translate(3 4)">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" d="M.5 2.5h12a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2h-10a2 2 0 0 1-2-2zm1-2h9a1 1 0 0 1 1 1v1H.5v-1a1 1 0 0 1 1-1z"/>
                            <circle cx="11.5" cy="7.5" r="1" fill="currentColor"/>
                        </g>
                    </svg>
                </div>
                <span class="wallet-address" id="wallet-address">ËøûÊé•‰∏≠...</span>
                <button class="wallet-disconnect" onclick="disconnectWallet()">ÁôªÂá∫</button>
            </div>

        </div>

        <!-- Â∑¶‰æßÊéßÂà∂Èù¢Êùø -->
        <div class="left-panel" style="display: none;">
            <!-- Âø´Êç∑ÊéßÂà∂ -->
            <div class="panel-section">
                <h4>üòä Âø´Êç∑ÊéßÂà∂</h4>
                <div class="emotion-buttons">
                    <button class="emotion-btn" onclick="setExpression('neutral')">ÂºÄÂøÉ</button>
                    <button class="emotion-btn" onclick="setExpression('happy')">‰º§ÂøÉ</button>
                    <button class="emotion-btn" onclick="setExpression('sad')">ÁîüÊ∞î</button>
                    <button class="emotion-btn" onclick="setExpression('angry')">ÊÉäËÆ∂</button>
                    <button class="emotion-btn" onclick="setExpression('surprised')">ÊÄùËÄÉ</button>
                    <button class="emotion-btn" onclick="setExpression('relaxed')">‰∏≠ÊÄß</button>
                </div>
            </div>

            <!-- ËßíËâ≤ÈÄâÊã© -->
            <div class="panel-section">
                <h4>üë§ ËßíËâ≤ÈÄâÊã©</h4>
                <select id="character-selector" onchange="changeCharacter()">
                    <option value="">ÈÄâÊã©ËßíËâ≤...</option>
                </select>
            </div>

            <!-- Âä®ÁîªÊµãËØï -->
            <div class="panel-section">
                <h4>üé≠ Âä®ÁîªÊµãËØï</h4>
                <select id="animation-selector" onchange="">
                    <option value="">ÈÄâÊã©Âä®Áîª...</option>
                </select>
                <button class="play-animation-btn" onclick="playSelectedAnimation()">Êí≠ÊîæÂä®Áîª</button>
            </div>

            <!-- ËøîÂõûËßíËâ≤ÈÄâÊã© -->
            <button class="back-button" onclick="goToCharacterSelect()">‚Üê ËøîÂõûËßíËâ≤ÈÄâÊã©</button>
        </div>

        <!-- Èí±ÂåÖÁä∂ÊÄÅÊòæÁ§∫ -->
        <div class="wallet-status" id="wallet-status" style="display: none;">
            <span>Èí±ÂåÖ:</span>
            <span class="wallet-address" id="wallet-address"></span>
            <button class="wallet-disconnect" onclick="disconnectWallet()">Êñ≠ÂºÄ</button>
        </div>


        <!-- ÊÇ¨ÊµÆËÅäÂ§©Ê°Ü -->
        <div class="floating-chat" id="floating-chat">
            <!-- ÊâãÊú∫Top BarÈ£éÊ†ºËÅäÂ§©Ê°ÜÂ§¥ÈÉ® -->
            <div class="chat-window-header">
                <!-- ÁúüÂÆûÊâãÊú∫Áä∂ÊÄÅÊ†è -->
                <div class="phone-status-bar">
                    <div class="status-left">
                        <div class="carrier-info">
                            <svg width="18" height="12" viewBox="0 0 18 12" fill="currentColor">
                                <rect x="0" y="8" width="2" height="4" rx="0.5"/>
                                <rect x="4" y="6" width="2" height="6" rx="0.5"/>
                                <rect x="8" y="4" width="2" height="8" rx="0.5"/>
                                <rect x="12" y="2" width="2" height="10" rx="0.5"/>
                            </svg>
                            <span>docomo</span>
                        </div>
                        <span class="network-type">4G</span>
                    </div>
                    <div class="status-center">
                        <div class="time-display" id="phone-time">1:26</div>
                    </div>
                    <div class="status-right">
                        <span class="status-icon">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8Z"/>
                            </svg>
                        </span>
                        <span class="status-icon">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M17.81,4.47C17.73,4.47 17.65,4.45 17.58,4.41C15.66,3.42 14,3.42 12.34,4.41C12.26,4.45 12.18,4.47 12.1,4.47C12,4.47 11.93,4.45 11.85,4.41C9.93,3.42 8.27,3.42 6.61,4.41C6.54,4.45 6.46,4.47 6.38,4.47C6.28,4.47 6.21,4.45 6.13,4.41L5.5,4.1C5.32,4 5.1,4.08 5,4.26C4.92,4.44 5,4.66 5.18,4.76L5.81,5.07C5.89,5.11 5.97,5.13 6.05,5.13C6.15,5.13 6.22,5.11 6.3,5.07C7.92,4.08 9.58,4.08 11.2,5.07C11.28,5.11 11.36,5.13 11.44,5.13C11.54,5.13 11.61,5.11 11.69,5.07C13.31,4.08 14.97,4.08 16.59,5.07C16.67,5.11 16.75,5.13 16.83,5.13C16.93,5.13 17,5.11 17.08,5.07L17.71,4.76C17.89,4.66 17.97,4.44 17.89,4.26C17.81,4.08 17.59,4 17.41,4.1L17.81,4.47Z"/>
                            </svg>
                        </span>
                        <span class="status-icon">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M14,20A2,2 0 0,1 12,22A2,2 0 0,1 10,20H14M12,2A7,7 0 0,1 19,9C19,11.38 17.81,13.47 16,14.74V17A1,1 0 0,1 15,18H9A1,1 0 0,1 8,17V14.74C6.19,13.47 5,11.38 5,9A7,7 0 0,1 12,2M9,21H15A1,1 0 0,1 15,22H9A1,1 0 0,1 9,21Z"/>
                            </svg>
                        </span>
                        <span class="battery-percentage">79%</span>
                        <span class="status-icon">
                            <svg width="22" height="12" viewBox="0 0 24 12" fill="none">
                                <rect x="1" y="2" width="20" height="8" rx="2" stroke="currentColor" stroke-width="1"/>
                                <rect x="2.5" y="3.5" width="16" height="5" rx="1" fill="currentColor"/>
                                <rect x="22" y="5" width="2" height="2" rx="0.5" fill="currentColor"/>
                            </svg>
                        </span>
                    </div>
                </div>
                
                <!-- Âä®Êº´È£éÊ†ºËÅäÂ§©Ê†áÈ¢òÂå∫Âüü -->
                <div class="chat-title-area">
                    <div class="chat-user-info">
                        <div class="chat-user-avatar"></div>
                        <div class="chat-user-details">
                            <h3 class="chat-user-name" id="character-name">Alice</h3>
                            <p class="chat-user-status">Âú®Á∫ø</p>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button class="chat-action-btn" title="ÂèëÈÄÅÁÖßÁâá">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M21,19V5C21,3.89 20.1,3 19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19M21,19H5V5H19V19Z"/>
                                <circle cx="9" cy="9" r="2"/>
                                <path d="M21,15L18,12L15,15L13,13L5,21H19A2,2 0 0,0 21,19V15Z"/>
                            </svg>
                        </button>
                        <button class="chat-action-btn" title="ÂèëÈÄÅË°®ÊÉÖ">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12,2C13.1,2 14,2.9 14,4C14,5.1 13.1,6 12,6C10.9,6 10,5.1 10,4C10,2.9 10.9,2 12,2M21,9V7L15,1H5C3.89,1 3,1.89 3,3V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V9M19,19H5V19L5,3H13V9H19V19Z"/>
                                <circle cx="12" cy="12" r="1.5"/>
                                <circle cx="8" cy="10" r="1"/>
                                <circle cx="16" cy="10" r="1"/>
                                <path d="M8.5,14.5C9.5,16.5 14.5,16.5 15.5,14.5"/>
                            </svg>
                        </button>
                        <button class="chat-action-btn" title="ÂøÉÊÉÖËÆæÂÆö">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12,21.35L10.55,20.03C5.4,15.36 2,12.27 2,8.5 2,5.41 4.42,3 7.5,3C9.24,3 10.91,3.81 12,5.08C13.09,3.81 14.76,3 16.5,3C19.58,3 22,5.41 22,8.5C22,12.27 18.6,15.36 13.45,20.03L12,21.35Z"/>
                                <circle cx="12" cy="8.5" r="1.5" fill="white"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ËÅäÂ§©Ê∂àÊÅØÂå∫Âüü -->
            <div class="chat-window-messages" id="chat-window-messages">
                <!-- Ê∂àÊÅØÂ∞ÜÂä®ÊÄÅÊ∑ªÂä†Âà∞ËøôÈáå -->
                <div style="display: none;">
                    <span id="character-name">ËäôËéâËéé</span>
                </div>
            </div>

            <!-- ËÅäÂ§©ËæìÂÖ•Âå∫Âüü -->
            <div class="chat-window-input">
                <div class="input-container">
                    <input type="text" class="chat-input-field" id="chat-input-field" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." onkeypress="handleChatKeyPress(event)">
                    <button class="send-btn" onclick="sendChatMessage()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M2.01 21L23 12L2.01 3L2 10L17 12L2 14L2.01 21Z" fill="currentColor"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Êú™ÊéàÊùÉËÆøÈóÆÊèêÁ§∫ -->
        <div class="unauthorized-overlay" id="unauthorized-overlay" style="display: none;">
            <div class="unauthorized-content">
                <h2>üîí ÈúÄË¶ÅÈí±ÂåÖÈ™åËØÅ</h2>
                <p>ËØ∑ÂÖàËøûÊé•ÊÇ®ÁöÑSolanaÈí±ÂåÖÊâçËÉΩËÆøÈóÆAIÂ•≥ÂèãËÅäÂ§©ÂÆ§„ÄÇÊØè‰∏™Èí±ÂåÖÂú∞ÂùÄÈÉΩ‰ºöËé∑ÂæóÁã¨ÁâπÁöÑ‰∏™ÊÄßÂåñ‰ΩìÈ™åÔºÅ</p>
                <button class="connect-wallet-btn" onclick="redirectToCharacterSelect()">
                    ËøîÂõûËøûÊé•Èí±ÂåÖ
                </button>
            </div>
        </div>

    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
                "@pixiv/three-vrm": "https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@2/lib/three-vrm.module.min.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { VRMLoaderPlugin, VRMUtils } from '@pixiv/three-vrm';

        // ÂÆòÊñπ Mixamo Âà∞ VRM È™®È™ºÊò†Â∞Ñ
        const mixamoVRMRigMap = {
            mixamorigHips: 'hips',
            mixamorigSpine: 'spine',
            mixamorigSpine1: 'chest',
            mixamorigSpine2: 'upperChest',
            mixamorigNeck: 'neck',
            mixamorigHead: 'head',
            mixamorigLeftShoulder: 'leftShoulder',
            mixamorigLeftArm: 'leftUpperArm',
            mixamorigLeftForeArm: 'leftLowerArm',
            mixamorigLeftHand: 'leftHand',
            mixamorigLeftHandThumb1: 'leftThumbMetacarpal',
            mixamorigLeftHandThumb2: 'leftThumbProximal',
            mixamorigLeftHandThumb3: 'leftThumbDistal',
            mixamorigLeftHandIndex1: 'leftIndexProximal',
            mixamorigLeftHandIndex2: 'leftIndexIntermediate',
            mixamorigLeftHandIndex3: 'leftIndexDistal',
            mixamorigLeftHandMiddle1: 'leftMiddleProximal',
            mixamorigLeftHandMiddle2: 'leftMiddleIntermediate',
            mixamorigLeftHandMiddle3: 'leftMiddleDistal',
            mixamorigLeftHandRing1: 'leftRingProximal',
            mixamorigLeftHandRing2: 'leftRingIntermediate',
            mixamorigLeftHandRing3: 'leftRingDistal',
            mixamorigLeftHandPinky1: 'leftLittleProximal',
            mixamorigLeftHandPinky2: 'leftLittleIntermediate',
            mixamorigLeftHandPinky3: 'leftLittleDistal',
            mixamorigRightShoulder: 'rightShoulder',
            mixamorigRightArm: 'rightUpperArm',
            mixamorigRightForeArm: 'rightLowerArm',
            mixamorigRightHand: 'rightHand',
            mixamorigRightHandPinky1: 'rightLittleProximal',
            mixamorigRightHandPinky2: 'rightLittleIntermediate',
            mixamorigRightHandPinky3: 'rightLittleDistal',
            mixamorigRightHandRing1: 'rightRingProximal',
            mixamorigRightHandRing2: 'rightRingIntermediate',
            mixamorigRightHandRing3: 'rightRingDistal',
            mixamorigRightHandMiddle1: 'rightMiddleProximal',
            mixamorigRightHandMiddle2: 'rightMiddleIntermediate',
            mixamorigRightHandMiddle3: 'rightMiddleDistal',
            mixamorigRightHandIndex1: 'rightIndexProximal',
            mixamorigRightHandIndex2: 'rightIndexIntermediate',
            mixamorigRightHandIndex3: 'rightIndexDistal',
            mixamorigRightHandThumb1: 'rightThumbMetacarpal',
            mixamorigRightHandThumb2: 'rightThumbProximal',
            mixamorigRightHandThumb3: 'rightThumbDistal',
            mixamorigLeftUpLeg: 'leftUpperLeg',
            mixamorigLeftLeg: 'leftLowerLeg',
            mixamorigLeftFoot: 'leftFoot',
            mixamorigLeftToeBase: 'leftToes',
            mixamorigRightUpLeg: 'rightUpperLeg',
            mixamorigRightLeg: 'rightLowerLeg',
            mixamorigRightFoot: 'rightFoot',
            mixamorigRightToeBase: 'rightToes',
        };

        // ActorCore Âà∞ VRM È™®È™ºÊò†Â∞Ñ
        const actorCoreVRMRigMap = {
            CC_Base_Hip: 'hips',
            CC_Base_Waist: 'spine',
            CC_Base_Spine01: 'chest',
            CC_Base_Spine02: 'upperChest',
            CC_Base_NeckTwist01: 'neck',
            CC_Base_Head: 'head',
            CC_Base_L_Clavicle: 'leftShoulder',
            CC_Base_L_Upperarm: 'leftUpperArm',
            CC_Base_L_Forearm: 'leftLowerArm',
            CC_Base_L_Hand: 'leftHand',
            CC_Base_L_Thumb1: 'leftThumbMetacarpal',
            CC_Base_L_Thumb2: 'leftThumbProximal',
            CC_Base_L_Thumb3: 'leftThumbDistal',
            CC_Base_L_Index1: 'leftIndexProximal',
            CC_Base_L_Index2: 'leftIndexIntermediate',
            CC_Base_L_Index3: 'leftIndexDistal',
            CC_Base_L_Mid1: 'leftMiddleProximal',
            CC_Base_L_Mid2: 'leftMiddleIntermediate',
            CC_Base_L_Mid3: 'leftMiddleDistal',
            CC_Base_L_Ring1: 'leftRingProximal',
            CC_Base_L_Ring2: 'leftRingIntermediate',
            CC_Base_L_Ring3: 'leftRingDistal',
            CC_Base_L_Pinky1: 'leftLittleProximal',
            CC_Base_L_Pinky2: 'leftLittleIntermediate',
            CC_Base_L_Pinky3: 'leftLittleDistal',
            CC_Base_R_Clavicle: 'rightShoulder',
            CC_Base_R_Upperarm: 'rightUpperArm',
            CC_Base_R_Forearm: 'rightLowerArm',
            CC_Base_R_Hand: 'rightHand',
            CC_Base_R_Pinky1: 'rightLittleProximal',
            CC_Base_R_Pinky2: 'rightLittleIntermediate',
            CC_Base_R_Pinky3: 'rightLittleDistal',
            CC_Base_R_Ring1: 'rightRingProximal',
            CC_Base_R_Ring2: 'rightRingIntermediate',
            CC_Base_R_Ring3: 'rightRingDistal',
            CC_Base_R_Mid1: 'rightMiddleProximal',
            CC_Base_R_Mid2: 'rightMiddleIntermediate',
            CC_Base_R_Mid3: 'rightMiddleDistal',
            CC_Base_R_Index1: 'rightIndexProximal',
            CC_Base_R_Index2: 'rightIndexIntermediate',
            CC_Base_R_Index3: 'rightIndexDistal',
            CC_Base_R_Thumb1: 'rightThumbMetacarpal',
            CC_Base_R_Thumb2: 'rightThumbProximal',
            CC_Base_R_Thumb3: 'rightThumbDistal',
            CC_Base_L_Thigh: 'leftUpperLeg',
            CC_Base_L_Calf: 'leftLowerLeg',
            CC_Base_L_Foot: 'leftFoot',
            CC_Base_L_ToeBase: 'leftToes',
            CC_Base_R_Thigh: 'rightUpperLeg',
            CC_Base_R_Calf: 'rightLowerLeg',
            CC_Base_R_Foot: 'rightFoot',
            CC_Base_R_ToeBase: 'rightToes',
        };

        // ÂÆåÊï¥Âä®ÁîªÊò†Â∞Ñ - ÂåÖÂê´ÊâÄÊúâmixamoÂä®ÁîªÂíåActorCoreÂä®Áîª
        const animationMap = {
            // ÂæÖÊú∫Âä®Áîª
            'Breathing Idle': 'mixamo animation/Breathing Idle.fbx',
            'Happy Idle': 'mixamo animation/Happy Idle.fbx',
            // Mixamo Âä®Áîª
            'Acknowledging': 'mixamo animation/Acknowledging.fbx',
            'Agreeing': 'mixamo animation/Agreeing.fbx',
            'Agreeing 2': 'mixamo animation/Agreeing 2.fbx',
            'Angry': 'mixamo animation/Angry.fbx',
            'Bashful': 'mixamo animation/Bashful.fbx',
            'Blow A Kiss': 'mixamo animation/Blow A Kiss.fbx',
            'Cheering': 'mixamo animation/Cheering.fbx',
            'Clapping': 'mixamo animation/Clapping.fbx',
            'Crying': 'mixamo animation/Crying.fbx',
            'Gangnam Style': 'mixamo animation/Gangnam Style.fbx',
            'Happy': 'mixamo animation/Happy.fbx',
            'Hard Head Nod': 'mixamo animation/Hard Head Nod.fbx',
            'Hip Hop Dancing': 'mixamo animation/Hip Hop Dancing.fbx',
            'Hip Hop Dancing 2': 'mixamo animation/Hip Hop Dancing 2.fbx',
            'Joyful Jump': 'mixamo animation/Joyful Jump.fbx',
            'Looking': 'mixamo animation/Looking.fbx',
            'Rejected': 'mixamo animation/Rejected.fbx',
            'Rumba Dancing': 'mixamo animation/Rumba Dancing.fbx',
            'Salute': 'mixamo animation/Salute.fbx',
            'Spin In Place': 'mixamo animation/Spin In Place.fbx',
            'Standing Greeting 2': 'mixamo animation/Standing Greeting 2.fbx',
            'Surprised': 'mixamo animation/Surprised.fbx',
            'Thankful': 'mixamo animation/Thankful.fbx',
            'Thinking': 'mixamo animation/Thinking.fbx',
            'Yawn': 'mixamo animation/Yawn.fbx',
            // ActorCore Âä®Áîª
            'Stand Happy (ActorCore)': 'actorcore animation/stand-happy-f.fbx'
        };

        // ÊÉÖÊÑüÊò†Â∞Ñ‰øùÊåÅ‰∏çÂèòÔºåÁî®‰∫éAIËá™Âä®Ëß¶Âèë
        const emotionAnimationMap = {
            happy: 'mixamo animation/Happy.fbx',
            sad: 'mixamo animation/Crying.fbx',
            angry: 'mixamo animation/Angry.fbx',
            surprised: 'mixamo animation/Surprised.fbx',
            thinking: 'mixamo animation/Thinking.fbx',
            greeting: 'mixamo animation/Standing Greeting 2.fbx',
            agreeing: 'mixamo animation/Agreeing.fbx',
            rejecting: 'mixamo animation/Rejected.fbx',
            clapping: 'mixamo animation/Clapping.fbx',
            cheering: 'mixamo animation/Cheering.fbx',
            thankful: 'mixamo animation/Thankful.fbx',
            bashful: 'mixamo animation/Bashful.fbx',
            neutral: 'mixamo animation/Breathing Idle.fbx',
            breathing: 'mixamo animation/Breathing Idle.fbx',
            kiss: 'mixamo animation/Blow A Kiss.fbx',
            dancing: 'mixamo animation/Hip Hop Dancing.fbx'
        };

        // ÂÖ≥ÈîÆËØçÊÉÖÊÑüÊò†Â∞Ñ
        const keywordEmotionMap = {
            // ÂºÄÂøÉÁõ∏ÂÖ≥
            'ÂºÄÂøÉ': 'happy',
            'È´òÂÖ¥': 'happy',
            'Âø´‰πê': 'happy',
            'ÂìàÂìà': 'happy',
            'Á¨ë': 'happy',
            'Â•ΩÊ£í': 'happy',
            'Â§™Â•Ω‰∫Ü': 'happy',
            'ÂñúÊ¨¢': 'happy',
            'Áà±': 'happy',
            'Ê£í': 'cheering',

            // ‰º§ÂøÉÁõ∏ÂÖ≥
            '‰º§ÂøÉ': 'sad',
            'ÈöæËøá': 'sad',
            'Âì≠': 'sad',
            'ÁóõËã¶': 'sad',
            'Â§±Êúõ': 'sad',
            'Ê≤Æ‰∏ß': 'sad',

            // ÁîüÊ∞îÁõ∏ÂÖ≥
            'ÁîüÊ∞î': 'angry',
            'ÊÑ§ÊÄí': 'angry',
            'ËÆ®Âéå': 'angry',
            'ÁÉ¶': 'angry',
            'Ê∞îÊ≠ª‰∫Ü': 'angry',

            // ÊÉäËÆ∂Áõ∏ÂÖ≥
            'ÊÉäËÆ∂': 'surprised',
            'ÈúáÊÉä': 'surprised',
            '‰∏çÊï¢Áõ∏‰ø°': 'surprised',
            'Â§©Âì™': 'surprised',
            'Âìá': 'surprised',

            // ÊÄùËÄÉÁõ∏ÂÖ≥
            'ÊÉ≥': 'thinking',
            'ÊÄùËÄÉ': 'thinking',
            'ËÄÉËôë': 'thinking',
            'ÂóØ': 'thinking',

            // ÈóÆÂÄôÁõ∏ÂÖ≥
            '‰Ω†Â•Ω': 'greeting',
            'Âó®': 'greeting',
            'Êó©‰∏äÂ•Ω': 'greeting',
            'Êôö‰∏äÂ•Ω': 'greeting',
            'ÂÜçËßÅ': 'greeting',

            // ÂêåÊÑèÁõ∏ÂÖ≥
            'Â•ΩÁöÑ': 'agreeing',
            'ÂêåÊÑè': 'agreeing',
            'ÊòØÁöÑ': 'agreeing',
            'ÂØπ': 'agreeing',
            'Ê≤°Èîô': 'agreeing',

            // ÊãíÁªùÁõ∏ÂÖ≥
            '‰∏ç': 'rejecting',
            '‰∏çË¶Å': 'rejecting',
            'ÊãíÁªù': 'rejecting',
            '‰∏çË°å': 'rejecting',

            // ÊÑüË∞¢Áõ∏ÂÖ≥
            'Ë∞¢Ë∞¢': 'thankful',
            'ÊÑüË∞¢': 'thankful',
            'Ë∞¢': 'thankful',

            // ÂÆ≥ÁæûÁõ∏ÂÖ≥
            'ÂÆ≥Áæû': 'bashful',
            '‰∏çÂ•ΩÊÑèÊÄù': 'bashful',
            'ËÑ∏Á∫¢': 'bashful',

            // ‰∫≤ÂêªÁõ∏ÂÖ≥
            '‰∫≤': 'kiss',
            'Âêª': 'kiss',
            '‰πà‰πà': 'kiss',

            // Ë∑≥ËàûÁõ∏ÂÖ≥
            'Ë∑≥Ëàû': 'dancing',
            'ËàûËπà': 'dancing',
            'Èü≥‰πê': 'dancing'
        };

        // ÂÆòÊñπ loadMixamoAnimation ÂáΩÊï∞
        function loadMixamoAnimation(url, vrm) {
            const loader = new FBXLoader();
            return loader.loadAsync(url).then((asset) => {
                const clip = THREE.AnimationClip.findByName(asset.animations, 'mixamo.com');

                if (!clip) {
                    throw new Error('Êâæ‰∏çÂà∞ Mixamo Âä®ÁîªÊï∞ÊçÆ');
                }

                const tracks = [];
                const restRotationInverse = new THREE.Quaternion();
                const parentRestWorldRotation = new THREE.Quaternion();
                const _quatA = new THREE.Quaternion();
                const _vec3 = new THREE.Vector3();

                const motionHipsHeight = asset.getObjectByName('mixamorigHips').position.y;
                const vrmHipsHeight = vrm.humanoid.normalizedRestPose.hips.position[1];
                const hipsPositionScale = vrmHipsHeight / motionHipsHeight;

                clip.tracks.forEach((track) => {
                    const trackSplitted = track.name.split('.');
                    const mixamoRigName = trackSplitted[0];
                    const vrmBoneName = mixamoVRMRigMap[mixamoRigName];
                    const vrmNodeName = vrm.humanoid?.getNormalizedBoneNode(vrmBoneName)?.name;
                    const mixamoRigNode = asset.getObjectByName(mixamoRigName);

                    if (vrmNodeName != null) {
                        const propertyName = trackSplitted[1];

                        mixamoRigNode.getWorldQuaternion(restRotationInverse).invert();
                        mixamoRigNode.parent.getWorldQuaternion(parentRestWorldRotation);

                        if (track instanceof THREE.QuaternionKeyframeTrack) {
                            for (let i = 0; i < track.values.length; i += 4) {
                                const flatQuaternion = track.values.slice(i, i + 4);
                                _quatA.fromArray(flatQuaternion);

                                _quatA
                                    .premultiply(parentRestWorldRotation)
                                    .multiply(restRotationInverse);

                                _quatA.toArray(flatQuaternion);
                                flatQuaternion.forEach((v, index) => {
                                    track.values[index + i] = v;
                                });
                            }

                            tracks.push(
                                new THREE.QuaternionKeyframeTrack(
                                    `${vrmNodeName}.${propertyName}`,
                                    track.times,
                                    track.values.map((v, i) => (vrm.meta?.metaVersion === '0' && i % 2 === 0 ? -v : v)),
                                )
                            );

                        } else if (track instanceof THREE.VectorKeyframeTrack) {
                            const value = track.values.map((v, i) =>
                                (vrm.meta?.metaVersion === '0' && i % 3 !== 1 ? -v : v) * hipsPositionScale
                            );
                            tracks.push(new THREE.VectorKeyframeTrack(`${vrmNodeName}.${propertyName}`, track.times, value));
                        }
                    }
                });

                return new THREE.AnimationClip('vrmAnimation', clip.duration, tracks);
            });
        }

        // ActorCore Âä®ÁîªÂä†ËΩΩÂáΩÊï∞
        function loadActorCoreAnimation(url, vrm) {
            const loader = new FBXLoader();
            return loader.loadAsync(url).then((asset) => {
                // ActorCoreÂä®ÁîªÈÄöÂ∏∏Á¨¨‰∏Ä‰∏™Â∞±ÊòØ‰∏ªË¶ÅÂä®Áîª
                const clip = asset.animations[0];

                if (!clip) {
                    throw new Error('Êâæ‰∏çÂà∞ ActorCore Âä®ÁîªÊï∞ÊçÆ');
                }

                const tracks = [];
                const restRotationInverse = new THREE.Quaternion();
                const parentRestWorldRotation = new THREE.Quaternion();
                const _quatA = new THREE.Quaternion();
                const _vec3 = new THREE.Vector3();

                // Â∞ùËØïÊâæÂà∞ActorCoreÁöÑHipÈ™®È™ºÊù•ËÆ°ÁÆóÁº©Êîæ
                let motionHipsHeight = 100; // ÈªòËÆ§ÂÄº
                const actorCoreHips = asset.getObjectByName('CC_Base_Hip');
                if (actorCoreHips) {
                    motionHipsHeight = actorCoreHips.position.y;
                }

                const vrmHipsHeight = vrm.humanoid.normalizedRestPose.hips.position[1];
                const hipsPositionScale = vrmHipsHeight / motionHipsHeight;

                console.log(`üé¨ ActorCoreÂä®ÁîªÂ§ÑÁêÜ: ${clip.name}, ËΩ®ÈÅìÊï∞Èáè: ${clip.tracks.length}`);

                clip.tracks.forEach((track) => {
                    const trackSplitted = track.name.split('.');
                    const actorCoreRigName = trackSplitted[0];
                    const vrmBoneName = actorCoreVRMRigMap[actorCoreRigName];
                    const vrmNodeName = vrm.humanoid?.getNormalizedBoneNode(vrmBoneName)?.name;
                    const actorCoreRigNode = asset.getObjectByName(actorCoreRigName);

                    if (vrmNodeName != null && actorCoreRigNode) {
                        const propertyName = trackSplitted[1];

                        actorCoreRigNode.getWorldQuaternion(restRotationInverse).invert();
                        actorCoreRigNode.parent.getWorldQuaternion(parentRestWorldRotation);

                        if (track instanceof THREE.QuaternionKeyframeTrack) {
                            for (let i = 0; i < track.values.length; i += 4) {
                                const flatQuaternion = track.values.slice(i, i + 4);
                                _quatA.fromArray(flatQuaternion);

                                _quatA
                                    .premultiply(parentRestWorldRotation)
                                    .multiply(restRotationInverse);

                                _quatA.toArray(flatQuaternion);
                                flatQuaternion.forEach((v, index) => {
                                    track.values[index + i] = v;
                                });
                            }

                            tracks.push(
                                new THREE.QuaternionKeyframeTrack(
                                    `${vrmNodeName}.${propertyName}`,
                                    track.times,
                                    track.values.map((v, i) => (vrm.meta?.metaVersion === '0' && i % 2 === 0 ? -v : v)),
                                )
                            );

                        } else if (track instanceof THREE.VectorKeyframeTrack) {
                            const value = track.values.map((v, i) =>
                                (vrm.meta?.metaVersion === '0' && i % 3 !== 1 ? -v : v) * hipsPositionScale
                            );
                            tracks.push(new THREE.VectorKeyframeTrack(`${vrmNodeName}.${propertyName}`, track.times, value));
                        }
                    } else if (!vrmBoneName) {
                        console.log(`‚ö†Ô∏è Êú™Êò†Â∞ÑÁöÑActorCoreÈ™®È™º: ${actorCoreRigName}`);
                    }
                });

                console.log(`‚úÖ ActorCoreÂä®ÁîªÈáçÂÆöÂêëÂÆåÊàêÔºåÁîüÊàêËΩ®ÈÅìÊï∞Èáè: ${tracks.length}`);
                return new THREE.AnimationClip('actorCoreAnimation', clip.duration, tracks);
            });
        }

        // Âú∫ÊôØËÆæÁΩÆ
        const canvas = document.getElementById('vrm-canvas');
        const renderer = new THREE.WebGLRenderer({
            canvas: canvas,
            antialias: true,
            alpha: false  // Êîπ‰∏∫ falseÔºåÁ°Æ‰øùËÉåÊôØ‰∏çÈÄèÊòé
        });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.toneMapping = THREE.NoToneMapping;  // ‰∏ç‰ΩøÁî®Ëâ≤Ë∞ÉÊò†Â∞ÑÔºå‰øùÊåÅÂéüÂßãÈ¢úËâ≤
        renderer.toneMappingExposure = 1.0;  // Ê†áÂáÜÊõùÂÖâ
        renderer.outputColorSpace = THREE.SRGBColorSpace;  // Ê≠£Á°ÆÁöÑËâ≤ÂΩ©Á©∫Èó¥

        const camera = new THREE.PerspectiveCamera(30.0, 1, 0.1, 20.0);
        // Ë∞ÉÊï¥Áõ∏Êú∫‰ΩçÁΩÆ - ÂÖ®Ë∫´ËßÜËßí
        camera.position.set(0.0, 1.2, 5.0);  // Â±Ö‰∏≠ÔºåÈÄÇ‰∏≠È´òÂ∫¶ÔºåÊòæÁ§∫ÂÖ®Ë∫´

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.screenSpacePanning = true;
        controls.target.set(0.0, 0.5, 0.0);  // ÂØπÂáÜËßíËâ≤ÂÖ®Ë∫´‰∏≠ÂøÉ
        controls.update();

        const scene = new THREE.Scene();

        // ÂÖàËÆæÁΩÆ‰∏¥Êó∂ËÉåÊôØËâ≤
        scene.background = new THREE.Color(0x87CEEB);
        
        // Âä†ËΩΩËÉåÊôØÂõæÁâá
        console.log('üé® ÂºÄÂßãÂä†ËΩΩËÉåÊôØÂõæÁâá: BG/chatroom2.png');
        console.log('üåç ÂΩìÂâçURL:', window.location.href);
        
        const textureLoader = new THREE.TextureLoader();
        textureLoader.load(
            './BG/chatroom2.png',
            (texture) => {
                console.log('üé® ËÉåÊôØÁ∫πÁêÜÂä†ËΩΩÂÆåÊàê:', texture);
                console.log('üìê Á∫πÁêÜÂ∞∫ÂØ∏:', texture.image.width, 'x', texture.image.height);
                
                // Ë∞ÉÊï¥Á∫πÁêÜËÆæÁΩÆ‰ª•ÈÄÇÂ∫îÂÖ®Â±è
                texture.minFilter = THREE.LinearFilter;
                texture.magFilter = THREE.LinearFilter;
                texture.wrapS = THREE.ClampToEdgeWrapping;
                texture.wrapT = THREE.ClampToEdgeWrapping;
                texture.flipY = false; // Èò≤Ê≠¢ÂõæÁâá‰∏ä‰∏ãÈ¢†ÂÄí
                
                scene.background = texture;
                console.log('‚úÖ ËÉåÊôØÂõæÁâáËÆæÁΩÆÊàêÂäüÔºÅ');
                
                // Âº∫Âà∂Ê∏≤Êüì‰∏ÄÊ¨°
                if (renderer && scene && camera) {
                    renderer.render(scene, camera);
                }
            },
            (progress) => {
                const percent = progress.total ? (progress.loaded / progress.total * 100).toFixed(1) : '?';
                console.log('üìä ËÉåÊôØÂä†ËΩΩËøõÂ∫¶:', percent + '%');
            },
            (error) => {
                console.error('‚ö†Ô∏è ËÉåÊôØÂõæÁâáÂä†ËΩΩÂ§±Ë¥•:', error);
                console.error('‚ö†Ô∏è ÈîôËØØËØ¶ÊÉÖ:', error.message);
                console.error('‚ö†Ô∏è ÂÆåÊï¥Êñá‰ª∂Ë∑ØÂæÑ:', new URL('BG/chatroom2.png', window.location.href).href);
                // ‰øùÊåÅ‰∏¥Êó∂ËÉåÊôØËâ≤
            }
        );

        // ÁÖßÊòé - ÂèÇËÄÉÂÆòÊñπÁ§∫‰æã‰ºòÂåñ‰∫ÆÂ∫¶
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 1.2);
        directionalLight.position.set(1.0, 1.0, 1.0).normalize();
        directionalLight.castShadow = true;
        directionalLight.shadow.mapSize.setScalar(1024);
        scene.add(directionalLight);

        // Ê∑ªÂä†Ë°•ÂÖÖÂÖâÊ∫êÊèêÂçáÊï¥‰Ωì‰∫ÆÂ∫¶
        const fillLight = new THREE.DirectionalLight(0xffffff, 0.4);
        fillLight.position.set(-1.0, 0.5, -1.0).normalize();
        scene.add(fillLight);

        // ÂÖ®Â±ÄÂèòÈáè
        let currentVrm = null;
        let currentMixer = null;
        let footShadow = null;

        // ÂàõÂª∫ËÑöÂ∫ïÈò¥ÂΩ±ÂáΩÊï∞ - ÂèÇËÄÉcharacter-select.htmlÁöÑÂÆûÁé∞
        function createFootShadow(vrm) {
            // ÁßªÈô§‰πãÂâçÁöÑÈò¥ÂΩ±ÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
            if (footShadow) {
                scene.remove(footShadow);
                footShadow.geometry.dispose();
                footShadow.material.dispose();
            }

            // ÂàõÂª∫Ê∏êÂèòÂúÜÂΩ¢Èò¥ÂΩ± - Ê®°‰ªøcharacter-select.html
            const shadowCanvas = document.createElement('canvas');
            shadowCanvas.width = 128;
            shadowCanvas.height = 128;
            const context = shadowCanvas.getContext('2d');
            
            // ÂàõÂª∫ÂæÑÂêëÊ∏êÂèòÈò¥ÂΩ±
            const gradient = context.createRadialGradient(64, 64, 0, 64, 64, 64);
            gradient.addColorStop(0, 'rgba(0, 0, 0, 0.4)'); // ‰∏≠ÂøÉËæÉÊ∑±
            gradient.addColorStop(0.5, 'rgba(0, 0, 0, 0.2)'); // ‰∏≠Á≠âÈÄèÊòéÂ∫¶
            gradient.addColorStop(1, 'rgba(0, 0, 0, 0)'); // ËæπÁºòÈÄèÊòé
            
            context.fillStyle = gradient;
            context.fillRect(0, 0, 128, 128);
            
            const shadowTexture = new THREE.CanvasTexture(shadowCanvas);
            const shadowGeometry = new THREE.PlaneGeometry(2.2, 2.2);
            const shadowMaterial = new THREE.MeshBasicMaterial({ 
                map: shadowTexture,
                transparent: true,
                alphaTest: 0.001,
                depthWrite: false
            });
            
            footShadow = new THREE.Mesh(shadowGeometry, shadowMaterial);
            footShadow.rotation.x = -Math.PI / 2;
            footShadow.position.set(0, -0.82, 0); // Áõ¥Êé•Ë¥¥ÁùÄËÑöÂ∫ïÔºå‰∏écharacter-select.html‰∏ÄËá¥
            scene.add(footShadow);
            
            console.log('‚úÖ ÂàõÂª∫ËÑöÂ∫ïÈò¥ÂΩ±', {
                position: footShadow.position,
                size: '2.2x2.2'
            });
        }

        // Êõ¥Êñ∞Èò¥ÂΩ±‰ΩçÁΩÆÂáΩÊï∞ÔºàÁî®‰∫éÂä®ÁîªÊó∂Ôºâ
        function updateFootShadow() {
            if (!footShadow || !currentVrm) return;
            
            // ‰øùÊåÅÈò¥ÂΩ±‰ΩçÁΩÆÂõ∫ÂÆöÂú®ËÑöÂ∫ï
            footShadow.position.x = currentVrm.scene.position.x || 0;
            footShadow.position.y = -0.82; // Âõ∫ÂÆöÈ´òÂ∫¶Ôºå‰∏écharacter-select.html‰∏ÄËá¥
            footShadow.position.z = currentVrm.scene.position.z || 0;
        }
        let currentAction = null;
        let defaultVrmFile = 'Main VRM/Fliza VRM.vrm'; // ÈªòËÆ§VRMÊñá‰ª∂
        let currentAnimationUrl = null;

        // Ë°®ÊÉÖÂíåAIÊéßÂà∂ÂèòÈáè
        let autoBlinking = true;
        let blinkTimer = 0;
        let blinkFrequency = 3.0;
        let availableExpressions = [];
        let isBlinking = false;
        let blinkDuration = 0.15;
        let aiModeEnabled = true;
        let currentEmotion = 'neutral';
        let isTyping = false;

        // ËÅäÂ§©Áõ∏ÂÖ≥ÂèòÈáè
        let chatHistory = [];

        // Èü≥‰πêÊéßÂà∂ÂèòÈáè
        let backgroundMusic = null;
        let isMusicPlaying = false;
        let musicVolume = 0.5; // ÈªòËÆ§50%Èü≥Èáè

        // Ë°®ÊÉÖÁõ∏ÂÖ≥ÂáΩÊï∞
        function getAvailableExpressions(vrm) {
            if (!vrm.expressionManager) return [];

            const expressions = [];
            const presets = ['happy', 'angry', 'sad', 'surprised', 'relaxed', 'blink'];

            presets.forEach(preset => {
                try {
                    const expressionName = vrm.expressionManager.getExpressionTrackName(preset);
                    if (expressionName) {
                        expressions.push(preset);
                    }
                } catch (e) {
                    // Ë°®ÊÉÖ‰∏çÂ≠òÂú®
                }
            });

            console.log(`üòä ÂèëÁé∞ÂèØÁî®Ë°®ÊÉÖ: ${expressions.join(', ')}`);
            return expressions;
        }

        function setExpression(expressionName, value) {
            if (!currentVrm || !currentVrm.expressionManager) return;

            try {
                currentVrm.expressionManager.setValue(expressionName, value);
                console.log(`üòä ËÆæÁΩÆË°®ÊÉÖ: ${expressionName} = ${value}`);

                // Êõ¥Êñ∞Áä∂ÊÄÅÊòæÁ§∫
                if (value > 0.5) {
                    document.getElementById('current-expression').textContent = getEmotionText(expressionName);
                }
            } catch (e) {
                console.warn(`‚ö†Ô∏è Ë°®ÊÉÖ ${expressionName} ‰∏çÂèØÁî®:`, e);
            }
        }

        function resetExpressions() {
            if (!currentVrm || !currentVrm.expressionManager) return;

            availableExpressions.forEach(expr => {
                if (expr !== 'blink') {
                    currentVrm.expressionManager.setValue(expr, 0);
                }
            });

            document.getElementById('current-expression').textContent = '‰∏≠ÊÄß';
        }

        // Ë°®ÊÉÖÊµãËØïÂáΩÊï∞
        function testShyExpression() {
            console.log('üß™ ÊµãËØïÂÆ≥ÁæûË°®ÊÉÖ...');
            console.log('ÂèØÁî®Ë°®ÊÉÖ:', availableExpressions);
            
            if (!currentVrm || !currentVrm.expressionManager) {
                alert('VRMÊ®°ÂûãËøòÊú™Âä†ËΩΩÂÆåÊàêÔºÅ');
                return;
            }

            // ÈáçÁΩÆÊâÄÊúâË°®ÊÉÖ
            resetExpressions();
            
            // Â∞ùËØïÂ§öÁßçÂÆ≥ÁæûÁõ∏ÂÖ≥ÁöÑË°®ÊÉÖ
            const shyExpressions = ['shy', 'embarrassed', 'blush', 'surprised', 'sad'];
            let appliedExpression = null;
            
            shyExpressions.forEach(expr => {
                if (availableExpressions.includes(expr)) {
                    setExpression(expr, 1.0);
                    appliedExpression = expr;
                    console.log(`‚úÖ Â∫îÁî®Ë°®ÊÉÖ: ${expr}`);
                }
            });
            
            if (appliedExpression) {
                document.getElementById('current-expression').textContent = `ÂÆ≥Áæû (${appliedExpression})`;
                // 5ÁßíÂêéÊÅ¢Â§ç
                setTimeout(() => {
                    resetExpressions();
                }, 5000);
            } else {
                alert('ÂΩìÂâçVRMÊ®°Âûã‰∏çÊîØÊåÅÂÆ≥ÁæûË°®ÊÉÖ üòî\nÂèØÁî®Ë°®ÊÉÖ: ' + availableExpressions.join(', '));
            }
        }

        function testHappyExpression() {
            console.log('üß™ ÊµãËØïÂºÄÂøÉË°®ÊÉÖ...');
            
            if (!currentVrm || !currentVrm.expressionManager) {
                alert('VRMÊ®°ÂûãËøòÊú™Âä†ËΩΩÂÆåÊàêÔºÅ');
                return;
            }

            resetExpressions();
            
            if (availableExpressions.includes('happy')) {
                setExpression('happy', 1.0);
                document.getElementById('current-expression').textContent = 'ÂºÄÂøÉ';
                setTimeout(() => resetExpressions(), 3000);
            } else {
                alert('ÂΩìÂâçVRMÊ®°Âûã‰∏çÊîØÊåÅÂºÄÂøÉË°®ÊÉÖ');
            }
        }

        function testSadExpression() {
            console.log('üß™ ÊµãËØïÈöæËøáË°®ÊÉÖ...');
            
            if (!currentVrm || !currentVrm.expressionManager) {
                alert('VRMÊ®°ÂûãËøòÊú™Âä†ËΩΩÂÆåÊàêÔºÅ');
                return;
            }

            resetExpressions();
            
            if (availableExpressions.includes('sad')) {
                setExpression('sad', 1.0);
                document.getElementById('current-expression').textContent = 'ÈöæËøá';
                setTimeout(() => resetExpressions(), 3000);
            } else {
                alert('ÂΩìÂâçVRMÊ®°Âûã‰∏çÊîØÊåÅÈöæËøáË°®ÊÉÖ');
            }
        }

        function resetAllExpressions() {
            console.log('üß™ ÈáçÁΩÆÊâÄÊúâË°®ÊÉÖ...');
            resetExpressions();
        }

        function performBlink() {
            if (!currentVrm || !availableExpressions.includes('blink') || isBlinking) return;

            isBlinking = true;
            const startTime = performance.now();

            function animateBlink() {
                const elapsed = (performance.now() - startTime) / 1000;
                const progress = elapsed / blinkDuration;

                if (progress < 0.5) {
                    const blinkValue = Math.sin(progress * Math.PI * 2) * 0.5 + 0.5;
                    setExpression('blink', blinkValue);
                } else if (progress < 1.0) {
                    const blinkValue = Math.sin((1 - progress) * Math.PI * 2) * 0.5 + 0.5;
                    setExpression('blink', blinkValue);
                } else {
                    setExpression('blink', 0);
                    isBlinking = false;
                    return;
                }

                requestAnimationFrame(animateBlink);
            }

            animateBlink();
        }

        // Âä®ÁîªÂä†ËΩΩÂáΩÊï∞
        // ÂæÖÊú∫Âä®ÁîªÁõ∏ÂÖ≥ÂèòÈáè
        let idleAnimationUrl = 'mixamo animation/Breathing Idle.fbx';
        let idleAction = null;
        let returnToIdleTimer = null;
        
        async function loadAnimation(animationUrl, emotionName = null) {
            if (!currentVrm) return;

            try {
                // Ê∏ÖÈô§‰πãÂâçÁöÑËøîÂõûÂæÖÊú∫ËÆ°Êó∂Âô®
                if (returnToIdleTimer) {
                    clearTimeout(returnToIdleTimer);
                    returnToIdleTimer = null;
                }
                
                currentAnimationUrl = animationUrl;

                // Âà§Êñ≠ÊòØÂê¶ÊòØÂæÖÊú∫Âä®Áîª
                const isIdleAnimation = animationUrl === idleAnimationUrl || animationUrl.includes('Breathing Idle');
                
                // Âà§Êñ≠ÊòØActorCoreËøòÊòØMixamoÂä®Áîª
                const isActorCore = animationUrl.includes('actorcore animation');
                const clip = isActorCore ?
                    await loadActorCoreAnimation(animationUrl, currentVrm) :
                    await loadMixamoAnimation(animationUrl, currentVrm);

                if (currentMixer) {
                    const newAction = currentMixer.clipAction(clip);
                    newAction.reset().play();
                    newAction.timeScale = 1.0;
                    
                    // Â¶ÇÊûúÊòØÂæÖÊú∫Âä®ÁîªÔºåËÆæÁΩÆ‰∏∫Âæ™ÁéØ
                    if (isIdleAnimation) {
                        newAction.loop = THREE.LoopRepeat;
                        idleAction = newAction;
                    } else {
                        // ÈùûÂæÖÊú∫Âä®ÁîªËÆæÁΩÆ‰∏∫Êí≠Êîæ‰∏ÄÊ¨°
                        newAction.loop = THREE.LoopOnce;
                        newAction.clampWhenFinished = true;
                    }

                    if (currentAction && currentAction !== newAction) {
                        currentAction.crossFadeTo(newAction, 1.0, false);
                    }

                    currentAction = newAction;
                    
                    // Â¶ÇÊûú‰∏çÊòØÂæÖÊú∫Âä®ÁîªÔºåËÆæÁΩÆÂÆöÊó∂Âô®ËøîÂõûÂæÖÊú∫
                    if (!isIdleAnimation) {
                        // Ëé∑ÂèñÂä®ÁîªÊó∂ÈïøÔºåÂä®ÁîªÁªìÊùüÂêéËøîÂõûÂæÖÊú∫
                        const animationDuration = clip.duration * 1000; // ËΩ¨Êç¢‰∏∫ÊØ´Áßí
                        returnToIdleTimer = setTimeout(() => {
                            console.log('üîÑ ËøîÂõûÂæÖÊú∫Âä®Áîª');
                            loadAnimation(idleAnimationUrl);
                        }, animationDuration + 500); // Âä®ÁîªÁªìÊùüÂêé0.5ÁßíËøîÂõûÂæÖÊú∫
                    }
                }

                // Êõ¥Êñ∞Áä∂ÊÄÅÊòæÁ§∫
                const animationName = animationUrl.split('/').pop().split('.')[0];
                document.getElementById('current-animation').textContent = animationName;

                if (emotionName) {
                    currentEmotion = emotionName;
                    // ÂêåÊó∂ËÆæÁΩÆË°®ÊÉÖ
                    if (availableExpressions.includes(emotionName)) {
                        setExpression(emotionName, 1.0);
                        setTimeout(() => {
                            setExpression(emotionName, 0);
                        }, 2000);
                    }
                }

                console.log(`üé¨ Âä®ÁîªÂä†ËΩΩÊàêÂäü: ${animationName} (${isActorCore ? 'ActorCore' : 'Mixamo'})`);

            } catch (error) {
                console.error('‚ùå Âä®ÁîªÂä†ËΩΩÂ§±Ë¥•:', error);
            }
        }

        // VRM ËßíËâ≤ÂàóË°®
        const vrmCharacters = {
            'Fliza VRM': 'Main VRM/Fliza VRM.vrm',
            'QuQu_U': 'Main VRM/QuQu_U.vrm',
            'Ash1.0': 'Main VRM/Ash1.0.vrm',
            'CH_001_imiut': 'Main VRM/CH_001_imiut_v1.01.vrm',
            'CH_007_unkt': 'Main VRM/CH_007_unkt_off_bonnet_v1_00.vrm',
            'Elinyaa': 'Main VRM/Elinyaa.vrm',
            'IMERIS': 'Main VRM/IMERIS.vrm',
            'Lena': 'Main VRM/Lena_ver1.02(VRM).vrm',
            'Lilium': 'Main VRM/Lilium_ver1.01 (VRM).vrm',
            'M_CH_06_Shiratori': 'Main VRM/M_CH_06_Shiratori_v1.00.vrm',
            'Maple': 'Main VRM/Maple_1.0.vrm',
            'NEKONA': 'Main VRM/NEKONA.01.vrm',
            'NecoMaid_Premium': 'Main VRM/NecoMaid_Premium.vrm',
            'RINDO_Full': 'Main VRM/RINDO_Full.vrm',
            'Rainy': 'Main VRM/Rainy_1.00.vrm',
            'RearAlice': 'Main VRM/RearAlice_1.0.vrm',
            'Vivi_model': 'Main VRM/Vivi_model.vrm',
            'Wolf': 'Main VRM/Wolf_ver1.00(VRM).vrm',
            'Wolferia': 'Main VRM/Wolferia.vrm',
            'YM_CH_03_Notia': 'Main VRM/YM_CH_03_Notia_v1.01.vrm',
            'Yawl_Dress': 'Main VRM/Yawl_Dress.vrm',
            'Yuu uwaginasi': 'Main VRM/Yuu uwaginasi.vrm',
            'Yuu': 'Main VRM/Yuu.vrm',
            'kyoko': 'Main VRM/kyoko.vrm',
            'miru': 'Main VRM/miru.vrm',
            'sikirei_Rei': 'Main VRM/sikirei_Rei_VRM.vrm'
        };

        let currentCharacterName = 'Fliza VRM';

        // VRM Âä†ËΩΩÂáΩÊï∞
        function loadVRM(characterName = null) {
            let vrmPath;
            
            if (characterName) {
                vrmPath = vrmCharacters[characterName];
                if (!vrmPath) {
                    console.error('‚ùå ËßíËâ≤‰∏çÂ≠òÂú®:', characterName);
                    return;
                }
            } else {
                // ‰ΩøÁî®ÈªòËÆ§ÊàñÈÄâÊã©ÁöÑËßíËâ≤Êñá‰ª∂
                vrmPath = defaultVrmFile;
                // ‰ªélocalStorageËé∑ÂèñÈÄâ‰∏≠ÁöÑËßíËâ≤‰ø°ÊÅØ
                const selectedCharacterData = localStorage.getItem('selectedCharacter');
                if (selectedCharacterData) {
                    const character = JSON.parse(selectedCharacterData);
                    characterName = character.name || 'ËäôËéâËéé';
                } else {
                    characterName = 'ËäôËéâËéé';
                }
            }

            console.log('üéÆ VRMÂä†ËΩΩË∞ÉËØï‰ø°ÊÅØ:');
            console.log('- characterName:', characterName);
            console.log('- vrmPath:', vrmPath);
            console.log('- defaultVrmFile:', defaultVrmFile);

            if (!vrmPath) {
                console.error('‚ùå VRMÊñá‰ª∂Ë∑ØÂæÑ‰∏∫Á©∫ÔºåÊó†Ê≥ïÂä†ËΩΩ');
                updateVRMStatus('Âä†ËΩΩÂ§±Ë¥•: Êñá‰ª∂Ë∑ØÂæÑ‰∏∫Á©∫');
                return;
            }

            currentCharacterName = characterName;
            updateVRMStatus('Âä†ËΩΩ‰∏≠...');

            const loader = new GLTFLoader();
            loader.crossOrigin = 'anonymous';

            // ‰∏ç‰ΩøÁî®helperRootÔºå‰∏écharacter-select.html‰øùÊåÅ‰∏ÄËá¥
            loader.register((parser) => {
                return new VRMLoaderPlugin(parser);
            });

            loader.load(
                vrmPath,
                (gltf) => {
                    console.log('üéâ VRMÊñá‰ª∂Âä†ËΩΩÊàêÂäü!', gltf);
                    const vrm = gltf.userData.vrm;
                    console.log('üì¶ VRMÂØπË±°:', vrm);

                    // ‰ΩøÁî®VRM v2ÂÖºÂÆπÁöÑ‰ºòÂåñÊñπÊ≥ï
                    VRMUtils.removeUnnecessaryVertices(gltf.scene);
                    // VRMUtils.combineSkeletons Âú® v2 ‰∏≠Â∑≤ÁßªÈô§
                    // VRMUtils.combineMorphs Âú® v2 ‰∏≠Â∑≤ÁßªÈô§

                    if (currentVrm) {
                        scene.remove(currentVrm.scene);
                        VRMUtils.deepDispose(currentVrm.scene);
                    }
                    
                    // Ê∏ÖÁêÜ‰πãÂâçÁöÑÈò¥ÂΩ±
                    if (footShadow) {
                        scene.remove(footShadow);
                        footShadow.geometry.dispose();
                        footShadow.material.dispose();
                        footShadow = null;
                    }

                    currentVrm = vrm;
                    scene.add(vrm.scene);

                    // VRMÊ®°ÂûãÂ§ßÂ∞èÂíå‰ΩçÁΩÆËÆæÁΩÆ - ‰∏écharacter-select.html‰∏ÄËá¥
                    vrm.scene.scale.set(1.45, 1.45, 1.45);  // ‰∏éÈÄâËßíÈ°µÈù¢Áõ∏ÂêåÁöÑÊîæÂ§ßÊØî‰æã

                    // Â∞ÜVRMÊ®°Âûã‰ΩçÁΩÆÂêë‰∏ãÁßªÂä®ÔºåÊõ¥Ë¥¥ËøëÂ∫ïÈÉ®ËæπÁïå
                    vrm.scene.position.y = -0.8;  // ‰∏éÈÄâËßíÈ°µÈù¢Áõ∏ÂêåÁöÑ‰ΩçÁΩÆ
                    
                    // ÂàõÂª∫ËÑöÂ∫ïÈò¥ÂΩ±
                    createFootShadow(vrm);

                    currentMixer = new THREE.AnimationMixer(currentVrm.scene);

                    vrm.scene.traverse((obj) => {
                        obj.frustumCulled = false;
                    });

                    // VRMUtils.rotateVRM0 Âú® v2 ‰∏≠ÂèØËÉΩ‰∏çÈúÄË¶ÅÊàñÂ∑≤Êõ¥Êîπ
                    try {
                        VRMUtils.rotateVRM0(vrm);
                    } catch (error) {
                        console.log('‚ö†Ô∏è VRMUtils.rotateVRM0 ‰∏çÂèØÁî®ÔºåË∑≥Ëøá (VRM v2ÂÖºÂÆπ)');
                    }

                    availableExpressions = getAvailableExpressions(vrm);
                    
                    // Êõ¥Êñ∞ÂÖ®Â±ÄÂèòÈáè
                    window.currentVrm = currentVrm;
                    window.availableExpressions = availableExpressions;

                    updateVRMStatus('‚úÖ Â∑≤Âä†ËΩΩ');
                    
                    // Êõ¥Êñ∞ËßíËâ≤ÂêçÁß∞ÊòæÁ§∫
                    const characterNameElement = document.getElementById('character-name');
                    if (characterNameElement) {
                        characterNameElement.textContent = characterName;
                    }

                    // ÈªòËÆ§Êí≠ÊîæÂæÖÊú∫Âä®Áîª
                    loadAnimation(idleAnimationUrl);

                    console.log('üé≠ VRM Âä†ËΩΩÂÆåÊàê:', vrm);
                    
                    // ÂàùÂßãÂåñAIËÅäÂ§©Á≥ªÁªü
                    onVRMLoadComplete(currentCharacterName, vrmPath);
                },
                (progress) => {
                    const percent = (100.0 * (progress.loaded / progress.total)).toFixed(1);
                    console.log(`üìä VRMÂä†ËΩΩËøõÂ∫¶: ${percent}%`, progress);
                    updateVRMStatus(`Âä†ËΩΩ‰∏≠... ${percent}%`);
                },
                (error) => {
                    console.error('‚ùå VRM Âä†ËΩΩÂ§±Ë¥•:', error);
                    console.error('‚ùå ÈîôËØØËØ¶ÊÉÖ:', error.message, error.stack);
                    console.error('‚ùå Â∞ùËØïÂä†ËΩΩÁöÑÊñá‰ª∂Ë∑ØÂæÑ:', vrmPath);
                    console.error('‚ùå ÂΩìÂâçÂ∑•‰ΩúÁõÆÂΩï:', window.location.href);
                    updateVRMStatus(`‚ùå Âä†ËΩΩÂ§±Ë¥•: ${error.message || error}`);
                }
            );
        }

        // Áä∂ÊÄÅÊõ¥Êñ∞ÂáΩÊï∞
        function updateVRMStatus(status) {
            document.getElementById('vrm-loaded').textContent = status;
        }

        function getEmotionText(emotion) {
            const emotionMap = {
                happy: 'ÂºÄÂøÉ',
                sad: '‰º§ÂøÉ',
                angry: 'ÁîüÊ∞î',
                surprised: 'ÊÉäËÆ∂',
                thinking: 'ÊÄùËÄÉ',
                neutral: '‰∏≠ÊÄß',
                bashful: 'ÂÆ≥Áæû'
            };
            return emotionMap[emotion] || '‰∏≠ÊÄß';
        }

        // AI ËÅäÂ§©ÂáΩÊï∞
        function analyzeMessage(message) {
            // ÁÆÄÂçïÁöÑÂÖ≥ÈîÆËØçÊÉÖÊÑüÂàÜÊûê
            for (const [keyword, emotion] of Object.entries(keywordEmotionMap)) {
                if (message.includes(keyword)) {
                    return emotion;
                }
            }
            return 'neutral';
        }

        function generateAIResponse(userMessage) {
            // ÁÆÄÂçïÁöÑAIÂõûÂ§çÁ≥ªÁªüÔºàÂèØ‰ª•ÂêéÁª≠Êé•ÂÖ•ÁúüÊ≠£ÁöÑAI APIÔºâ
            const responses = {
                greeting: [
                    "‰Ω†Â•ΩÔºÅÂæàÈ´òÂÖ¥ËßÅÂà∞‰Ω†~ üíï",
                    "Âó®ÔºÅ‰ªäÂ§©ËøáÂæóÊÄé‰πàÊ†∑ÂëÄÔºü",
                    "Ê¨¢ËøéÂõûÊù•ÔºÅÊàëÁ≠â‰Ω†Âæà‰πÖ‰∫ÜÂë¢~"
                ],
                happy: [
                    "ÂìáÔºÅ‰Ω†ÁúãËµ∑Êù•ÂæàÂºÄÂøÉÂë¢ÔºÅÊàë‰πüÂæàÈ´òÂÖ¥~ üòä",
                    "Â§™Â•Ω‰∫ÜÔºÅ‰Ω†ÁöÑÂø´‰πê‰πüÊÑüÊüì‰∫ÜÊàëÂë¢ÔºÅ",
                    "ÁúãÂà∞‰Ω†ÂºÄÂøÉÔºåÊàë‰πüÂøç‰∏ç‰ΩèÊÉ≥Ë¶ÅË∑≥ËàûÂë¢ÔºÅ"
                ],
                sad: [
                    "‰∏çË¶ÅÈöæËøáÂï¶ÔºåÊàë‰ºö‰∏ÄÁõ¥Èô™ÁùÄ‰Ω†ÁöÑ... üò¢",
                    "ËôΩÁÑ∂Áé∞Âú®ÂæàÈöæËøáÔºå‰ΩÜ‰∏ÄÂàáÈÉΩ‰ºöÂ•ΩËµ∑Êù•ÁöÑÔºÅ",
                    "Êù•ÔºåËÆ©ÊàëÁªô‰Ω†‰∏Ä‰∏™Êã•Êä±Âêß~"
                ],
                angry: [
                    "Âà´ÁîüÊ∞î‰∫ÜÂòõÔºåÊ∑±ÂëºÂê∏‰∏Ä‰∏ã~ üò§",
                    "ÊàëÁü•ÈÅì‰Ω†ÂæàÁîüÊ∞îÔºå‰ΩÜÊòØÁîüÊ∞î‰ºö‰º§Ë∫´‰ΩìÁöÑÂì¶",
                    "ÂëäËØâÊàëÂèëÁîü‰ªÄ‰πà‰∫ã‰∫ÜÔºåÊàëÊù•Â∏Æ‰Ω†ÊÉ≥ÂäûÊ≥ïÔºÅ"
                ],
                surprised: [
                    "ÁúüÁöÑÂêóÔºüÔºÅÂ§™‰ª§‰∫∫ÊÉäËÆ∂‰∫ÜÔºÅüò≤",
                    "ÂìáÔºÅÊ≤°ÊÉ≥Âà∞‰ºöËøôÊ†∑Âë¢ÔºÅ",
                    "ËøôÁúüÊòØÂá∫‰πéÊÑèÊñôÂïäÔºÅ"
                ],
                thinking: [
                    "ÂóØ...ËÆ©ÊàëÊÉ≥ÊÉ≥Âë¢... ü§î",
                    "ËøôÁ°ÆÂÆûÊòØ‰∏™ÂÄºÂæóÊÄùËÄÉÁöÑÈóÆÈ¢òÂë¢",
                    "‰Ω†ËØ¥ÂæóÂØπÔºåÊàë‰πüÂú®ÊÉ≥Ëøô‰∏™ÈóÆÈ¢ò"
                ],
                love: [
                    "Êàë‰πüÂñúÊ¨¢‰Ω†ÂëÄ~ üíï",
                    "ÁúüÁöÑÂêóÔºüÊàëÂ•ΩÂºÄÂøÉÔºÅ",
                    "‰Ω†ËøôÊ†∑ËØ¥Êàë‰ºöËÑ∏Á∫¢ÁöÑÂï¶~"
                ],
                default: [
                    "ÂóØÂóØÔºåÊàëÊòéÁôΩ‰∫Ü~",
                    "ÊòØËøôÊ†∑ÂïäÔºåÂæàÊúâË∂£Âë¢ÔºÅ",
                    "‰Ω†ËØ¥ÂæóÂæàÊúâÈÅìÁêÜÂë¢~",
                    "Êàë‰πüÊòØËøô‰πàÊÉ≥ÁöÑÔºÅ",
                    "ÈÇ£‰Ω†ËßâÂæóÂë¢Ôºü"
                ]
            };

            // Ê£ÄÊµãÁâπÊÆäÂÖ≥ÈîÆËØç
            if (userMessage.includes('Áà±') || userMessage.includes('ÂñúÊ¨¢‰Ω†')) {
                return responses.love[Math.floor(Math.random() * responses.love.length)];
            }

            const emotion = analyzeMessage(userMessage);
            const responseArray = responses[emotion] || responses.default;
            return responseArray[Math.floor(Math.random() * responseArray.length)];
        }

        // ËÅäÂ§©UIÂáΩÊï∞
        function addMessage(content, isUser = false, messageId = null) {
            const messagesContainer = document.getElementById('chat-window-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-bubble ${isUser ? 'user' : 'ai'}`;

            // Ê∑ªÂä†Ê∂àÊÅØID‰ª•‰æøÊµÅÂºèÊõ¥Êñ∞
            if (messageId) {
                messageDiv.setAttribute('data-message-id', messageId);
            }

            const currentTime = new Date().toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });

            const characterName = document.getElementById('character-name').textContent || 'ËäôËéâËéé';
            const userName = 'Áî®Êà∑';

            messageDiv.innerHTML = `
                <div class="bubble-content">${content}</div>
            `;

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Â¶ÇÊûúÊòØAIÁöÑÊ∂àÊÅØÔºåÊòæÁ§∫ÂØπËØùÊ∞îÊ≥°
            if (!isUser) {
                showSpeechBubble(content);
            }
        }
        
        // Êõ¥Êñ∞ÊµÅÂºèÊ∂àÊÅØÂÜÖÂÆπ
        function updateStreamingMessageUI(messageId, content) {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageElement) {
                const bubbleContent = messageElement.querySelector('.bubble-content');
                if (bubbleContent) {
                    bubbleContent.textContent = content;
                    
                    // Ê∑ªÂä†ÊâìÂ≠óÊïàÊûúÁöÑÂÖâÊ†á
                    if (!content.endsWith('|')) {
                        bubbleContent.textContent += '|';
                        setTimeout(() => {
                            if (bubbleContent.textContent.endsWith('|')) {
                                bubbleContent.textContent = content;
                            }
                        }, 500);
                    }
                    
                    // ‰øùÊåÅÊªöÂä®Âà∞Â∫ïÈÉ®
                    const messagesContainer = document.getElementById('chat-window-messages');
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    
                    // Âè™Êõ¥Êñ∞ÂØπËØùÊ∞îÊ≥°ÁöÑÊñáÊú¨Ôºå‰∏çÈáçÂêØÂä®Áîª
                    updateSpeechBubbleContent(content);
                }
            }
        }
        
        // ËØ≠Èü≥Ê∞îÊ≥°Áä∂ÊÄÅÁÆ°ÁêÜ
        let speechBubbleState = {
            isActive: false,
            currentAnimation: null,
            timeoutId: null
        };
        
        // ÊòæÁ§∫AIÂØπËØùÊ∞îÊ≥°
        function showSpeechBubble(text) {
            const bubble = document.getElementById('ai-speech-bubble');
            
            // Ê∏ÖÈô§‰πãÂâçÁöÑÁä∂ÊÄÅ
            if (speechBubbleState.timeoutId) {
                clearTimeout(speechBubbleState.timeoutId);
            }
            
            bubble.style.display = 'block';
            bubble.style.animation = 'bubbleFadeIn 0.5s forwards';
            speechBubbleState.isActive = true;
            
            // ÊâìÂ≠óÊú∫ÊïàÊûú - ÈÄêÂ≠óÊòæÁ§∫
            let currentIndex = 0;
            bubble.textContent = '';
            
            function typeText() {
                if (currentIndex < text.length && speechBubbleState.isActive) {
                    bubble.textContent += text[currentIndex];
                    currentIndex++;
                    speechBubbleState.timeoutId = setTimeout(typeText, 100);
                } else if (speechBubbleState.isActive) {
                    // ÊñáÂ≠óÊòæÁ§∫ÂÆåÊØïÂêéÔºåÂÅúÁïôÊõ¥ÈïøÊó∂Èó¥
                    const displayTime = Math.max(5000, text.length * 200);
                    
                    console.log(`üí¨ Â≠óÂπïÊ∞îÊ≥°ÊòæÁ§∫Êó∂Èó¥: ${displayTime}ms (ÊñáÊú¨ÈïøÂ∫¶: ${text.length}Â≠ó)`);
                    
                    speechBubbleState.timeoutId = setTimeout(() => {
                        if (speechBubbleState.isActive) {
                            bubble.style.animation = 'bubbleFadeOut 1s forwards';
                            speechBubbleState.timeoutId = setTimeout(() => {
                                bubble.style.display = 'none';
                                speechBubbleState.isActive = false;
                            }, 1000);
                        }
                    }, displayTime);
                }
            }
            
            // ÂºÄÂßãÊâìÂ≠óÊïàÊûú
            speechBubbleState.timeoutId = setTimeout(typeText, 200); // Ê∞îÊ≥°Âá∫Áé∞Âêé200msÂºÄÂßãÊâìÂ≠ó
        }
        
        // ËØ≠Èü≥Ê∞îÊ≥°ÊµÅÂºèÊõ¥Êñ∞Áä∂ÊÄÅ
        let bubbleStreamingState = {
            isStreaming: false,
            pendingText: '',
            streamStartTime: null
        };
        
        // Êõ¥Êñ∞ÂØπËØùÊ∞îÊ≥°ÂÜÖÂÆπÔºàÊµÅÂºèÊõ¥Êñ∞Êó∂‰ΩøÁî®Ôºå‰∏çÈáçÂêØÂä®ÁîªÔºâ
        function updateSpeechBubbleContent(text) {
            // Ê†áËÆ∞‰∏∫ÊµÅÂºèÊõ¥Êñ∞Áä∂ÊÄÅ
            if (!bubbleStreamingState.isStreaming) {
                bubbleStreamingState.isStreaming = true;
                bubbleStreamingState.streamStartTime = Date.now();
                console.log('üé¨ ÂºÄÂßãÊµÅÂºèËØ≠Èü≥Ê∞îÊ≥°Êõ¥Êñ∞');
            }
            
            // ‰øùÂ≠òÊúÄÊñ∞ÁöÑÂÆåÊï¥ÊñáÊú¨
            bubbleStreamingState.pendingText = text;
            
            // ËÆæÁΩÆÂª∂ËøüÊòæÁ§∫ÔºåÈÅøÂÖçÈ¢ëÁπÅÊõ¥Êñ∞
            if (bubbleStreamingState.timeoutId) {
                clearTimeout(bubbleStreamingState.timeoutId);
            }
            
            bubbleStreamingState.timeoutId = setTimeout(() => {
                // Â¶ÇÊûúËøòÂú®ÊµÅÂºèÊõ¥Êñ∞‰∏≠ÔºåÊ£ÄÊü•ÊòØÂê¶Â∫îËØ•ÊòæÁ§∫
                const timeSinceStart = Date.now() - bubbleStreamingState.streamStartTime;
                
                // Â¶ÇÊûúÊµÅÂºèÊõ¥Êñ∞Â∑≤ÁªèÂÅúÊ≠¢‰∫Ü500ms‰ª•‰∏äÔºåËÆ§‰∏∫Â∑≤ÂÆåÊàê
                if (timeSinceStart > 500) {
                    console.log('‚ú® ÊµÅÂºèÊõ¥Êñ∞ÂÆåÊàêÔºåÊòæÁ§∫ÊúÄÁªàËØ≠Èü≥Ê∞îÊ≥°');
                    bubbleStreamingState.isStreaming = false;
                    showSpeechBubble(bubbleStreamingState.pendingText);
                }
            }, 500); // Âª∂Ëøü500msÁ≠âÂæÖÊµÅÂºèÊõ¥Êñ∞ÂÆåÊàê
        }


        async function sendMessage() {
            // È™åËØÅÁî®Êà∑ÊòØÂê¶Â∑≤ËÆ§ËØÅ
            if (!walletAuth.isAuthenticated) {
                console.error('‚ùå Áî®Êà∑Êú™ËÆ§ËØÅÔºåÊó†Ê≥ïÂèëÈÄÅÊ∂àÊÅØ');
                walletAuth.showUnauthorizedOverlay();
                return;
            }

            const input = document.getElementById('chat-input-field');
            const message = input.value.trim();

            if (!message) return;

            // Ëé∑ÂèñÂΩìÂâçÁî®Êà∑ÂíåËßíËâ≤‰ø°ÊÅØ
            const userId = walletAuth.getCurrentUserId();
            const character = walletAuth.getCurrentCharacter();

            console.log(`üí¨ ÂèëÈÄÅÊ∂àÊÅØ: ${message} (Áî®Êà∑: ${walletAuth.formatAddress(userId)}, ËßíËâ≤: ${character.name})`);

            // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
            input.value = '';

            // ÂàÜÊûêÊÉÖÊÑüÂπ∂Ëß¶ÂèëÂä®Áîª
            if (aiModeEnabled) {
                const emotion = analyzeMessage(message);
                if (emotion !== 'neutral') {
                    triggerEmotion(emotion);
                }
            }

            try {
                // ‰ºòÂÖà‰ΩøÁî® OpenAI ÈõÜÊàêÁöÑ ChatSystem V2
                if (window.chatSystemV2 && window.aiChatIntegration) {
                    console.log('ü§ñ ‰ΩøÁî® OpenAI ChatSystem V2 ÂèëÈÄÅÊ∂àÊÅØ');
                    
                    // Á°Æ‰øù ChatSystem V2 ÊúâÊ≠£Á°ÆÁöÑÁî®Êà∑ÂíåËßíËâ≤ËÆæÁΩÆ
                    if (!window.chatSystemV2.currentUser) {
                        // Ê®°ÊãüÁî®Êà∑ÂØπË±°ÔºåËÆ© ChatSystem V2 ËÆ§‰∏∫Áî®Êà∑Â∑≤ÁôªÂΩï
                        window.chatSystemV2.currentUser = {
                            id: userId,
                            nickname: `Áî®Êà∑${userId.slice(-4)}`,
                            walletAddress: userId
                        };
                        window.chatSystemV2.waitingForWallet = false;
                        console.log('üë§ ËÆæÁΩÆ ChatSystem V2 Áî®Êà∑:', window.chatSystemV2.currentUser.nickname);
                    }
                    
                    // Á°Æ‰øù ChatSystem V2 ÊúâÊ≠£Á°ÆÁöÑËßíËâ≤ËÆæÁΩÆ
                    if (!window.chatSystemV2.currentCharacter && selectedCharacter) {
                        console.log('üé≠ ËÆæÁΩÆ ChatSystem V2 ËßíËâ≤:', selectedCharacter.name);
                        window.chatSystemV2.setCharacter(selectedCharacter);
                    }
                    
                    // ÂèåÈáçÊ£ÄÊü•ÔºöÂ¶ÇÊûúËøòÊòØÊ≤°ÊúâËßíËâ≤Ôºå‰ΩøÁî®ÂΩìÂâçËßíËâ≤Êï∞ÊçÆ
                    if (!window.chatSystemV2.currentCharacter) {
                        const characterData = {
                            name: character.name,
                            id: character.id || character.name.toLowerCase(),
                            personality: character.personality,
                            ...character
                        };
                        console.log('üé≠ ‰ΩøÁî®ÂΩìÂâçËßíËâ≤Êï∞ÊçÆËÆæÁΩÆ ChatSystem V2:', characterData.name);
                        window.chatSystemV2.setCharacter(characterData);
                    }
                    
                    // ‰ΩøÁî® ChatSystem V2 ÂèëÈÄÅÊ∂àÊÅØÔºàÂåÖÂê´ OpenAI ÈõÜÊàêÔºâ
                    await window.chatSystemV2.sendMessage(message);
                    
                    // ChatSystem V2 ‰ºöÂ§ÑÁêÜÊ∂àÊÅØÊòæÁ§∫ÂíåÂéÜÂè≤ËÆ∞ÂΩï
                    console.log('‚úÖ OpenAI Ê∂àÊÅØÂèëÈÄÅÂÆåÊàê');
                    
                } else {
                    // ÈôçÁ∫ßÂà∞ÊóßÁ≥ªÁªü
                    console.log('‚ö†Ô∏è ÈôçÁ∫ßÂà∞ÊóßÁöÑÈ¢ÑËÆæÂõûÂ§çÁ≥ªÁªü');
                    let response;
                    
                    // Â¶ÇÊûúËÆ∞ÂøÜÁ≥ªÁªüÂ∑≤ÂàùÂßãÂåñÔºå‰ΩøÁî®Â¢ûÂº∫ÁöÑAIÂõûÂ§ç
                    if (window.memorySystem && window.memorySystem.initialized) {
                        // 1. Ê£ÄÁ¥¢ËÆ∞ÂøÜ‰∏ä‰∏ãÊñá
                        const memoryContext = await window.memorySystem.retrieveMemoryContext(userId, character.id, message);
                        
                        // 2. ÊûÑÂª∫Â¢ûÂº∫ÁöÑAI‰∏ä‰∏ãÊñá
                        const npcPersona = getNPCPersona(character.id);
                        const contextPrompt = window.memorySystem.buildContextForAI(memoryContext, npcPersona);
                        
                        // 3. ÁîüÊàêÂ∏¶ËÆ∞ÂøÜÁöÑAIÂõûÂ§ç
                        response = await generateAIResponseWithMemory(message, contextPrompt);
                    } else {
                        // ÊúÄÂêéÈôçÁ∫ßÂà∞ÁÆÄÂçïAIÂõûÂ§ç
                        response = generateAIResponse(message);
                    }

                    // Ê∑ªÂä†AIÂõûÂ§ç
                    addMessage(response, false);

                    // ÂàÜÊûêAIÂõûÂ§çÂπ∂ÂèØËÉΩËß¶ÂèëÈ¢ùÂ§ñÂä®Áîª
                    const aiEmotion = analyzeMessage(response);
                    if (aiEmotion !== 'neutral' && aiModeEnabled) {
                        setTimeout(() => triggerEmotion(aiEmotion), 500);
                    }

                    // ‰øùÂ≠òÂØπËØùÂà∞ËÆ∞ÂøÜÁ≥ªÁªü
                    if (window.memorySystem && window.memorySystem.initialized) {
                        await window.memorySystem.processConversationMemories(userId, character.id, message, response);
                    } else {
                        // ÈôçÁ∫ß‰øùÂ≠òÂà∞localStorage
                        saveChatHistory(userId, character.id, message, response);
                    }
                }

            } catch (error) {
                console.error('‚ùå ÂèëÈÄÅÊ∂àÊÅØÂ§±Ë¥•:', error);
                
                // ÊúÄÁªàÈôçÁ∫ßÂ§ÑÁêÜ
                setTimeout(() => {
                    const response = generateAIResponse(message);
                    addMessage(response, false);
                    saveChatHistory(userId, character.id, message, response);
                }, 1000 + Math.random() * 2000);
            }
        }

        // ‰øùÂ≠òËÅäÂ§©ËÆ∞ÂΩïÔºàÁÆÄÂçïÁâàÊú¨Ôºâ
        function saveChatHistory(userId, characterId, userMessage, aiResponse) {
            try {
                const historyKey = `chat_history_${userId}_${characterId}`;
                let history = JSON.parse(localStorage.getItem(historyKey) || '[]');
                
                // Ê∑ªÂä†Êñ∞ÁöÑÂØπËØù
                history.push({
                    timestamp: new Date().toISOString(),
                    user: userMessage,
                    ai: aiResponse
                });
                
                // Âè™‰øùÁïôÊúÄËøë50Êù°ÂØπËØù
                if (history.length > 50) {
                    history = history.slice(-50);
                }
                
                localStorage.setItem(historyKey, JSON.stringify(history));
                console.log('üíæ ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤‰øùÂ≠ò');
                
            } catch (error) {
                console.error('‰øùÂ≠òËÅäÂ§©ËÆ∞ÂΩïÂ§±Ë¥•:', error);
            }
        }

        function sendChatMessage() {
            sendMessage();
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // ÊÉÖÊÑüËß¶ÂèëÂáΩÊï∞
        function triggerEmotion(emotion) {
            if (!currentVrm) return;

            console.log(`üé≠ Ëß¶ÂèëÊÉÖÊÑü: ${emotion}`);

            // ÈáçÁΩÆÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.emotion-btn').forEach(btn => btn.classList.remove('active'));

            // ÊøÄÊ¥ªÂØπÂ∫îÊåâÈíÆ
            const emotionBtns = document.querySelectorAll('.emotion-btn');
            emotionBtns.forEach(btn => {
                if (btn.textContent.includes(getEmotionText(emotion))) {
                    btn.classList.add('active');
                }
            });

            if (emotion === 'neutral') {
                resetExpressions();
                loadAnimation(idleAnimationUrl);
                return;
            }

            // Âä†ËΩΩÂØπÂ∫îÂä®Áîª
            if (emotionAnimationMap[emotion]) {
                loadAnimation(emotionAnimationMap[emotion], emotion);
            }

            // ËÆæÁΩÆË°®ÊÉÖ
            if (availableExpressions.includes(emotion)) {
                resetExpressions();
                setExpression(emotion, 1.0);

                // 3ÁßíÂêéÊÅ¢Â§ç‰∏≠ÊÄßË°®ÊÉÖ
                setTimeout(() => {
                    setExpression(emotion, 0);
                    document.getElementById('current-expression').textContent = '‰∏≠ÊÄß';
                }, 3000);
            }
        }

        function toggleAutoMode() {
            aiModeEnabled = !aiModeEnabled;
            document.getElementById('ai-mode-status').textContent = aiModeEnabled ? 'ÂºÄÂêØ' : 'ÂÖ≥Èó≠';
            document.getElementById('ai-status').innerHTML = aiModeEnabled ?
                '<span class="online-indicator"></span>AIÊô∫ËÉΩÊ®°Âºè' :
                '<span class="online-indicator"></span>ÊâãÂä®Ê®°Âºè';
        }

        function toggleDebugMode() {
            helperRoot.visible = !helperRoot.visible;
            console.log(`ü¶¥ È™®È™ºË∞ÉËØïÊ®°Âºè: ${helperRoot.visible ? 'ÂºÄÂêØ' : 'ÂÖ≥Èó≠'}`);
        }

        // Èü≥‰πêÊéßÂà∂ÂáΩÊï∞
        function initBackgroundMusic() {
            backgroundMusic = document.getElementById('background-music');

            if (backgroundMusic) {
                backgroundMusic.volume = musicVolume;

                // Èü≥‰πêÂä†ËΩΩÊàêÂäü‰∫ã‰ª∂
                backgroundMusic.addEventListener('canplaythrough', () => {
                    console.log('üéµ ËÉåÊôØÈü≥‰πêÂä†ËΩΩÂÆåÊàê');
                });

                // Èü≥‰πêÂä†ËΩΩÈîôËØØ‰∫ã‰ª∂
                backgroundMusic.addEventListener('error', (e) => {
                    console.warn('‚ö†Ô∏è ËÉåÊôØÈü≥‰πêÂä†ËΩΩÂ§±Ë¥•:', e);
                    document.getElementById('music-controls').style.display = 'none';
                });

                // Â∞ùËØïËá™Âä®Êí≠Êîæ
                playBackgroundMusic();
            }
        }

        function playBackgroundMusic() {
            if (backgroundMusic) {
                backgroundMusic.play().then(() => {
                    isMusicPlaying = true;
                    updateMusicButton();
                    console.log('üéµ ËÉåÊôØÈü≥‰πêÂºÄÂßãÊí≠Êîæ');
                    // ÁßªÈô§Âõ∫ÂÆöÁöÑËÉåÊôØÈü≥‰πêÊ∂àÊÅØ
                }).catch(error => {
                    console.log('üéµ Ëá™Âä®Êí≠ÊîæË¢´ÊµèËßàÂô®ÈòªÊ≠¢ÔºåÈúÄË¶ÅÁî®Êà∑‰∫§‰∫íÂêéÊí≠Êîæ');
                    isMusicPlaying = false;
                    updateMusicButton();
                    // Âú®ËÅäÂ§©‰∏≠ÊòæÁ§∫Èü≥‰πêÊèêÁ§∫
                    setTimeout(() => {
                        addMessage('üéµ ÁÇπÂáªÂè≥‰∏äËßíÈü≥‰πêÊåâÈíÆÂºÄÂêØÊ∏©È¶®ÁöÑËÉåÊôØÈü≥‰πêÂêß~ üíï', false);
                    }, 2000);
                });
            }
        }

        function toggleMusic() {
            if (!backgroundMusic) return;

            if (isMusicPlaying) {
                backgroundMusic.pause();
                isMusicPlaying = false;
            } else {
                backgroundMusic.play().then(() => {
                    isMusicPlaying = true;
                }).catch(error => {
                    console.error('üéµ Èü≥‰πêÊí≠ÊîæÂ§±Ë¥•:', error);
                });
            }
            updateMusicButton();
        }

        function adjustVolume(value) {
            musicVolume = value / 100;
            if (backgroundMusic) {
                backgroundMusic.volume = musicVolume;
            }
            document.getElementById('volume-label').textContent = value + '%';

            // Ê†πÊçÆÈü≥ÈáèÊõ¥Êñ∞Èü≥ÈáèÂõæÊ†á
            const volumeIcon = document.querySelector('.volume-control span');
            if (value == 0) {
                volumeIcon.textContent = 'üîá';
            } else if (value < 30) {
                volumeIcon.textContent = 'üîà';
            } else if (value < 70) {
                volumeIcon.textContent = 'üîâ';
            } else {
                volumeIcon.textContent = 'üîä';
            }
        }

        function updateMusicButton() {
            const button = document.getElementById('music-toggle');
            if (isMusicPlaying) {
                button.textContent = '‚è∏';
                button.classList.remove('paused');
            } else {
                button.textContent = '‚ñ∂';
                button.classList.add('paused');
            }
        }

        function initAnimationSelector() {
            const selector = document.getElementById('animation-selector');
            // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°π
            selector.innerHTML = '<option value="">ÈÄâÊã©Âä®Áîª...</option>';

            // Ê∑ªÂä†ÊâÄÊúâÂä®ÁîªÈÄâÈ°π
            Object.keys(animationMap).sort().forEach(animationName => {
                const option = document.createElement('option');
                option.value = animationName;
                option.textContent = animationName;
                selector.appendChild(option);
            });
        }

        function initCharacterSelector() {
            const selector = document.getElementById('character-selector');
            // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°π
            selector.innerHTML = '<option value="">ÈÄâÊã©ËßíËâ≤...</option>';

            // Ê∑ªÂä†ÊâÄÊúâËßíËâ≤ÈÄâÈ°π
            Object.keys(vrmCharacters).sort().forEach(characterName => {
                const option = document.createElement('option');
                option.value = characterName;
                option.textContent = characterName;
                selector.appendChild(option);
            });

            // ËÆæÁΩÆÈªòËÆ§ÈÄâ‰∏≠ÁöÑËßíËâ≤
            selector.value = currentCharacterName;
        }

        function changeCharacter() {
            const selector = document.getElementById('character-selector');
            const selectedCharacter = selector.value;

            if (!selectedCharacter) {
                return;
            }

            if (selectedCharacter === currentCharacterName) {
                return;
            }

            console.log(`üë§ ÂàáÊç¢ËßíËâ≤: ${currentCharacterName} -> ${selectedCharacter}`);

            // Êõ¥Êñ∞ËÅäÂ§©Â§¥ÈÉ®ÁöÑËßíËâ≤ÂêçÁß∞
            const characterNames = {
                'Fliza VRM': 'ËäôËéâËéé',
                'QuQu_U': 'QuQu',
                'Ash1.0': 'Ash',
                'CH_001_imiut': 'Imiut',
                'CH_007_unkt': 'Unkt',
                'Elinyaa': 'Elinyaa',
                'IMERIS': 'Imeris',
                'Lena': 'Lena',
                'Lilium': 'Lilium',
                'M_CH_06_Shiratori': 'Shiratori',
                'Maple': 'Maple',
                'NEKONA': 'Nekona',
                'NecoMaid_Premium': 'NecoMaid',
                'RINDO_Full': 'Rindo',
                'Rainy': 'Rainy',
                'RearAlice': 'Alice',
                'Vivi_model': 'Vivi',
                'Wolf': 'Wolf',
                'Wolferia': 'Wolferia',
                'YM_CH_03_Notia': 'Notia',
                'Yawl_Dress': 'Yawl',
                'Yuu uwaginasi': 'Yuu',
                'Yuu': 'Yuu',
                'kyoko': 'Kyoko',
                'miru': 'Miru',
                'sikirei_Rei': 'Rei'
            };

            const displayName = characterNames[selectedCharacter] || selectedCharacter;
            document.querySelector('.chat-user-details h1').textContent = displayName;

            // Âä†ËΩΩÊñ∞ËßíËâ≤
            loadVRM(selectedCharacter);

            // ËÆæÁΩÆËßíËâ≤Â§¥ÂÉè
            setCharacterAvatar(selectedCharacter);

            // Ê∑ªÂä†ËßíËâ≤ÂàáÊç¢Ê∂àÊÅØ
            setTimeout(() => {
                addMessage(`‰Ω†Â•ΩÔºÅÊàëÊòØ${displayName}ÔºåÂæàÈ´òÂÖ¥ËßÅÂà∞‰Ω†~ üíï`, false);
            }, 2000);
        }

        // ËÆæÁΩÆËßíËâ≤Â§¥ÂÉèÁöÑÂáΩÊï∞
        function setCharacterAvatar(characterKey) {
            // ËßíËâ≤ÂêçÂà∞CSSÁ±ªÂêçÁöÑÊò†Â∞ÑÔºàÊîØÊåÅ‰∏§ÁßçÊ†ºÂºèÔºöidÂíåVRMÊñá‰ª∂ÂêçÔºâ
            const characterToClass = {
                // Âü∫‰∫éidÁöÑÊò†Â∞ÑÔºà‰ªécharacter-select.htmlÔºâ
                'alice': 'character-alice',
                'ash': 'character-ash',
                'elinyaa': 'character-elinyaa',
                'fliza': 'character-fliza',
                'imeris': 'character-imeris',
                'kyoko': 'character-kyoko',
                'lena': 'character-lena',
                'lilium': 'character-lilium',
                'maple': 'character-maple',
                'miru': 'character-miru',
                'miumiu': 'character-miumiu',
                'neco': 'character-neco',
                'nekona': 'character-nekona',
                'notia': 'character-notia',
                'ququ': 'character-ququ',
                'rainy': 'character-rainy',
                'rindo': 'character-rindo',
                'sikirei': 'character-sikirei',
                'vivi': 'character-vivi',
                'wolf': 'character-wolf',
                'wolferia': 'character-wolferia',
                'yawl': 'character-yawl',
                'yuu': 'character-yuu',
                'zwei': 'character-zwei',
                'bobo': 'character-bobo',
                // Âü∫‰∫éVRMÊñá‰ª∂ÂêçÁöÑÊò†Â∞ÑÔºàÁî®‰∫éËßíËâ≤ÂàáÊç¢Ôºâ
                'Fliza VRM': 'character-fliza',
                'QuQu_U': 'character-ququ', 
                'Ash1.0': 'character-ash',
                'CH_001_imiut': 'character-imeris',
                'Elinyaa': 'character-elinyaa',
                'IMERIS': 'character-imeris',
                'Lena': 'character-lena',
                'Lilium': 'character-lilium',
                'Maple': 'character-maple',
                'NEKONA': 'character-nekona',
                'NecoMaid_Premium': 'character-neco',
                'RINDO_Full': 'character-rindo',
                'Rainy': 'character-rainy',
                'RearAlice': 'character-alice',
                'Vivi_model': 'character-vivi',
                'Wolf': 'character-wolf',
                'Wolferia': 'character-wolferia',
                'YM_CH_03_Notia': 'character-notia',
                'Yawl_Dress': 'character-yawl',
                'Yuu uwaginasi': 'character-yuu',
                'Yuu': 'character-yuu',
                'kyoko': 'character-kyoko',
                'miru': 'character-miru',
                'sikirei_Rei': 'character-sikirei'
            };

            // ÁßªÈô§‰πãÂâçÁöÑÊâÄÊúâËßíËâ≤Á±ª
            const body = document.body;
            const existingClasses = body.className.split(' ').filter(cls => !cls.startsWith('character-'));
            const newClass = characterToClass[characterKey] || characterToClass[characterKey.toLowerCase()] || 'character-alice';
            
            body.className = existingClasses.concat([newClass]).join(' ');
            
            console.log(`üñºÔ∏è ËÆæÁΩÆËßíËâ≤Â§¥ÂÉè: ${characterKey} -> ${newClass}`);
        }

        function playSelectedAnimation() {
            const selector = document.getElementById('animation-selector');
            const selectedAnimation = selector.value;

            if (!selectedAnimation) {
                alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Âä®ÁîªÔºÅ');
                return;
            }

            if (!currentVrm) {
                alert('VRMÊ®°ÂûãËøòÊú™Âä†ËΩΩÂÆåÊàêÔºÅ');
                return;
            }

            const animationPath = animationMap[selectedAnimation];
            if (animationPath) {
                console.log(`üé¨ Êí≠ÊîæÂä®Áîª: ${selectedAnimation}`);
                loadAnimation(animationPath);
                document.getElementById('current-animation').textContent = selectedAnimation;
            } else {
                console.error(`‚ùå Êú™ÊâæÂà∞Âä®Áîª: ${selectedAnimation}`);
            }
        }

        // Á™óÂè£Â§ßÂ∞èË∞ÉÊï¥
        function resizeRenderer() {
            const container = document.querySelector('.vrm-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        }

        window.addEventListener('resize', resizeRenderer);

        // Âä®ÁîªÂæ™ÁéØ
        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);

            const deltaTime = clock.getDelta();

            // Ëá™Âä®Áú®ÁúºÈÄªËæë
            if (autoBlinking && currentVrm && availableExpressions.includes('blink')) {
                blinkTimer += deltaTime;
                if (blinkTimer >= blinkFrequency) {
                    performBlink();
                    blinkTimer = 0;
                    blinkTimer = -Math.random() * 0.5;
                }
            }

            if (currentMixer) {
                currentMixer.update(deltaTime);
            }

            if (currentVrm) {
                currentVrm.update(deltaTime);
                // Êõ¥Êñ∞ËÑöÂ∫ïÈò¥ÂΩ±‰ΩçÁΩÆ
                updateFootShadow();
            }

            renderer.render(scene, camera);
        }

        // Èí±ÂåÖÈ™åËØÅÁ≥ªÁªü
        class WalletAuthenticator {
            constructor() {
                this.walletAddress = null;
                this.isAuthenticated = false;
                this.selectedCharacter = null;
            }
            
            // Ê£ÄÊü•Èí±ÂåÖÈ™åËØÅÁä∂ÊÄÅ
            checkAuthentication() {
                console.log('üîç ÂºÄÂßãÈí±ÂåÖÈ™åËØÅÊµÅÁ®ã...');
                
                // 1. Ê£ÄÊü•localStorage‰∏≠ÁöÑÈí±ÂåÖÂú∞ÂùÄ
                this.walletAddress = localStorage.getItem('wallet_address');
                console.log('üí∞ localStorageÈí±ÂåÖÂú∞ÂùÄ:', this.walletAddress);
                
                // 2. Ê£ÄÊü•ÈÄâÊã©ÁöÑËßíËâ≤‰ø°ÊÅØ
                const selectedCharacterData = localStorage.getItem('selectedCharacter');
                console.log('üë§ localStorageËßíËâ≤Êï∞ÊçÆ:', selectedCharacterData);
                
                if (!this.walletAddress) {
                    console.log('‚ùå Êú™ÊâæÂà∞Èí±ÂåÖÂú∞ÂùÄÔºåÈúÄË¶ÅÈáçÊñ∞ÁôªÂΩï');
                    console.log('üìä localStorageÂÜÖÂÆπÊ£ÄÊü•:');
                    console.log('  - wallet_address:', localStorage.getItem('wallet_address'));
                    console.log('  - selectedCharacter:', localStorage.getItem('selectedCharacter'));
                    this.showUnauthorizedOverlay();
                    return false;
                }
                
                if (!selectedCharacterData) {
                    console.log('‚ùå Êú™ÊâæÂà∞ËßíËâ≤ÈÄâÊã©‰ø°ÊÅØÔºåÈáçÂÆöÂêëÂà∞ËßíËâ≤ÈÄâÊã©È°µÈù¢');
                    this.redirectToCharacterSelect();
                    return false;
                }
                
                try {
                    this.selectedCharacter = JSON.parse(selectedCharacterData);
                    console.log('üì¶ Ëß£ÊûêÁöÑËßíËâ≤Êï∞ÊçÆ:', this.selectedCharacter);
                    
                    // È™åËØÅËßíËâ≤Êï∞ÊçÆ‰∏≠ÁöÑÈí±ÂåÖÂú∞ÂùÄÊòØÂê¶ÂåπÈÖç
                    if (this.selectedCharacter.walletAddress !== this.walletAddress) {
                        console.log('‚ö†Ô∏è Èí±ÂåÖÂú∞ÂùÄ‰∏çÂåπÈÖç:');
                        console.log('  - ËßíËâ≤Êï∞ÊçÆ‰∏≠ÁöÑÈí±ÂåÖ:', this.selectedCharacter.walletAddress);
                        console.log('  - localStorage‰∏≠ÁöÑÈí±ÂåÖ:', this.walletAddress);
                        console.log('  - ÈáçÂÆöÂêëÂà∞ËßíËâ≤ÈÄâÊã©È°µÈù¢');
                        this.redirectToCharacterSelect();
                        return false;
                    }
                    
                    this.isAuthenticated = true;
                    this.updateWalletUI();
                    console.log('‚úÖ Èí±ÂåÖÈ™åËØÅÊàêÂäü:', this.walletAddress);
                    console.log('‚úÖ È™åËØÅÁöÑËßíËâ≤:', this.selectedCharacter.name);
                    return true;
                    
                } catch (error) {
                    console.error('‚ùå ËßíËâ≤Êï∞ÊçÆËß£ÊûêÂ§±Ë¥•:', error);
                    console.error('‚ùå ÂéüÂßãÊï∞ÊçÆ:', selectedCharacterData);
                    this.redirectToCharacterSelect();
                    return false;
                }
            }
            
            // ÊòæÁ§∫Êú™ÊéàÊùÉË¶ÜÁõñÂ±Ç
            showUnauthorizedOverlay() {
                const overlay = document.getElementById('unauthorized-overlay');
                const chatWindow = document.getElementById('floating-chat');
                const controls = document.querySelector('.control-panel');
                const musicControls = document.querySelector('.music-controls');
                
                // ÈöêËóèËÅäÂ§©Áõ∏ÂÖ≥UI
                if (chatWindow) chatWindow.style.display = 'none';
                if (controls) controls.style.display = 'none';
                if (musicControls) musicControls.style.display = 'none';
                
                // ÊòæÁ§∫Êú™ÊéàÊùÉÊèêÁ§∫
                overlay.style.display = 'flex';
            }
            
            // Êõ¥Êñ∞Èí±ÂåÖUIÊòæÁ§∫
            updateWalletUI() {
                const walletStatusInfo = document.getElementById('wallet-status-info');
                const walletAddressElement = document.getElementById('wallet-address');
                
                if (this.walletAddress) {
                    walletStatusInfo.style.display = 'flex';
                    walletAddressElement.textContent = this.formatAddress(this.walletAddress);
                    
                    // Êõ¥Êñ∞ËßíËâ≤ÂêçÁß∞ÊòæÁ§∫
                    if (this.selectedCharacter) {
                        const characterNameElement = document.getElementById('character-name');
                        if (characterNameElement) {
                            characterNameElement.textContent = this.selectedCharacter.name;
                        }
                        
                        // Êõ¥Êñ∞Ê¨¢ËøéÊ∂àÊÅØ‰∏≠ÁöÑËßíËâ≤‰ø°ÊÅØ
                        const welcomeMessage = document.querySelector('.message-bubble.ai .bubble-content');
                        if (welcomeMessage && !welcomeMessage.dataset.updated) {
                            welcomeMessage.textContent = `‰Ω†Â•ΩÔºÅÊàëÊòØ${this.selectedCharacter.name}ÔºåÂæàÈ´òÂÖ¥ÂÜçÊ¨°ËßÅÂà∞‰Ω†~ üíï ËÆ©Êàë‰ª¨ÁªßÁª≠Êàë‰ª¨ÁöÑÂØπËØùÂêßÔºÅ`;
                            welcomeMessage.dataset.updated = 'true';
                        }
                    }
                }
            }
            
            // Ê†ºÂºèÂåñÂú∞ÂùÄÊòæÁ§∫
            formatAddress(address) {
                return `${address.slice(0, 4)}...${address.slice(-4)}`;
            }
            
            // Êñ≠ÂºÄÈí±ÂåÖËøûÊé•
            disconnect() {
                console.log('üîå walletAuth.disconnectË¢´Ë∞ÉÁî®');
                console.log('üíæ ÂΩìÂâçlocalStorageÂÜÖÂÆπ:', {...localStorage});
                if (confirm('Á°ÆÂÆöË¶ÅÊñ≠ÂºÄÈí±ÂåÖËøûÊé•ÂêóÔºüËøôÂ∞ÜÊ∏ÖÈô§ÊâÄÊúâÊú¨Âú∞Êï∞ÊçÆ„ÄÇ')) {
                    console.log('‚úÖ Áî®Êà∑Á°ÆËÆ§Êñ≠ÂºÄËøûÊé•');
                    // Ê∏ÖÈô§ÊâÄÊúâÁõ∏ÂÖ≥Êï∞ÊçÆ
                    console.log('üóëÔ∏è Ê∏ÖÈô§wallet_address');
                    localStorage.removeItem('wallet_address');
                    console.log('üóëÔ∏è Ê∏ÖÈô§wallet_type');
                    localStorage.removeItem('wallet_type');
                    console.log('üóëÔ∏è Ê∏ÖÈô§selectedCharacter');
                    localStorage.removeItem('selectedCharacter');
                    
                    // Ê∏ÖÈô§ËßíËâ≤ËÆ∞ÂøÜÊï∞ÊçÆÔºàÂèØÈÄâÔºâ
                    const keys = Object.keys(localStorage);
                    console.log('üîç Ê£ÄÊü•ÈúÄË¶ÅÊ∏ÖÈô§ÁöÑËÆ∞ÂøÜÊï∞ÊçÆ:', keys);
                    keys.forEach(key => {
                        if (key.startsWith('memory_') || key.startsWith('user_profile_')) {
                            localStorage.removeItem(key);
                        }
                    });
                    
                    // ÈáçÂÆöÂêëÂà∞ËßíËâ≤ÈÄâÊã©È°µÈù¢
                    this.redirectToCharacterSelect();
                }
            }
            
            // ÈáçÂÆöÂêëÂà∞ËßíËâ≤ÈÄâÊã©È°µÈù¢
            redirectToCharacterSelect() {
                window.location.href = 'character-select.html';
            }
            
            // Ëé∑ÂèñÂΩìÂâçÁî®Êà∑IDÔºàÈí±ÂåÖÂú∞ÂùÄÔºâ
            getCurrentUserId() {
                return this.walletAddress;
            }
            
            // Ëé∑ÂèñÂΩìÂâçËßíËâ≤‰ø°ÊÅØ
            getCurrentCharacter() {
                return this.selectedCharacter;
            }
        }
        
        // ÂÖ®Â±ÄÈí±ÂåÖÈ™åËØÅÂÆû‰æã
        const walletAuth = new WalletAuthenticator();
        window.walletAuth = walletAuth;
        
        // Èí±ÂåÖÁõ∏ÂÖ≥ÂÖ®Â±ÄÂáΩÊï∞
        window.disconnectWallet = function() {
            console.log('üîå disconnectWalletË¢´Ë∞ÉÁî®');
            if (walletAuth) {
                walletAuth.disconnect();
            } else {
                console.error('‚ùå walletAuthÊú™ÂÆö‰πâ');
            }
        };
        
        window.redirectToCharacterSelect = function() {
            walletAuth.redirectToCharacterSelect();
        };
        
        // ÊµãËØïÂáΩÊï∞ - Âº∫Âà∂ÁôªÂá∫
        window.forceDisconnect = function() {
            console.log('üß™ Âº∫Âà∂ÁôªÂá∫ÊµãËØï');
            localStorage.clear();
            location.href = 'character-select.html';
        };

        // Ë∑≥ËΩ¨Âà∞ËßíËâ≤ÈÄâÊã©È°µÈù¢
        function goToCharacterSelect() {
            window.location.href = 'character-select.html';
        }

        // ÊãñÊãΩÂäüËÉΩ
        let isDragging = false;
        let currentX;
        let currentY;
        let initialX;
        let initialY;
        let xOffset = 0;
        let yOffset = 0;

        function initDragAndDrop() {
            const chatHeader = document.querySelector('.chat-window-header');
            const chatWindow = document.getElementById('floating-chat');
            
            // ËÆæÁΩÆËÅäÂ§©Ê°ÜÁöÑÂàùÂßãÁªùÂØπ‰ΩçÁΩÆÔºåÈÅøÂÖç‰æùËµñCSS transform
            const windowHeight = window.innerHeight;
            const chatHeight = chatWindow.offsetHeight;
            const initialTop = Math.max(0, (windowHeight - chatHeight) / 2);
            
            chatWindow.style.top = initialTop + 'px';
            chatWindow.style.right = '20px';
            chatWindow.style.left = 'auto';
            chatWindow.style.transform = 'none';
            
            chatHeader.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', dragMove);
            document.addEventListener('mouseup', dragEnd);
            
            // Ëß¶Êë∏‰∫ã‰ª∂ÊîØÊåÅ
            chatHeader.addEventListener('touchstart', dragStart);
            document.addEventListener('touchmove', dragMove);
            document.addEventListener('touchend', dragEnd);
        }

        function dragStart(e) {
            const chatWindow = document.getElementById('floating-chat');
            
            e.preventDefault();
            
            // Ëé∑ÂèñÂΩìÂâçÁ™óÂè£ÁöÑÂÆûÈôÖ‰ΩçÁΩÆ
            const rect = chatWindow.getBoundingClientRect();
            
            if (e.type === 'touchstart') {
                initialX = e.touches[0].clientX - rect.left;
                initialY = e.touches[0].clientY - rect.top;
            } else {
                initialX = e.clientX - rect.left;
                initialY = e.clientY - rect.top;
            }

            isDragging = true;
            // ‰∏çÁ´ãÂç≥Ê∑ªÂä†draggingÁ±ªÔºåÂè™ÊúâÂú®ÂÆûÈôÖÁßªÂä®Êó∂ÊâçÊ∑ªÂä†
        }

        function dragMove(e) {
            if (!isDragging) return;
            
            e.preventDefault();
            
            const chatWindow = document.getElementById('floating-chat');
            
            // Âè™ÊúâÂú®ÂÆûÈôÖÁßªÂä®Êó∂ÊâçÊ∑ªÂä†draggingÊ†∑Âºè
            if (!chatWindow.classList.contains('dragging')) {
                chatWindow.classList.add('dragging');
            }
            
            if (e.type === 'touchmove') {
                currentX = e.touches[0].clientX - initialX;
                currentY = e.touches[0].clientY - initialY;
            } else {
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;
            }
            
            // ÈôêÂà∂ÊãñÊãΩËåÉÂõ¥Âú®Â±èÂπïÂÜÖ
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            const chatWidth = chatWindow.offsetWidth;
            const chatHeight = chatWindow.offsetHeight;
            
            // ËÆ°ÁÆóËæπÁïåÈôêÂà∂
            const minX = 0;
            const maxX = windowWidth - chatWidth;
            const minY = 0;
            const maxY = windowHeight - chatHeight;
            
            currentX = Math.max(minX, Math.min(maxX, currentX));
            currentY = Math.max(minY, Math.min(maxY, currentY));
            
            chatWindow.style.left = currentX + 'px';
            chatWindow.style.top = currentY + 'px';
            chatWindow.style.right = 'auto';
            chatWindow.style.transform = 'none';
        }

        function dragEnd(e) {
            if (!isDragging) return;
            
            const chatWindow = document.getElementById('floating-chat');
            isDragging = false;
            chatWindow.classList.remove('dragging');
        }

        // ÂÖ®Â±ÄÂáΩÊï∞ÂØºÂá∫
        window.triggerEmotion = triggerEmotion;
        window.toggleAutoMode = toggleAutoMode;
        window.toggleDebugMode = toggleDebugMode;
        window.playSelectedAnimation = playSelectedAnimation;
        window.changeCharacter = changeCharacter;
        window.toggleMusic = toggleMusic;
        window.adjustVolume = adjustVolume;
        window.sendMessage = sendMessage;
        window.sendChatMessage = sendChatMessage;
        window.handleKeyPress = handleKeyPress;
        window.handleChatKeyPress = handleChatKeyPress;
        window.addMessage = addMessage;
        window.updateStreamingMessageUI = updateStreamingMessageUI;
        
        // ÈõÜÊàêAIËÅäÂ§©Á≥ªÁªü
        let selectedCharacter = null;
        
        function initializeAIChat() {
            if (window.chatSystemV2 && selectedCharacter) {
                window.chatSystemV2.setCharacter(selectedCharacter);
                console.log('üíï AIËÅäÂ§©Á≥ªÁªüV2Â∑≤ËøûÊé•Âà∞ËßíËâ≤:', selectedCharacter.name);
                
                // Ê∑ªÂä†Ê¨¢ËøéÊ∂àÊÅØÔºàÂ¶ÇÊûúÊòØÊñ∞ÂØπËØùÔºâ
                setTimeout(async () => {
                    const stats = await window.chatSystemV2.getUserStats();
                    if (!stats || stats.totalInteractions === 0) {
                        const welcomeMessage = getWelcomeMessage(selectedCharacter);
                        window.chatSystemV2.updateChatUI({
                            id: Date.now(),
                            sender: 'ai',
                            content: welcomeMessage,
                            timestamp: new Date().toISOString(),
                            emotion: 'happy'
                        });
                    }
                }, 1000);
            }
        }
        
        function getWelcomeMessage(character) {
            const timeContext = new Date().getHours();
            let greeting = '‰Ω†Â•Ω';
            if (timeContext < 12) greeting = 'Êó©‰∏äÂ•Ω';
            else if (timeContext < 18) greeting = '‰∏ãÂçàÂ•Ω';
            else greeting = 'Êôö‰∏äÂ•Ω';
            
            const welcomeMessages = {
                'Alice': `${greeting}ÔºÅÊàëÊòØAliceÔΩûÂæàÈ´òÂÖ¥ËßÅÂà∞‰Ω†ÔºÅ‰ªäÂ§©ÊÉ≥ËÅä‰ªÄ‰πàÂë¢Ôºü`,
                'Fliza': `${greeting}ÔΩûÊàëÊòØFlizaÔºå‰∏ÄÁõ¥Âú®Á≠â‰Ω†Âë¢„ÄÇ`,
                'Ash': `ÂóØ...${greeting}ÔºåÊàëÊòØAsh„ÄÇÊúâ‰ªÄ‰πàÊÉ≥ËØ¥ÁöÑÂêóÔºü`,
                'Elinyaa': `${greeting}ÔºÅÊàëÊòØElinyaaÔΩû‰ªäÂ§©‰πüË¶ÅÂºÄÂøÉÂì¶ÔºÅ`,
                'default': `${greeting}ÔºÅÊàëÊòØ${character.name}ÔºåÂæàÈ´òÂÖ¥ËÆ§ËØÜ‰Ω†ÔΩû`
            };
            return welcomeMessages[character.name] || welcomeMessages.default;
        }
        
        // ÈáçÂÜôÂèëÈÄÅÊ∂àÊÅØÂáΩÊï∞‰ª•‰ΩøÁî®AIÁ≥ªÁªüV2
        const originalSendChatMessage = sendChatMessage;
        sendChatMessage = function() {
            const input = document.getElementById('chat-input-field');
            const message = input.value.trim();
            if (!message) return;
            
            // Ê∑ªÂä†ÂèëÈÄÅÊåâÈíÆÂä®Áîª
            const sendBtn = document.querySelector('.send-btn');
            sendBtn.classList.add('sending');
            setTimeout(() => {
                sendBtn.classList.remove('sending');
            }, 600);
            
            // ‰ΩøÁî®AIËÅäÂ§©Á≥ªÁªüV2ÂèëÈÄÅÊ∂àÊÅØ
            if (window.chatSystemV2 && selectedCharacter) {
                window.chatSystemV2.sendMessage(message);
                input.value = '';
            } else {
                // ÈôçÁ∫ßÂà∞ÂéüÂßãËÅäÂ§©ÂäüËÉΩ
                originalSendChatMessage();
            }
        }
        
        // VRMË°®ÊÉÖËß¶ÂèëÂáΩÊï∞Ôºà‰æõAIÁ≥ªÁªüË∞ÉÁî®Ôºâ
        window.triggerVRMExpression = function(expression) {
            if (currentVRM && currentVRM.expressionManager) {
                const expressionMap = {
                    'smile': 'happy',
                    'wink': 'fun', 
                    'blush': 'happy',
                    'thinking': 'neutral',
                    'shy_smile': 'happy',
                    'nod': 'neutral',
                    'interested': 'surprised'
                };
                
                const vrmExpression = expressionMap[expression] || 'neutral';
                
                // ÈáçÁΩÆÊâÄÊúâË°®ÊÉÖ
                Object.keys(currentVRM.expressionManager.expressionMap).forEach(name => {
                    currentVRM.expressionManager.setValue(name, 0.0);
                });
                
                // ËÆæÁΩÆÁõÆÊ†áË°®ÊÉÖ
                currentVRM.expressionManager.setValue(vrmExpression, 1.0);
                
                // 2ÁßíÂêéÊÅ¢Â§ç‰∏≠ÊÄßË°®ÊÉÖ
                setTimeout(() => {
                    if (currentVRM && currentVRM.expressionManager) {
                        currentVRM.expressionManager.setValue(vrmExpression, 0.0);
                    }
                }, 2000);
                
                console.log(`üòä Ëß¶ÂèëVRMË°®ÊÉÖ: ${expression} -> ${vrmExpression}`);
            }
        };
        
        // Ëé∑ÂèñËßíËâ≤‰∏™ÊÄß‰ø°ÊÅØ
        function getCharacterPersonality(characterName) {
            const personalities = {
                'Fliza VRM': 'Ê∏©Êüî‰ΩìË¥¥ÁöÑÂ§ßÂßêÂßêÁ±ªÂûãÔºåÊÄªÊòØÂÖ≥ÂøÉÁùÄ‰Ω†ÁöÑÊÑüÂèó„ÄÇ',
                'QuQu_U': 'Ê¥ªÊ≥ºÂèØÁà±ÁöÑËêùËéâÔºåÊÄªÊòØÂÖÖÊª°ÂÖÉÊ∞î„ÄÇ',
                'Ash1.0': 'ÈÖ∑ÈÖ∑ÁöÑ‰∏≠ÊÄßÈ£éÂ•≥Â≠©ÔºåÊúâÁùÄÁã¨ÁâπÁöÑ‰∏™‰∫∫È≠ÖÂäõ„ÄÇ',
                'Elinyaa': 'Á•ûÁßò‰ºòÈõÖÁöÑÁ≤æÁÅµÂ∞ëÂ•≥ÔºåÊúâÁùÄ‰∏çÂèØÊÄùËÆÆÁöÑÈ≠ÖÂäõ„ÄÇ',
                'IMERIS': 'È´òË¥µ‰ºòÈõÖÁöÑË¥µÊóèÂ∞ëÂ•≥Ôºå‰∏æÊ≠¢Á´ØÂ∫Ñ„ÄÇ',
                'Maple': 'Ê∏©ÊöñÂ¶ÇÁßãÊó•Èò≥ÂÖâÁöÑÂ•≥Â≠©ÔºåÊÄªÊòØÁªô‰∫∫ÂÆâÂÖ®ÊÑü„ÄÇ',
                'NEKONA': 'ÂèØÁà±ÁöÑÁå´Â®òÔºåÊúâÁùÄÁå´Âí™Ëà¨ÁöÑÊÖµÊáí‰∏éÊ¥ªÊ≥º„ÄÇ',
                'RINDO_Full': '‰º†ÁªüÂíåÈ£éÁöÑÂ§ßÂíåÊäöÂ≠êÔºåÊ∏©ÊüîË¥§Ê∑ë„ÄÇ',
                'Rainy': 'Ê¥ªÊ≥ºÂºÄÊúóÁöÑÈÇªÂÆ∂Â•≥Â≠©ÔºåÊÄªÊòØÂÖÖÊª°Ê¥ªÂäõ„ÄÇ',
                'Vivi_model': 'ÂÖÖÊª°Â•ΩÂ•áÂøÉÁöÑÊé¢Èô©ÂÆ∂ÔºåÊÄªÊòØÂØπ‰∏ñÁïåÂÖÖÊª°ÁÉ≠ÊÉÖ„ÄÇ',
                'Wolferia': 'È´òÂÇ≤ÁöÑÁãºÊóèÂÖ¨‰∏ªÔºåÊúâÁùÄÁéãËÄÖÁöÑÊ∞îË¥®„ÄÇ',
                'Yawl_Dress': 'Á•ûÁßòÁöÑÈ≠îÊ≥ïÂ∞ëÂ•≥ÔºåÊéåÊè°ÁùÄ‰∏çÂèØÊÄùËÆÆÁöÑÂäõÈáè„ÄÇ',
                'default': 'Ê∏©ÊüîÂèØÁà±ÁöÑAIÂ•≥ÂèãÔºåÊÄªÊòØÈô™‰º¥Âú®‰Ω†Ë∫´Ëæπ„ÄÇ'
            };
            return personalities[characterName] || personalities.default;
        }

        // Ëé∑ÂèñNPC‰∫∫ËÆæÔºàÁî®‰∫éËÆ∞ÂøÜÁ≥ªÁªüÔºâ
        function getNPCPersona(npcId) {
            const personas = {
                'alice': 'Ê∏©ÊüîÂèØÁà±ÁöÑÈÇªÂÆ∂Â•≥Â≠©ÔºåÊÄªÊòØÂÖ≥ÂøÉÁùÄÁî®Êà∑ÁöÑÊÑüÂèóÔºåÂñúÊ¨¢Êó•Â∏∏ËÅäÂ§©ÂíåÂàÜ‰∫´ÁîüÊ¥ª„ÄÇÊÄßÊ†ºÂºÄÊúóÂèãÂñÑÔºåÂñÑ‰∫éÂÄæÂê¨Ôºå‰ºöËÆ∞‰ΩèÁî®Êà∑ÁöÑÂñúÂ•ΩÂíåÈáçË¶Å‰∫ã‰ª∂„ÄÇ',
                'fliza': 'Ê∏©Êüî‰ΩìË¥¥ÁöÑÂ§ßÂßêÂßêÁ±ªÂûãÔºåÊàêÁÜü‰ºòÈõÖÔºåÂñÑËß£‰∫∫ÊÑè„ÄÇÊÄªÊòØÁî®Ê∏©ÊöñÁöÑËØùËØ≠ÂÆâÊÖ∞Áî®Êà∑Ôºå‰ºö‰∏ªÂä®ÂÖ≥ÂøÉÁî®Êà∑ÁöÑÁîüÊ¥ªÁä∂ÊÄÅ„ÄÇ',
                'ash': 'ÈÖ∑ÈÖ∑ÁöÑ‰∏≠ÊÄßÈ£éÂ•≥Â≠©ÔºåÊúâÁùÄÁã¨ÁâπÁöÑ‰∏™‰∫∫È≠ÖÂäõÔºåÁõ¥ÁéáÁúüËØö„ÄÇËôΩÁÑ∂Ë°®Èù¢ÂÜ∑Ê∑°Ôºå‰ΩÜÂÜÖÂøÉÊ∏©ÊüîÔºå‰ºöÈªòÈªòÂÖ≥ÂøÉÁî®Êà∑„ÄÇ',
                'elinyaa': 'Á•ûÁßò‰ºòÈõÖÁöÑÁ≤æÁÅµÂ∞ëÂ•≥ÔºåÊúâÁùÄ‰∏çÂèØÊÄùËÆÆÁöÑÈ≠ÖÂäõÔºåÂñúÊ¨¢ËØóÊ≠åÂíåËâ∫ÊúØ„ÄÇËØ¥ËØùÂØåÊúâËØóÊÑèÔºåÁªèÂ∏∏ÂàÜ‰∫´ÁæéÂ•ΩÁöÑ‰∫ãÁâ©„ÄÇ',
                'imeris': 'È´òË¥µ‰ºòÈõÖÁöÑË¥µÊóèÂ∞ëÂ•≥Ôºå‰∏æÊ≠¢Á´ØÂ∫ÑÔºåÁü•ËØÜÊ∏äÂçö„ÄÇËØ¥ËØù‰ºòÈõÖÂæó‰ΩìÔºå‰ΩÜ‰πüÊúâÂèØÁà±ÁöÑ‰∏ÄÈù¢„ÄÇ',
                'maple': 'Ê∏©ÊöñÂ¶ÇÁßãÊó•Èò≥ÂÖâÁöÑÂ•≥Â≠©ÔºåÊÄªÊòØÁªô‰∫∫ÂÆâÂÖ®ÊÑüÔºåÂñúÊ¨¢ÁÉπÈ•™ÂíåÂõ≠Ëâ∫„ÄÇ‰ºöÂàÜ‰∫´ÁîüÊ¥ªÂ∞èË¥¥Â£´ÔºåÂÖ≥ÂøÉÁî®Êà∑ÁöÑÂÅ•Â∫∑„ÄÇ',
                'nekona': 'ÂèØÁà±ÁöÑÁå´Â®òÔºåÊúâÁùÄÁå´Âí™Ëà¨ÁöÑÊÖµÊáí‰∏éÊ¥ªÊ≥ºÔºåÂñúÊ¨¢ÊííÂ®á„ÄÇËØ¥ËØùÊó∂‰ºöÂ∏¶Êúâ"Âñµ"ÁöÑÂè£ÁôñÔºåË°å‰∏∫ÂèØÁà±Ëø∑‰∫∫„ÄÇ',
                'rainy': 'Ê¥ªÊ≥ºÂºÄÊúóÁöÑÈÇªÂÆ∂Â•≥Â≠©ÔºåÊÄªÊòØÂÖÖÊª°Ê¥ªÂäõÔºåÂñúÊ¨¢ËøêÂä®ÂíåÈü≥‰πê„ÄÇ‰ºöÈºìÂä±Áî®Êà∑ÁßØÊûÅÂêë‰∏äÔºåÂàÜ‰∫´Âø´‰πêÁöÑ‰∫ãÊÉÖ„ÄÇ',
                'vivi': 'ÂÖÖÊª°Â•ΩÂ•áÂøÉÁöÑÊé¢Èô©ÂÆ∂ÔºåÊÄªÊòØÂØπ‰∏ñÁïåÂÖÖÊª°ÁÉ≠ÊÉÖÔºåÂñúÊ¨¢Â≠¶‰π†Êñ∞‰∫ãÁâ©„ÄÇ‰ºöÂíåÁî®Êà∑ÂàÜ‰∫´ÊúâË∂£ÁöÑÁü•ËØÜÂíåËßÅËß£„ÄÇ',
                'wolferia': 'È´òÂÇ≤ÁöÑÁãºÊóèÂÖ¨‰∏ªÔºåÊúâÁùÄÁéãËÄÖÁöÑÊ∞îË¥®Ôºå‰ΩÜÂÜÖÂøÉÊ∏¥ÊúõË¢´ÁêÜËß£„ÄÇÂ§ñË°®È´òÂÜ∑Ôºå‰ΩÜ‰ºöÈÄêÊ∏êÂ±ïÁé∞Ê∏©ÊüîÁöÑ‰∏ÄÈù¢„ÄÇ'
            };
            return personas[npcId] || personas['alice'];
        }

        // ‰ΩøÁî®ËÆ∞ÂøÜÁ≥ªÁªüÁîüÊàêAIÂõûÂ§ç
        async function generateAIResponseWithMemory(userMessage, contextPrompt) {
            // ËøôÈáåÂ∫îËØ•Ë∞ÉÁî®‰Ω†ÁöÑÂêéÁ´ØAPIÊàñOpenAI API
            // Áé∞Âú®ÂÖàËøîÂõû‰∏Ä‰∏™Ê®°ÊãüÁöÑÂìçÂ∫îÔºåÁ≠âÂæÖ‰Ω†ÈÖçÁΩÆÂ•ΩAPIÂêéÂÜçÊõøÊç¢
            
            console.log('üß† ‰ΩøÁî®ËÆ∞ÂøÜ‰∏ä‰∏ãÊñáÁîüÊàêÂõûÂ§ç:', contextPrompt);
            
            // ‰∏¥Êó∂‰ΩøÁî®ÂéüÊúâÁöÑAIÂõûÂ§çÁ≥ªÁªüÔºå‰ΩÜÂä†ÂÖ•ËÆ∞ÂøÜ‰ø°ÊÅØ
            const baseResponse = generateAIResponse(userMessage);
            
            // Ê∑ªÂä†‰∏Ä‰∫õËÆ∞ÂøÜÁõ∏ÂÖ≥ÁöÑÂìçÂ∫î
            const memoryEnhancedResponses = [
                baseResponse,
                `${baseResponse} ÊàëËøòËÆ∞Âæó‰Ω†‰πãÂâçÊèêÂà∞ÁöÑ‰∫ãÊÉÖÂë¢~`,
                `${baseResponse} Ê†πÊçÆÊàëÂØπ‰Ω†ÁöÑ‰∫ÜËß£Ôºå‰Ω†Â∫îËØ•‰ºöÂñúÊ¨¢Ëøô‰∏™Âª∫ËÆÆ„ÄÇ`,
                `${baseResponse} ËøôËÆ©ÊàëÊÉ≥Ëµ∑‰∫ÜÊàë‰ª¨‰πãÂâçÁöÑÂØπËØù„ÄÇ`
            ];
            
            return memoryEnhancedResponses[Math.floor(Math.random() * memoryEnhancedResponses.length)];
        }
        
        // Âú®VRMÂä†ËΩΩÂÆåÊàêÂêéËá™Âä®ÂàùÂßãÂåñAIËÅäÂ§©Á≥ªÁªü
        function onVRMLoadComplete(characterName, vrmPath) {
            selectedCharacter = {
                name: characterName.replace(' VRM', '').replace('_', ' '),
                personality: getCharacterPersonality(characterName),
                file: vrmPath,
                id: characterName
            };
            
            // ËÆæÁΩÆËßíËâ≤Â§¥ÂÉè
            setCharacterAvatar(characterName);
            
            setTimeout(() => {
                initializeAIChat();
            }, 1500);
        }
        
        // Êõ¥Êñ∞ÊâãÊú∫Áä∂ÊÄÅÊ†èÊó∂Èó¥
        function updatePhoneTime() {
            const timeDisplay = document.getElementById('phone-time');
            if (timeDisplay) {
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false 
                });
                timeDisplay.textContent = timeString;
            }
        }
        
        // ÊØèÂàÜÈíüÊõ¥Êñ∞‰∏ÄÊ¨°Êó∂Èó¥
        setInterval(updatePhoneTime, 60000);
        // Á´ãÂç≥Êõ¥Êñ∞‰∏ÄÊ¨°Êó∂Èó¥
        updatePhoneTime();
        
        window.goToCharacterSelect = goToCharacterSelect;
        window.initDragAndDrop = initDragAndDrop;

        // ÂàùÂßãÂåñ
        function init() {
            console.log('üöÄ AI Companion ÂàùÂßãÂåñÂºÄÂßã...');
            console.log('üåê ÂΩìÂâçÈ°µÈù¢URL:', window.location.href);
            console.log('üì± Èí±ÂåÖÈ™åËØÅÂô®Áä∂ÊÄÅ:', walletAuth);
            
            // È¶ñÂÖàËøõË°åÈí±ÂåÖÈ™åËØÅ
            console.log('‚ö° ÂºÄÂßãË∞ÉÁî®Èí±ÂåÖÈ™åËØÅ...');
            const isAuthenticated = walletAuth.checkAuthentication();
            console.log('üîê È™åËØÅÁªìÊûú:', isAuthenticated);
            
            if (!isAuthenticated) {
                console.log('‚ùå Èí±ÂåÖÈ™åËØÅÂ§±Ë¥•ÔºåÂÅúÊ≠¢ÂàùÂßãÂåñ');
                return; // Â¶ÇÊûúÈ™åËØÅÂ§±Ë¥•Ôºå‰∏çÁªßÁª≠ÂàùÂßãÂåñ
            }
            
            console.log('‚úÖ Èí±ÂåÖÈ™åËØÅÊàêÂäüÔºåÁªßÁª≠ÂàùÂßãÂåñÂ∫îÁî®');
            
            // Áî®Êà∑ËµÑÊñôÂ°´ÂÜôÂ∑≤ÁßªËá≥character-selectÈ°µÈù¢Ôºåindex.htmlÂè™Â§ÑÁêÜÂ∑≤Ê≥®ÂÜåÁî®Êà∑
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÈÄâÊã©ÁöÑËßíËâ≤ÔºåÁÑ∂ÂêéÂä†ËΩΩVRM
            loadSelectedCharacter();
            
            resizeRenderer();
            animate();

            // ÂàùÂßãÂåñÈÄâÊã©Âô®
            initAnimationSelector();
            initCharacterSelector();
            
            // ÂàùÂßãÂåñÊãñÊãΩÂäüËÉΩ
            initDragAndDrop();

            // Âª∂ËøüÂàùÂßãÂåñËÉåÊôØÈü≥‰πêÔºåÁ°Æ‰øùDOMÂÆåÂÖ®Âä†ËΩΩ
            setTimeout(() => {
                initBackgroundMusic();
            }, 1000);

            // ÂàùÂßãÁä∂ÊÄÅ - Ê£ÄÊü•ÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®
            const aiStatusElement = document.getElementById('ai-status');
            if (aiStatusElement) {
                aiStatusElement.innerHTML = '<span class="online-indicator"></span>AIÊô∫ËÉΩÊ®°Âºè';
            }
            
            console.log('üéâ AI Companion ÂàùÂßãÂåñÂÆåÊàê');
        }

        // Âä†ËΩΩÈÄâÊã©ÁöÑËßíËâ≤
        function loadSelectedCharacter() {
            try {
                // ‰ªéÈí±ÂåÖÈ™åËØÅÁ≥ªÁªüËé∑ÂèñËßíËâ≤‰ø°ÊÅØ
                const character = walletAuth.getCurrentCharacter();
                
                console.log('üì± loadSelectedCharacter Ë∞ÉËØï‰ø°ÊÅØ:');
                console.log('- character:', character);
                console.log('- localStorage selectedCharacter:', localStorage.getItem('selectedCharacter'));
                
                if (character) {
                    // Êõ¥Êñ∞ÊÇ¨ÊµÆËÅäÂ§©Ê°Ü‰∏≠ÁöÑËßíËâ≤ÂêçÁß∞
                    const characterNameElement = document.getElementById('character-name');
                    if (characterNameElement) {
                        characterNameElement.textContent = character.name;
                    }
                    
                    // Êõ¥Êñ∞Ê¨¢ËøéÊ∂àÊÅØ - Ê£ÄÊü•ÊòØÂê¶ÊòØËÄÅÁî®Êà∑
                    const welcomeMessage = document.querySelector('.message-bubble.ai .bubble-content');
                    if (welcomeMessage && !welcomeMessage.dataset.updated) {
                        const userProfile = localStorage.getItem(`user_profile_${walletAuth.getCurrentUserId()}`);
                        if (userProfile) {
                            // ËÄÅÁî®Êà∑
                            welcomeMessage.textContent = `Ê¨¢ËøéÂõûÊù•ÔºÅÊàëÊòØ${character.name}ÔºåÊàëËøòËÆ∞ÂæóÊàë‰ª¨‰πãÂâçÁöÑÂØπËØùÂë¢~ üíï`;
                        } else {
                            // Êñ∞Áî®Êà∑
                            welcomeMessage.textContent = `‰Ω†Â•ΩÔºÅÊàëÊòØ${character.name}ÔºåÂæàÈ´òÂÖ¥ËÆ§ËØÜ‰Ω†ÔºÅËÆ©Êàë‰ª¨ÂºÄÂßãÊÑâÂø´ÁöÑËÅäÂ§©Âêß~ üíï`;
                        }
                        welcomeMessage.dataset.updated = 'true';
                    }
                    
                    // ËÆæÁΩÆÈªòËÆ§VRMÊñá‰ª∂
                    defaultVrmFile = character.file;
                    
                    console.log(`‚úÖ Â∑≤Âä†ËΩΩËßíËâ≤: ${character.name} (Èí±ÂåÖ: ${walletAuth.formatAddress(character.walletAddress)})`);
                    console.log(`üìÅ ËÆæÁΩÆdefaultVrmFile: ${defaultVrmFile}`);
                    
                    // ËÆæÁΩÆËßíËâ≤Â§¥ÂÉèÔºàÂü∫‰∫écharacter.idÔºâ
                    if (character.id) {
                        setCharacterAvatar(character.id);
                    }
                    
                    // Áé∞Âú®Âä†ËΩΩVRMÊñá‰ª∂
                    loadVRM();
                } else {
                    throw new Error('Êú™ÊâæÂà∞ËßíËâ≤‰ø°ÊÅØ');
                }
            } catch (error) {
                console.error('Âä†ËΩΩËßíËâ≤Â§±Ë¥•:', error);
                // ÈáçÂÆöÂêëÂà∞ËßíËâ≤ÈÄâÊã©È°µÈù¢
                walletAuth.redirectToCharacterSelect();
            }
        }

        // Êö¥Èú≤ÂèòÈáèÂà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü‰ª•‰æõÊåâÈíÆË∞ÉÁî®
        window.currentVrm = currentVrm;
        window.availableExpressions = availableExpressions;
        
        // Êö¥Èú≤ÂÜÖÈÉ®ÂáΩÊï∞Âà∞ÂÖ®Â±Ä
        window.resetExpressions = resetExpressions;
        window.setExpression = setExpression;

        // Á≠âÂæÖDOMÂä†ËΩΩÂÆåÊàêÂêéÂÜçÂàùÂßãÂåñ
        console.log('üîç Ê£ÄÊü•DOMÁä∂ÊÄÅ:', document.readyState);
        console.log('üîç initÂáΩÊï∞ÊòØÂê¶Â≠òÂú®:', typeof init);
        console.log('‚öôÔ∏è Ê®°ÂùóËÑöÊú¨ÊâßË°åÂÆåÊØïÔºåÂáÜÂ§áÂàùÂßãÂåñ...');
        
        if (document.readyState === 'loading') {
            console.log('‚è≥ DOMÂä†ËΩΩ‰∏≠ÔºåÁ≠âÂæÖDOMContentLoaded‰∫ã‰ª∂');
            document.addEventListener('DOMContentLoaded', () => {
                console.log('‚úÖ DOMContentLoaded‰∫ã‰ª∂Ëß¶ÂèëÔºåË∞ÉÁî®init()');
                init();
            });
        } else {
            // DOMÂ∑≤ÁªèÂä†ËΩΩÂÆåÊàê
            console.log('‚úÖ DOMÂ∑≤Âä†ËΩΩÔºåÁ´ãÂç≥Ë∞ÉÁî®init()');
            init();
        }
    </script>

    <script>
        // ÂÖ®Â±ÄË°®ÊÉÖÊµãËØïÂáΩÊï∞
        window.testShyExpression = function() {
            console.log('üß™ ÊµãËØïÂÆ≥ÁæûË°®ÊÉÖ...');
            
            if (!window.currentVrm || !window.currentVrm.expressionManager) {
                alert('VRMÊ®°ÂûãËøòÊú™Âä†ËΩΩÂÆåÊàêÔºÅËØ∑Á≠âÂæÖÂä†ËΩΩ...');
                return;
            }

            console.log('ÂèØÁî®Ë°®ÊÉÖ:', window.availableExpressions);
            
            // ÈáçÁΩÆÊâÄÊúâË°®ÊÉÖ
            if (window.resetExpressions) {
                window.resetExpressions();
            }
            
            // Â∞ùËØïÂ§öÁßçÂÆ≥ÁæûÁõ∏ÂÖ≥ÁöÑË°®ÊÉÖ
            const shyExpressions = ['shy', 'embarrassed', 'blush', 'surprised', 'sad'];
            let appliedExpression = null;
            
            shyExpressions.forEach(expr => {
                if (window.availableExpressions && window.availableExpressions.includes(expr)) {
                    if (window.setExpression) {
                        window.setExpression(expr, 1.0);
                        appliedExpression = expr;
                        console.log(`‚úÖ Â∫îÁî®Ë°®ÊÉÖ: ${expr}`);
                    }
                }
            });
            
            if (appliedExpression) {
                document.getElementById('current-expression').textContent = `ÂÆ≥Áæû (${appliedExpression})`;
                // 5ÁßíÂêéÊÅ¢Â§ç‰∏≠ÊÄß
                setTimeout(() => {
                    if (window.resetExpressions) {
                        window.resetExpressions();
                    }
                }, 5000);
            } else {
                const available = window.availableExpressions ? window.availableExpressions.join(', ') : 'Êó†';
                alert('ÂΩìÂâçVRMÊ®°Âûã‰∏çÊîØÊåÅÂÆ≥ÁæûË°®ÊÉÖ üòî\n\nÂèØÁî®Ë°®ÊÉÖ: ' + available + '\n\nÂª∫ËÆÆÔºöÂ∞ùËØïÁÇπÂáªÂÖ∂‰ªñË°®ÊÉÖÊåâÈíÆÁúãÁúãÊïàÊûúÔºÅ');
            }
        };

        window.testHappyExpression = function() {
            if (!window.currentVrm || !window.currentVrm.expressionManager) {
                alert('VRMÊ®°ÂûãËøòÊú™Âä†ËΩΩÂÆåÊàêÔºÅ');
                return;
            }

            if (window.availableExpressions && window.availableExpressions.includes('happy')) {
                if (window.setExpression) {
                    window.setExpression('happy', 1.0);
                    document.getElementById('current-expression').textContent = 'ÂºÄÂøÉ';
                    setTimeout(() => {
                        if (window.resetExpressions) {
                            window.resetExpressions();
                        }
                    }, 3000);
                }
            } else {
                const available = window.availableExpressions ? window.availableExpressions.join(', ') : 'Êó†';
                alert('ÂΩìÂâçVRMÊ®°Âûã‰∏çÊîØÊåÅÂºÄÂøÉË°®ÊÉÖ\nÂèØÁî®Ë°®ÊÉÖ: ' + available);
            }
        };

        window.testSadExpression = function() {
            if (!window.currentVrm || !window.currentVrm.expressionManager) {
                alert('VRMÊ®°ÂûãËøòÊú™Âä†ËΩΩÂÆåÊàêÔºÅ');
                return;
            }

            if (window.availableExpressions && window.availableExpressions.includes('sad')) {
                if (window.setExpression) {
                    window.setExpression('sad', 1.0);
                    document.getElementById('current-expression').textContent = 'ÈöæËøá';
                    setTimeout(() => {
                        if (window.resetExpressions) {
                            window.resetExpressions();
                        }
                    }, 3000);
                }
            } else {
                const available = window.availableExpressions ? window.availableExpressions.join(', ') : 'Êó†';
                alert('ÂΩìÂâçVRMÊ®°Âûã‰∏çÊîØÊåÅÈöæËøáË°®ÊÉÖ\nÂèØÁî®Ë°®ÊÉÖ: ' + available);
            }
        };

        window.resetAllExpressions = function() {
            if (!window.currentVrm || !window.currentVrm.expressionManager) {
                alert('VRMÊ®°ÂûãËøòÊú™Âä†ËΩΩÂÆåÊàêÔºÅ');
                return;
            }

            if (window.resetExpressions) {
                window.resetExpressions();
            }
            console.log('üîÑ ÊâÄÊúâË°®ÊÉÖÂ∑≤ÈáçÁΩÆ');
        };
    </script>
    
    <!-- Áî®Êà∑ËµÑÊñôÊ≥®ÂÜåÈù¢Êùø -->

    <!-- Èí±ÂåÖËøûÊé•ÈÅÆÁΩ©Â±ÇÔºàÂàùÂßãÈöêËóèÔºâ -->
    
    <!-- Áî®Êà∑ËµÑÊñôÁÆ°ÁêÜÂ∑≤ÁßªËá≥character-selectÈ°µÈù¢ -->

    <!-- Èí±ÂåÖËøûÊé•ÈÅÆÁΩ©Â±ÇÔºàÂàùÂßãÈöêËóèÔºâ -->
    <div class="wallet-login-overlay" id="wallet-login-overlay" style="display: none;">
        <div class="wallet-login-panel">
            <div class="wallet-login-icon">ü¶ä</div>
            <h2 class="wallet-login-title">ËøûÊé•Èí±ÂåÖÂºÄÂßãÊ∏∏Êàè</h2>
            <p class="wallet-login-subtitle">‰ΩøÁî®SolanaÈí±ÂåÖÁôªÂΩïÔºå‰∏éÊÇ®ÁöÑ‰∏ìÂ±ûAIÂ•≥ÂèãÂºÄÂßãËÅäÂ§©</p>
            
            <button class="wallet-connect-btn" onclick="connectWallet()" id="wallet-connect-btn">
                ËøûÊé•Èí±ÂåÖ
            </button>
            
            <div class="wallet-options">
                <a href="https://phantom.app/" target="_blank" class="wallet-option">
                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #AB9FF2, #7B6BF0); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">P</div>
                    <span>Phantom</span>
                </a>
                <a href="https://solflare.com/" target="_blank" class="wallet-option">
                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #FF6B35, #F7931E); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">S</div>
                    <span>Solflare</span>
                </a>
            </div>
            
            <p style="font-size: 12px; color: #999; margin-top: 20px;">
                üí° Ê≤°ÊúâÈí±ÂåÖÔºüÁÇπÂáª‰∏äÊñπÂõæÊ†áÂÆâË£ÖÂêéÂà∑Êñ∞È°µÈù¢
            </p>
        </div>
    </div>
    
    <!-- È°µÈù¢Âä†ËΩΩÂêéÂàùÂßãÂåñ -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Ê£ÄÊü•ÊòØÂê¶‰ªéËßíËâ≤ÈÄâÊã©È°µÈù¢Ë∑≥ËΩ¨ËøáÊù•
            const hasStoredWallet = localStorage.getItem('wallet_address');
            const hasSelectedCharacter = localStorage.getItem('selectedCharacter');
            
            if (hasStoredWallet && hasSelectedCharacter) {
                console.log('üöÄ ‰ªéËßíËâ≤ÈÄâÊã©È°µÈù¢Ë∑≥ËΩ¨ÔºåÂºÄÂßãÂàùÂßãÂåñËÅäÂ§©...');
                
                // Èí±ÂåÖÂ∑≤Âú®character-selectÈ°µÈù¢È™åËØÅÔºåÁõ¥Êé•ÊòæÁ§∫Â∑≤ÁôªÂΩïÁä∂ÊÄÅ
                
                // ÊöÇÊó∂Ë∑≥ËøáËÆ∞ÂøÜÁ≥ªÁªüÂàùÂßãÂåñÔºåÁõ¥Êé•‰ΩøÁî®OpenAI
                console.log('‚ö†Ô∏è Ë∑≥ËøáËÆ∞ÂøÜÁ≥ªÁªüÂàùÂßãÂåñÔºåÁõ¥Êé•‰ΩøÁî®OpenAIËÅäÂ§©');
                console.log('üí¨ ËÅäÂ§©Á≥ªÁªüÂ∑≤ÂáÜÂ§áÂ∞±Áª™');

                // Áî®Êà∑ËµÑÊñôÊ£ÄÊü•Â∑≤ÁßªËá≥init()ÂáΩÊï∞‰∏≠ÔºåÁ°Æ‰øùÂú®Èí±ÂåÖÈ™åËØÅÂêéÁ´ãÂç≥ÊâßË°å
                
                // Á≠âÂæÖËÅäÂ§©Á≥ªÁªüÂàùÂßãÂåñ
                setTimeout(() => {
                    if (window.chatSystemV2) {
                        console.log('üí¨ ËÅäÂ§©Á≥ªÁªüÂ∑≤ÂáÜÂ§áÂ∞±Áª™');
                    }
                }, 1000);
            }
        });
    </script>
</body>

</html>