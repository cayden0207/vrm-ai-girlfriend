<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com; style-src 'self' 'unsafe-inline' https://unpkg.com; img-src 'self' data: blob: https://mintlify.s3.us-west-1.amazonaws.com https://assets.coingecko.com https://cdn.jsdelivr.net https://raw.githubusercontent.com https://images.ctfassets.net https://avatars.githubusercontent.com https://backpack.app https://www.madlads.com https://pbs.twimg.com https://static.okx.com https://img.bitgetimg.com https://tp-statics.tokenpocket.pro; media-src 'self' blob: data:; connect-src 'self' blob: http://localhost:3000 https://api.devnet.solana.com https://api.elevenlabs.io;">
    <title>HEROES - 选择你的女友角色</title>
    <link rel="stylesheet" href="wallet-ui.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow: hidden;
            color: white;
            position: relative;
            margin: 0;
            padding: 0;
            background: url('BG/selection-bg.jpg') center/cover no-repeat;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* 顶部标题 */
        .heroes-title {
            position: absolute;
            top: 12px;
            left: 12px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            z-index: 100;
        }

        /* 角色信息面板 - 日式档案卡设计 */
        .character-info {
            position: absolute;
            top: 40px;
            left: 12px;
            width: 190px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(200, 200, 200, 0.5);
            border-radius: 7px;
            padding: 0;
            z-index: 100;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        .character-name {
            font-size: 10px;
            font-weight: bold;
            color: #333;
            margin: 0;
            text-align: center;
            padding: 8px;
            background: rgba(255, 255, 255, 0.8);
            border-bottom: 1px solid rgba(200, 200, 200, 0.3);
        }

        .profile-section {
            margin-bottom: 2px;
        }

        .profile-header {
            background: linear-gradient(135deg, #2c2c2c, #1a1a1a);
            color: white;
            padding: 4px 8px;
            font-size: 7px;
            font-weight: 600;
            position: relative;
            border-left: 2px solid #e91e63;
        }

        .profile-content {
            background: rgba(248, 248, 248, 0.95);
            padding: 8px;
            color: #333;
        }

        .profile-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid rgba(200, 200, 200, 0.3);
        }

        .profile-row:last-child {
            border-bottom: none;
        }

        .profile-label {
            font-size: 7px;
            color: #666;
            font-weight: 500;
        }

        .profile-value {
            font-size: 7px;
            color: #333;
            font-weight: 600;
        }

        .profile-text {
            font-size: 7px;
            color: #333;
            line-height: 1.4;
            padding: 2px 0;
        }

        .favorite-section {
            background: rgba(248, 248, 248, 0.95);
            padding: 8px;
            color: #333;
            text-align: center;
            font-size: 7px;
        }

        .expand-button {
            position: absolute;
            top: 4px;
            right: 6px;
            width: 12px;
            height: 12px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 2px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
        }

        .refresh-button {
            position: absolute;
            bottom: 8px;
            right: 8px;
            width: 16px;
            height: 16px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        }

        /* 浮动语音选择器样式 - 基于参考截图 */
        .voice-selector-floating {
            position: absolute;
            top: 20%; /* 从40%调整为20%，向上移动50% */
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 50px;
            padding: 12px 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            animation: fadeInUp 0.6s ease-out;
        }

        .language-flags {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .flag-btn {
            background: transparent;
            border: none;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            opacity: 0.7;
            position: relative;
        }

        .flag-btn:hover {
            transform: scale(1.15);
            opacity: 1;
        }

        .flag-btn.active {
            opacity: 1;
            background: rgba(100, 150, 255, 0.15);
            box-shadow: 0 0 0 3px rgba(100, 150, 255, 0.4);
            transform: scale(1.1);
        }

        .flag-btn.active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background: #4285f4;
            border-radius: 50%;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translate(-50%, -40%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        /* 中央角色名称显示 */
        .character-display-name {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 36px;
            font-weight: bold;
            color: white;
            text-shadow: 1.5px 1.5px 3px rgba(0, 0, 0, 0.5);
            z-index: 50;
            opacity: 0.9;
        }

        /* VRM展示区域 - 中央 */
        .vrm-display {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .vrm-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* 简化的加载动画样式 */
        .character-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            display: none;
            flex-direction: column;
            align-items: center;
            animation: fadeInLoader 0.3s ease-out;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border-radius: 16px;
            box-shadow: 40px 0px 0 0 rgba(255, 255, 255, 0.2), 
                       32.4px 23.5px 0 0 rgba(255, 255, 255, 0.4), 
                       12.4px 38px 0 0 rgba(255, 255, 255, 0.6), 
                       -12.4px 38px 0 0 rgba(255, 255, 255, 0.8), 
                       -32.4px 23.5px 0 0 #ffffff;
            animation: spinner-rotate 1s infinite linear;
            margin-bottom: 20px;
        }

        .loader-text {
            font-size: 16px;
            color: white;
            text-align: center;
            letter-spacing: 3px;
            font-weight: 600;
            text-transform: uppercase;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        @keyframes spinner-rotate {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeInLoader {
            from { 
                opacity: 0; 
                transform: translate(-50%, -50%) scale(0.9);
            }
            to { 
                opacity: 1; 
                transform: translate(-50%, -50%) scale(1);
            }
        }



        /* 角色选择器 - 底部 - 模仿截图样式 */
        .character-selector {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 9px;
            padding: 12px 31px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(4px);
            border-radius: 60px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            z-index: 100;
            box-shadow: 0 1px 7px rgba(0, 0, 0, 0.1);
        }

        /* 导航按钮 - 左右箭头 */
        .nav-button {
            width: 42px;
            height: 42px;
            border: 3px solid rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 21px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .nav-button:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.1);
        }

        .character-thumbnails {
            display: flex;
            gap: 9px;
            align-items: center;
        }

        .character-thumb {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
            position: relative;
            background: white;
        }

        /* 当前选中的角色 */
        .character-thumb.active {
            border-color: #FFD700;
            transform: scale(1.15);
            box-shadow: 0 0 7px rgba(255, 215, 0, 0.6);
        }

        /* 中心的选中指示器 - 模仿截图设计 */
        .selected-indicator {
            width: 75px;
            height: 105px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            border-radius: 18px;
            border: 1.5px solid rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 6px;
            margin: 0 9px;
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.15);
            position: relative;
        }
        
        .selected-indicator .selected-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            overflow: hidden;
            margin-bottom: 6px;
            border: 1.5px solid white;
        }
        
        .selected-indicator .selected-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .selected-indicator .selected-badge {
            width: 18px;
            height: 18px;
            background: #000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 9px;
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .selected-indicator .selected-text {
            color: #666;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .character-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .character-thumb:hover {
            transform: scale(1.05);
            border-color: white;
        }

        .character-thumb.selected {
            width: 40px;
            height: 40px;
            border-color: #333;
            border-width: 2px;
            transform: scale(1);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }

        .character-thumb.selected::before {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            border: 2px solid #ffd700;
            border-radius: 50%;
            z-index: -1;
        }

        .character-thumb.selected::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 8px;
            background: #ffd700;
            border-radius: 50%;
        }

        .select-indicator {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 14px;
            color: white;
            font-weight: 500;
        }


        /* 右上角钱包连接区域 */
        .wallet-connect-area {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        /* 现代化连接按钮 - 基于UI参考 */
        .wallet-connect-button {
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
            border: none;
            border-radius: 30px;
            padding: 12px 24px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.3);
            min-width: 120px;
            justify-content: center;
        }

        .wallet-connect-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(139, 92, 246, 0.4);
            background: linear-gradient(135deg, #7c3aed 0%, #9333ea 100%);
        }

        .wallet-connect-button:active {
            transform: translateY(-1px);
        }

        .wallet-connect-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .wallet-loading {
            animation: spin 1s linear infinite;
        }

        /* 已连接状态显示 */
        .wallet-info {
            background: rgba(26, 26, 26, 0.95);
            border: 1px solid #333333;
            border-radius: 20px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 220px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        }

        .wallet-info-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .wallet-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 20px;
        }

        .wallet-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .wallet-address {
            color: #ffffff;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        .wallet-balance {
            color: #888888;
            font-size: 12px;
        }

        .wallet-actions {
            position: relative;
        }

        .wallet-menu-btn {
            background: none;
            border: none;
            color: #888888;
            font-size: 16px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .wallet-menu-btn:hover {
            background: #2a2a2a;
            color: #ffffff;
        }

        .wallet-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: #1a1a1a;
            border: 1px solid #333333;
            border-radius: 12px;
            min-width: 180px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            z-index: 1001;
            overflow: hidden;
            display: none;
        }

        .wallet-dropdown-item {
            padding: 12px 16px;
            color: #ffffff;
            cursor: pointer;
            transition: background 0.2s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .wallet-dropdown-item:hover {
            background: #2a2a2a;
        }

        .wallet-dropdown-item:last-child {
            border-top: 1px solid #333333;
            color: #ef4444;
        }

        .wallet-dropdown-item:last-child:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* 钱包连接模态框 - 基于UI参考设计 */
        .wallet-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s ease;
        }

        .wallet-modal-overlay {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .wallet-modal-content {
            background: #1a1a1a;
            border-radius: 24px;
            padding: 32px;
            width: 100%;
            max-width: 420px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
        }

        .wallet-modal-header {
            margin-bottom: 32px;
            text-align: left;
        }

        .wallet-modal-header h2 {
            color: #ffffff;
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .wallet-modal-header p {
            color: #888888;
            font-size: 16px;
            line-height: 1.5;
            margin: 0;
        }

        .wallet-close-btn {
            position: absolute;
            top: 24px;
            right: 24px;
            background: none;
            border: none;
            color: #888888;
            font-size: 24px;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .wallet-close-btn:hover {
            background: #2a2a2a;
            color: #ffffff;
        }

        /* 钱包选项列表 */
        .wallet-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 32px;
        }

        .wallet-option {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            background: #2a2a2a;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
            text-decoration: none;
            color: #ffffff;
        }

        .wallet-option:hover {
            background: #333333;
            border-color: #444444;
            transform: translateY(-1px);
        }

        .wallet-option:active {
            transform: translateY(0);
        }

        /* Phantom钱包特殊高亮效果 */
        .wallet-option[data-provider="phantom"]:hover {
            background: linear-gradient(135deg, rgba(171, 159, 242, 0.1), rgba(171, 159, 242, 0.05));
            border-color: rgba(171, 159, 242, 0.3);
            box-shadow: 0 4px 20px rgba(171, 159, 242, 0.1);
        }

        .wallet-option-icon {
            font-size: 24px;
            margin-right: 16px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
        }

        .wallet-option-name {
            color: #ffffff;
            font-size: 18px;
            font-weight: 600;
            flex: 1;
        }

        .wallet-option-arrow {
            color: #666666;
            font-size: 18px;
            transition: all 0.2s ease;
        }

        .wallet-option:hover .wallet-option-arrow {
            color: #ffffff;
            transform: translateX(4px);
        }

        /* 页脚 */
        .wallet-modal-footer {
            text-align: center;
            padding-top: 24px;
            border-top: 1px solid #2a2a2a;
        }

        .wallet-modal-footer p {
            color: #666666;
            font-size: 14px;
            line-height: 1.5;
        }

        .wallet-link {
            color: #4f46e5;
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .wallet-link:hover {
            color: #6366f1;
        }

        /* 动画 */
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* 消息提示 */
        .wallet-toast {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #1a1a1a;
            border: 1px solid #333333;
            border-radius: 12px;
            padding: 12px 20px;
            color: #ffffff;
            font-size: 14px;
            z-index: 10001;
            animation: toastSlideIn 0.3s ease;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
        }

        .wallet-toast-success {
            border-left: 4px solid #10b981;
        }

        .wallet-toast-error {
            border-left: 4px solid #ef4444;
        }

        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }


        /* 开始按钮 - 现代渐变设计 */
        .start-button {
            --h-button: 100px;
            --w-button: 280px;
            --round: 50px;
            cursor: pointer;
            position: absolute;
            bottom: 40px;
            right: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            overflow: visible;
            transition: all 0.25s ease;
            animation: pulse 2s infinite;
            box-shadow: 0 8px 30px rgba(135, 206, 250, 0.4);
            background: linear-gradient(135deg, #E6B3FF 0%, #B3D9FF 100%);
            border-radius: var(--round);
            border: 2px solid rgba(255, 255, 255, 0.6);
            outline: none;
            padding: 15px 30px;
            z-index: 100;
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .start-button::before {
            content: "✨";
            position: absolute;
            left: -20px;
            top: -10px;
            font-size: 16px;
            animation: twinkle 1.5s infinite alternate;
        }
        
        .start-button::after {
            content: "✨";
            position: absolute;
            right: -15px;
            bottom: -5px;
            font-size: 14px;
            animation: twinkle 1.8s infinite alternate;
        }

        @keyframes twinkle {
            0% { opacity: 0.3; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1.2); }
        }

        .start-button:active {
            transform: scale(0.95);
        }
        
        .start-button:hover {
            box-shadow: 0 12px 40px rgba(135, 206, 250, 0.6);
            transform: translateY(-2px);
        }

        .points_wrapper {
            overflow: hidden;
            width: 100%;
            height: 100%;
            pointer-events: none;
            position: absolute;
            z-index: 1;
        }

        .points_wrapper .point {
            bottom: -10px;
            position: absolute;
            animation: floating-points infinite ease-in-out;
            pointer-events: none;
            width: 2px;
            height: 2px;
            background-color: #fff;
            border-radius: 9999px;
        }

        @keyframes floating-points {
            0% {
                transform: translateY(0);
            }
            85% {
                opacity: 0;
            }
            100% {
                transform: translateY(-55px);
                opacity: 0;
            }
        }

        .points_wrapper .point:nth-child(1) {
            left: 10%;
            opacity: 1;
            animation-duration: 2.35s;
            animation-delay: 0.2s;
        }
        .points_wrapper .point:nth-child(2) {
            left: 30%;
            opacity: 0.7;
            animation-duration: 2.5s;
            animation-delay: 0.5s;
        }
        .points_wrapper .point:nth-child(3) {
            left: 25%;
            opacity: 0.8;
            animation-duration: 2.2s;
            animation-delay: 0.1s;
        }
        .points_wrapper .point:nth-child(4) {
            left: 44%;
            opacity: 0.6;
            animation-duration: 2.05s;
        }
        .points_wrapper .point:nth-child(5) {
            left: 50%;
            opacity: 1;
            animation-duration: 1.9s;
        }
        .points_wrapper .point:nth-child(6) {
            left: 75%;
            opacity: 0.5;
            animation-duration: 1.5s;
            animation-delay: 1.5s;
        }
        .points_wrapper .point:nth-child(7) {
            left: 88%;
            opacity: 0.9;
            animation-duration: 2.2s;
            animation-delay: 0.2s;
        }
        .points_wrapper .point:nth-child(8) {
            left: 58%;
            opacity: 0.8;
            animation-duration: 2.25s;
            animation-delay: 0.2s;
        }
        .points_wrapper .point:nth-child(9) {
            left: 98%;
            opacity: 0.6;
            animation-duration: 2.6s;
            animation-delay: 0.1s;
        }
        .points_wrapper .point:nth-child(10) {
            left: 65%;
            opacity: 1;
            animation-duration: 2.5s;
            animation-delay: 0.2s;
        }

        .inner {
            z-index: 2;
            gap: 3px;
            position: relative;
            width: 100%;
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 700;
            line-height: 1.5;
            transition: color 0.2s ease-in-out;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.8),
                         0 0 40px rgba(223, 113, 255, 0.6);
            letter-spacing: 0.1em;
        }

        .inner svg.icon {
            width: 9px;
            height: 9px;
            transition: fill 0.1s linear;
        }

        .start-button:focus svg.icon {
            fill: white;
        }
        .start-button:hover svg.icon {
            fill: transparent;
            animation:
                dasharray 1s linear forwards,
                filled 0.1s linear forwards 0.95s;
        }
        @keyframes dasharray {
            from {
                stroke-dasharray: 0 0 0 0;
            }
            to {
                stroke-dasharray: 68 68 0 0;
            }
        }
        @keyframes filled {
            to {
                fill: white;
            }
        }


        /* 响应式设计 */
        @media (max-width: 768px) {
            .heroes-title {
                font-size: 32px;
            }

            .character-display-name {
                font-size: 48px;
                bottom: 180px;
            }

            .character-info {
                top: 100px;
                left: 20px;
                right: 20px;
                max-width: none;
            }

            .control-panel {
                top: 20px;
                right: 20px;
            }

            .character-selector {
                bottom: 20px;
                left: 20px;
                right: 20px;
                transform: none;
            }

            .start-button {
                bottom: 20px;
                right: 20px;
            }
        }

        /* 用户资料面板样式 - 精确复刻设计 */
        .user-profile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            background: rgba(0, 0, 0, 0.16);
            backdrop-filter: blur(6px);
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s ease;
        }

        .profile-panel {
            background: white;
            border-radius: 25px;
            padding: 8px; /* 添加白色边框效果 */
            max-width: 416px; /* 320px * 1.3 = 416px */
            width: 85%;
            max-height: 85vh; /* 添加最大高度 */
            position: relative;
            box-shadow: 0 12px 35px rgba(0,0,0,0.2);
            border: 3px solid #F0F0F0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .profile-panel-header {
            background: linear-gradient(180deg, #B3E5FC 0%, #81D4FA 50%, #4FC3F7 100%);
            text-align: center;
            padding: 25px 0; /* 更大的内边距 */
            margin: 0;
            position: relative;
            flex-shrink: 0; /* 防止头部被压缩 */
            border-radius: 20px 20px 0 0; /* 只有顶部圆角 */
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.3), 
                        0 2px 4px rgba(0,0,0,0.1);
        }

        .profile-panel-title {
            font-size: 24px; /* 更大的字体 */
            margin: 0;
            font-weight: 600; /* 更粗的字重 */
            color: #2E3A47; /* 更深的颜色 */
            text-shadow: 0 1px 2px rgba(255,255,255,0.5);
            letter-spacing: 1px; /* 增加字间距 */
        }

        .profile-form {
            padding: 30px; /* 调整内边距 */
            display: flex;
            flex-direction: column;
            gap: 30px; 
            overflow-y: auto; /* 启用垂直滚动 */
            flex: 1; /* 占据剩余空间 */
            max-height: calc(85vh - 90px); /* 减去头部和边框高度 */
            background: white;
            border-radius: 0 0 17px 17px; /* 底部圆角，配合外层边框 */
        }

        .profile-field {
            display: flex;
            flex-direction: column;
            gap: 16px; /* 12px * 1.3 ≈ 16px */
            position: relative;
        }

        /* 金色装饰线条 */
        .field-label {
            font-size: 18px; /* 14px * 1.3 ≈ 18px */
            font-weight: 500;
            color: #D4AF37;
            text-align: center;
            margin: 0;
            position: relative;
            padding: 0 26px; /* 20px * 1.3 ≈ 26px */
        }

        .field-label::before,
        .field-label::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 52px; /* 40px * 1.3 ≈ 52px */
            height: 1px;
            background: #D4AF37;
        }

        .field-label::before {
            left: 0;
        }

        .field-label::after {
            right: 0;
        }

        .profile-input, .profile-select {
            padding: 16px 46px 16px 20px; /* 12px*1.3≈16px, 35px*1.3≈46px, 15px*1.3≈20px */
            border: none;
            border-radius: 10px; /* 8px * 1.3 ≈ 10px */
            background: #E1F5FE;
            color: #333;
            font-size: 18px; /* 14px * 1.3 ≈ 18px */
            transition: all 0.3s ease;
            position: relative;
        }

        .profile-input:focus, .profile-select:focus {
            outline: none;
            background: #B3E5FC;
        }

        .profile-input::placeholder {
            color: rgba(0,0,0,0.5);
        }

        /* 输入框羽毛笔图标 */
        .profile-field::after {
            content: '🪶';
            position: absolute;
            right: 16px; /* 12px * 1.3 ≈ 16px */
            top: 49px; /* 38px * 1.3 ≈ 49px */
            font-size: 16px; /* 12px * 1.3 ≈ 16px */
            pointer-events: none;
        }

        .name-inputs, .birthday-inputs {
            display: flex;
            gap: 10px; /* Reduced gap for 3 selects */
            position: relative;
        }

        .name-inputs .profile-input,
        .birthday-inputs .profile-select {
            flex: 1;
        }
        
        .birthday-inputs .profile-select {
            min-width: 0; /* Allow shrinking */
        }

        .field-note {
            font-size: 14px; /* 11px * 1.3 ≈ 14px */
            color: #E91E63;
            line-height: 1.3;
            text-align: center;
            margin-top: 7px; /* 5px * 1.3 ≈ 7px */
        }

        .profile-submit-btn {
            padding: 16px 52px; /* 12px*1.3≈16px, 40px*1.3≈52px */
            border: none;
            border-radius: 26px; /* 20px * 1.3 ≈ 26px */
            font-size: 21px; /* 16px * 1.3 ≈ 21px */
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #FF69B4, #E91E63);
            color: white;
            font-weight: 500;
            margin: 20px auto 0; /* 15px * 1.3 ≈ 20px */
            box-shadow: 0 4px 16px rgba(233, 30, 99, 0.3); /* 3px*1.3≈4px, 12px*1.3≈16px */
            display: block;
            width: 156px; /* 120px * 1.3 ≈ 156px */
        }

        .profile-submit-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.4);
        }

        .profile-submit-btn:active {
            transform: translateY(0px);
        }

        /* 特殊样式调整 */
        .birthday-inputs .profile-field::after {
            display: none; /* 生日选择框不显示编辑图标 */
        }

        .profile-field.has-multiple-inputs::after {
            display: none; /* 多个输入框的字段不显示编辑图标 */
        }

        /* 记忆系统样式 */
        .memory-section {
            background: rgba(255,255,255,0.2);
            border-radius: 16px; /* 12px * 1.3 ≈ 16px */
            padding: 26px; /* 20px * 1.3 ≈ 26px */
            margin-top: 13px; /* 10px * 1.3 ≈ 13px */
        }

        .memory-title {
            text-align: center;
            color: #D4AF37;
            font-size: 18px; /* 14px * 1.3 ≈ 18px */
            font-weight: 500;
            margin-bottom: 20px; /* 15px * 1.3 ≈ 20px */
            position: relative;
            padding: 0 26px; /* 20px * 1.3 ≈ 26px */
        }

        .memory-title::before,
        .memory-title::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 39px; /* 30px * 1.3 ≈ 39px */
            height: 1px;
            background: #D4AF37;
        }

        .memory-title::before {
            left: 0;
        }

        .memory-title::after {
            right: 0;
        }

        .memory-field {
            margin-bottom: 16px; /* 12px * 1.3 ≈ 16px */
            position: relative;
        }

        .memory-label {
            font-size: 16px; /* 12px * 1.3 ≈ 16px */
            color: #666;
            margin-bottom: 7px; /* 5px * 1.3 ≈ 7px */
            display: block;
        }

        .memory-input {
            width: 100%;
            padding: 10px 39px 10px 16px; /* 8px*1.3≈10px, 30px*1.3≈39px, 12px*1.3≈16px */
            border: none;
            border-radius: 8px; /* 6px * 1.3 ≈ 8px */
            background: #F0F8FF;
            color: #333;
            font-size: 16px; /* 12px * 1.3 ≈ 16px */
            box-sizing: border-box;
        }

        .memory-field::after {
            content: '🪶'; /* 改为羽毛笔图标 */
            position: absolute;
            right: 10px; /* 8px * 1.3 ≈ 10px */
            top: 36px; /* 28px * 1.3 ≈ 36px */
            font-size: 13px; /* 10px * 1.3 ≈ 13px */
            pointer-events: none;
        }

        /* 动画效果 */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 10px 40px rgba(223, 113, 255, 0.4);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 15px 60px rgba(223, 113, 255, 0.6);
                transform: scale(1.02);
            }
        }

        .character-info,
        .character-selector,
        .start-button,
        .control-panel {
            animation: fadeInUp 0.8s ease-out;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- 顶部标题 -->
        <div class="heroes-title">HEROES</div>

        <!-- 角色信息面板 - 日式档案卡UI -->
        <div class="character-info">
            <div class="character-name" id="character-name">Fliza</div>
            
            <div class="profile-section">
                <div class="profile-header">
                    プロフィール/Basic Info
                    <button class="expand-button">↗</button>
                </div>
                <div class="profile-content">
                    <div class="profile-row">
                        <span class="profile-label">年龄/Age</span>
                        <span class="profile-value" id="character-age">22歳</span>
                    </div>
                    <div class="profile-row">
                        <span class="profile-label">诞生日/Birthday</span>
                        <span class="profile-value" id="character-birthday">6月5日</span>
                    </div>
                    <div class="profile-row">
                        <span class="profile-label">星座/Zodiac</span>
                        <span class="profile-value" id="character-zodiac">双子座</span>
                    </div>
                </div>
            </div>
            
            <div class="profile-section">
                <div class="profile-header">
                    性格/Personality
                </div>
                <div class="profile-content">
                    <div class="profile-text" id="character-personality">
                        活泼外向，调皮可爱
                    </div>
                </div>
            </div>
            
            <div class="profile-section">
                <div class="profile-header">
                    兴趣/Daily Interests
                </div>
                <div class="profile-content">
                    <div class="profile-text" id="character-interests">
                        跳舞、唱歌
                    </div>
                </div>
            </div>
            
            <div class="profile-section">
                <div class="profile-header">
                    喜好 & 讨厌/Likes & Dislikes
                </div>
                <div class="profile-content">
                    <div class="profile-row">
                        <span class="profile-label">喜欢</span>
                        <span class="profile-value" id="character-likes">鲜花和彩色甜点</span>
                    </div>
                    <div class="profile-row">
                        <span class="profile-label">讨厌</span>
                        <span class="profile-value" id="character-dislikes">安静和过于严肃的场合</span>
                    </div>
                </div>
            </div>
            
            <div class="profile-section">
                <div class="profile-header">
                    最爱/Favorites
                    <button class="expand-button">↗</button>
                </div>
                <div class="profile-content">
                    <div class="profile-row">
                        <span class="profile-label">食物</span>
                        <span class="profile-value" id="character-food">草莓蛋糕、马卡龙</span>
                    </div>
                    <div class="profile-row">
                        <span class="profile-label">音乐</span>
                        <span class="profile-value" id="character-music">流行舞曲、K-Pop</span>
                    </div>
                    <div class="profile-row">
                        <span class="profile-label">电影</span>
                        <span class="profile-value" id="character-movies">浪漫喜剧</span>
                    </div>
                    <div class="profile-row">
                        <span class="profile-label">游戏</span>
                        <span class="profile-value" id="character-games">节奏舞蹈游戏</span>
                    </div>
                </div>
            </div>
            
            <button class="refresh-button">⟲</button>
        </div>

        <!-- 中央角色名称 -->
        <div class="character-display-name" id="character-display-name">芙莉莎</div>

        <!-- 语音选择器 - 浮动控件 -->
        <div class="voice-selector-floating">
            <div class="language-flags">
                <button class="flag-btn active" data-lang="jp" onclick="playVoiceSample('jp')">🇯🇵</button>
                <button class="flag-btn" data-lang="cn" onclick="playVoiceSample('cn')">🇨🇳</button>
                <button class="flag-btn" data-lang="en" onclick="playVoiceSample('en')">🇺🇸</button>
            </div>
        </div>

        <!-- VRM展示区域 -->
        <div class="vrm-display">
            <canvas id="vrm-canvas" class="vrm-canvas"></canvas>
            
            <!-- 角色加载动画 -->
            <div class="character-loader" id="character-loader">
                <div class="spinner"></div>
                <div class="loader-text">LOADING</div>
            </div>
        </div>

        <!-- 角色选择器 -->
        <div class="character-selector">
            <button class="nav-button" onclick="previousCharacter()">‹</button>
            <div class="character-thumbnails" id="character-thumbnails"></div>
            <div class="selected-indicator">
                <div class="selected-avatar">
                    <img id="selected-avatar-img" src="" alt="Selected Character">
                </div>
                <div class="selected-badge">A</div>
                <div class="selected-text">Select</div>
            </div>
            <div class="character-thumbnails" id="character-thumbnails-right"></div>
            <button class="nav-button" onclick="nextCharacter()">›</button>
        </div>


        <!-- Solana 官方钱包适配器 React 组件 -->
        <div class="wallet-connect-area">
            <div id="wallet-adapter-root"></div>
        </div>


        <!-- 开始按钮 -->
        <button class="start-button" onclick="startChat()">
            <div class="fold"></div>
            <div class="points_wrapper">
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
            </div>
            <span class="inner">开始聊天</span>
        </button>
    </div>
    
    <!-- 钱包连接模态框 - 现代化设计 -->
    <div class="wallet-modal" id="wallet-modal">
        <div class="wallet-modal-overlay">
            <div class="wallet-modal-content">
                <div class="wallet-modal-header">
                    <h2>Connect wallet</h2>
                    <p>Get started by connecting your preferred wallet below.</p>
                    <button class="wallet-close-btn" id="wallet-close-btn">×</button>
                </div>
                
                <div class="wallet-list">
                    <div class="wallet-option" data-provider="phantom">
                        <div class="wallet-option-icon">👻</div>
                        <span class="wallet-option-name">Phantom</span>
                        <div class="wallet-option-arrow">→</div>
                    </div>
                    
                    <div class="wallet-option" data-provider="solflare">
                        <div class="wallet-option-icon">☀️</div>
                        <span class="wallet-option-name">Solflare</span>
                        <div class="wallet-option-arrow">→</div>
                    </div>
                    
                    <div class="wallet-option" data-provider="coinbase">
                        <div class="wallet-option-icon">🔷</div>
                        <span class="wallet-option-name">Coinbase</span>
                        <div class="wallet-option-arrow">→</div>
                    </div>
                    
                    <div class="wallet-option" data-provider="backpack">
                        <div class="wallet-option-icon">🎒</div>
                        <span class="wallet-option-name">Backpack</span>
                        <div class="wallet-option-arrow">→</div>
                    </div>
                </div>
                
                <div class="wallet-modal-footer">
                    <p>By connecting your wallet, you're agree to our 
                        <a href="#" class="wallet-link">Terms of Service</a> 
                        and our 
                        <a href="#" class="wallet-link">Privacy Policy</a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
                "@pixiv/three-vrm": "https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@2/lib/three-vrm.module.min.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { VRMLoaderPlugin, VRMUtils } from '@pixiv/three-vrm';

        // 角色数据 - 包含详细档案信息
        const characters = [
            {
                id: "alice",
                name: "Alice",
                file: "Main VRM/Alice.vrm",
                personality: "活泼外向，调皮可爱",
                dailyInterests: "跳舞、唱歌",
                likes: "鲜花和彩色甜点",
                dislikes: "安静和过于严肃的场合",
                favoriteFood: "草莓蛋糕、马卡龙",
                favoriteMusic: "流行舞曲、K-Pop",
                favoriteMovies: "浪漫喜剧",
                favoriteGames: "节奏舞蹈游戏",
                age: "22歳",
                birthday: "6月5日",
                zodiac: "双子座",
                height: "好感度Lv.10开放",
                weight: "好感度Lv.10开放",
                measurements: "好感度Lv.20开放",
                voiceId: "rEJAAHKQqr6yTNCh8xS0",
                sampleLines: {
                    jp: "月明かりの下で二人きりで踊ろう！",
                    cn: "让我们在月光下共舞，只属于我们两个人！",
                    en: "Let's dance under the moonlight, just us two!"
                }
            },
            {
                id: "ash",
                name: "Ash",
                file: "Main VRM/Ash.vrm",
                personality: "冷静理性，逻辑清晰",
                dailyInterests: "阅读、编程",
                likes: "夜晚和浓咖啡",
                dislikes: "噪音和意外干扰",
                favoriteFood: "黑巧克力",
                favoriteMusic: "Lo-fi 轻松音乐、环境音",
                favoriteMovies: "科幻、悬疑惊悚",
                favoriteGames: "解谜冒险游戏",
                age: "24歳",
                birthday: "11月12日",
                zodiac: "天蝎座",
                height: "好感度Lv.10开放",
                weight: "好感度Lv.10开放",
                measurements: "好感度Lv.20开放",
                voiceId: "bY4cOgafbv5vatmokfg0",
                sampleLines: {
                    jp: "静かな夜に本とコーヒーが最高だ。",
                    cn: "静谧的夜晚，书和咖啡最完美。",
                    en: "A quiet night with a book and coffee is perfect."
                }
            },
            {
                id: "elinyaa",
                name: "Elinyaa",
                file: "Main VRM/Elinyaa.vrm",
                personality: "神秘优雅的精灵少女，有着不可思议的魅力。",
                traits: ["神秘", "优雅", "精灵", "空灵"],
                emoji: "🧚",
                level: 29,
                type: "精灵系"
            },
            {
                id: "fliza",
                name: "Fliza",
                file: "Main VRM/Fliza VRM.vrm",
                personality: "温暖体贴，善解人意",
                dailyInterests: "农作、园艺",
                likes: "日出和晨露",
                dislikes: "污染",
                favoriteFood: "新鲜水果、蜂蜜柠檬水",
                favoriteMusic: "民谣、自然音景",
                favoriteMovies: "自然纪录片、暖心故事",
                favoriteGames: "动物森友会",
                age: "23歳",
                birthday: "8月14日",
                zodiac: "狮子座",
                height: "好感度Lv.10开放",
                weight: "好感度Lv.10开放",
                measurements: "好感度Lv.20开放",
                voiceId: "s9lrHYk7TIJ2UO7UNbje",
                sampleLines: {
                    jp: "日の出に一緒に種をまかない？",
                    cn: "想和我一起在日出时播种吗？",
                    en: "Care to join me in planting seeds at sunrise?"
                }
            },
            {
                id: "imeris",
                name: "Imeris",
                file: "Main VRM/IMERIS.vrm",
                personality: "高贵优雅的贵族少女，举止端庄。",
                traits: ["高贵", "优雅", "端庄", "贵族"],
                emoji: "👑",
                level: 31,
                type: "贵族系",
                voiceId: "YuKvHNms5efZ0SvhIr3g",
                sampleLines: {
                    jp: "体温を測らせてね—あなたのことを大事に思ってる。",
                    cn: "让我给你量量体温——我很在意你。",
                    en: "Let me check your temperature—I care for you."
                }
            },
            {
                id: "maple",
                name: "Maple",
                file: "Main VRM/Maple.vrm",
                personality: "温暖如秋日阳光的女孩，总是给人安全感。",
                traits: ["温暖", "贤惠", "细心", "治愈"],
                emoji: "🍁",
                level: 26,
                type: "温暖系",
                voiceId: "B8gJV1IhpuegLxdpXFOE",
                sampleLines: {
                    jp: "暖炉のそばでワッフルはいかが？",
                    cn: "想在温暖的壁炉边享用华夫饼吗？",
                    en: "Would you like a warm waffle by my cozy fireplace?"
                }
            },
            {
                id: "nekona",
                name: "Nekona",
                file: "Main VRM/NEKONA.vrm",
                personality: "可爱的猫娘，有着猫咪般的慵懒与活泼。",
                traits: ["可爱", "猫娘", "慵懒", "活泼"],
                emoji: "🐱",
                level: 21,
                type: "兽娘系",
                voiceId: "kcg1KQQGuCGzH6FUjsZQ",
                sampleLines: {
                    jp: "夜が秘密を囁く—一緒に探検しよう？",
                    cn: "夜晚低语秘密——我们去探索吧？",
                    en: "The night whispers secrets—shall we explore them?"
                }
            },
            {
                id: "notia",
                name: "Notia",
                file: "Main VRM/Notia.vrm",
                personality: "知性冷静的研究者，对知识充满渴望。",
                traits: ["知性", "冷静", "研究", "博学"],
                emoji: "🔬",
                level: 32,
                type: "学者系",
                voiceId: "abz2RylgxmJx76xNpaj1",
                sampleLines: {
                    jp: "そろそろ茶道をしませんか？心に静けさを満たそう。",
                    cn: "要举行茶道了吗？让宁静充满心灵。",
                    en: "Tea ceremony soon? Let tranquility fill our hearts."
                }
            },
            {
                id: "ququ",
                name: "QuQu",
                file: "Main VRM/QuQu.vrm",
                personality: "活泼可爱的萝莉，总是充满元气。",
                traits: ["活泼", "可爱", "元气", "萝莉"],
                emoji: "🎀",
                level: 20,
                type: "萝莉系",
                voiceId: "tfQFvzjodQp63340jz2r",
                sampleLines: {
                    jp: "次のワイルドライドでアドレナリンを追いかける準備は？",
                    cn: "准备好在下一次狂野冒险中追逐肾上腺素了吗？",
                    en: "Ready to chase adrenaline on our next wild ride?"
                }
            },
            {
                id: "rindo",
                name: "Rindo",
                file: "Main VRM/RINDO.vrm",
                personality: "传统和风的大和抚子，温柔贤淑。",
                traits: ["和风", "传统", "温柔", "贤淑"],
                emoji: "🌸",
                level: 28,
                type: "和风系",
                voiceId: "nclQ39ewSlJMu5Nidnsf",
                sampleLines: {
                    jp: "刀の抜き方に集中して。規律が肝心だ。",
                    cn: "专注于刀刃的出鞘；纪律是关键。",
                    en: "Focus on the cut of your blade; discipline is key."
                }
            },
            {
                id: "rainy",
                name: "Rainy",
                file: "Main VRM/Rainy.vrm",
                personality: "活泼开朗的邻家女孩，总是充满活力。",
                traits: ["活泼", "开朗", "运动", "阳光"],
                emoji: "🌧️",
                level: 22,
                type: "活力系",
                voiceId: "1ghrzLZQ7Dza7Xs9OkhY",
                sampleLines: {
                    jp: "窓を叩く雨音は私のお気に入りの子守唄。",
                    cn: "雨滴敲打窗户是我最爱的摇篮曲。",
                    en: "Rain tapping on windows is my favorite lullaby."
                }
            },
            {
                id: "vivi",
                name: "Vivi",
                file: "Main VRM/Vivi.vrm",
                personality: "充满好奇心的探险家，总是对世界充满热情。",
                traits: ["好奇", "冒险", "热情", "乐观"],
                emoji: "✨",
                level: 24,
                type: "冒险系",
                voiceId: "4lWJNy00PxQAOMgQTiIS",
                sampleLines: {
                    jp: "今夜はみんなに笑顔を届ける配信をしよう！",
                    cn: "今晚让我们直播并与大家分享微笑吧！",
                    en: "Let's stream and share smiles with everyone tonight!"
                }
            },
            {
                id: "wolferia",
                name: "Wolferia",
                file: "Main VRM/Wolferia.vrm",
                personality: "高傲的狼族公主，有着王者的气质。",
                traits: ["高傲", "狼族", "王者", "威严"],
                emoji: "🐺",
                level: 33,
                type: "兽娘系"
            },
            {
                id: "yawl",
                name: "Yawl",
                file: "Main VRM/Yawl.vrm",
                personality: "神秘的魔法少女，掌握着不可思议的力量。",
                traits: ["神秘", "魔法", "幻想", "强大"],
                emoji: "🔮",
                level: 30,
                type: "魔法系"
            },
            {
                id: "yuuyii",
                name: "Yuu Yii",
                file: "Main VRM/Yuu Yii.vrm",
                personality: "温柔可爱的双子之一，总是带着甜美的笑容。",
                traits: ["温柔", "可爱", "双子", "甜美"],
                emoji: "💕",
                level: 23,
                type: "双子系"
            },
            {
                id: "zwei",
                name: "Zwei",
                file: "Main VRM/Zwei.vrm",
                personality: "冷酷帅气的战士少女，有着坚强的内心。",
                traits: ["冷酷", "帅气", "战士", "坚强"],
                emoji: "⚔️",
                level: 29,
                type: "战士系"
            },
            {
                id: "bobo",
                name: "Bobo",
                file: "Main VRM/bobo.vrm",
                personality: "天真无邪的小天使，总是带来欢乐。",
                traits: ["天真", "无邪", "快乐", "天使"],
                emoji: "😇",
                level: 19,
                type: "天使系"
            },
            {
                id: "kyoko",
                name: "Kyoko",
                file: "Main VRM/kyoko.vrm",
                personality: "成熟稳重的大姐姐，值得信赖。",
                traits: ["成熟", "稳重", "可靠", "大姐姐"],
                emoji: "💜",
                level: 28,
                type: "姐姐系"
            },
            {
                id: "lena",
                name: "Lena",
                file: "Main VRM/lena.vrm",
                personality: "聪明机智的学霸型女孩，总是能给你最好的建议。",
                traits: ["聪明", "理性", "学霸", "可靠"],
                emoji: "📚",
                level: 30,
                type: "智慧系"
            },
            {
                id: "lilium",
                name: "Lilium",
                file: "Main VRM/lilium.vrm",
                personality: "优雅神秘的少女，有着独特的魅力。",
                traits: ["优雅", "神秘", "艺术", "浪漫"],
                emoji: "🌺",
                level: 28,
                type: "神秘系"
            },
            {
                id: "miru",
                name: "Miru",
                file: "Main VRM/miru.vrm",
                personality: "软萌可爱的小萝莉，让人忍不住想保护。",
                traits: ["软萌", "可爱", "萝莉", "纯真"],
                emoji: "🍼",
                level: 18,
                type: "萝莉系"
            },
            {
                id: "miumiu",
                name: "Miu Miu",
                file: "Main VRM/miu miu.vrm",
                personality: "俏皮可爱的猫耳少女，喜欢撒娇。",
                traits: ["俏皮", "可爱", "猫耳", "撒娇"],
                emoji: "😸",
                level: 21,
                type: "兽娘系"
            },
            {
                id: "sikirei",
                name: "Sikirei",
                file: "Main VRM/sikirei.vrm",
                personality: "如四季般多变的少女，充满神秘感。",
                traits: ["多变", "神秘", "四季", "灵动"],
                emoji: "🌷",
                level: 27,
                type: "自然系"
            },
            {
                id: "wolf",
                name: "Wolf",
                file: "Main VRM/wolf.vrm",
                personality: "孤高的独狼，有着自己的坚持。",
                traits: ["孤高", "独立", "坚持", "冷静"],
                emoji: "🌙",
                level: 31,
                type: "孤狼系"
            }
        ];

        // 角色头像映射
        function getProfilePicture(characterName) {
            const profileMap = {
                'Alice': 'alice-pf.png',
                'Ash': 'ash-pf.png',
                'Elinyaa': 'elinyaa-pf.png',
                'Fliza': 'fliza-pf.png',
                'Imeris': 'imeris-pf.png',
                'Maple': 'maple-pf.png',
                'Nekona': 'nekona.png',
                'Notia': 'notia-pf.png',
                'QuQu': 'ququ-pf.png',
                'Rindo': 'rindo-pf.png',
                'Rainy': 'rainy-pf.png',
                'Vivi': 'vivi-pf.png',
                'Wolferia': 'wolferia-pf.png',
                'Yawl': 'yawl-pf.png',
                'Yuu Yii': 'yuu yii-pf.png',
                'Zwei': 'zwei-pf.png',
                'Bobo': 'bobo-pf.png',
                'Kyoko': 'kyoko-pf.png',
                'Lena': 'lena-pf.png',
                'Lilium': 'lilium.png',
                'Miru': 'Miru-pf.png',
                'Miu Miu': 'miumiu-pf.png',
                'Sikirei': 'sikirei-pf.png',
                'Wolf': 'wolf.png'
            };
            return `profile-pic/${profileMap[characterName] || 'default.png'}`;
        }

        // 全局变量
        let scene, camera, renderer, controls;
        let currentVRM = null;
        let mixer = null;
        let animationAction = null;
        let currentCharacterIndex = 0;
        let isLoading = false;
        
        // 语音播放功能变量 - 提前声明
        let currentAudio = null;
        let currentLanguage = 'jp'; // 默认日语
        
        // 后端API配置
        const API_URL = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';

        // 初始化
        init();
        generateThumbnails();
        // Initialize selected character image and profile
        document.addEventListener('DOMContentLoaded', function() {
            const selectedAvatar = document.getElementById('selected-avatar-img');
            if (selectedAvatar && characters[0]) {
                selectedAvatar.src = getProfilePicture(characters[0].name);
            }
            // Initialize character profile
            updateCharacterProfile(characters[0]);
        });
        loadCharacter(0);

        function init() {
            // 创建场景
            scene = new THREE.Scene();

            // 获取canvas容器的实际尺寸
            const canvas = document.getElementById('vrm-canvas');
            const container = canvas.parentElement;
            const containerRect = container.getBoundingClientRect();
            
            // 创建相机 - 使用容器尺寸而不是窗口尺寸
            camera = new THREE.PerspectiveCamera(30.0, containerRect.width / containerRect.height, 0.1, 20.0);
            camera.position.set(0.0, 0.5, 5.2);

            // 创建渲染器 - 使用容器尺寸
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
            renderer.setSize(containerRect.width, containerRect.height);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setClearColor(0x000000, 0); // 透明背景
            
            // 不需要复杂阴影系统，使用简单脚底阴影
            // renderer.shadowMap.enabled = true;
            // renderer.shadowMap.type = THREE.PCFSoftShadowMap;

            // 创建控制器 - 使用与index.html相同的设置
            controls = new OrbitControls(camera, renderer.domElement);
            controls.screenSpacePanning = true;
            controls.target.set(0.0, 0.5, 0.0);
            controls.update();

            // 添加环境光
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            // 主光源 - 简化设置
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
            directionalLight.position.set(1, 6, 2);
            
            scene.add(directionalLight);

            // 补光
            const fillLight = new THREE.DirectionalLight(0xffffff, 0.3);
            fillLight.position.set(-5, 5, -5);
            scene.add(fillLight);

            // 创建渐变圆形阴影 - 模仿参考截图
            const shadowCanvas = document.createElement('canvas');
            shadowCanvas.width = 128;
            shadowCanvas.height = 128;
            const context = shadowCanvas.getContext('2d');
            
            // 创建径向渐变阴影
            const gradient = context.createRadialGradient(64, 64, 0, 64, 64, 64);
            gradient.addColorStop(0, 'rgba(0, 0, 0, 0.4)'); // 中心较深
            gradient.addColorStop(0.5, 'rgba(0, 0, 0, 0.2)'); // 中等透明度
            gradient.addColorStop(1, 'rgba(0, 0, 0, 0)'); // 边缘完全透明
            
            context.fillStyle = gradient;
            context.fillRect(0, 0, 128, 128);
            
            const shadowTexture = new THREE.CanvasTexture(shadowCanvas);
            const shadowGeometry = new THREE.PlaneGeometry(2.2, 2.2);
            const shadowMaterial = new THREE.MeshBasicMaterial({ 
                map: shadowTexture,
                transparent: true,
                alphaTest: 0.001,
                depthWrite: false
            });
            
            const shadow = new THREE.Mesh(shadowGeometry, shadowMaterial);
            shadow.rotation.x = -Math.PI / 2;
            shadow.position.set(0, -0.82, 0); // 直接贴着脚底
            scene.add(shadow);
            
            // 保存阴影引用，以便后续更新位置
            window.characterShadow = shadow;

            // 开始渲染循环
            animate();

            // 窗口大小调整
            window.addEventListener('resize', onWindowResize);
        }


        function animate() {
            requestAnimationFrame(animate);

            const deltaTime = 0.016;
            
            // 更新VRM
            if (currentVRM) {
                currentVRM.update(deltaTime);
            }
            
            // 更新动画混合器
            if (mixer) {
                mixer.update(deltaTime);
            }

            // 更新控制器
            controls.update();

            // 渲染
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            const canvas = document.getElementById('vrm-canvas');
            const container = canvas.parentElement;
            const containerRect = container.getBoundingClientRect();
            
            camera.aspect = containerRect.width / containerRect.height;
            camera.updateProjectionMatrix();
            renderer.setSize(containerRect.width, containerRect.height);
        }

        function loadCharacter(index) {
            if (isLoading) {
                console.log('正在加载中，跳过');
                return;
            }

            isLoading = true;
            // Update character index and thumbnails immediately
            currentCharacterIndex = index;
            updateThumbnails();
            
            const loadingStartTime = Date.now();

            const character = characters[index];
            console.log('🔄 开始加载角色:', character.name);
            
            // 显示加载动画
            showCharacterLoader();

            // 更新UI
            const nameElement = document.getElementById('character-name');
            if (nameElement) nameElement.textContent = character.name;
            
            const levelElement = document.getElementById('character-level');
            if (levelElement) levelElement.textContent = character.level;
            
            const displayNameElement = document.getElementById('character-display-name');
            if (displayNameElement) displayNameElement.textContent = character.name;

            // 不需要占位符

            // 加载VRM
            const loader = new GLTFLoader();
            loader.register((parser) => new VRMLoaderPlugin(parser));

            loader.load(
                character.file,
                (gltf) => {
                    console.log('✅ GLTF加载成功');
                    const vrm = gltf.userData.vrm;
                    
                    if (vrm) {
                        console.log('✅ VRM数据存在');
                        
                        // 使用VRM v2兼容的优化方法
                        VRMUtils.removeUnnecessaryVertices(gltf.scene);
                        // VRMUtils.combineSkeletons 在 v2 中已移除
                        // VRMUtils.combineMorphs 在 v2 中已移除
                        
                        // 清理旧VRM（但保留灯光和占位符）
                        if (currentVRM) {
                            scene.remove(currentVRM.scene);
                            VRMUtils.deepDispose(currentVRM.scene);
                            console.log('🗑️ 清除旧VRM');
                        }

                        // 设置新VRM - 使用与index.html相同的设置
                        currentVRM = vrm;
                        
                        // 将VRM模型放大45% (与index.html一致)
                        vrm.scene.scale.set(1.45, 1.45, 1.45);
                        
                        // 将VRM模型位置向下移动，更贴近底部边界
                        vrm.scene.position.y = -0.8;
                        
                        // 先隐藏VRM，防止T-pose闪现
                        vrm.scene.visible = false;
                        
                        mixer = new THREE.AnimationMixer(currentVRM.scene);
                        
                        vrm.scene.traverse((obj) => {
                            obj.frustumCulled = false;
                        });
                        
                        // VRMUtils.rotateVRM0 在 v2 中可能不需要或已更改
                        // 如果是 VRM 0.x 格式，可能需要旋转；VRM 1.x 格式通常不需要
                        try {
                            VRMUtils.rotateVRM0(vrm);
                        } catch (error) {
                            console.log('⚠️ VRMUtils.rotateVRM0 不可用，跳过 (VRM v2兼容)');
                        }
                        
                        // 添加到场景
                        scene.add(vrm.scene);
                        
                        // 立即加载默认动画，然后显示VRM
                        loadDefaultAnimation().then(() => {
                            // 等待几帧确保动画开始播放，然后显示VRM
                            setTimeout(() => {
                                if (currentVRM && currentVRM.scene) {
                                    currentVRM.scene.visible = true;
                                    // 隐藏加载器
                                    hideCharacterLoader();
                                }
                            }, 150); // 增加到150ms确保动画已经应用
                        });
                        
                        console.log('✅ VRM设置完成:', character.name);
                        console.log('场景中的对象数量:', scene.children.length);
                    } else {
                        console.log('❌ VRM数据不存在');
                        // VRM数据不存在时也要隐藏加载器
                        hideCharacterLoader();
                    }

                    finishLoading(index, loadingStartTime);
                },
                (progress) => {
                    const percent = Math.round(progress.loaded / progress.total * 100);
                    console.log('加载进度:', percent + '%');
                },
                (error) => {
                    console.error('❌ VRM加载失败:', error);
                    // 加载失败时隐藏加载器
                    hideCharacterLoader();
                    finishLoading(index, loadingStartTime);
                }
            );
        }

        function finishLoading(index, loadingStartTime) {
            const elapsedTime = Date.now() - (loadingStartTime || 0);
            const remainingTime = Math.max(0, 3000 - elapsedTime); // 最少3秒
            
            setTimeout(() => {
                isLoading = false;
                
                // 调试信息
                console.log('加载完成');
            }, remainingTime);
        }


        function generateThumbnails() {
            const containerLeft = document.getElementById('character-thumbnails');
            const containerRight = document.getElementById('character-thumbnails-right');
            containerLeft.innerHTML = '';
            containerRight.innerHTML = '';

            const currentIndex = currentCharacterIndex;
            const showCount = 4; // 左右各显示4个角色
            
            // 左边的角色 (当前角色之前的3个)
            for (let i = showCount; i > 0; i--) {
                const index = (currentIndex - i + characters.length) % characters.length;
                const character = characters[index];
                
                const thumb = document.createElement('div');
                thumb.className = 'character-thumb';
                thumb.onclick = () => selectCharacter(index);
                
                const content = document.createElement('img');
                content.src = getProfilePicture(character.name);
                content.style.width = '100%';
                content.style.height = '100%';
                content.style.objectFit = 'cover';
                content.style.borderRadius = '50%';
                content.alt = character.name;
                
                thumb.appendChild(content);
                containerLeft.appendChild(thumb);
            }
            
            // 右边的角色 (当前角色之后的3个)
            for (let i = 1; i <= showCount; i++) {
                const index = (currentIndex + i) % characters.length;
                const character = characters[index];
                
                const thumb = document.createElement('div');
                thumb.className = 'character-thumb';
                thumb.onclick = () => selectCharacter(index);
                
                const content = document.createElement('img');
                content.src = getProfilePicture(character.name);
                content.style.width = '100%';
                content.style.height = '100%';
                content.style.objectFit = 'cover';
                content.style.borderRadius = '50%';
                content.alt = character.name;
                
                thumb.appendChild(content);
                containerRight.appendChild(thumb);
            }

        }

        // 更新角色档案信息
        function updateCharacterProfile(character) {
            // 获取角色详细信息，如果没有则使用默认值
            const profile = getCharacterProfile(character.name);
            
            document.getElementById('character-name').textContent = character.name;
            document.getElementById('character-age').textContent = profile.age + "歳";
            document.getElementById('character-birthday').textContent = profile.birthday;
            document.getElementById('character-zodiac').textContent = profile.zodiac;
            document.getElementById('character-personality').textContent = profile.personality;
            document.getElementById('character-interests').textContent = profile.dailyInterests;
            document.getElementById('character-likes').textContent = profile.likes;
            document.getElementById('character-dislikes').textContent = profile.dislikes;
            document.getElementById('character-food').textContent = profile.favoriteFood;
            document.getElementById('character-music').textContent = profile.favoriteMusic;
            document.getElementById('character-movies').textContent = profile.favoriteMovies;
            document.getElementById('character-games').textContent = profile.favoriteGames;
            
            // 更新语音选择器
            updateVoiceSelector();
        }

        // 根据角色名获取详细档案 - 基于character.md数据
        function getCharacterProfile(name) {
            const profiles = {
                "Alice": {
                    age: 22,
                    birthday: "6月5日",
                    zodiac: "双子座",
                    personality: "活泼外向，调皮可爱",
                    dailyInterests: "跳舞、唱歌",
                    likes: "鲜花和彩色甜点",
                    dislikes: "安静和过于严肃的场合",
                    favoriteFood: "草莓蛋糕、马卡龙",
                    favoriteMusic: "流行舞曲、K-Pop",
                    favoriteMovies: "浪漫喜剧",
                    favoriteGames: "节奏舞蹈游戏"
                },
                "Ash": {
                    age: 24,
                    birthday: "11月12日",
                    zodiac: "天蝎座",
                    personality: "冷静、内敛、逻辑思维强",
                    dailyInterests: "阅读、编程",
                    likes: "夜晚和浓咖啡",
                    dislikes: "噪音和突然的干扰",
                    favoriteFood: "黑巧克力",
                    favoriteMusic: "Lo-fi轻音乐、氛围音乐",
                    favoriteMovies: "科幻、悬疑惊悚片",
                    favoriteGames: "解谜冒险游戏"
                },
                "Bobo": {
                    age: 19,
                    birthday: "12月2日",
                    zodiac: "射手座",
                    personality: "温柔、害羞、敏感",
                    dailyInterests: "手绘插画",
                    likes: "柔软的毛绒玩具",
                    dislikes: "拥挤的地方",
                    favoriteFood: "抹茶拿铁、焦糖布丁",
                    favoriteMusic: "轻柔器乐",
                    favoriteMovies: "动画电影、温情电影",
                    favoriteGames: "纪念碑谷"
                },
                "Elinyaa": {
                    age: 18,
                    birthday: "2月25日",
                    zodiac: "双鱼座",
                    personality: "甜美、活泼、童真",
                    dailyInterests: "Cosplay、角色扮演",
                    likes: "各种糖果",
                    dislikes: "苦味食物",
                    favoriteFood: "棉花糖、彩虹糖",
                    favoriteMusic: "J-Pop、儿歌",
                    favoriteMovies: "奇幻冒险",
                    favoriteGames: "角色扮演游戏"
                },
                "Fliza": {
                    age: 23,
                    birthday: "8月14日",
                    zodiac: "狮子座",
                    personality: "温暖、关怀、富有同情心",
                    dailyInterests: "农业、园艺",
                    likes: "日出和晨露",
                    dislikes: "环境污染",
                    favoriteFood: "新鲜水果、蜂蜜柠檬水",
                    favoriteMusic: "民谣、自然音景",
                    favoriteMovies: "自然纪录片、温馨故事",
                    favoriteGames: "动物森友会"
                },
                "Imeris": {
                    age: 25,
                    birthday: "4月2日",
                    zodiac: "牡羊座",
                    personality: "细心、温柔、乐于助人",
                    dailyInterests: "护理研究、健康教育",
                    likes: "樱花和柔和的粉色调",
                    dislikes: "冲突",
                    favoriteFood: "樱花糕点",
                    favoriteMusic: "新世纪音乐、钢琴独奏",
                    favoriteMovies: "医疗剧、治愈纪录片",
                    favoriteGames: "医院管理模拟"
                },
                "Kyoko": {
                    age: 20,
                    birthday: "10月30日",
                    zodiac: "天蝎座",
                    personality: "独立、坚韧、自信",
                    dailyInterests: "徒步、攀岩",
                    likes: "清新的山间空气",
                    dislikes: "人群和噪音",
                    favoriteFood: "烤鱼、能量棒",
                    favoriteMusic: "电子、摇滚",
                    favoriteMovies: "动作冒险",
                    favoriteGames: "塔防策略游戏"
                },
                "Lena": {
                    age: 21,
                    birthday: "5月9日",
                    zodiac: "金牛座",
                    personality: "优雅、自信、有魅力",
                    dailyInterests: "时装设计、花艺",
                    likes: "红酒和精致的下午茶",
                    dislikes: "迟到和粗鲁",
                    favoriteFood: "黑松露意面、红酒",
                    favoriteMusic: "爵士乐",
                    favoriteMovies: "艺术剧情片",
                    favoriteGames: "模拟人生"
                },
                "Lilium": {
                    age: 24,
                    birthday: "1月15日",
                    zodiac: "摩羯座",
                    personality: "热情、充满活力、大胆",
                    dailyInterests: "街舞、健身",
                    likes: "火锅和辛辣食物",
                    dislikes: "冷菜",
                    favoriteFood: "麻辣火锅、辣味零食",
                    favoriteMusic: "EDM、Hip-hop",
                    favoriteMovies: "浪漫剧情片",
                    favoriteGames: "音乐节奏游戏"
                },
                "Maple": {
                    age: 22,
                    birthday: "9月25日",
                    zodiac: "天秤座",
                    personality: "温暖、细心、耐心",
                    dailyInterests: "烘焙、插花",
                    likes: "枫叶图案",
                    dislikes: "急躁",
                    favoriteFood: "枫糖华夫饼、南瓜派",
                    favoriteMusic: "原声民谣、轻爵士",
                    favoriteMovies: "励志动画电影",
                    favoriteGames: "星露谷物语"
                },
                "Miru": {
                    age: 19,
                    birthday: "12月29日",
                    zodiac: "摩羯座",
                    personality: "梦幻、可爱、有点害羞",
                    dailyInterests: "收集毛绒玩具",
                    likes: "云朵和柔软的质感",
                    dislikes: "黑暗",
                    favoriteFood: "棉花糖",
                    favoriteMusic: "Lo-fi背景音乐、氛围音景",
                    favoriteMovies: "奇幻动画",
                    favoriteGames: "生活模拟游戏"
                },
                "Miu Miu": {
                    age: 20,
                    birthday: "3月8日",
                    zodiac: "双鱼座",
                    personality: "古怪、有创意、爱玩",
                    dailyInterests: "潮流DIY手工",
                    likes: "糖果和鲜艳颜色",
                    dislikes: "严肃",
                    favoriteFood: "彩虹糖、巧克力",
                    favoriteMusic: "K-Pop、流行音乐",
                    favoriteMovies: "轻喜剧、动画短片",
                    favoriteGames: "三消益智游戏"
                },
                "Nekona": {
                    age: 18,
                    birthday: "6月27日",
                    zodiac: "巨蟹座",
                    personality: "温柔、狡黠、有点神秘",
                    dailyInterests: "夜晚散步、收集叶子",
                    likes: "夜晚",
                    dislikes: "直射阳光",
                    favoriteFood: "芒果冰沙、莓果拼盘",
                    favoriteMusic: "轻松节拍、氛围音乐",
                    favoriteMovies: "心理惊悚片",
                    favoriteGames: "解谜冒险"
                },
                "Notia": {
                    age: 23,
                    birthday: "9月1日",
                    zodiac: "处女座",
                    personality: "沉着、优雅、古典",
                    dailyInterests: "茶道、插花",
                    likes: "茶香",
                    dislikes: "浓咖啡",
                    favoriteFood: "日式点心、抹茶冰淇淋",
                    favoriteMusic: "传统民乐",
                    favoriteMovies: "历史剧",
                    favoriteGames: "卡牌策略"
                },
                "QuQu": {
                    age: 22,
                    birthday: "4月20日",
                    zodiac: "金牛座",
                    personality: "大胆、直率、热情",
                    dailyInterests: "极限运动",
                    likes: "户外冒险",
                    dislikes: "限制",
                    favoriteFood: "烤串、烤玉米",
                    favoriteMusic: "摇滚、金属",
                    favoriteMovies: "动作大片",
                    favoriteGames: "竞技多人游戏"
                },
                "Rainy": {
                    age: 21,
                    birthday: "11月5日",
                    zodiac: "天蝎座",
                    personality: "安静、温柔、内省",
                    dailyInterests: "雨中漫步",
                    likes: "雨声",
                    dislikes: "炎热晴天",
                    favoriteFood: "拉面、热巧克力",
                    favoriteMusic: "慢节奏爵士",
                    favoriteMovies: "艺术和独立电影",
                    favoriteGames: "互动小说"
                },
                "Rindo": {
                    age: 25,
                    birthday: "2月1日",
                    zodiac: "水瓶座",
                    personality: "冷静、坚韧、坚定",
                    dailyInterests: "剑道练习",
                    likes: "寒冷气候",
                    dislikes: "过甜的食物",
                    favoriteFood: "烤羊肉串",
                    favoriteMusic: "金属摇滚、电子音乐",
                    favoriteMovies: "武侠动作片",
                    favoriteGames: "硬核动作游戏"
                },
                "Sikirei": {
                    age: 24,
                    birthday: "10月10日",
                    zodiac: "天秤座",
                    personality: "诱人、神秘、优雅",
                    dailyInterests: "占星研究",
                    likes: "星星和夜空",
                    dislikes: "光污染",
                    favoriteFood: "蓝莓布丁、花草茶",
                    favoriteMusic: "氛围音景",
                    favoriteMovies: "科幻悬疑",
                    favoriteGames: "模拟人生"
                },
                "Vivi": {
                    age: 19,
                    birthday: "8月25日",
                    zodiac: "处女座",
                    personality: "外向、开朗、善于交际",
                    dailyInterests: "直播、收集漫画",
                    likes: "热闹聚会",
                    dislikes: "害羞和沉默",
                    favoriteFood: "披萨、零食拼盘",
                    favoriteMusic: "流行音乐、DJ混音",
                    favoriteMovies: "喜剧片",
                    favoriteGames: "MMO、休闲游戏"
                },
                "Wolf": {
                    personality: "野性、孤傲、本能驱动",
                    dailyInterests: "夜晚探索、野外生存",
                    likes: "森林和月光",
                    dislikes: "城市噪音",
                    favoriteFood: "烤鹿肉",
                    favoriteMusic: "民谣和原声吉他",
                    favoriteMovies: "恐怖惊悚片",
                    favoriteGames: "生存制作游戏"
                },
                "Wolferia": {
                    personality: "自由奔放、不拘束、爱冒险",
                    dailyInterests: "滑雪、极限运动",
                    likes: "雪上运动",
                    dislikes: "炽热高温",
                    favoriteFood: "冰淇淋、甜筒",
                    favoriteMusic: "迷幻电音",
                    favoriteMovies: "冒险奇幻",
                    favoriteGames: "冬季运动游戏"
                },
                "Yawl": {
                    personality: "优雅、知性、冷淡",
                    dailyInterests: "古典文学鉴赏",
                    likes: "精致咖啡厅",
                    dislikes: "浓茶和噪音",
                    favoriteFood: "法式糕点、红茶",
                    favoriteMusic: "古典音乐",
                    favoriteMovies: "艺术剧情片",
                    favoriteGames: "解谜推理"
                },
                "Yuu Yii": {
                    personality: "甜美、kawaii风格、乐于助人",
                    dailyInterests: "手工制作发饰",
                    likes: "泡泡和粉色调",
                    dislikes: "现实压力",
                    favoriteFood: "草莓慕斯、棉花糖",
                    favoriteMusic: "J-Pop、儿歌",
                    favoriteMovies: "动漫电影",
                    favoriteGames: "生活模拟游戏"
                },
                "Zwei": {
                    personality: "稳重、保护欲强、忠诚",
                    dailyInterests: "武术训练",
                    likes: "夜晚和宁静",
                    dislikes: "刺眼光线",
                    favoriteFood: "北京烤鸭、牛排",
                    favoriteMusic: "打击乐节奏",
                    favoriteMovies: "战争史诗、奇幻史诗",
                    favoriteGames: "策略模拟"
                }
            };
            
            return profiles[name] || {
                age: 20,
                birthday: "4月15日",
                zodiac: "牡羊座", 
                personality: "温柔体贴的AI女友，总是关心着你",
                dailyInterests: "聊天、游戏",
                likes: "和你在一起的时光",
                dislikes: "孤单",
                favoriteFood: "甜点",
                favoriteMusic: "轻音乐",
                favoriteMovies: "浪漫片",
                favoriteGames: "休闲游戏"
            };
        }

        function updateThumbnails() {
            // Simply regenerate the thumbnails without calling updateThumbnails again
            const containerLeft = document.getElementById('character-thumbnails');
            const containerRight = document.getElementById('character-thumbnails-right');
            containerLeft.innerHTML = '';
            containerRight.innerHTML = '';

            const currentIndex = currentCharacterIndex;
            const showCount = 4; // 左右各显示4个角色
            
            // Update selected character image
            const selectedAvatar = document.getElementById('selected-avatar-img');
            selectedAvatar.src = getProfilePicture(characters[currentIndex].name);
            
            // Update character profile information
            updateCharacterProfile(characters[currentIndex]);
            
            // 左边的角色 (当前角色之前的3个)
            for (let i = showCount; i > 0; i--) {
                const index = (currentIndex - i + characters.length) % characters.length;
                const character = characters[index];
                
                const thumb = document.createElement('div');
                thumb.className = 'character-thumb';
                thumb.onclick = () => selectCharacter(index);
                
                const content = document.createElement('img');
                content.src = getProfilePicture(character.name);
                content.style.width = '100%';
                content.style.height = '100%';
                content.style.objectFit = 'cover';
                content.style.borderRadius = '50%';
                content.alt = character.name;
                
                thumb.appendChild(content);
                containerLeft.appendChild(thumb);
            }
            
            // 右边的角色 (当前角色之后的3个)
            for (let i = 1; i <= showCount; i++) {
                const index = (currentIndex + i) % characters.length;
                const character = characters[index];
                
                const thumb = document.createElement('div');
                thumb.className = 'character-thumb';
                thumb.onclick = () => selectCharacter(index);
                
                const content = document.createElement('img');
                content.src = getProfilePicture(character.name);
                content.style.width = '100%';
                content.style.height = '100%';
                content.style.objectFit = 'cover';
                content.style.borderRadius = '50%';
                content.alt = character.name;
                
                thumb.appendChild(content);
                containerRight.appendChild(thumb);
            }
        }


        function selectCharacter(index) {
            if (index !== currentCharacterIndex && !isLoading) {
                loadCharacter(index);
            }
        }


        async function playVoiceSample(language) {
            // 停止当前播放的音频
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }

            const character = characters[currentCharacterIndex];
            const sampleText = character.sampleLines?.[language];
            const voiceId = character.voiceId;
            
            if (!sampleText || !voiceId) {
                console.warn(`Missing sample text or voice ID for ${character.name} in ${language}`);
                return;
            }

            // 更新按钮状态
            updateLanguageButtons(language);
            currentLanguage = language;

            // 显示播放提示
            console.log(`🎵 Playing ${character.name}'s ${language} sample: "${sampleText}"`);

            try {
                // 使用 ElevenLabs API 生成语音
                const audioUrl = await generateElevenLabsVoice(sampleText, voiceId);
                
                if (audioUrl) {
                    // 播放生成的音频
                    const audio = new Audio(audioUrl);
                    currentAudio = audio;
                    
                    audio.onended = () => {
                        currentAudio = null;
                        // 清理临时URL
                        URL.revokeObjectURL(audioUrl);
                    };
                    
                    audio.onerror = () => {
                        console.error('音频播放失败');
                        currentAudio = null;
                        URL.revokeObjectURL(audioUrl);
                    };
                    
                    await audio.play();
                } else {
                    console.error('语音生成失败');
                }
            } catch (error) {
                console.error('❌ ElevenLabs API 调用失败:', error);
                console.error('🚫 语音播放失败，请检查API密钥和网络连接');
            }
        }

        // 通过后端API调用TTS
        async function generateElevenLabsVoice(text, voiceId) {
            const url = `${API_URL}/api/tts/generate`;
            
            console.log(`🔄 正在调用 TTS API...`);
            console.log(`📝 文本: "${text}"`);
            console.log(`🎤 Voice ID: ${voiceId}`);
            
            const requestOptions = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    text: text,
                    voiceId: voiceId,
                    language: currentLanguage
                })
            };

            const response = await fetch(url, requestOptions);
            
            console.log(`📡 API 响应状态: ${response.status} ${response.statusText}`);
            
            if (!response.ok) {
                let errorMsg = '语音生成失败';
                try {
                    const errorData = await response.json();
                    errorMsg = errorData.error || errorMsg;
                } catch (e) {
                    // 如果不是JSON响应
                }
                console.error(`❌ TTS API 错误: ${errorMsg}`);
                throw new Error(errorMsg);
            }

            const audioBlob = await response.blob();
            console.log(`✅ 音频生成成功，大小: ${(audioBlob.size / 1024).toFixed(2)} KB`);
            return URL.createObjectURL(audioBlob);
        }

        function updateLanguageButtons(activeLanguage) {
            const buttons = document.querySelectorAll('.flag-btn');
            buttons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === activeLanguage) {
                    btn.classList.add('active');
                }
            });
        }

        function updateVoiceSelector() {
            // 确保按钮状态正确，如果currentLanguage还没初始化则使用默认值
            const language = (typeof currentLanguage !== 'undefined') ? currentLanguage : 'jp';
            updateLanguageButtons(language);
        }

        function previousCharacter() {
            const newIndex = currentCharacterIndex > 0 ? currentCharacterIndex - 1 : characters.length - 1;
            selectCharacter(newIndex);
        }

        function nextCharacter() {
            const newIndex = currentCharacterIndex < characters.length - 1 ? currentCharacterIndex + 1 : 0;
            selectCharacter(newIndex);
        }


        // 加载器控制函数
        function showCharacterLoader() {
            const loader = document.getElementById('character-loader');
            loader.style.display = 'flex';
        }

        function hideCharacterLoader() {
            const loader = document.getElementById('character-loader');
            loader.style.display = 'none';
        }

        // 全局函数
        window.selectCharacter = selectCharacter;
        window.previousCharacter = previousCharacter;
        window.nextCharacter = nextCharacter;
        window.playVoiceSample = playVoiceSample;
        window.startChat = function() {
            // 检查钱包连接状态
            if (!window.modernWalletUI || !window.modernWalletUI.getWalletInfo().isConnected) {
                alert('请先连接钱包后再开始聊天！');
                // 显示钱包连接模态框
                if (window.modernWalletUI) {
                    window.modernWalletUI.showWalletModal();
                }
                return;
            }
            
            // 检查是否选择了角色
            if (currentCharacterIndex < 0 || !characters[currentCharacterIndex]) {
                alert('请先选择一个角色！');
                return;
            }
            
            // 获取当前钱包信息
            const walletInfo = window.modernWalletUI.getWalletInfo();
            const selectedCharacter = characters[currentCharacterIndex];
            
            // 添加钱包地址到角色数据中，以便验证
            const characterWithWallet = {
                ...selectedCharacter,
                walletAddress: walletInfo.wallet.address,
                connectedAt: Date.now()
            };
            
            // 保存到localStorage
            localStorage.setItem('selectedCharacter', JSON.stringify(characterWithWallet));
            localStorage.setItem('wallet_address', walletInfo.wallet.address);
            localStorage.setItem('wallet_type', walletInfo.wallet.provider);
            localStorage.setItem('userId', walletInfo.wallet.address); // 使用钱包地址作为用户ID
            
            console.log('🚀 开始聊天:', selectedCharacter.name, '钱包:', 
                       `${walletInfo.wallet.address.slice(0, 6)}...${walletInfo.wallet.address.slice(-4)}`);
            
            // 跳转到聊天界面
            window.location.href = 'index.html';
        };

        // Mixamo到VRM骨骼映射 - 从index.html复制
        const mixamoVRMRigMap = {
            mixamorigHips: 'hips',
            mixamorigSpine: 'spine',
            mixamorigSpine1: 'chest',
            mixamorigSpine2: 'upperChest',
            mixamorigNeck: 'neck',
            mixamorigHead: 'head',
            mixamorigLeftShoulder: 'leftShoulder',
            mixamorigLeftArm: 'leftUpperArm',
            mixamorigLeftForeArm: 'leftLowerArm',
            mixamorigLeftHand: 'leftHand',
            mixamorigLeftHandThumb1: 'leftThumbMetacarpal',
            mixamorigLeftHandThumb2: 'leftThumbProximal',
            mixamorigLeftHandThumb3: 'leftThumbDistal',
            mixamorigLeftHandIndex1: 'leftIndexProximal',
            mixamorigLeftHandIndex2: 'leftIndexIntermediate',
            mixamorigLeftHandIndex3: 'leftIndexDistal',
            mixamorigLeftHandMiddle1: 'leftMiddleProximal',
            mixamorigLeftHandMiddle2: 'leftMiddleIntermediate',
            mixamorigLeftHandMiddle3: 'leftMiddleDistal',
            mixamorigLeftHandRing1: 'leftRingProximal',
            mixamorigLeftHandRing2: 'leftRingIntermediate',
            mixamorigLeftHandRing3: 'leftRingDistal',
            mixamorigLeftHandPinky1: 'leftLittleProximal',
            mixamorigLeftHandPinky2: 'leftLittleIntermediate',
            mixamorigLeftHandPinky3: 'leftLittleDistal',
            mixamorigRightShoulder: 'rightShoulder',
            mixamorigRightArm: 'rightUpperArm',
            mixamorigRightForeArm: 'rightLowerArm',
            mixamorigRightHand: 'rightHand',
            mixamorigRightHandPinky1: 'rightLittleProximal',
            mixamorigRightHandPinky2: 'rightLittleIntermediate',
            mixamorigRightHandPinky3: 'rightLittleDistal',
            mixamorigRightHandRing1: 'rightRingProximal',
            mixamorigRightHandRing2: 'rightRingIntermediate',
            mixamorigRightHandRing3: 'rightRingDistal',
            mixamorigRightHandMiddle1: 'rightMiddleProximal',
            mixamorigRightHandMiddle2: 'rightMiddleIntermediate',
            mixamorigRightHandMiddle3: 'rightMiddleDistal',
            mixamorigRightHandIndex1: 'rightIndexProximal',
            mixamorigRightHandIndex2: 'rightIndexIntermediate',
            mixamorigRightHandIndex3: 'rightIndexDistal',
            mixamorigRightHandThumb1: 'rightThumbMetacarpal',
            mixamorigRightHandThumb2: 'rightThumbProximal',
            mixamorigRightHandThumb3: 'rightThumbDistal',
            mixamorigLeftUpLeg: 'leftUpperLeg',
            mixamorigLeftLeg: 'leftLowerLeg',
            mixamorigLeftFoot: 'leftFoot',
            mixamorigLeftToeBase: 'leftToes',
            mixamorigRightUpLeg: 'rightUpperLeg',
            mixamorigRightLeg: 'rightLowerLeg',
            mixamorigRightFoot: 'rightFoot',
            mixamorigRightToeBase: 'rightToes',
        };

        // 使用与index.html相同的loadMixamoAnimation函数
        function loadMixamoAnimation(url, vrm) {
            const loader = new FBXLoader();
            return loader.loadAsync(url).then((asset) => {
                const clip = THREE.AnimationClip.findByName(asset.animations, 'mixamo.com');

                if (!clip) {
                    throw new Error('找不到 Mixamo 动画数据');
                }

                const tracks = [];
                const restRotationInverse = new THREE.Quaternion();
                const parentRestWorldRotation = new THREE.Quaternion();
                const _quatA = new THREE.Quaternion();

                const motionHipsHeight = asset.getObjectByName('mixamorigHips').position.y;
                const vrmHipsHeight = vrm.humanoid.normalizedRestPose.hips.position[1];
                const hipsPositionScale = vrmHipsHeight / motionHipsHeight;

                clip.tracks.forEach((track) => {
                    const trackSplitted = track.name.split('.');
                    const mixamoRigName = trackSplitted[0];
                    const vrmBoneName = mixamoVRMRigMap[mixamoRigName];
                    const vrmNodeName = vrm.humanoid?.getNormalizedBoneNode(vrmBoneName)?.name;
                    const mixamoRigNode = asset.getObjectByName(mixamoRigName);

                    if (vrmNodeName != null) {
                        const propertyName = trackSplitted[1];

                        mixamoRigNode.getWorldQuaternion(restRotationInverse).invert();
                        mixamoRigNode.parent.getWorldQuaternion(parentRestWorldRotation);

                        if (track instanceof THREE.QuaternionKeyframeTrack) {
                            for (let i = 0; i < track.values.length; i += 4) {
                                const flatQuaternion = track.values.slice(i, i + 4);
                                _quatA.fromArray(flatQuaternion);

                                _quatA
                                    .premultiply(parentRestWorldRotation)
                                    .multiply(restRotationInverse);

                                _quatA.toArray(flatQuaternion);
                                flatQuaternion.forEach((v, index) => {
                                    track.values[index + i] = v;
                                });
                            }

                            tracks.push(
                                new THREE.QuaternionKeyframeTrack(
                                    `${vrmNodeName}.${propertyName}`,
                                    track.times,
                                    track.values.map((v, i) => (vrm.meta?.metaVersion === '0' && i % 2 === 0 ? -v : v)),
                                )
                            );

                        } else if (track instanceof THREE.VectorKeyframeTrack) {
                            const value = track.values.map((v, i) =>
                                (vrm.meta?.metaVersion === '0' && i % 3 !== 1 ? -v : v) * hipsPositionScale
                            );
                            tracks.push(new THREE.VectorKeyframeTrack(`${vrmNodeName}.${propertyName}`, track.times, value));
                        }
                    }
                });

                return new THREE.AnimationClip('vrmAnimation', clip.duration, tracks);
            });
        }

        // 加载默认动画
        async function loadDefaultAnimation() {
            if (!currentVRM || !mixer) return Promise.resolve();

            try {
                console.log('开始加载默认动画...');
                const clip = await loadMixamoAnimation(encodeURI('mixamo animation/Look Around.fbx'), currentVRM);
                
                if (animationAction) {
                    animationAction.stop();
                }
                
                animationAction = mixer.clipAction(clip);
                animationAction.reset().play();
                animationAction.timeScale = 0.7;
                
                console.log('Bashful 动画播放成功');
                return Promise.resolve();
            } catch (error) {
                console.log('播放默认动画失败:', error);
                return Promise.resolve(); // 即使失败也要显示VRM
            }
        }

        // 调试函数 - 在控制台中可以调用
        window.debugScene = function() {
            console.log('场景对象:', scene.children);
            console.log('当前VRM:', currentVRM);
            console.log('当前角色索引:', currentCharacterIndex);
        };
    </script>
    
    <!-- React 和 Solana Web3 -->
    <script src="config.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    
    <!-- 简化的 Solana 钱包连接组件 -->
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // 简单的钱包连接组件
        function WalletConnector() {
            const [isConnected, setIsConnected] = useState(false);
            const [walletAddress, setWalletAddress] = useState(null);
            const [walletType, setWalletType] = useState(null);
            const [balance, setBalance] = useState(0);
            const [showModal, setShowModal] = useState(false);
            const [isConnecting, setIsConnecting] = useState(false);
            
            // 检查已有连接
            useEffect(() => {
                const savedAddress = localStorage.getItem('wallet_address');
                const savedType = localStorage.getItem('wallet_type');
                
                if (savedAddress && savedType) {
                    // 尝试重新连接
                    checkWalletConnection(savedType);
                }
            }, []);
            
            // 检查钱包连接状态
            const checkWalletConnection = async (type) => {
                const provider = getWalletProvider(type);
                if (provider && provider.isConnected) {
                    setIsConnected(true);
                    setWalletAddress(provider.publicKey.toString());
                    setWalletType(type);
                    await updateBalance(provider.publicKey);
                }
            };
            
            // 获取钱包提供者
            const getWalletProvider = (type) => {
                switch(type) {
                    case 'phantom':
                        return window.phantom?.solana;
                    case 'solflare':
                        return window.solflare;
                    case 'coinbase':
                        return window.coinbaseSolana;
                    case 'backpack':
                        return window.backpack;
                    case 'okx':
                        return window.okxwallet?.solana;
                    case 'bitget':
                        return window.bitkeep?.solana;
                    case 'tokenpocket':
                        return window.tokenpocket?.solana;
                    default:
                        return null;
                }
            };
            
            // 连接钱包
            const connectWallet = async (walletType) => {
                setIsConnecting(true);
                try {
                    const provider = getWalletProvider(walletType);
                    
                    if (!provider) {
                        alert(`请先安装 ${walletType} 钱包扩展`);
                        return;
                    }
                    
                    const response = await provider.connect();
                    const address = response.publicKey.toString();
                    
                    // 保存状态
                    setIsConnected(true);
                    setWalletAddress(address);
                    setWalletType(walletType);
                    setShowModal(false);
                    
                    // 保存到 localStorage
                    localStorage.setItem('wallet_address', address);
                    localStorage.setItem('wallet_type', walletType);
                    
                    // 获取余额
                    await updateBalance(response.publicKey);
                    
                    // 触发全局事件
                    window.dispatchEvent(new CustomEvent('walletConnected', {
                        detail: { address, provider: walletType }
                    }));
                    
                    console.log('✅ 钱包连接成功:', address);
                    
                    // 检查用户是否需要填写资料
                    setTimeout(async () => {
                        console.log('🔍 开始检查用户资料流程...');
                        console.log('🔍 检查profile manager状态:', !!window.profileManager);
                        
                        if (window.profileManager) {
                            const userId = `wallet_${address}`;
                            const walletAddress = address;
                            console.log('👤 用户ID:', userId);
                            console.log('🏦 钱包地址:', walletAddress);
                            
                            try {
                                console.log('🚀 正在从API检查用户资料...');
                                const existingProfile = await window.profileManager.checkUserProfile(userId);
                                console.log('📄 API返回的用户资料:', existingProfile);
                                
                                if (!existingProfile) {
                                    console.log('📝 新用户：没有找到资料，显示注册面板');
                                    console.log('📱 即将显示profile panel...');
                                    
                                    // 确保面板存在
                                    const profilePanel = document.getElementById('user-profile-overlay');
                                    if (profilePanel) {
                                        console.log('✅ Profile panel元素找到，显示面板');
                                        window.profileManager.showProfilePanel();
                                    } else {
                                        console.error('❌ 找不到user-profile-overlay元素');
                                    }
                                } else {
                                    console.log('👤 老用户：找到现有资料，显示欢迎信息');
                                    console.log('📋 用户资料详情:', {
                                        nickname: existingProfile.username || existingProfile.nickname,
                                        location: existingProfile.location,
                                        created: existingProfile.created_at
                                    });
                                    
                                    // 显示用户欢迎信息
                                    window.profileManager.showUserWelcome(existingProfile);
                                }
                            } catch (error) {
                                console.error('❌ 检查用户资料失败:', error);
                                console.log('🔧 出现错误，默认显示注册面板');
                                window.profileManager.showProfilePanel();
                            }
                        } else {
                            console.error('❌ profileManager未初始化');
                            console.log('💡 尝试手动初始化profileManager...');
                            
                            // 尝试手动触发初始化
                            if (typeof UserProfileManager !== 'undefined' || window.UserProfileManager) {
                                window.profileManager = new (window.UserProfileManager || UserProfileManager)();
                                console.log('✅ 手动初始化profileManager成功');
                                
                                // 立即重新执行检查，无需刷新页面
                                setTimeout(async () => {
                                    const userId = `wallet_${address}`;
                                    try {
                                        const existingProfile = await window.profileManager.checkUserProfile(userId);
                                        if (!existingProfile) {
                                            console.log('📝 新用户：显示注册面板');
                                            window.profileManager.showProfilePanel();
                                        } else {
                                            console.log('✅ 用户资料已存在，正常流程');
                                            window.profileManager.showUserWelcome(existingProfile);
                                        }
                                    } catch (error) {
                                        console.error('❌ 重新检查失败:', error);
                                        window.profileManager.showProfilePanel();
                                    }
                                }, 500);
                            } else {
                                console.error('❌ UserProfileManager类未找到，页面可能未完全加载');
                            }
                        }
                    }, 1500); // 增加延迟确保所有组件加载完成 // 延迟1秒显示资料面板
                } catch (error) {
                    console.error('❌ 连接失败:', error);
                    alert('钱包连接失败: ' + error.message);
                } finally {
                    setIsConnecting(false);
                }
            };
            
            // 断开连接
            const disconnectWallet = async () => {
                try {
                    const provider = getWalletProvider(walletType);
                    if (provider && provider.disconnect) {
                        await provider.disconnect();
                    }
                    
                    // 清理状态
                    setIsConnected(false);
                    setWalletAddress(null);
                    setWalletType(null);
                    setBalance(0);
                    
                    // 清理 localStorage
                    localStorage.removeItem('wallet_address');
                    localStorage.removeItem('wallet_type');
                    
                    // 触发全局事件
                    window.dispatchEvent(new CustomEvent('walletDisconnected'));
                    
                    console.log('🚪 钱包已断开连接');
                } catch (error) {
                    console.error('断开连接失败:', error);
                }
            };
            
            // 更新余额
            const updateBalance = async (publicKey) => {
                try {
                    const connection = new window.solanaWeb3.Connection(
                        'https://api.devnet.solana.com',
                        'confirmed'
                    );
                    const balance = await connection.getBalance(publicKey);
                    setBalance(balance / window.solanaWeb3.LAMPORTS_PER_SOL);
                } catch (error) {
                    console.error('获取余额失败:', error);
                }
            };
            
            // 格式化地址
            const formatAddress = (address) => {
                if (!address) return '';
                return `${address.slice(0, 6)}...${address.slice(-4)}`;
            };
            
            // 获取钱包图标 - 使用内嵌 SVG
            const getWalletIcon = (type) => {
                const walletLogos = {
                    'phantom': {
                        primary: 'https://mintlify.s3.us-west-1.amazonaws.com/phantom-e50e2e68/resources/images/Phantom_SVG_Icon.svg',
                        fallback: 'https://assets.coingecko.com/coins/images/33067/large/phantom.png'
                    },
                    'solflare': {
                        primary: './assets/wallet/solflare.png',
                        fallback: './assets/wallet/solflare.png'
                    },
                    'coinbase': {
                        primary: './assets/wallet/coinbase logo.webp',
                        fallback: './assets/wallet/coinbase logo.webp'
                    },
                    'backpack': {
                        primary: 'https://backpack.app/favicon.ico',
                        fallback: 'https://www.madlads.com/mad_logo.svg'
                    },
                    'okx': {
                        primary: 'https://static.okx.com/cdn/assets/imgs/247/58E63FEA47A2B7D7.png',
                        fallback: 'https://avatars.githubusercontent.com/u/33663881?s=200&v=4'
                    },
                    'bitget': {
                        primary: './assets/wallet/bitget wallet.png',
                        fallback: './assets/wallet/bitget wallet.png'
                    },
                    'tokenpocket': {
                        primary: 'https://tp-statics.tokenpocket.pro/logo/tokenpocket.png',
                        fallback: 'https://avatars.githubusercontent.com/u/29760615?s=200&v=4'
                    }
                };
                
                if (walletLogos[type]) {
                    let currentSrc = walletLogos[type].primary;
                    let fallbackUsed = false;
                    
                    const img = React.createElement('img', {
                        src: currentSrc,
                        alt: type,
                        style: {
                            width: '24px',
                            height: '24px',
                            borderRadius: '6px',
                            objectFit: 'contain'
                        },
                        onError: (e) => {
                            if (!fallbackUsed && walletLogos[type].fallback) {
                                fallbackUsed = true;
                                e.target.src = walletLogos[type].fallback;
                            } else {
                                // 最终备用方案 - 显示钱包名称首字母
                                const div = document.createElement('div');
                                div.style.cssText = `
                                    width: 24px; height: 24px; 
                                    border-radius: 6px; 
                                    background: linear-gradient(135deg, #8b5cf6, #a855f7); 
                                    display: flex; 
                                    align-items: center; 
                                    justify-content: center; 
                                    font-size: 12px; 
                                    color: white; 
                                    font-weight: 600;
                                `;
                                div.textContent = type.charAt(0).toUpperCase();
                                e.target.style.display = 'none';
                                e.target.parentElement.appendChild(div);
                            }
                        }
                    });
                    
                    return img;
                } else {
                    return React.createElement('div', {
                        style: {
                            width: '24px',
                            height: '24px',
                            borderRadius: '6px',
                            background: 'linear-gradient(135deg, #8b5cf6, #a855f7)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            fontSize: '12px',
                            color: 'white',
                            fontWeight: '600'
                        }
                    }, '💜');
                }
            };
            
            // 未连接状态 - 显示连接按钮
            if (!isConnected) {
                return (
                    <div>
                        <button
                            onClick={() => setShowModal(true)}
                            style={{
                                background: 'linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%)',
                                border: 'none',
                                borderRadius: '30px',
                                padding: '12px 24px',
                                color: 'white',
                                fontSize: '16px',
                                fontWeight: '600',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px',
                                transition: 'all 0.3s ease',
                                boxShadow: '0 4px 20px rgba(139, 92, 246, 0.3)',
                                minWidth: '120px',
                                justifyContent: 'center'
                            }}
                            disabled={isConnecting}
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 21 21">
                                <g fill="none" fill-rule="evenodd" transform="translate(3 4)">
                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" d="M.5 2.5h12a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2h-10a2 2 0 0 1-2-2zm1-2h9a1 1 0 0 1 1 1v1H.5v-1a1 1 0 0 1 1-1z"/>
                                    <circle cx="11.5" cy="7.5" r="1" fill="currentColor"/>
                                </g>
                            </svg>
                            <span>{isConnecting ? 'Connecting...' : 'Connect'}</span>
                        </button>
                        
                        {showModal && (
                            <div
                                style={{
                                    position: 'fixed',
                                    top: 0,
                                    left: 0,
                                    right: 0,
                                    bottom: 0,
                                    background: 'rgba(0, 0, 0, 0.9)',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    zIndex: 10000
                                }}
                                onClick={(e) => {
                                    if (e.target === e.currentTarget) {
                                        setShowModal(false);
                                    }
                                }}
                            >
                                <div style={{
                                    background: '#1c1917',
                                    borderRadius: '24px',
                                    padding: '32px',
                                    width: '400px',
                                    maxWidth: '90%',
                                    color: 'white'
                                }}>
                                    <h2 style={{ marginBottom: '8px', fontSize: '24px' }}>Connect wallet</h2>
                                    <p style={{ color: '#888', marginBottom: '24px' }}>
                                        Get started by connecting your preferred wallet below.
                                    </p>
                                    
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                        {[
                                            { 
                                                id: 'phantom', 
                                                name: 'Phantom', 
                                                logo: 'https://mintlify.s3.us-west-1.amazonaws.com/phantom-e50e2e68/resources/images/Phantom_SVG_Icon.svg',
                                                fallback: 'https://assets.coingecko.com/coins/images/33067/large/phantom.png'
                                            },
                                            { 
                                                id: 'solflare', 
                                                name: 'Solflare', 
                                                logo: './assets/wallet/solflare.png',
                                                fallback: './assets/wallet/solflare.png'
                                            },
                                            { 
                                                id: 'coinbase', 
                                                name: 'Coinbase Wallet', 
                                                logo: './assets/wallet/coinbase logo.webp',
                                                fallback: './assets/wallet/coinbase logo.webp'
                                            },
                                            { 
                                                id: 'backpack', 
                                                name: 'Backpack', 
                                                logo: 'https://backpack.app/favicon.ico',
                                                fallback: 'https://www.madlads.com/mad_logo.svg'
                                            },
                                            { 
                                                id: 'okx', 
                                                name: 'OKX Wallet', 
                                                logo: 'https://static.okx.com/cdn/assets/imgs/247/58E63FEA47A2B7D7.png',
                                                fallback: 'https://avatars.githubusercontent.com/u/33663881?s=200&v=4'
                                            },
                                            { 
                                                id: 'bitget', 
                                                name: 'Bitget Wallet', 
                                                logo: './assets/wallet/bitget wallet.png',
                                                fallback: './assets/wallet/bitget wallet.png'
                                            },
                                            { 
                                                id: 'tokenpocket', 
                                                name: 'TokenPocket', 
                                                logo: 'https://tp-statics.tokenpocket.pro/logo/tokenpocket.png',
                                                fallback: 'https://avatars.githubusercontent.com/u/29760615?s=200&v=4'
                                            }
                                        ].map(wallet => (
                                            <button
                                                key={wallet.id}
                                                onClick={() => connectWallet(wallet.id)}
                                                style={{
                                                    background: '#2a2a2a',
                                                    border: '1px solid #333',
                                                    borderRadius: '12px',
                                                    padding: '16px',
                                                    color: 'white',
                                                    fontSize: '16px',
                                                    cursor: 'pointer',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '12px',
                                                    transition: 'all 0.2s'
                                                }}
                                                onMouseOver={(e) => e.currentTarget.style.background = '#333'}
                                                onMouseOut={(e) => e.currentTarget.style.background = '#2a2a2a'}
                                            >
                                                <img 
                                                    src={wallet.logo} 
                                                    alt={wallet.name}
                                                    style={{ 
                                                        width: '32px', 
                                                        height: '32px', 
                                                        borderRadius: '8px',
                                                        objectFit: 'contain'
                                                    }}
                                                    onError={(e) => {
                                                        // 尝试fallback图片
                                                        if (wallet.fallback && e.target.src !== wallet.fallback) {
                                                            e.target.src = wallet.fallback;
                                                        } else {
                                                            // 如果图片加载失败，显示文字备用
                                                            e.target.style.display = 'none';
                                                            const div = document.createElement('div');
                                                        div.style.cssText = `
                                                            width: 32px; height: 32px; 
                                                            border-radius: 8px; 
                                                            background: #666; 
                                                            display: flex; 
                                                            align-items: center; 
                                                            justify-content: center; 
                                                            font-size: 12px; 
                                                            color: white;
                                                        `;
                                                            div.textContent = wallet.name.charAt(0);
                                                            e.target.parentElement.insertBefore(div, e.target);
                                                        }
                                                    }}
                                                />
                                                <span style={{ flex: 1, textAlign: 'left' }}>{wallet.name}</span>
                                                <span style={{ color: '#888' }}>→</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }
            
            // 已连接状态 - 显示钱包信息
            return (
                <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '12px',
                    background: 'rgba(28, 25, 23, 0.95)',
                    border: '1px solid #333333',
                    borderRadius: '16px',
                    padding: '8px 16px',
                    backdropFilter: 'blur(10px)',
                    boxShadow: '0 8px 30px rgba(0, 0, 0, 0.3)',
                    color: 'white'
                }}>
                    <div>
                        {getWalletIcon(walletType)}
                    </div>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '2px' }}>
                        <div style={{ fontSize: '14px', fontWeight: '600', fontFamily: '"Courier New", monospace' }}>
                            {formatAddress(walletAddress)}
                        </div>
                        <div style={{ color: '#888888', fontSize: '12px' }}>
                            {balance.toFixed(4)} SOL
                        </div>
                    </div>
                    <button
                        onClick={disconnectWallet}
                        style={{
                            background: 'transparent',
                            border: '1px solid #444444',
                            borderRadius: '8px',
                            color: '#888888',
                            cursor: 'pointer',
                            padding: '6px 12px',
                            fontSize: '12px'
                        }}
                    >
                        断开
                    </button>
                </div>
            );
        }
        
        // 渲染 React 组件
        const root = ReactDOM.createRoot(document.getElementById('wallet-adapter-root'));
        root.render(React.createElement(WalletConnector));
        
        // 全局钱包状态管理 (向后兼容)
        let currentWalletState = {
            isConnected: false,
            wallet: null
        };
        
        // 监听钱包状态变化
        window.addEventListener('walletConnected', (event) => {
            currentWalletState = {
                isConnected: true,
                wallet: {
                    address: event.detail.address,
                    provider: event.detail.provider,
                    balance: event.detail.balance
                }
            };
        });
        
        window.addEventListener('walletDisconnected', () => {
            currentWalletState = {
                isConnected: false,
                wallet: null
            };
        });
        
        // 兼容接口
        window.walletManager = {
            getWalletInfo: () => currentWalletState
        };
        
        window.modernWalletUI = window.walletManager; // 向后兼容
        
        // 用户资料管理系统 - 在Babel环境中定义
        console.log('🚀 开始定义UserProfileManager类...');
        class UserProfileManager {
            constructor() {
                this.currentUserId = null;
            }
            
            // 检查用户是否需要填写资料 - 纯API驱动，无localStorage
            async checkUserProfile(userId) {
                // 从userId提取钱包地址
                const walletAddress = userId.replace('wallet_', '');
                
                try {
                    // 从后端API获取最新资料
                    const apiUrl = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';
                    const response = await fetch(`${apiUrl}/api/profiles/${walletAddress}`);
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.profile) {
                            console.log('✅ 从API获取用户资料成功:', result.profile);
                            return result.profile;
                        }
                    }
                    
                    if (response.status === 404) {
                        console.log('📝 API确认：用户资料不存在');
                        return null;
                    }
                    
                    console.warn('⚠️ API响应异常，状态码:', response.status);
                    return null;
                    
                } catch (error) {
                    console.error('❌ API请求失败:', error);
                    return null;
                }
            }
            
            // 显示用户资料面板
            showProfilePanel(userId = null, existingProfile = null) {
                console.log('📱 显示用户资料面板');
                const overlay = document.getElementById('user-profile-overlay');
                if (overlay) {
                    // 如果是编辑模式，填充现有数据
                    if (existingProfile) {
                        this.fillFormWithProfile(existingProfile);
                        // 更改标题为编辑模式
                        const title = overlay.querySelector('.profile-panel-title');
                        if (title) title.textContent = '编辑资料';
                    } else {
                        // 重置表单
                        this.resetForm();
                        const title = overlay.querySelector('.profile-panel-title');
                        if (title) title.textContent = '用户注册';
                    }
                    
                    overlay.style.display = 'flex';
                    console.log('✅ 资料面板已显示');
                } else {
                    console.error('❌ 找不到user-profile-overlay元素');
                }
            }
            
            // 填充表单数据
            fillFormWithProfile(profile) {
                const fields = {
                    'username': profile.nickname || profile.username,
                    'displayName': profile.nickname || profile.first_name || '',
                    'birthYear': profile.birth_year,
                    'birthMonth': profile.birth_month,
                    'birthDay': profile.birth_day,
                    'location': profile.location,
                    'language': profile.language || 'zh-CN'
                };
                
                Object.entries(fields).forEach(([fieldId, value]) => {
                    const field = document.getElementById(fieldId);
                    if (field && value) {
                        field.value = value;
                    }
                });
            }
            
            // 重置表单
            resetForm() {
                const form = document.getElementById('profile-form');
                if (form) {
                    form.reset();
                }
            }
            
            // 显示用户欢迎信息
            showUserWelcome(profile) {
                console.log('👋 显示用户欢迎信息:', profile);
                // 这里可以添加欢迎信息显示逻辑
            }
        }

        // 确保UserProfileManager类可全局访问
        console.log('📤 设置全局UserProfileManager...');
        window.UserProfileManager = UserProfileManager;
        
        // 立即初始化ProfileManager以确保在钱包连接时可用
        console.log('🏗️ 创建profileManager实例...');
        const profileManager = new UserProfileManager();
        window.profileManager = profileManager;
        console.log('✅ ProfileManager已初始化');
        
    </script>
                // 连接按钮点击
                const connectButton = document.getElementById('wallet-connect-button');
                if (connectButton) {
                    connectButton.addEventListener('click', () => this.showWalletModal());
                }

                // 关闭模态框
                const closeBtn = document.getElementById('wallet-close-btn');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => this.hideWalletModal());
                }

                // 模态框覆盖层点击关闭
                const modal = document.getElementById('wallet-modal');
                if (modal) {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal || e.target.closest('.wallet-modal-overlay')) {
                            if (e.target === modal || e.target === e.target.closest('.wallet-modal-overlay')) {
                                this.hideWalletModal();
                            }
                        }
                    });
                }

                // 钱包选项点击
                const walletOptions = document.querySelectorAll('.wallet-option');
                walletOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        const provider = option.dataset.provider;
                        this.connectWallet(provider);
                    });
                });

                // 钱包菜单按钮
                const menuBtn = document.getElementById('wallet-menu-btn');
                if (menuBtn) {
                    menuBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.toggleDropdown();
                    });
                }

                // 复制地址
                const copyBtn = document.getElementById('copy-address-btn');
                if (copyBtn) {
                    copyBtn.addEventListener('click', () => this.copyAddress());
                }

                // 断开连接
                const disconnectBtn = document.getElementById('disconnect-wallet-btn');
                if (disconnectBtn) {
                    disconnectBtn.addEventListener('click', () => this.disconnect());
                }

                // 点击其他地方关闭下拉菜单
                document.addEventListener('click', () => {
                    this.hideDropdown();
                });
            }

            showWalletModal() {
                const modal = document.getElementById('wallet-modal');
                if (modal) {
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                }
            }

            hideWalletModal() {
                const modal = document.getElementById('wallet-modal');
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                }
            }

            async connectWallet(walletName) {
                try {
                    console.log(`🔗 连接钱包: ${walletName}`);
                    
                    // 查找钱包配置
                    const walletConfig = this.wallets.find(w => w.name.toLowerCase() === walletName.toLowerCase());
                    if (!walletConfig) {
                        throw new Error(`钱包 ${walletName} 未找到或未安装`);
                    }
                    
                    const adapter = walletConfig.adapter();
                    if (!adapter) {
                        this.showToast(`${walletName} 钱包未安装`, 'error');
                        return;
                    }
                    
                    // 更新按钮状态
                    this.updateConnectButton(true);
                    
                    // 连接钱包
                    let response;
                    if (adapter.connect) {
                        response = await adapter.connect();
                    } else if (adapter.publicKey && adapter.isConnected) {
                        response = { publicKey: adapter.publicKey };
                    } else {
                        throw new Error('钱包适配器不支持连接');
                    }
                    
                    const address = response.publicKey.toString();
                    
                    // 保存连接状态
                    this.selectedWallet = {
                        name: walletName,
                        adapter,
                        address,
                        config: walletConfig
                    };
                    this.isConnected = true;
                    
                    // 保存到localStorage
                    localStorage.setItem('wallet_address', address);
                    localStorage.setItem('wallet_type', walletName.toLowerCase());
                    
                    console.log(`✅ ${walletName} 连接成功:`, address);
                    
                    // 更新UI
                    this.updateUI();
                    this.hideWalletModal();
                    this.showToast(`${walletName} 连接成功!`, 'success');
                    
                    // 触发全局事件
                    window.dispatchEvent(new CustomEvent('walletConnected', {
                        detail: { address, provider: walletName.toLowerCase() }
                    }));
                    
                } catch (error) {
                    console.error('❌ 钱包连接失败:', error);
                    this.updateConnectButton(false);
                    this.showToast(`连接失败: ${error.message}`, 'error');
                }
            }

            async disconnect() {
                try {
                    console.log('🚪 断开钱包连接...');

                    if (this.selectedWallet?.adapter?.disconnect) {
                        await this.selectedWallet.adapter.disconnect();
                    }
                    
                    // 清理状态
                    this.selectedWallet = null;
                    this.isConnected = false;

                    // 清理localStorage
                    localStorage.removeItem('wallet_address');
                    localStorage.removeItem('wallet_type');
                    localStorage.removeItem('selectedCharacter');

                    // 更新UI
                    this.updateUI();
                    this.hideDropdown();
                    this.showToast('钱包已断开连接', 'success');

                    // 触发全局事件
                    window.dispatchEvent(new CustomEvent('walletDisconnected'));

                } catch (error) {
                    console.error('❌ 断开连接失败:', error);
                    // 强制清理状态
                    this.selectedWallet = null;
                    this.isConnected = false;
                    localStorage.clear();
                    this.updateUI();
                }
            }

            checkExistingConnection() {
                const savedAddress = localStorage.getItem('wallet_address');
                const savedType = localStorage.getItem('wallet_type');
                
                if (savedAddress && savedType) {
                    console.log('🔍 检查已保存的钱包连接...');
                    
                    const walletConfig = this.wallets.find(w => w.name.toLowerCase() === savedType.toLowerCase());
                    if (walletConfig) {
                        const adapter = walletConfig.adapter();
                        if (adapter && adapter.isConnected && adapter.publicKey) {
                            this.selectedWallet = {
                                name: walletConfig.name,
                                adapter,
                                address: savedAddress,
                                config: walletConfig
                            };
                            this.isConnected = true;
                            this.updateUI();
                            console.log('✅ 自动重连成功:', savedAddress);
                        }
                    }
                }
            }

            updateUI() {
                const connectButton = document.getElementById('wallet-connect-button');
                const walletInfo = document.getElementById('wallet-info');
                const walletAddress = document.getElementById('wallet-address');
                const walletAvatar = document.getElementById('wallet-avatar');

                if (this.isConnected && this.selectedWallet) {
                    // 已连接状态
                    if (connectButton) connectButton.style.display = 'none';
                    if (walletInfo) walletInfo.style.display = 'flex';
                    if (walletAddress) walletAddress.textContent = this.formatAddress(this.selectedWallet.address);
                    if (walletAvatar) walletAvatar.textContent = this.selectedWallet.config.icon;
                } else {
                    // 显示未连接状态
                    if (connectButton) connectButton.style.display = 'flex';
                    if (walletInfo) walletInfo.style.display = 'none';
                }
            }

            updateConnectButton(loading) {
                const button = document.getElementById('wallet-connect-button');
                if (!button) return;

                const textSpan = button.querySelector('.wallet-text');
                if (loading) {
                    button.disabled = true;
                    if (textSpan) textSpan.textContent = 'Connecting...';
                } else {
                    button.disabled = false;
                    if (textSpan) textSpan.textContent = 'Connect';
                }
            }

            toggleDropdown() {
                const dropdown = document.getElementById('wallet-dropdown');
                if (dropdown) {
                    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
                }
            }

            hideDropdown() {
                const dropdown = document.getElementById('wallet-dropdown');
                if (dropdown) {
                    dropdown.style.display = 'none';
                }
            }

            copyAddress() {
                if (this.selectedWallet?.address) {
                    navigator.clipboard.writeText(this.selectedWallet.address).then(() => {
                        this.showToast('地址已复制到剪贴板', 'success');
                    }).catch(() => {
                        this.showToast('复制失败', 'error');
                    });
                }
                this.hideDropdown();
            }

            formatAddress(address) {
                if (!address) return '';
                return `${address.slice(0, 6)}...${address.slice(-4)}`;
            }

            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `wallet-toast wallet-toast-${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }

            // 公共API
            getWalletInfo() {
                return {
                    isConnected: this.isConnected,
                    wallet: this.selectedWallet
                };
            }
            
            getPublicKey() {
                return this.selectedWallet?.adapter?.publicKey || null;
            }
            
            async signMessage(message) {
                if (!this.selectedWallet?.adapter?.signMessage) {
                    throw new Error('当前钱包不支持消息签名');
                }
                return await this.selectedWallet.adapter.signMessage(message);
            }
        }

        // 用户资料管理系统 - 移到这里确保在钱包初始化之前定义
        console.log('🚀 开始定义UserProfileManager类...');
        class UserProfileManager {
            constructor() {
                this.currentUserId = null;
            }
            
            // 检查用户是否需要填写资料 - 纯API驱动，无localStorage
            async checkUserProfile(userId) {
                // 从userId提取钱包地址
                const walletAddress = userId.replace('wallet_', '');
                
                try {
                    // 从后端API获取最新资料
                    const apiUrl = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';
                    const response = await fetch(`${apiUrl}/api/profiles/${walletAddress}`);
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.profile) {
                            console.log('✅ 从API获取用户资料成功:', result.profile);
                            return result.profile;
                        }
                    }
                    
                    if (response.status === 404) {
                        console.log('📝 API确认：用户资料不存在');
                        return null;
                    }
                    
                    console.warn('⚠️ API响应异常，状态码:', response.status);
                    return null;
                    
                } catch (error) {
                    console.error('❌ API请求失败:', error);
                    return null;
                }
            }
            
            // 显示用户资料面板
            showProfilePanel(userId = null, existingProfile = null) {
                console.log('📱 显示用户资料面板');
                const overlay = document.getElementById('user-profile-overlay');
                if (overlay) {
                    // 如果是编辑模式，填充现有数据
                    if (existingProfile) {
                        this.fillFormWithProfile(existingProfile);
                        // 更改标题为编辑模式
                        const title = overlay.querySelector('.profile-panel-title');
                        if (title) title.textContent = '编辑资料';
                    } else {
                        // 重置表单
                        this.resetForm();
                        const title = overlay.querySelector('.profile-panel-title');
                        if (title) title.textContent = '用户注册';
                    }
                    
                    overlay.style.display = 'flex';
                    console.log('✅ 资料面板已显示');
                } else {
                    console.error('❌ 找不到user-profile-overlay元素');
                }
            }
            
            // 填充表单数据
            fillFormWithProfile(profile) {
                const fields = {
                    'username': profile.nickname || profile.username,
                    'displayName': profile.nickname || profile.first_name || '',
                    'birthYear': profile.birth_year,
                    'birthMonth': profile.birth_month,
                    'birthDay': profile.birth_day,
                    'location': profile.location,
                    'language': profile.language || 'zh-CN'
                };
                
                Object.entries(fields).forEach(([fieldId, value]) => {
                    const field = document.getElementById(fieldId);
                    if (field && value) {
                        field.value = value;
                    }
                });
            }
            
            // 重置表单
            resetForm() {
                const form = document.getElementById('profile-form');
                if (form) {
                    form.reset();
                }
            }
            
            // 显示用户欢迎信息
            showUserWelcome(profile) {
                console.log('👋 显示用户欢迎信息:', profile);
                // 这里可以添加欢迎信息显示逻辑
            }
        }

        // 确保UserProfileManager类可全局访问
        console.log('📤 设置全局UserProfileManager...');
        window.UserProfileManager = UserProfileManager;
        
        // 立即初始化ProfileManager以确保在钱包连接时可用
        console.log('🏗️ 创建profileManager实例...');
        const profileManager = new UserProfileManager();
        window.profileManager = profileManager;
        console.log('✅ ProfileManager已初始化');

        // 初始化钱包管理器
        let walletManager;
        document.addEventListener('DOMContentLoaded', () => {
            walletManager = new SolanaWalletManager();
            window.walletManager = walletManager; // 暴露到全局
            window.modernWalletUI = walletManager; // 向后兼容
        });

        // 兼容旧的全局函数
        window.connectWallet = function() {
            if (walletManager) {
                walletManager.showWalletModal();
            }
        };
        
        window.disconnectWallet = function() {
            if (walletManager) {
                walletManager.disconnect();
            }
        };
        
        // 用户资料管理系统
        class UserProfileManager {
            constructor() {
                this.currentUserId = null;
            }
            
            // 检查用户是否需要填写资料 - 纯API驱动，无localStorage
            async checkUserProfile(userId) {
                // 从userId提取钱包地址
                const walletAddress = userId.replace('wallet_', '');
                
                try {
                    // 从后端API获取最新资料
                    const apiUrl = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';
                    const response = await fetch(`${apiUrl}/api/profiles/${walletAddress}`);
                    
                    if (response.ok) {
                        const result = await response.json();
                        const profile = result.profile;
                        console.log('✅ 从数据库获取用户资料:', profile.username || profile.nickname || '未知');
                        return profile;
                    } else if (response.status === 404) {
                        console.log('ℹ️ 用户资料不存在，需要注册');
                        return null;
                    } else {
                        console.error('❌ API获取用户资料失败:', response.status);
                        return null;
                    }
                } catch (error) {
                    console.error('❌ API请求失败:', error.message);
                    // 生产环境：API失败应该提示用户重试
                    alert('网络连接失败，请检查网络后刷新页面');
                    return null;
                }
            }
            
            // 保存用户资料 - 纯API驱动，无localStorage回退
            async saveUserProfile(userId, profileData) {
                const walletAddress = userId.replace('wallet_', '');
                
                // 准备API数据
                const apiData = {
                    walletAddress: walletAddress,
                    nickname: profileData.nickname || profileData.username,
                    age: profileData.age,
                    gender: profileData.gender,
                    birthday: profileData.birthday,
                    location: profileData.location,
                    occupation: profileData.occupation,
                    interests: profileData.interests,
                    bio: profileData.bio
                };
                
                try {
                    // 发送到后端API
                    const apiUrl = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';
                    console.log('🌐 发送API请求到:', `${apiUrl}/api/profiles`);
                    console.log('📊 发送数据:', apiData);
                    
                    const response = await fetch(`${apiUrl}/api/profiles`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(apiData)
                    });
                    
                    console.log('📈 API响应状态:', response.status);
                    
                    if (response.ok) {
                        const result = await response.json();
                        const savedProfile = result.profile;
                        console.log('✅ 用户资料已保存到数据库:', savedProfile.username || savedProfile.nickname || '未知');
                        return savedProfile;
                    } else if (response.status === 409) {
                        // 用户已存在，尝试更新
                        console.log('🔄 用户已存在，尝试更新资料');
                        return await this.updateUserProfile(userId, profileData);
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.message || `API保存失败: ${response.status}`);
                    }
                } catch (error) {
                    console.error('❌ 保存用户资料失败:', error.message);
                    // 生产环境：显示用户友好的错误提示
                    alert('保存失败，请检查网络连接后重试');
                    throw error; // 向上抛出错误，让调用者处理
                }
            }
            
            // 获取用户资料
            getUserProfile(userId) {
                return this.checkUserProfile(userId);
            }
            
            // 删除用户资料 - 纯API驱动
            async deleteUserProfile(userId) {
                const walletAddress = userId.replace('wallet_', '');
                
                try {
                    // 从API删除
                    const apiUrl = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';
                    const response = await fetch(`${apiUrl}/api/profiles/${walletAddress}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        console.log('✅ 用户资料已从数据库删除');
                        return true;
                    } else {
                        console.error('❌ 删除失败:', response.status);
                        return false;
                    }
                } catch (error) {
                    console.error('❌ API删除失败:', error.message);
                    alert('删除失败，请检查网络连接后重试');
                    return false;
                }
            }
            
            // 更新用户资料 - 纯API驱动
            async updateUserProfile(userId, updates) {
                const walletAddress = userId.replace('wallet_', '');
                
                try {
                    const apiUrl = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';
                    const response = await fetch(`${apiUrl}/api/profiles/${walletAddress}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(updates)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('✅ 用户资料已更新');
                        return result.profile;
                    } else {
                        console.error('❌ 更新失败:', response.status);
                        return null;
                    }
                } catch (error) {
                    console.error('❌ API更新失败:', error.message);
                    alert('更新失败，请检查网络连接后重试');
                    return null;
                }
            }
            
            
            // 获取所有用户资料 - 纯API驱动
            async getAllUserProfiles() {
                try {
                    const apiUrl = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';
                    const response = await fetch(`${apiUrl}/api/profiles`);
                    
                    if (response.ok) {
                        const result = await response.json();
                        return result.profiles || [];
                    } else {
                        console.error('❌ 获取所有用户失败:', response.status);
                        return [];
                    }
                } catch (error) {
                    console.error('❌ API请求失败:', error.message);
                    return [];
                }
            }
            
            // 显示资料注册面板
            showProfilePanel(userId = null, existingProfile = null) {
                const overlay = document.getElementById('user-profile-overlay');
                if (overlay) {
                    // 如果是编辑模式，填充现有数据
                    if (existingProfile) {
                        this.fillFormWithProfile(existingProfile);
                        // 更改标题为编辑模式
                        const title = overlay.querySelector('.profile-panel-title');
                        if (title) title.textContent = '编辑资料';
                    } else {
                        // 重置表单
                        this.resetForm();
                        const title = overlay.querySelector('.profile-panel-title');
                        if (title) title.textContent = '用户注册';
                    }
                    
                    // 初始化月份和日期选择器
                    setTimeout(() => {
                        this.initDateSelectors();
                    }, 100);
                    overlay.style.display = 'flex';
                    console.log('📝 显示用户资料注册面板');
                }
            }
            
            // 隐藏资料注册面板
            hideProfilePanel() {
                const overlay = document.getElementById('user-profile-overlay');
                if (overlay) {
                    overlay.style.display = 'none';
                }
            }
            
            // 初始化月份和日期选择器
            initDateSelectors() {
                const yearSelect = document.getElementById('birthYear');
                const monthSelect = document.getElementById('birthMonth');
                const daySelect = document.getElementById('birthDay');
                
                if (!yearSelect || !monthSelect || !daySelect) {
                    console.error('Date selectors not found');
                    return;
                }
                
                // 清空并填充年份（1950-2010，适合成年用户）
                yearSelect.innerHTML = '<option value="">年</option>';
                const currentYear = new Date().getFullYear();
                for (let i = currentYear - 15; i >= 1950; i--) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    yearSelect.appendChild(option);
                }
                
                // 清空并填充月份
                monthSelect.innerHTML = '<option value="">月</option>';
                for (let i = 1; i <= 12; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    monthSelect.appendChild(option);
                }
                
                // 清空并填充日期（默认31天）
                daySelect.innerHTML = '<option value="">日</option>';
                for (let i = 1; i <= 31; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    daySelect.appendChild(option);
                }
                
                // 月份变化时更新日期
                monthSelect.addEventListener('change', () => {
                    this.updateDayOptions(monthSelect.value);
                });
            }
            
            // 根据月份更新日期选项
            updateDayOptions(month) {
                const daySelect = document.getElementById('birthDay');
                const daysInMonth = [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
                const maxDays = month ? daysInMonth[month - 1] : 31;
                
                daySelect.innerHTML = '<option value="">日</option>';
                for (let i = 1; i <= maxDays; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    daySelect.appendChild(option);
                }
            }
            
            // 用现有资料填充表单
            fillFormWithProfile(profile) {
                const form = document.getElementById('profile-form');
                if (form && profile) {
                    // 填充基本信息
                    const nickname = form.querySelector('[name="nickname"]');
                    if (nickname) nickname.value = profile.nickname || '';
                    
                    const age = form.querySelector('[name="age"]');
                    if (age) age.value = profile.age || '';
                    
                    const location = form.querySelector('[name="location"]');
                    if (location) location.value = profile.location || '';
                    
                    const occupation = form.querySelector('[name="occupation"]');
                    if (occupation) occupation.value = profile.occupation || '';
                    
                    const interests = form.querySelector('[name="interests"]');
                    if (interests) interests.value = profile.interests || '';
                    
                    const bio = form.querySelector('[name="bio"]');
                    if (bio) bio.value = profile.bio || '';
                    
                    // 填充生日
                    if (profile.birthday) {
                        const [year, month, day] = profile.birthday.split('-');
                        const birthYear = form.querySelector('#birthYear');
                        const birthMonth = form.querySelector('#birthMonth');
                        const birthDay = form.querySelector('#birthDay');
                        
                        if (birthYear) birthYear.value = year;
                        if (birthMonth) birthMonth.value = parseInt(month);
                        if (birthDay) birthDay.value = parseInt(day);
                    }
                    
                    // 填充性别
                    if (profile.gender) {
                        const genderRadio = form.querySelector(`[name="gender"][value="${profile.gender}"]`);
                        if (genderRadio) genderRadio.checked = true;
                    }
                }
            }
            
            // 重置表单
            resetForm() {
                const form = document.getElementById('profile-form');
                if (form) {
                    form.reset();
                    // 清除日期选择器
                    const birthYear = form.querySelector('#birthYear');
                    const birthMonth = form.querySelector('#birthMonth');
                    const birthDay = form.querySelector('#birthDay');
                    
                    if (birthYear) birthYear.value = '';
                    if (birthMonth) birthMonth.value = '';
                    if (birthDay) birthDay.value = '';
                }
            }
            
            // 显示用户欢迎信息
            showUserWelcome(profile) {
                // 创建临时欢迎消息
                const welcomeDiv = document.createElement('div');
                welcomeDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 15px 20px;
                    border-radius: 10px;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                    z-index: 10000;
                    font-family: 'Microsoft YaHei', sans-serif;
                    max-width: 300px;
                    animation: slideInRight 0.5s ease;
                `;
                
                welcomeDiv.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 8px;">🎉 欢迎回来!</div>
                    <div style="font-size: 14px; opacity: 0.9;">
                        你好, ${profile.nickname || '用户'}! 进入AI女友世界
                    </div>
                    <button onclick="this.parentElement.remove()" style="
                        position: absolute;
                        top: 5px;
                        right: 8px;
                        background: none;
                        border: none;
                        color: white;
                        cursor: pointer;
                        font-size: 18px;
                        opacity: 0.7;
                    ">×</button>
                `;
                
                document.body.appendChild(welcomeDiv);
                
                // 3秒后自动消失
                setTimeout(() => {
                    if (welcomeDiv.parentElement) {
                        welcomeDiv.remove();
                    }
                }, 3000);
            }
        }
        
        // 确保UserProfileManager类可全局访问
        window.UserProfileManager = UserProfileManager;
        
        // 立即初始化ProfileManager以确保在钱包连接时可用
        const profileManager = new UserProfileManager();
        window.profileManager = profileManager;
        console.log('✅ ProfileManager已初始化');
        
        // 提交用户资料表单
        async function submitProfile(event) {
            try {
                console.log('🔄 表单提交开始');
                event.preventDefault();
                console.log('✅ 阻止了默认表单提交行为');
                
                const formData = {
                username: document.getElementById('username').value.trim(),
                displayName: document.getElementById('displayName').value.trim(),
                birthYear: document.getElementById('birthYear').value,
                birthMonth: document.getElementById('birthMonth').value,
                birthDay: document.getElementById('birthDay').value,
                location: document.getElementById('location').value.trim(),
                language: document.getElementById('language').value,
                // 记忆系统数据
                memory: {
                    favoriteFood: document.getElementById('favoriteFood').value.trim(),
                    favoriteColor: document.getElementById('favoriteColor').value.trim(),
                    hobbies: document.getElementById('hobbies').value.trim()
                }
            };
            
            console.log('📊 收集到的表单数据:', formData);
            
            // 验证必填字段
            const requiredFields = {
                username: formData.username,
                displayName: formData.displayName,
                birthYear: formData.birthYear,
                birthMonth: formData.birthMonth,
                birthDay: formData.birthDay,
                location: formData.location,
                language: formData.language
            };
            
            const missingFields = Object.entries(requiredFields).filter(([key, value]) => !value).map(([key]) => key);
            if (missingFields.length > 0) {
                console.error('❌ 缺少必填字段:', missingFields);
                alert(`请填写所有必填信息！缺少: ${missingFields.join(', ')}`);
                return;
            }
            
            // 保存用户资料
            const walletAddress = localStorage.getItem('wallet_address');
            if (walletAddress) {
                const userId = `wallet_${walletAddress}`;
                
                // 转换数据格式以匹配API期望
                const month = formData.birthMonth.toString().padStart ? formData.birthMonth.padStart(2, '0') : (formData.birthMonth.length === 1 ? '0' + formData.birthMonth : formData.birthMonth);
                const day = formData.birthDay.toString().padStart ? formData.birthDay.padStart(2, '0') : (formData.birthDay.length === 1 ? '0' + formData.birthDay : formData.birthDay);
                
                const apiFormData = {
                    nickname: formData.displayName,
                    username: formData.username,
                    age: new Date().getFullYear() - parseInt(formData.birthYear),
                    birthday: `${formData.birthYear}-${month}-${day}`,
                    location: formData.location,
                    language: formData.language,
                    interests: formData.memory.hobbies,
                    bio: `喜欢的食物: ${formData.memory.favoriteFood}, 喜欢的颜色: ${formData.memory.favoriteColor}`
                };
                
                console.log('📝 准备保存用户资料:', apiFormData);
                
                // 保存到数据库
                try {
                    await profileManager.saveUserProfile(userId, apiFormData);
                    console.log('✅ 用户资料保存成功，隐藏面板');
                    profileManager.hideProfilePanel();
                } catch (error) {
                    console.error('❌ 保存用户资料失败:', error);
                    alert('保存用户资料失败，请重试');
                    return;
                }
                
                console.log('✅ 用户资料提交完成，准备选择角色');
                
                // 显示提示消息
                const successMsg = document.createElement('div');
                successMsg.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.9);
                    color: white;
                    padding: 20px 40px;
                    border-radius: 10px;
                    font-size: 16px;
                    z-index: 10001;
                `;
                successMsg.textContent = '🎉 注册完成！请选择你的AI女友角色';
                document.body.appendChild(successMsg);
                
                setTimeout(() => {
                    successMsg.remove();
                }, 3000);
                
            } else {
                console.error('❌ 无法获取钱包地址，无法保存资料');
            }
            } catch (error) {
                console.error('❌ 表单提交过程中发生错误:', error);
                alert('提交失败：' + error.message);
            }
        }
        
        // handleProfileSubmit会在普通script标签中定义
        
        // 暴露函数到全局作用域
        window.submitProfile = submitProfile;
        
        // 测试函数 - 强制显示profile panel
        window.testShowProfilePanel = function() {
            console.log('🧪 测试显示profile panel');
            if (window.profileManager) {
                console.log('✅ profileManager存在，显示面板');
                window.profileManager.showProfilePanel();
            } else {
                console.error('❌ profileManager不存在');
            }
        };
        
        // 新增：测试新用户流程
        window.testNewUserFlow = function() {
            console.log('🧪 模拟新用户流程');
            const testAddress = 'TEST_NEW_USER_' + Date.now();
            console.log('🔄 使用测试地址:', testAddress);
            
            setTimeout(async () => {
                if (window.profileManager) {
                    const userId = `wallet_${testAddress}`;
                    try {
                        const profile = await window.profileManager.checkUserProfile(userId);
                        console.log('📄 检查结果:', profile);
                        if (!profile) {
                            console.log('📝 新用户确认，显示面板');
                            window.profileManager.showProfilePanel();
                        }
                    } catch (error) {
                        console.log('❌ API错误，显示面板');
                        window.profileManager.showProfilePanel();
                    }
                }
            }, 500);
        };
        
        // ===================
        // 全局用户管理函数
        // ===================
        
        // 清除当前用户资料（模拟首次登录）
        window.clearUserProfile = async function() {
            const walletAddress = localStorage.getItem('wallet_address');
            if (walletAddress) {
                const userId = `wallet_${walletAddress}`;
                console.log('🧹 正在从数据库清除用户资料:', userId);
                
                // 纯API删除，不再使用localStorage
                if (window.profileManager) {
                    const success = await window.profileManager.deleteUserProfile(userId);
                    if (success) {
                        console.log('✅ 用户资料已从数据库删除，刷新页面查看效果');
                        location.reload();
                    } else {
                        console.log('⚠️ 删除失败，可能用户不存在');
                    }
                } else {
                    console.error('❌ profileManager未初始化');
                }
            } else {
                console.log('⚠️ 未连接钱包，无需清除');
            }
        };
        
        // 清除所有用户资料
        window.clearAllProfiles = function() {
            const profiles = window.profileManager.getAllUserProfiles();
            profiles.forEach(({userId}) => {
                window.profileManager.deleteUserProfile(userId);
            });
            console.log(`✅ 已清除 ${profiles.length} 个用户资料`);
        };
        
        // 查看所有用户资料
        window.showAllProfiles = function() {
            const profiles = window.profileManager.getAllUserProfiles();
            console.log(`📋 总共有 ${profiles.length} 个用户资料:`);
            profiles.forEach(({userId, profile}) => {
                console.log(`👤 ${userId}:`, profile);
            });
            return profiles;
        };
        
        // 编辑当前用户资料
        window.editCurrentProfile = function() {
            const walletAddress = localStorage.getItem('wallet_address');
            if (walletAddress) {
                const userId = `wallet_${walletAddress}`;
                const profile = window.profileManager.getUserProfile(userId);
                if (profile) {
                    window.profileManager.showProfilePanel(userId, profile);
                    console.log('📝 正在编辑用户资料');
                } else {
                    console.log('⚠️ 未找到用户资料，显示新用户注册面板');
                    window.profileManager.showProfilePanel();
                }
            } else {
                console.log('⚠️ 未连接钱包');
            }
        };
        
        // 获取当前用户资料
        window.getCurrentProfile = function() {
            const walletAddress = localStorage.getItem('wallet_address');
            if (walletAddress) {
                const userId = `wallet_${walletAddress}`;
                const profile = window.profileManager.getUserProfile(userId);
                console.log('👤 当前用户资料:', profile);
                return profile;
            } else {
                console.log('⚠️ 未连接钱包');
                return null;
            }
        };
        
    </script>
    <!-- 用户信息填写面板 -->
    <div class="user-profile-overlay" id="user-profile-overlay" style="display: none;">
        <div class="profile-panel">
            <div class="profile-panel-header">
                <h2 class="profile-panel-title">用户注册</h2>
            </div>
            
            <form class="profile-form">
                <!-- 用户名 -->
                <div class="profile-field">
                    <label class="field-label">用户名</label>
                    <input type="text" class="profile-input" id="username" placeholder="最多12个字符" maxlength="12" required>
                    <div class="field-note">其他用户可以看到（最多12个字符）</div>
                </div>
                
                <!-- 昵称（姓名） -->
                <div class="profile-field">
                    <label class="field-label">你的名字</label>
                    <input type="text" class="profile-input" id="displayName" placeholder="姓名" required>
                    <div class="field-note">「你的名字」是AI女友在聊天中称呼你的名字，对其他用户不可见<br>「用户名」和「你的名字」以后可以在个人资料中修改。</div>
                </div>
                
                <!-- 生日 -->
                <div class="profile-field has-multiple-inputs">
                    <label class="field-label">你的生日</label>
                    <div class="birthday-inputs">
                        <select class="profile-select" id="birthYear" required>
                            <option value="">年</option>
                            <option value="2010">2010</option>
                            <option value="2009">2009</option>
                            <option value="2008">2008</option>
                            <option value="2007">2007</option>
                            <option value="2006">2006</option>
                            <option value="2005">2005</option>
                            <option value="2004">2004</option>
                            <option value="2003">2003</option>
                            <option value="2002">2002</option>
                            <option value="2001">2001</option>
                            <option value="2000">2000</option>
                            <option value="1999">1999</option>
                            <option value="1998">1998</option>
                            <option value="1997">1997</option>
                            <option value="1996">1996</option>
                            <option value="1995">1995</option>
                            <option value="1994">1994</option>
                            <option value="1993">1993</option>
                            <option value="1992">1992</option>
                            <option value="1991">1991</option>
                            <option value="1990">1990</option>
                            <option value="1989">1989</option>
                            <option value="1988">1988</option>
                            <option value="1987">1987</option>
                            <option value="1986">1986</option>
                            <option value="1985">1985</option>
                            <option value="1984">1984</option>
                            <option value="1983">1983</option>
                            <option value="1982">1982</option>
                            <option value="1981">1981</option>
                            <option value="1980">1980</option>
                            <option value="1979">1979</option>
                            <option value="1978">1978</option>
                            <option value="1977">1977</option>
                            <option value="1976">1976</option>
                            <option value="1975">1975</option>
                            <option value="1974">1974</option>
                            <option value="1973">1973</option>
                            <option value="1972">1972</option>
                            <option value="1971">1971</option>
                            <option value="1970">1970</option>
                            <option value="1969">1969</option>
                            <option value="1968">1968</option>
                            <option value="1967">1967</option>
                            <option value="1966">1966</option>
                            <option value="1965">1965</option>
                            <option value="1964">1964</option>
                            <option value="1963">1963</option>
                            <option value="1962">1962</option>
                            <option value="1961">1961</option>
                            <option value="1960">1960</option>
                            <option value="1959">1959</option>
                            <option value="1958">1958</option>
                            <option value="1957">1957</option>
                            <option value="1956">1956</option>
                            <option value="1955">1955</option>
                            <option value="1954">1954</option>
                            <option value="1953">1953</option>
                            <option value="1952">1952</option>
                            <option value="1951">1951</option>
                            <option value="1950">1950</option>
                        </select>
                        <select class="profile-select" id="birthMonth" required>
                            <option value="">月</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                        </select>
                        <select class="profile-select" id="birthDay" required>
                            <option value="">日</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                            <option value="13">13</option>
                            <option value="14">14</option>
                            <option value="15">15</option>
                            <option value="16">16</option>
                            <option value="17">17</option>
                            <option value="18">18</option>
                            <option value="19">19</option>
                            <option value="20">20</option>
                            <option value="21">21</option>
                            <option value="22">22</option>
                            <option value="23">23</option>
                            <option value="24">24</option>
                            <option value="25">25</option>
                            <option value="26">26</option>
                            <option value="27">27</option>
                            <option value="28">28</option>
                            <option value="29">29</option>
                            <option value="30">30</option>
                            <option value="31">31</option>
                        </select>
                    </div>
                    <div class="field-note">※生日设置后无法更改</div>
                </div>
                
                <!-- 国家/城市 -->
                <div class="profile-field">
                    <label class="field-label">居住地</label>
                    <input type="text" class="profile-input" id="location" placeholder="例：北京、上海、纽约" required>
                </div>
                
                <!-- 语言偏好 -->
                <div class="profile-field">
                    <label class="field-label">语言设置</label>
                    <select class="profile-select" id="language" required>
                        <option value="">选择语言</option>
                        <option value="中文">中文</option>
                        <option value="English">English</option>
                        <option value="日本語">日本語</option>
                        <option value="한국어">한국어</option>
                        <option value="Español">Español</option>
                        <option value="Français">Français</option>
                    </select>
                </div>
                
                <!-- 记忆系统 -->
                <div class="memory-section">
                    <div class="memory-title">个人偏好记忆</div>
                    
                    <div class="memory-field">
                        <label class="memory-label">喜欢的食物</label>
                        <input type="text" class="memory-input" id="favoriteFood" placeholder="例：火锅、意面、寿司">
                    </div>
                    
                    <div class="memory-field">
                        <label class="memory-label">喜欢的颜色</label>
                        <input type="text" class="memory-input" id="favoriteColor" placeholder="例：蓝色、粉色、绿色">
                    </div>
                    
                    <div class="memory-field">
                        <label class="memory-label">兴趣爱好</label>
                        <input type="text" class="memory-input" id="hobbies" placeholder="例：读书、听音乐、游戏">
                    </div>
                    
                </div>
                
                <button type="button" class="profile-submit-btn" onclick="handleProfileSubmit(event)">OK</button>
            </form>
        </div>
    </div>

<script>
// 直接在这里实现完整的表单提交逻辑
window.handleProfileSubmit = async function(event) {
    try {
        console.log('🔄 表单提交开始');
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        const formData = {
            username: document.getElementById('username').value.trim(),
            displayName: document.getElementById('displayName').value.trim(),
            birthYear: document.getElementById('birthYear').value,
            birthMonth: document.getElementById('birthMonth').value,
            birthDay: document.getElementById('birthDay').value,
            location: document.getElementById('location').value.trim(),
            language: document.getElementById('language').value,
            // 记忆系统数据
            memory: {
                favoriteFood: document.getElementById('favoriteFood').value.trim(),
                favoriteColor: document.getElementById('favoriteColor').value.trim(),
                hobbies: document.getElementById('hobbies').value.trim()
            }
        };
        
        console.log('📊 收集到的表单数据:', formData);
        
        // 验证必填字段
        const requiredFields = {
            username: formData.username,
            displayName: formData.displayName,
            birthYear: formData.birthYear,
            birthMonth: formData.birthMonth,
            birthDay: formData.birthDay,
            location: formData.location,
            language: formData.language
        };
        
        const missingFields = Object.entries(requiredFields).filter(([key, value]) => !value).map(([key]) => key);
        if (missingFields.length > 0) {
            console.error('❌ 缺少必填字段:', missingFields);
            alert(`请填写所有必填信息！缺少: ${missingFields.join(', ')}`);
            return;
        }
        
        // 保存用户资料
        const walletAddress = localStorage.getItem('wallet_address');
        if (walletAddress) {
            const userId = `wallet_${walletAddress}`;
            
            // 转换数据格式以匹配API期望
            const month = formData.birthMonth.toString().length === 1 ? '0' + formData.birthMonth : formData.birthMonth;
            const day = formData.birthDay.toString().length === 1 ? '0' + formData.birthDay : formData.birthDay;
            
            const apiFormData = {
                nickname: formData.displayName,
                username: formData.username,
                age: new Date().getFullYear() - parseInt(formData.birthYear),
                birthday: `${formData.birthYear}-${month}-${day}`,
                location: formData.location,
                language: formData.language,
                interests: formData.memory.hobbies,
                bio: `喜欢的食物: ${formData.memory.favoriteFood}, 喜欢的颜色: ${formData.memory.favoriteColor}`
            };
            
            console.log('📝 准备保存用户资料:', apiFormData);
            
            // 发送到后端API
            try {
                const apiUrl = 'http://localhost:3000';
                console.log('🌐 发送API请求到:', `${apiUrl}/api/profiles`);
                console.log('📊 发送数据:', apiFormData);
                
                const response = await fetch(`${apiUrl}/api/profiles`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        walletAddress: walletAddress,
                        ...apiFormData
                    })
                });
                
                console.log('📈 API响应状态:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ 用户资料保存成功');
                    
                    // 隐藏面板
                    const overlay = document.getElementById('user-profile-overlay');
                    if (overlay) {
                        overlay.style.display = 'none';
                    }
                    
                    // 显示成功提示
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: rgba(0, 0, 0, 0.9);
                        color: white;
                        padding: 20px 40px;
                        border-radius: 10px;
                        font-size: 16px;
                        z-index: 10001;
                    `;
                    successMsg.textContent = '🎉 注册完成！请选择你的AI女友角色';
                    document.body.appendChild(successMsg);
                    
                    setTimeout(() => {
                        successMsg.remove();
                    }, 3000);
                    
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `API保存失败: ${response.status}`);
                }
            } catch (error) {
                console.error('❌ 保存用户资料失败:', error);
                alert('保存用户资料失败，请重试: ' + error.message);
            }
        } else {
            console.error('❌ 无法获取钱包地址，无法保存资料');
            alert('无法获取钱包地址，请重新连接钱包');
        }
    } catch (error) {
        console.error('❌ 表单提交过程中发生错误:', error);
        alert('提交失败：' + error.message);
    }
};
</script>

</body>
</html>