<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com; style-src 'self' 'unsafe-inline' https://unpkg.com; img-src 'self' data: blob: https://mintlify.s3.us-west-1.amazonaws.com https://assets.coingecko.com https://cdn.jsdelivr.net https://raw.githubusercontent.com https://images.ctfassets.net https://avatars.githubusercontent.com https://backpack.app https://www.madlads.com https://pbs.twimg.com https://static.okx.com https://img.bitgetimg.com https://tp-statics.tokenpocket.pro; media-src 'self' blob: data:; connect-src 'self' blob: http://localhost:3000 https://api.devnet.solana.com https://api.elevenlabs.io;">
    <title>HEROES - é€‰æ‹©ä½ çš„å¥³å‹è§’è‰²</title>
    <link rel="stylesheet" href="wallet-ui.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow: hidden;
            color: white;
            position: relative;
            margin: 0;
            padding: 0;
            background: url('BG/selection-bg.jpg') center/cover no-repeat;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* é¡¶éƒ¨æ ‡é¢˜ */
        .heroes-title {
            position: absolute;
            top: 12px;
            left: 12px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            z-index: 100;
        }

        /* è§’è‰²ä¿¡æ¯é¢æ¿ - æ—¥å¼æ¡£æ¡ˆå¡è®¾è®¡ */
        .character-info {
            position: absolute;
            top: 40px;
            left: 12px;
            width: 190px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(200, 200, 200, 0.5);
            border-radius: 7px;
            padding: 0;
            z-index: 100;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        .character-name {
            font-size: 10px;
            font-weight: bold;
            color: #333;
            margin: 0;
            text-align: center;
            padding: 8px;
            background: rgba(255, 255, 255, 0.8);
            border-bottom: 1px solid rgba(200, 200, 200, 0.3);
        }

        .profile-section {
            margin-bottom: 2px;
        }

        .profile-header {
            background: linear-gradient(135deg, #2c2c2c, #1a1a1a);
            color: white;
            padding: 4px 8px;
            font-size: 7px;
            font-weight: 600;
            position: relative;
            border-left: 2px solid #e91e63;
        }

        .profile-content {
            background: rgba(248, 248, 248, 0.95);
            padding: 8px;
            color: #333;
        }

        .profile-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid rgba(200, 200, 200, 0.3);
        }

        .profile-row:last-child {
            border-bottom: none;
        }

        .profile-label {
            font-size: 7px;
            color: #666;
            font-weight: 500;
        }

        .profile-value {
            font-size: 7px;
            color: #333;
            font-weight: 600;
        }

        .profile-text {
            font-size: 7px;
            color: #333;
            line-height: 1.4;
            padding: 2px 0;
        }

        .favorite-section {
            background: rgba(248, 248, 248, 0.95);
            padding: 8px;
            color: #333;
            text-align: center;
            font-size: 7px;
        }

        .expand-button {
            position: absolute;
            top: 4px;
            right: 6px;
            width: 12px;
            height: 12px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 2px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
        }

        .refresh-button {
            position: absolute;
            bottom: 8px;
            right: 8px;
            width: 16px;
            height: 16px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        }

        /* æµ®åŠ¨è¯­éŸ³é€‰æ‹©å™¨æ ·å¼ - åŸºäºå‚è€ƒæˆªå›¾ */
        .voice-selector-floating {
            position: absolute;
            top: 20%; /* ä»40%è°ƒæ•´ä¸º20%ï¼Œå‘ä¸Šç§»åŠ¨50% */
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 50px;
            padding: 12px 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            animation: fadeInUp 0.6s ease-out;
        }

        .language-flags {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .flag-btn {
            background: transparent;
            border: none;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            opacity: 0.7;
            position: relative;
        }

        .flag-btn:hover {
            transform: scale(1.15);
            opacity: 1;
        }

        .flag-btn.active {
            opacity: 1;
            background: rgba(100, 150, 255, 0.15);
            box-shadow: 0 0 0 3px rgba(100, 150, 255, 0.4);
            transform: scale(1.1);
        }

        .flag-btn.active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background: #4285f4;
            border-radius: 50%;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translate(-50%, -40%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        /* ä¸­å¤®è§’è‰²åç§°æ˜¾ç¤º */
        .character-display-name {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 36px;
            font-weight: bold;
            color: white;
            text-shadow: 1.5px 1.5px 3px rgba(0, 0, 0, 0.5);
            z-index: 50;
            opacity: 0.9;
        }

        /* VRMå±•ç¤ºåŒºåŸŸ - ä¸­å¤® */
        .vrm-display {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .vrm-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* ç®€åŒ–çš„åŠ è½½åŠ¨ç”»æ ·å¼ */
        .character-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            display: none;
            flex-direction: column;
            align-items: center;
            animation: fadeInLoader 0.3s ease-out;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border-radius: 16px;
            box-shadow: 40px 0px 0 0 rgba(255, 255, 255, 0.2), 
                       32.4px 23.5px 0 0 rgba(255, 255, 255, 0.4), 
                       12.4px 38px 0 0 rgba(255, 255, 255, 0.6), 
                       -12.4px 38px 0 0 rgba(255, 255, 255, 0.8), 
                       -32.4px 23.5px 0 0 #ffffff;
            animation: spinner-rotate 1s infinite linear;
            margin-bottom: 20px;
        }

        .loader-text {
            font-size: 16px;
            color: white;
            text-align: center;
            letter-spacing: 3px;
            font-weight: 600;
            text-transform: uppercase;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        @keyframes spinner-rotate {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeInLoader {
            from { 
                opacity: 0; 
                transform: translate(-50%, -50%) scale(0.9);
            }
            to { 
                opacity: 1; 
                transform: translate(-50%, -50%) scale(1);
            }
        }



        /* è§’è‰²é€‰æ‹©å™¨ - åº•éƒ¨ - æ¨¡ä»¿æˆªå›¾æ ·å¼ */
        .character-selector {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 9px;
            padding: 12px 31px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(4px);
            border-radius: 60px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            z-index: 100;
            box-shadow: 0 1px 7px rgba(0, 0, 0, 0.1);
        }

        /* å¯¼èˆªæŒ‰é’® - å·¦å³ç®­å¤´ */
        .nav-button {
            width: 42px;
            height: 42px;
            border: 3px solid rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 21px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .nav-button:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.1);
        }

        .character-thumbnails {
            display: flex;
            gap: 9px;
            align-items: center;
        }

        .character-thumb {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
            position: relative;
            background: white;
        }

        /* å½“å‰é€‰ä¸­çš„è§’è‰² */
        .character-thumb.active {
            border-color: #FFD700;
            transform: scale(1.15);
            box-shadow: 0 0 7px rgba(255, 215, 0, 0.6);
        }

        /* ä¸­å¿ƒçš„é€‰ä¸­æŒ‡ç¤ºå™¨ - æ¨¡ä»¿æˆªå›¾è®¾è®¡ */
        .selected-indicator {
            width: 75px;
            height: 105px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            border-radius: 18px;
            border: 1.5px solid rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 6px;
            margin: 0 9px;
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.15);
            position: relative;
        }
        
        .selected-indicator .selected-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            overflow: hidden;
            margin-bottom: 6px;
            border: 1.5px solid white;
        }
        
        .selected-indicator .selected-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .selected-indicator .selected-badge {
            width: 18px;
            height: 18px;
            background: #000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 9px;
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .selected-indicator .selected-text {
            color: #666;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .character-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .character-thumb:hover {
            transform: scale(1.05);
            border-color: white;
        }

        .character-thumb.selected {
            width: 40px;
            height: 40px;
            border-color: #333;
            border-width: 2px;
            transform: scale(1);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }

        .character-thumb.selected::before {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            border: 2px solid #ffd700;
            border-radius: 50%;
            z-index: -1;
        }

        .character-thumb.selected::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 8px;
            background: #ffd700;
            border-radius: 50%;
        }

        .select-indicator {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 14px;
            color: white;
            font-weight: 500;
        }


        /* å³ä¸Šè§’é’±åŒ…è¿æ¥åŒºåŸŸ */
        .wallet-connect-area {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        /* ç°ä»£åŒ–è¿æ¥æŒ‰é’® - åŸºäºUIå‚è€ƒ */
        .wallet-connect-button {
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
            border: none;
            border-radius: 30px;
            padding: 12px 24px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.3);
            min-width: 120px;
            justify-content: center;
        }

        .wallet-connect-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(139, 92, 246, 0.4);
            background: linear-gradient(135deg, #7c3aed 0%, #9333ea 100%);
        }

        .wallet-connect-button:active {
            transform: translateY(-1px);
        }

        .wallet-connect-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .wallet-loading {
            animation: spin 1s linear infinite;
        }

        /* å·²è¿æ¥çŠ¶æ€æ˜¾ç¤º */
        .wallet-info {
            background: rgba(26, 26, 26, 0.95);
            border: 1px solid #333333;
            border-radius: 20px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 220px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        }

        .wallet-info-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .wallet-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 20px;
        }

        .wallet-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .wallet-address {
            color: #ffffff;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        .wallet-balance {
            color: #888888;
            font-size: 12px;
        }

        .wallet-actions {
            position: relative;
        }

        .wallet-menu-btn {
            background: none;
            border: none;
            color: #888888;
            font-size: 16px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .wallet-menu-btn:hover {
            background: #2a2a2a;
            color: #ffffff;
        }

        .wallet-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: #1a1a1a;
            border: 1px solid #333333;
            border-radius: 12px;
            min-width: 180px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            z-index: 1001;
            overflow: hidden;
            display: none;
        }

        .wallet-dropdown-item {
            padding: 12px 16px;
            color: #ffffff;
            cursor: pointer;
            transition: background 0.2s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .wallet-dropdown-item:hover {
            background: #2a2a2a;
        }

        .wallet-dropdown-item:last-child {
            border-top: 1px solid #333333;
            color: #ef4444;
        }

        .wallet-dropdown-item:last-child:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* é’±åŒ…è¿æ¥æ¨¡æ€æ¡† - åŸºäºUIå‚è€ƒè®¾è®¡ */
        .wallet-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s ease;
        }

        .wallet-modal-overlay {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .wallet-modal-content {
            background: #1a1a1a;
            border-radius: 24px;
            padding: 32px;
            width: 100%;
            max-width: 420px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
        }

        .wallet-modal-header {
            margin-bottom: 32px;
            text-align: left;
        }

        .wallet-modal-header h2 {
            color: #ffffff;
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .wallet-modal-header p {
            color: #888888;
            font-size: 16px;
            line-height: 1.5;
            margin: 0;
        }

        .wallet-close-btn {
            position: absolute;
            top: 24px;
            right: 24px;
            background: none;
            border: none;
            color: #888888;
            font-size: 24px;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .wallet-close-btn:hover {
            background: #2a2a2a;
            color: #ffffff;
        }

        /* é’±åŒ…é€‰é¡¹åˆ—è¡¨ */
        .wallet-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 32px;
        }

        .wallet-option {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            background: #2a2a2a;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
            text-decoration: none;
            color: #ffffff;
        }

        .wallet-option:hover {
            background: #333333;
            border-color: #444444;
            transform: translateY(-1px);
        }

        .wallet-option:active {
            transform: translateY(0);
        }

        /* Phantomé’±åŒ…ç‰¹æ®Šé«˜äº®æ•ˆæœ */
        .wallet-option[data-provider="phantom"]:hover {
            background: linear-gradient(135deg, rgba(171, 159, 242, 0.1), rgba(171, 159, 242, 0.05));
            border-color: rgba(171, 159, 242, 0.3);
            box-shadow: 0 4px 20px rgba(171, 159, 242, 0.1);
        }

        .wallet-option-icon {
            font-size: 24px;
            margin-right: 16px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
        }

        .wallet-option-name {
            color: #ffffff;
            font-size: 18px;
            font-weight: 600;
            flex: 1;
        }

        .wallet-option-arrow {
            color: #666666;
            font-size: 18px;
            transition: all 0.2s ease;
        }

        .wallet-option:hover .wallet-option-arrow {
            color: #ffffff;
            transform: translateX(4px);
        }

        /* é¡µè„š */
        .wallet-modal-footer {
            text-align: center;
            padding-top: 24px;
            border-top: 1px solid #2a2a2a;
        }

        .wallet-modal-footer p {
            color: #666666;
            font-size: 14px;
            line-height: 1.5;
        }

        .wallet-link {
            color: #4f46e5;
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .wallet-link:hover {
            color: #6366f1;
        }

        /* åŠ¨ç”» */
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* æ¶ˆæ¯æç¤º */
        .wallet-toast {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #1a1a1a;
            border: 1px solid #333333;
            border-radius: 12px;
            padding: 12px 20px;
            color: #ffffff;
            font-size: 14px;
            z-index: 10001;
            animation: toastSlideIn 0.3s ease;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
        }

        .wallet-toast-success {
            border-left: 4px solid #10b981;
        }

        .wallet-toast-error {
            border-left: 4px solid #ef4444;
        }

        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }


        /* å¼€å§‹æŒ‰é’® - ç°ä»£æ¸å˜è®¾è®¡ */
        .start-button {
            --h-button: 100px;
            --w-button: 280px;
            --round: 50px;
            cursor: pointer;
            position: absolute;
            bottom: 40px;
            right: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            overflow: visible;
            transition: all 0.25s ease;
            animation: pulse 2s infinite;
            box-shadow: 0 8px 30px rgba(135, 206, 250, 0.4);
            background: linear-gradient(135deg, #E6B3FF 0%, #B3D9FF 100%);
            border-radius: var(--round);
            border: 2px solid rgba(255, 255, 255, 0.6);
            outline: none;
            padding: 15px 30px;
            z-index: 100;
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .start-button::before {
            content: "âœ¨";
            position: absolute;
            left: -20px;
            top: -10px;
            font-size: 16px;
            animation: twinkle 1.5s infinite alternate;
        }
        
        .start-button::after {
            content: "âœ¨";
            position: absolute;
            right: -15px;
            bottom: -5px;
            font-size: 14px;
            animation: twinkle 1.8s infinite alternate;
        }

        @keyframes twinkle {
            0% { opacity: 0.3; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1.2); }
        }

        .start-button:active {
            transform: scale(0.95);
        }
        
        .start-button:hover {
            box-shadow: 0 12px 40px rgba(135, 206, 250, 0.6);
            transform: translateY(-2px);
        }

        .points_wrapper {
            overflow: hidden;
            width: 100%;
            height: 100%;
            pointer-events: none;
            position: absolute;
            z-index: 1;
        }

        .points_wrapper .point {
            bottom: -10px;
            position: absolute;
            animation: floating-points infinite ease-in-out;
            pointer-events: none;
            width: 2px;
            height: 2px;
            background-color: #fff;
            border-radius: 9999px;
        }

        @keyframes floating-points {
            0% {
                transform: translateY(0);
            }
            85% {
                opacity: 0;
            }
            100% {
                transform: translateY(-55px);
                opacity: 0;
            }
        }

        .points_wrapper .point:nth-child(1) {
            left: 10%;
            opacity: 1;
            animation-duration: 2.35s;
            animation-delay: 0.2s;
        }
        .points_wrapper .point:nth-child(2) {
            left: 30%;
            opacity: 0.7;
            animation-duration: 2.5s;
            animation-delay: 0.5s;
        }
        .points_wrapper .point:nth-child(3) {
            left: 25%;
            opacity: 0.8;
            animation-duration: 2.2s;
            animation-delay: 0.1s;
        }
        .points_wrapper .point:nth-child(4) {
            left: 44%;
            opacity: 0.6;
            animation-duration: 2.05s;
        }
        .points_wrapper .point:nth-child(5) {
            left: 50%;
            opacity: 1;
            animation-duration: 1.9s;
        }
        .points_wrapper .point:nth-child(6) {
            left: 75%;
            opacity: 0.5;
            animation-duration: 1.5s;
            animation-delay: 1.5s;
        }
        .points_wrapper .point:nth-child(7) {
            left: 88%;
            opacity: 0.9;
            animation-duration: 2.2s;
            animation-delay: 0.2s;
        }
        .points_wrapper .point:nth-child(8) {
            left: 58%;
            opacity: 0.8;
            animation-duration: 2.25s;
            animation-delay: 0.2s;
        }
        .points_wrapper .point:nth-child(9) {
            left: 98%;
            opacity: 0.6;
            animation-duration: 2.6s;
            animation-delay: 0.1s;
        }
        .points_wrapper .point:nth-child(10) {
            left: 65%;
            opacity: 1;
            animation-duration: 2.5s;
            animation-delay: 0.2s;
        }

        .inner {
            z-index: 2;
            gap: 3px;
            position: relative;
            width: 100%;
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 700;
            line-height: 1.5;
            transition: color 0.2s ease-in-out;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.8),
                         0 0 40px rgba(223, 113, 255, 0.6);
            letter-spacing: 0.1em;
        }

        .inner svg.icon {
            width: 9px;
            height: 9px;
            transition: fill 0.1s linear;
        }

        .start-button:focus svg.icon {
            fill: white;
        }
        .start-button:hover svg.icon {
            fill: transparent;
            animation:
                dasharray 1s linear forwards,
                filled 0.1s linear forwards 0.95s;
        }
        @keyframes dasharray {
            from {
                stroke-dasharray: 0 0 0 0;
            }
            to {
                stroke-dasharray: 68 68 0 0;
            }
        }
        @keyframes filled {
            to {
                fill: white;
            }
        }


        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .heroes-title {
                font-size: 32px;
            }

            .character-display-name {
                font-size: 48px;
                bottom: 180px;
            }

            .character-info {
                top: 100px;
                left: 20px;
                right: 20px;
                max-width: none;
            }

            .control-panel {
                top: 20px;
                right: 20px;
            }

            .character-selector {
                bottom: 20px;
                left: 20px;
                right: 20px;
                transform: none;
            }

            .start-button {
                bottom: 20px;
                right: 20px;
            }
        }

        /* ç”¨æˆ·èµ„æ–™é¢æ¿æ ·å¼ - ç²¾ç¡®å¤åˆ»è®¾è®¡ */
        .user-profile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            background: rgba(0, 0, 0, 0.16);
            backdrop-filter: blur(6px);
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s ease;
        }

        .profile-panel {
            background: white;
            border-radius: 25px;
            padding: 8px; /* æ·»åŠ ç™½è‰²è¾¹æ¡†æ•ˆæœ */
            max-width: 416px; /* 320px * 1.3 = 416px */
            width: 85%;
            max-height: 85vh; /* æ·»åŠ æœ€å¤§é«˜åº¦ */
            position: relative;
            box-shadow: 0 12px 35px rgba(0,0,0,0.2);
            border: 3px solid #F0F0F0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .profile-panel-header {
            background: linear-gradient(180deg, #B3E5FC 0%, #81D4FA 50%, #4FC3F7 100%);
            text-align: center;
            padding: 25px 0; /* æ›´å¤§çš„å†…è¾¹è· */
            margin: 0;
            position: relative;
            flex-shrink: 0; /* é˜²æ­¢å¤´éƒ¨è¢«å‹ç¼© */
            border-radius: 20px 20px 0 0; /* åªæœ‰é¡¶éƒ¨åœ†è§’ */
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.3), 
                        0 2px 4px rgba(0,0,0,0.1);
        }

        .profile-panel-title {
            font-size: 24px; /* æ›´å¤§çš„å­—ä½“ */
            margin: 0;
            font-weight: 600; /* æ›´ç²—çš„å­—é‡ */
            color: #2E3A47; /* æ›´æ·±çš„é¢œè‰² */
            text-shadow: 0 1px 2px rgba(255,255,255,0.5);
            letter-spacing: 1px; /* å¢åŠ å­—é—´è· */
        }

        .profile-form {
            padding: 30px; /* è°ƒæ•´å†…è¾¹è· */
            display: flex;
            flex-direction: column;
            gap: 30px; 
            overflow-y: auto; /* å¯ç”¨å‚ç›´æ»šåŠ¨ */
            flex: 1; /* å æ®å‰©ä½™ç©ºé—´ */
            max-height: calc(85vh - 90px); /* å‡å»å¤´éƒ¨å’Œè¾¹æ¡†é«˜åº¦ */
            background: white;
            border-radius: 0 0 17px 17px; /* åº•éƒ¨åœ†è§’ï¼Œé…åˆå¤–å±‚è¾¹æ¡† */
        }

        .profile-field {
            display: flex;
            flex-direction: column;
            gap: 16px; /* 12px * 1.3 â‰ˆ 16px */
            position: relative;
        }

        /* é‡‘è‰²è£…é¥°çº¿æ¡ */
        .field-label {
            font-size: 18px; /* 14px * 1.3 â‰ˆ 18px */
            font-weight: 500;
            color: #D4AF37;
            text-align: center;
            margin: 0;
            position: relative;
            padding: 0 26px; /* 20px * 1.3 â‰ˆ 26px */
        }

        .field-label::before,
        .field-label::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 52px; /* 40px * 1.3 â‰ˆ 52px */
            height: 1px;
            background: #D4AF37;
        }

        .field-label::before {
            left: 0;
        }

        .field-label::after {
            right: 0;
        }

        .profile-input, .profile-select {
            padding: 16px 46px 16px 20px; /* 12px*1.3â‰ˆ16px, 35px*1.3â‰ˆ46px, 15px*1.3â‰ˆ20px */
            border: none;
            border-radius: 10px; /* 8px * 1.3 â‰ˆ 10px */
            background: #E1F5FE;
            color: #333;
            font-size: 18px; /* 14px * 1.3 â‰ˆ 18px */
            transition: all 0.3s ease;
            position: relative;
        }

        .profile-input:focus, .profile-select:focus {
            outline: none;
            background: #B3E5FC;
        }

        .profile-input::placeholder {
            color: rgba(0,0,0,0.5);
        }

        /* è¾“å…¥æ¡†ç¾½æ¯›ç¬”å›¾æ ‡ */
        .profile-field::after {
            content: 'ğŸª¶';
            position: absolute;
            right: 16px; /* 12px * 1.3 â‰ˆ 16px */
            top: 49px; /* 38px * 1.3 â‰ˆ 49px */
            font-size: 16px; /* 12px * 1.3 â‰ˆ 16px */
            pointer-events: none;
        }

        .name-inputs, .birthday-inputs {
            display: flex;
            gap: 10px; /* Reduced gap for 3 selects */
            position: relative;
        }

        .name-inputs .profile-input,
        .birthday-inputs .profile-select {
            flex: 1;
        }
        
        .birthday-inputs .profile-select {
            min-width: 0; /* Allow shrinking */
        }

        .field-note {
            font-size: 14px; /* 11px * 1.3 â‰ˆ 14px */
            color: #E91E63;
            line-height: 1.3;
            text-align: center;
            margin-top: 7px; /* 5px * 1.3 â‰ˆ 7px */
        }

        .profile-submit-btn {
            padding: 16px 52px; /* 12px*1.3â‰ˆ16px, 40px*1.3â‰ˆ52px */
            border: none;
            border-radius: 26px; /* 20px * 1.3 â‰ˆ 26px */
            font-size: 21px; /* 16px * 1.3 â‰ˆ 21px */
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #FF69B4, #E91E63);
            color: white;
            font-weight: 500;
            margin: 20px auto 0; /* 15px * 1.3 â‰ˆ 20px */
            box-shadow: 0 4px 16px rgba(233, 30, 99, 0.3); /* 3px*1.3â‰ˆ4px, 12px*1.3â‰ˆ16px */
            display: block;
            width: 156px; /* 120px * 1.3 â‰ˆ 156px */
        }

        .profile-submit-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.4);
        }

        .profile-submit-btn:active {
            transform: translateY(0px);
        }

        /* ç‰¹æ®Šæ ·å¼è°ƒæ•´ */
        .birthday-inputs .profile-field::after {
            display: none; /* ç”Ÿæ—¥é€‰æ‹©æ¡†ä¸æ˜¾ç¤ºç¼–è¾‘å›¾æ ‡ */
        }

        .profile-field.has-multiple-inputs::after {
            display: none; /* å¤šä¸ªè¾“å…¥æ¡†çš„å­—æ®µä¸æ˜¾ç¤ºç¼–è¾‘å›¾æ ‡ */
        }

        /* è®°å¿†ç³»ç»Ÿæ ·å¼ */
        .memory-section {
            background: rgba(255,255,255,0.2);
            border-radius: 16px; /* 12px * 1.3 â‰ˆ 16px */
            padding: 26px; /* 20px * 1.3 â‰ˆ 26px */
            margin-top: 13px; /* 10px * 1.3 â‰ˆ 13px */
        }

        .memory-title {
            text-align: center;
            color: #D4AF37;
            font-size: 18px; /* 14px * 1.3 â‰ˆ 18px */
            font-weight: 500;
            margin-bottom: 20px; /* 15px * 1.3 â‰ˆ 20px */
            position: relative;
            padding: 0 26px; /* 20px * 1.3 â‰ˆ 26px */
        }

        .memory-title::before,
        .memory-title::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 39px; /* 30px * 1.3 â‰ˆ 39px */
            height: 1px;
            background: #D4AF37;
        }

        .memory-title::before {
            left: 0;
        }

        .memory-title::after {
            right: 0;
        }

        .memory-field {
            margin-bottom: 16px; /* 12px * 1.3 â‰ˆ 16px */
            position: relative;
        }

        .memory-label {
            font-size: 16px; /* 12px * 1.3 â‰ˆ 16px */
            color: #666;
            margin-bottom: 7px; /* 5px * 1.3 â‰ˆ 7px */
            display: block;
        }

        .memory-input {
            width: 100%;
            padding: 10px 39px 10px 16px; /* 8px*1.3â‰ˆ10px, 30px*1.3â‰ˆ39px, 12px*1.3â‰ˆ16px */
            border: none;
            border-radius: 8px; /* 6px * 1.3 â‰ˆ 8px */
            background: #F0F8FF;
            color: #333;
            font-size: 16px; /* 12px * 1.3 â‰ˆ 16px */
            box-sizing: border-box;
        }

        .memory-field::after {
            content: 'ğŸª¶'; /* æ”¹ä¸ºç¾½æ¯›ç¬”å›¾æ ‡ */
            position: absolute;
            right: 10px; /* 8px * 1.3 â‰ˆ 10px */
            top: 36px; /* 28px * 1.3 â‰ˆ 36px */
            font-size: 13px; /* 10px * 1.3 â‰ˆ 13px */
            pointer-events: none;
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 10px 40px rgba(223, 113, 255, 0.4);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 15px 60px rgba(223, 113, 255, 0.6);
                transform: scale(1.02);
            }
        }

        .character-info,
        .character-selector,
        .start-button,
        .control-panel {
            animation: fadeInUp 0.8s ease-out;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- é¡¶éƒ¨æ ‡é¢˜ -->
        <div class="heroes-title">HEROES</div>

        <!-- è§’è‰²ä¿¡æ¯é¢æ¿ - æ—¥å¼æ¡£æ¡ˆå¡UI -->
        <div class="character-info">
            <div class="character-name" id="character-name">Fliza</div>
            
            <div class="profile-section">
                <div class="profile-header">
                    ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«/Basic Info
                    <button class="expand-button">â†—</button>
                </div>
                <div class="profile-content">
                    <div class="profile-row">
                        <span class="profile-label">å¹´é¾„/Age</span>
                        <span class="profile-value" id="character-age">22æ­³</span>
                    </div>
                    <div class="profile-row">
                        <span class="profile-label">è¯ç”Ÿæ—¥/Birthday</span>
                        <span class="profile-value" id="character-birthday">6æœˆ5æ—¥</span>
                    </div>
                    <div class="profile-row">
                        <span class="profile-label">æ˜Ÿåº§/Zodiac</span>
                        <span class="profile-value" id="character-zodiac">åŒå­åº§</span>
                    </div>
                </div>
            </div>
            
            <div class="profile-section">
                <div class="profile-header">
                    æ€§æ ¼/Personality
                </div>
                <div class="profile-content">
                    <div class="profile-text" id="character-personality">
                        æ´»æ³¼å¤–å‘ï¼Œè°ƒçš®å¯çˆ±
                    </div>
                </div>
            </div>
            
            <div class="profile-section">
                <div class="profile-header">
                    å…´è¶£/Daily Interests
                </div>
                <div class="profile-content">
                    <div class="profile-text" id="character-interests">
                        è·³èˆã€å”±æ­Œ
                    </div>
                </div>
            </div>
            
            <div class="profile-section">
                <div class="profile-header">
                    å–œå¥½ & è®¨åŒ/Likes & Dislikes
                </div>
                <div class="profile-content">
                    <div class="profile-row">
                        <span class="profile-label">å–œæ¬¢</span>
                        <span class="profile-value" id="character-likes">é²œèŠ±å’Œå½©è‰²ç”œç‚¹</span>
                    </div>
                    <div class="profile-row">
                        <span class="profile-label">è®¨åŒ</span>
                        <span class="profile-value" id="character-dislikes">å®‰é™å’Œè¿‡äºä¸¥è‚ƒçš„åœºåˆ</span>
                    </div>
                </div>
            </div>
            
            <div class="profile-section">
                <div class="profile-header">
                    æœ€çˆ±/Favorites
                    <button class="expand-button">â†—</button>
                </div>
                <div class="profile-content">
                    <div class="profile-row">
                        <span class="profile-label">é£Ÿç‰©</span>
                        <span class="profile-value" id="character-food">è‰è“è›‹ç³•ã€é©¬å¡é¾™</span>
                    </div>
                    <div class="profile-row">
                        <span class="profile-label">éŸ³ä¹</span>
                        <span class="profile-value" id="character-music">æµè¡Œèˆæ›²ã€K-Pop</span>
                    </div>
                    <div class="profile-row">
                        <span class="profile-label">ç”µå½±</span>
                        <span class="profile-value" id="character-movies">æµªæ¼«å–œå‰§</span>
                    </div>
                    <div class="profile-row">
                        <span class="profile-label">æ¸¸æˆ</span>
                        <span class="profile-value" id="character-games">èŠ‚å¥èˆè¹ˆæ¸¸æˆ</span>
                    </div>
                </div>
            </div>
            
            <button class="refresh-button">âŸ²</button>
        </div>

        <!-- ä¸­å¤®è§’è‰²åç§° -->
        <div class="character-display-name" id="character-display-name">èŠ™è‰è</div>

        <!-- è¯­éŸ³é€‰æ‹©å™¨ - æµ®åŠ¨æ§ä»¶ -->
        <div class="voice-selector-floating">
            <div class="language-flags">
                <button class="flag-btn active" data-lang="jp" onclick="playVoiceSample('jp')">ğŸ‡¯ğŸ‡µ</button>
                <button class="flag-btn" data-lang="cn" onclick="playVoiceSample('cn')">ğŸ‡¨ğŸ‡³</button>
                <button class="flag-btn" data-lang="en" onclick="playVoiceSample('en')">ğŸ‡ºğŸ‡¸</button>
            </div>
        </div>

        <!-- VRMå±•ç¤ºåŒºåŸŸ -->
        <div class="vrm-display">
            <canvas id="vrm-canvas" class="vrm-canvas"></canvas>
            
            <!-- è§’è‰²åŠ è½½åŠ¨ç”» -->
            <div class="character-loader" id="character-loader">
                <div class="spinner"></div>
                <div class="loader-text">LOADING</div>
            </div>
        </div>

        <!-- è§’è‰²é€‰æ‹©å™¨ -->
        <div class="character-selector">
            <button class="nav-button" onclick="previousCharacter()">â€¹</button>
            <div class="character-thumbnails" id="character-thumbnails"></div>
            <div class="selected-indicator">
                <div class="selected-avatar">
                    <img id="selected-avatar-img" src="" alt="Selected Character">
                </div>
                <div class="selected-badge">A</div>
                <div class="selected-text">Select</div>
            </div>
            <div class="character-thumbnails" id="character-thumbnails-right"></div>
            <button class="nav-button" onclick="nextCharacter()">â€º</button>
        </div>


        <!-- Solana å®˜æ–¹é’±åŒ…é€‚é…å™¨ React ç»„ä»¶ -->
        <div class="wallet-connect-area">
            <div id="wallet-adapter-root"></div>
        </div>


        <!-- å¼€å§‹æŒ‰é’® -->
        <button class="start-button" onclick="startChat()">
            <div class="fold"></div>
            <div class="points_wrapper">
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
                <span class="point"></span>
            </div>
            <span class="inner">å¼€å§‹èŠå¤©</span>
        </button>
    </div>
    
    <!-- é’±åŒ…è¿æ¥æ¨¡æ€æ¡† - ç°ä»£åŒ–è®¾è®¡ -->
    <div class="wallet-modal" id="wallet-modal">
        <div class="wallet-modal-overlay">
            <div class="wallet-modal-content">
                <div class="wallet-modal-header">
                    <h2>Connect wallet</h2>
                    <p>Get started by connecting your preferred wallet below.</p>
                    <button class="wallet-close-btn" id="wallet-close-btn">Ã—</button>
                </div>
                
                <div class="wallet-list">
                    <div class="wallet-option" data-provider="phantom">
                        <div class="wallet-option-icon">ğŸ‘»</div>
                        <span class="wallet-option-name">Phantom</span>
                        <div class="wallet-option-arrow">â†’</div>
                    </div>
                    
                    <div class="wallet-option" data-provider="solflare">
                        <div class="wallet-option-icon">â˜€ï¸</div>
                        <span class="wallet-option-name">Solflare</span>
                        <div class="wallet-option-arrow">â†’</div>
                    </div>
                    
                    <div class="wallet-option" data-provider="coinbase">
                        <div class="wallet-option-icon">ğŸ”·</div>
                        <span class="wallet-option-name">Coinbase</span>
                        <div class="wallet-option-arrow">â†’</div>
                    </div>
                    
                    <div class="wallet-option" data-provider="backpack">
                        <div class="wallet-option-icon">ğŸ’</div>
                        <span class="wallet-option-name">Backpack</span>
                        <div class="wallet-option-arrow">â†’</div>
                    </div>
                </div>
                
                <div class="wallet-modal-footer">
                    <p>By connecting your wallet, you're agree to our 
                        <a href="#" class="wallet-link">Terms of Service</a> 
                        and our 
                        <a href="#" class="wallet-link">Privacy Policy</a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
                "@pixiv/three-vrm": "https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@2/lib/three-vrm.module.min.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { VRMLoaderPlugin, VRMUtils } from '@pixiv/three-vrm';

        // è§’è‰²æ•°æ® - åŒ…å«è¯¦ç»†æ¡£æ¡ˆä¿¡æ¯
        const characters = [
            {
                id: "alice",
                name: "Alice",
                file: "Main VRM/Alice.vrm",
                personality: "æ´»æ³¼å¤–å‘ï¼Œè°ƒçš®å¯çˆ±",
                dailyInterests: "è·³èˆã€å”±æ­Œ",
                likes: "é²œèŠ±å’Œå½©è‰²ç”œç‚¹",
                dislikes: "å®‰é™å’Œè¿‡äºä¸¥è‚ƒçš„åœºåˆ",
                favoriteFood: "è‰è“è›‹ç³•ã€é©¬å¡é¾™",
                favoriteMusic: "æµè¡Œèˆæ›²ã€K-Pop",
                favoriteMovies: "æµªæ¼«å–œå‰§",
                favoriteGames: "èŠ‚å¥èˆè¹ˆæ¸¸æˆ",
                age: "22æ­³",
                birthday: "6æœˆ5æ—¥",
                zodiac: "åŒå­åº§",
                height: "å¥½æ„Ÿåº¦Lv.10å¼€æ”¾",
                weight: "å¥½æ„Ÿåº¦Lv.10å¼€æ”¾",
                measurements: "å¥½æ„Ÿåº¦Lv.20å¼€æ”¾",
                voiceId: "rEJAAHKQqr6yTNCh8xS0",
                sampleLines: {
                    jp: "æœˆæ˜ã‹ã‚Šã®ä¸‹ã§äºŒäººãã‚Šã§è¸Šã‚ã†ï¼",
                    cn: "è®©æˆ‘ä»¬åœ¨æœˆå…‰ä¸‹å…±èˆï¼Œåªå±äºæˆ‘ä»¬ä¸¤ä¸ªäººï¼",
                    en: "Let's dance under the moonlight, just us two!"
                }
            },
            {
                id: "ash",
                name: "Ash",
                file: "Main VRM/Ash.vrm",
                personality: "å†·é™ç†æ€§ï¼Œé€»è¾‘æ¸…æ™°",
                dailyInterests: "é˜…è¯»ã€ç¼–ç¨‹",
                likes: "å¤œæ™šå’Œæµ“å’–å•¡",
                dislikes: "å™ªéŸ³å’Œæ„å¤–å¹²æ‰°",
                favoriteFood: "é»‘å·§å…‹åŠ›",
                favoriteMusic: "Lo-fi è½»æ¾éŸ³ä¹ã€ç¯å¢ƒéŸ³",
                favoriteMovies: "ç§‘å¹»ã€æ‚¬ç–‘æƒŠæ‚š",
                favoriteGames: "è§£è°œå†’é™©æ¸¸æˆ",
                age: "24æ­³",
                birthday: "11æœˆ12æ—¥",
                zodiac: "å¤©èåº§",
                height: "å¥½æ„Ÿåº¦Lv.10å¼€æ”¾",
                weight: "å¥½æ„Ÿåº¦Lv.10å¼€æ”¾",
                measurements: "å¥½æ„Ÿåº¦Lv.20å¼€æ”¾",
                voiceId: "bY4cOgafbv5vatmokfg0",
                sampleLines: {
                    jp: "é™ã‹ãªå¤œã«æœ¬ã¨ã‚³ãƒ¼ãƒ’ãƒ¼ãŒæœ€é«˜ã ã€‚",
                    cn: "é™è°§çš„å¤œæ™šï¼Œä¹¦å’Œå’–å•¡æœ€å®Œç¾ã€‚",
                    en: "A quiet night with a book and coffee is perfect."
                }
            },
            {
                id: "elinyaa",
                name: "Elinyaa",
                file: "Main VRM/Elinyaa.vrm",
                personality: "ç¥ç§˜ä¼˜é›…çš„ç²¾çµå°‘å¥³ï¼Œæœ‰ç€ä¸å¯æ€è®®çš„é­…åŠ›ã€‚",
                traits: ["ç¥ç§˜", "ä¼˜é›…", "ç²¾çµ", "ç©ºçµ"],
                emoji: "ğŸ§š",
                level: 29,
                type: "ç²¾çµç³»"
            },
            {
                id: "fliza",
                name: "Fliza",
                file: "Main VRM/Fliza VRM.vrm",
                personality: "æ¸©æš–ä½“è´´ï¼Œå–„è§£äººæ„",
                dailyInterests: "å†œä½œã€å›­è‰º",
                likes: "æ—¥å‡ºå’Œæ™¨éœ²",
                dislikes: "æ±¡æŸ“",
                favoriteFood: "æ–°é²œæ°´æœã€èœ‚èœœæŸ æª¬æ°´",
                favoriteMusic: "æ°‘è°£ã€è‡ªç„¶éŸ³æ™¯",
                favoriteMovies: "è‡ªç„¶çºªå½•ç‰‡ã€æš–å¿ƒæ•…äº‹",
                favoriteGames: "åŠ¨ç‰©æ£®å‹ä¼š",
                age: "23æ­³",
                birthday: "8æœˆ14æ—¥",
                zodiac: "ç‹®å­åº§",
                height: "å¥½æ„Ÿåº¦Lv.10å¼€æ”¾",
                weight: "å¥½æ„Ÿåº¦Lv.10å¼€æ”¾",
                measurements: "å¥½æ„Ÿåº¦Lv.20å¼€æ”¾",
                voiceId: "s9lrHYk7TIJ2UO7UNbje",
                sampleLines: {
                    jp: "æ—¥ã®å‡ºã«ä¸€ç·’ã«ç¨®ã‚’ã¾ã‹ãªã„ï¼Ÿ",
                    cn: "æƒ³å’Œæˆ‘ä¸€èµ·åœ¨æ—¥å‡ºæ—¶æ’­ç§å—ï¼Ÿ",
                    en: "Care to join me in planting seeds at sunrise?"
                }
            },
            {
                id: "imeris",
                name: "Imeris",
                file: "Main VRM/IMERIS.vrm",
                personality: "é«˜è´µä¼˜é›…çš„è´µæ—å°‘å¥³ï¼Œä¸¾æ­¢ç«¯åº„ã€‚",
                traits: ["é«˜è´µ", "ä¼˜é›…", "ç«¯åº„", "è´µæ—"],
                emoji: "ğŸ‘‘",
                level: 31,
                type: "è´µæ—ç³»",
                voiceId: "YuKvHNms5efZ0SvhIr3g",
                sampleLines: {
                    jp: "ä½“æ¸©ã‚’æ¸¬ã‚‰ã›ã¦ã­â€”ã‚ãªãŸã®ã“ã¨ã‚’å¤§äº‹ã«æ€ã£ã¦ã‚‹ã€‚",
                    cn: "è®©æˆ‘ç»™ä½ é‡é‡ä½“æ¸©â€”â€”æˆ‘å¾ˆåœ¨æ„ä½ ã€‚",
                    en: "Let me check your temperatureâ€”I care for you."
                }
            },
            {
                id: "maple",
                name: "Maple",
                file: "Main VRM/Maple.vrm",
                personality: "æ¸©æš–å¦‚ç§‹æ—¥é˜³å…‰çš„å¥³å­©ï¼Œæ€»æ˜¯ç»™äººå®‰å…¨æ„Ÿã€‚",
                traits: ["æ¸©æš–", "è´¤æƒ ", "ç»†å¿ƒ", "æ²»æ„ˆ"],
                emoji: "ğŸ",
                level: 26,
                type: "æ¸©æš–ç³»",
                voiceId: "B8gJV1IhpuegLxdpXFOE",
                sampleLines: {
                    jp: "æš–ç‚‰ã®ãã°ã§ãƒ¯ãƒƒãƒ•ãƒ«ã¯ã„ã‹ãŒï¼Ÿ",
                    cn: "æƒ³åœ¨æ¸©æš–çš„å£ç‚‰è¾¹äº«ç”¨åå¤«é¥¼å—ï¼Ÿ",
                    en: "Would you like a warm waffle by my cozy fireplace?"
                }
            },
            {
                id: "nekona",
                name: "Nekona",
                file: "Main VRM/NEKONA.vrm",
                personality: "å¯çˆ±çš„çŒ«å¨˜ï¼Œæœ‰ç€çŒ«å’ªèˆ¬çš„æ…µæ‡’ä¸æ´»æ³¼ã€‚",
                traits: ["å¯çˆ±", "çŒ«å¨˜", "æ…µæ‡’", "æ´»æ³¼"],
                emoji: "ğŸ±",
                level: 21,
                type: "å…½å¨˜ç³»",
                voiceId: "kcg1KQQGuCGzH6FUjsZQ",
                sampleLines: {
                    jp: "å¤œãŒç§˜å¯†ã‚’å›ãâ€”ä¸€ç·’ã«æ¢æ¤œã—ã‚ˆã†ï¼Ÿ",
                    cn: "å¤œæ™šä½è¯­ç§˜å¯†â€”â€”æˆ‘ä»¬å»æ¢ç´¢å§ï¼Ÿ",
                    en: "The night whispers secretsâ€”shall we explore them?"
                }
            },
            {
                id: "notia",
                name: "Notia",
                file: "Main VRM/Notia.vrm",
                personality: "çŸ¥æ€§å†·é™çš„ç ”ç©¶è€…ï¼Œå¯¹çŸ¥è¯†å……æ»¡æ¸´æœ›ã€‚",
                traits: ["çŸ¥æ€§", "å†·é™", "ç ”ç©¶", "åšå­¦"],
                emoji: "ğŸ”¬",
                level: 32,
                type: "å­¦è€…ç³»",
                voiceId: "abz2RylgxmJx76xNpaj1",
                sampleLines: {
                    jp: "ãã‚ãã‚èŒ¶é“ã‚’ã—ã¾ã›ã‚“ã‹ï¼Ÿå¿ƒã«é™ã‘ã•ã‚’æº€ãŸãã†ã€‚",
                    cn: "è¦ä¸¾è¡ŒèŒ¶é“äº†å—ï¼Ÿè®©å®é™å……æ»¡å¿ƒçµã€‚",
                    en: "Tea ceremony soon? Let tranquility fill our hearts."
                }
            },
            {
                id: "ququ",
                name: "QuQu",
                file: "Main VRM/QuQu.vrm",
                personality: "æ´»æ³¼å¯çˆ±çš„èè‰ï¼Œæ€»æ˜¯å……æ»¡å…ƒæ°”ã€‚",
                traits: ["æ´»æ³¼", "å¯çˆ±", "å…ƒæ°”", "èè‰"],
                emoji: "ğŸ€",
                level: 20,
                type: "èè‰ç³»",
                voiceId: "tfQFvzjodQp63340jz2r",
                sampleLines: {
                    jp: "æ¬¡ã®ãƒ¯ã‚¤ãƒ«ãƒ‰ãƒ©ã‚¤ãƒ‰ã§ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³ã‚’è¿½ã„ã‹ã‘ã‚‹æº–å‚™ã¯ï¼Ÿ",
                    cn: "å‡†å¤‡å¥½åœ¨ä¸‹ä¸€æ¬¡ç‹‚é‡å†’é™©ä¸­è¿½é€è‚¾ä¸Šè…ºç´ äº†å—ï¼Ÿ",
                    en: "Ready to chase adrenaline on our next wild ride?"
                }
            },
            {
                id: "rindo",
                name: "Rindo",
                file: "Main VRM/RINDO.vrm",
                personality: "ä¼ ç»Ÿå’Œé£çš„å¤§å’ŒæŠšå­ï¼Œæ¸©æŸ”è´¤æ·‘ã€‚",
                traits: ["å’Œé£", "ä¼ ç»Ÿ", "æ¸©æŸ”", "è´¤æ·‘"],
                emoji: "ğŸŒ¸",
                level: 28,
                type: "å’Œé£ç³»",
                voiceId: "nclQ39ewSlJMu5Nidnsf",
                sampleLines: {
                    jp: "åˆ€ã®æŠœãæ–¹ã«é›†ä¸­ã—ã¦ã€‚è¦å¾‹ãŒè‚å¿ƒã ã€‚",
                    cn: "ä¸“æ³¨äºåˆ€åˆƒçš„å‡ºé˜ï¼›çºªå¾‹æ˜¯å…³é”®ã€‚",
                    en: "Focus on the cut of your blade; discipline is key."
                }
            },
            {
                id: "rainy",
                name: "Rainy",
                file: "Main VRM/Rainy.vrm",
                personality: "æ´»æ³¼å¼€æœ—çš„é‚»å®¶å¥³å­©ï¼Œæ€»æ˜¯å……æ»¡æ´»åŠ›ã€‚",
                traits: ["æ´»æ³¼", "å¼€æœ—", "è¿åŠ¨", "é˜³å…‰"],
                emoji: "ğŸŒ§ï¸",
                level: 22,
                type: "æ´»åŠ›ç³»",
                voiceId: "1ghrzLZQ7Dza7Xs9OkhY",
                sampleLines: {
                    jp: "çª“ã‚’å©ãé›¨éŸ³ã¯ç§ã®ãŠæ°—ã«å…¥ã‚Šã®å­å®ˆå”„ã€‚",
                    cn: "é›¨æ»´æ•²æ‰“çª—æˆ·æ˜¯æˆ‘æœ€çˆ±çš„æ‘‡ç¯®æ›²ã€‚",
                    en: "Rain tapping on windows is my favorite lullaby."
                }
            },
            {
                id: "vivi",
                name: "Vivi",
                file: "Main VRM/Vivi.vrm",
                personality: "å……æ»¡å¥½å¥‡å¿ƒçš„æ¢é™©å®¶ï¼Œæ€»æ˜¯å¯¹ä¸–ç•Œå……æ»¡çƒ­æƒ…ã€‚",
                traits: ["å¥½å¥‡", "å†’é™©", "çƒ­æƒ…", "ä¹è§‚"],
                emoji: "âœ¨",
                level: 24,
                type: "å†’é™©ç³»",
                voiceId: "4lWJNy00PxQAOMgQTiIS",
                sampleLines: {
                    jp: "ä»Šå¤œã¯ã¿ã‚“ãªã«ç¬‘é¡”ã‚’å±Šã‘ã‚‹é…ä¿¡ã‚’ã—ã‚ˆã†ï¼",
                    cn: "ä»Šæ™šè®©æˆ‘ä»¬ç›´æ’­å¹¶ä¸å¤§å®¶åˆ†äº«å¾®ç¬‘å§ï¼",
                    en: "Let's stream and share smiles with everyone tonight!"
                }
            },
            {
                id: "wolferia",
                name: "Wolferia",
                file: "Main VRM/Wolferia.vrm",
                personality: "é«˜å‚²çš„ç‹¼æ—å…¬ä¸»ï¼Œæœ‰ç€ç‹è€…çš„æ°”è´¨ã€‚",
                traits: ["é«˜å‚²", "ç‹¼æ—", "ç‹è€…", "å¨ä¸¥"],
                emoji: "ğŸº",
                level: 33,
                type: "å…½å¨˜ç³»"
            },
            {
                id: "yawl",
                name: "Yawl",
                file: "Main VRM/Yawl.vrm",
                personality: "ç¥ç§˜çš„é­”æ³•å°‘å¥³ï¼ŒæŒæ¡ç€ä¸å¯æ€è®®çš„åŠ›é‡ã€‚",
                traits: ["ç¥ç§˜", "é­”æ³•", "å¹»æƒ³", "å¼ºå¤§"],
                emoji: "ğŸ”®",
                level: 30,
                type: "é­”æ³•ç³»"
            },
            {
                id: "yuuyii",
                name: "Yuu Yii",
                file: "Main VRM/Yuu Yii.vrm",
                personality: "æ¸©æŸ”å¯çˆ±çš„åŒå­ä¹‹ä¸€ï¼Œæ€»æ˜¯å¸¦ç€ç”œç¾çš„ç¬‘å®¹ã€‚",
                traits: ["æ¸©æŸ”", "å¯çˆ±", "åŒå­", "ç”œç¾"],
                emoji: "ğŸ’•",
                level: 23,
                type: "åŒå­ç³»"
            },
            {
                id: "zwei",
                name: "Zwei",
                file: "Main VRM/Zwei.vrm",
                personality: "å†·é…·å¸…æ°”çš„æˆ˜å£«å°‘å¥³ï¼Œæœ‰ç€åšå¼ºçš„å†…å¿ƒã€‚",
                traits: ["å†·é…·", "å¸…æ°”", "æˆ˜å£«", "åšå¼º"],
                emoji: "âš”ï¸",
                level: 29,
                type: "æˆ˜å£«ç³»"
            },
            {
                id: "bobo",
                name: "Bobo",
                file: "Main VRM/bobo.vrm",
                personality: "å¤©çœŸæ— é‚ªçš„å°å¤©ä½¿ï¼Œæ€»æ˜¯å¸¦æ¥æ¬¢ä¹ã€‚",
                traits: ["å¤©çœŸ", "æ— é‚ª", "å¿«ä¹", "å¤©ä½¿"],
                emoji: "ğŸ˜‡",
                level: 19,
                type: "å¤©ä½¿ç³»"
            },
            {
                id: "kyoko",
                name: "Kyoko",
                file: "Main VRM/kyoko.vrm",
                personality: "æˆç†Ÿç¨³é‡çš„å¤§å§å§ï¼Œå€¼å¾—ä¿¡èµ–ã€‚",
                traits: ["æˆç†Ÿ", "ç¨³é‡", "å¯é ", "å¤§å§å§"],
                emoji: "ğŸ’œ",
                level: 28,
                type: "å§å§ç³»"
            },
            {
                id: "lena",
                name: "Lena",
                file: "Main VRM/lena.vrm",
                personality: "èªæ˜æœºæ™ºçš„å­¦éœ¸å‹å¥³å­©ï¼Œæ€»æ˜¯èƒ½ç»™ä½ æœ€å¥½çš„å»ºè®®ã€‚",
                traits: ["èªæ˜", "ç†æ€§", "å­¦éœ¸", "å¯é "],
                emoji: "ğŸ“š",
                level: 30,
                type: "æ™ºæ…§ç³»"
            },
            {
                id: "lilium",
                name: "Lilium",
                file: "Main VRM/lilium.vrm",
                personality: "ä¼˜é›…ç¥ç§˜çš„å°‘å¥³ï¼Œæœ‰ç€ç‹¬ç‰¹çš„é­…åŠ›ã€‚",
                traits: ["ä¼˜é›…", "ç¥ç§˜", "è‰ºæœ¯", "æµªæ¼«"],
                emoji: "ğŸŒº",
                level: 28,
                type: "ç¥ç§˜ç³»"
            },
            {
                id: "miru",
                name: "Miru",
                file: "Main VRM/miru.vrm",
                personality: "è½¯èŒå¯çˆ±çš„å°èè‰ï¼Œè®©äººå¿ä¸ä½æƒ³ä¿æŠ¤ã€‚",
                traits: ["è½¯èŒ", "å¯çˆ±", "èè‰", "çº¯çœŸ"],
                emoji: "ğŸ¼",
                level: 18,
                type: "èè‰ç³»"
            },
            {
                id: "miumiu",
                name: "Miu Miu",
                file: "Main VRM/miu miu.vrm",
                personality: "ä¿çš®å¯çˆ±çš„çŒ«è€³å°‘å¥³ï¼Œå–œæ¬¢æ’’å¨‡ã€‚",
                traits: ["ä¿çš®", "å¯çˆ±", "çŒ«è€³", "æ’’å¨‡"],
                emoji: "ğŸ˜¸",
                level: 21,
                type: "å…½å¨˜ç³»"
            },
            {
                id: "sikirei",
                name: "Sikirei",
                file: "Main VRM/sikirei.vrm",
                personality: "å¦‚å››å­£èˆ¬å¤šå˜çš„å°‘å¥³ï¼Œå……æ»¡ç¥ç§˜æ„Ÿã€‚",
                traits: ["å¤šå˜", "ç¥ç§˜", "å››å­£", "çµåŠ¨"],
                emoji: "ğŸŒ·",
                level: 27,
                type: "è‡ªç„¶ç³»"
            },
            {
                id: "wolf",
                name: "Wolf",
                file: "Main VRM/wolf.vrm",
                personality: "å­¤é«˜çš„ç‹¬ç‹¼ï¼Œæœ‰ç€è‡ªå·±çš„åšæŒã€‚",
                traits: ["å­¤é«˜", "ç‹¬ç«‹", "åšæŒ", "å†·é™"],
                emoji: "ğŸŒ™",
                level: 31,
                type: "å­¤ç‹¼ç³»"
            }
        ];

        // è§’è‰²å¤´åƒæ˜ å°„
        function getProfilePicture(characterName) {
            const profileMap = {
                'Alice': 'alice-pf.png',
                'Ash': 'ash-pf.png',
                'Elinyaa': 'elinyaa-pf.png',
                'Fliza': 'fliza-pf.png',
                'Imeris': 'imeris-pf.png',
                'Maple': 'maple-pf.png',
                'Nekona': 'nekona.png',
                'Notia': 'notia-pf.png',
                'QuQu': 'ququ-pf.png',
                'Rindo': 'rindo-pf.png',
                'Rainy': 'rainy-pf.png',
                'Vivi': 'vivi-pf.png',
                'Wolferia': 'wolferia-pf.png',
                'Yawl': 'yawl-pf.png',
                'Yuu Yii': 'yuu yii-pf.png',
                'Zwei': 'zwei-pf.png',
                'Bobo': 'bobo-pf.png',
                'Kyoko': 'kyoko-pf.png',
                'Lena': 'lena-pf.png',
                'Lilium': 'lilium.png',
                'Miru': 'Miru-pf.png',
                'Miu Miu': 'miumiu-pf.png',
                'Sikirei': 'sikirei-pf.png',
                'Wolf': 'wolf.png'
            };
            return `profile-pic/${profileMap[characterName] || 'default.png'}`;
        }

        // å…¨å±€å˜é‡
        let scene, camera, renderer, controls;
        let currentVRM = null;
        let mixer = null;
        let animationAction = null;
        let currentCharacterIndex = 0;
        let isLoading = false;
        
        // è¯­éŸ³æ’­æ”¾åŠŸèƒ½å˜é‡ - æå‰å£°æ˜
        let currentAudio = null;
        let currentLanguage = 'jp'; // é»˜è®¤æ—¥è¯­
        
        // åç«¯APIé…ç½®
        const API_URL = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';

        // åˆå§‹åŒ–
        init();
        generateThumbnails();
        // Initialize selected character image and profile
        document.addEventListener('DOMContentLoaded', function() {
            const selectedAvatar = document.getElementById('selected-avatar-img');
            if (selectedAvatar && characters[0]) {
                selectedAvatar.src = getProfilePicture(characters[0].name);
            }
            // Initialize character profile
            updateCharacterProfile(characters[0]);
        });
        loadCharacter(0);

        function init() {
            // åˆ›å»ºåœºæ™¯
            scene = new THREE.Scene();

            // è·å–canvaså®¹å™¨çš„å®é™…å°ºå¯¸
            const canvas = document.getElementById('vrm-canvas');
            const container = canvas.parentElement;
            const containerRect = container.getBoundingClientRect();
            
            // åˆ›å»ºç›¸æœº - ä½¿ç”¨å®¹å™¨å°ºå¯¸è€Œä¸æ˜¯çª—å£å°ºå¯¸
            camera = new THREE.PerspectiveCamera(30.0, containerRect.width / containerRect.height, 0.1, 20.0);
            camera.position.set(0.0, 0.5, 5.2);

            // åˆ›å»ºæ¸²æŸ“å™¨ - ä½¿ç”¨å®¹å™¨å°ºå¯¸
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
            renderer.setSize(containerRect.width, containerRect.height);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setClearColor(0x000000, 0); // é€æ˜èƒŒæ™¯
            
            // ä¸éœ€è¦å¤æ‚é˜´å½±ç³»ç»Ÿï¼Œä½¿ç”¨ç®€å•è„šåº•é˜´å½±
            // renderer.shadowMap.enabled = true;
            // renderer.shadowMap.type = THREE.PCFSoftShadowMap;

            // åˆ›å»ºæ§åˆ¶å™¨ - ä½¿ç”¨ä¸index.htmlç›¸åŒçš„è®¾ç½®
            controls = new OrbitControls(camera, renderer.domElement);
            controls.screenSpacePanning = true;
            controls.target.set(0.0, 0.5, 0.0);
            controls.update();

            // æ·»åŠ ç¯å¢ƒå…‰
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            // ä¸»å…‰æº - ç®€åŒ–è®¾ç½®
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
            directionalLight.position.set(1, 6, 2);
            
            scene.add(directionalLight);

            // è¡¥å…‰
            const fillLight = new THREE.DirectionalLight(0xffffff, 0.3);
            fillLight.position.set(-5, 5, -5);
            scene.add(fillLight);

            // åˆ›å»ºæ¸å˜åœ†å½¢é˜´å½± - æ¨¡ä»¿å‚è€ƒæˆªå›¾
            const shadowCanvas = document.createElement('canvas');
            shadowCanvas.width = 128;
            shadowCanvas.height = 128;
            const context = shadowCanvas.getContext('2d');
            
            // åˆ›å»ºå¾„å‘æ¸å˜é˜´å½±
            const gradient = context.createRadialGradient(64, 64, 0, 64, 64, 64);
            gradient.addColorStop(0, 'rgba(0, 0, 0, 0.4)'); // ä¸­å¿ƒè¾ƒæ·±
            gradient.addColorStop(0.5, 'rgba(0, 0, 0, 0.2)'); // ä¸­ç­‰é€æ˜åº¦
            gradient.addColorStop(1, 'rgba(0, 0, 0, 0)'); // è¾¹ç¼˜å®Œå…¨é€æ˜
            
            context.fillStyle = gradient;
            context.fillRect(0, 0, 128, 128);
            
            const shadowTexture = new THREE.CanvasTexture(shadowCanvas);
            const shadowGeometry = new THREE.PlaneGeometry(2.2, 2.2);
            const shadowMaterial = new THREE.MeshBasicMaterial({ 
                map: shadowTexture,
                transparent: true,
                alphaTest: 0.001,
                depthWrite: false
            });
            
            const shadow = new THREE.Mesh(shadowGeometry, shadowMaterial);
            shadow.rotation.x = -Math.PI / 2;
            shadow.position.set(0, -0.82, 0); // ç›´æ¥è´´ç€è„šåº•
            scene.add(shadow);
            
            // ä¿å­˜é˜´å½±å¼•ç”¨ï¼Œä»¥ä¾¿åç»­æ›´æ–°ä½ç½®
            window.characterShadow = shadow;

            // å¼€å§‹æ¸²æŸ“å¾ªç¯
            animate();

            // çª—å£å¤§å°è°ƒæ•´
            window.addEventListener('resize', onWindowResize);
        }


        function animate() {
            requestAnimationFrame(animate);

            const deltaTime = 0.016;
            
            // æ›´æ–°VRM
            if (currentVRM) {
                currentVRM.update(deltaTime);
            }
            
            // æ›´æ–°åŠ¨ç”»æ··åˆå™¨
            if (mixer) {
                mixer.update(deltaTime);
            }

            // æ›´æ–°æ§åˆ¶å™¨
            controls.update();

            // æ¸²æŸ“
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            const canvas = document.getElementById('vrm-canvas');
            const container = canvas.parentElement;
            const containerRect = container.getBoundingClientRect();
            
            camera.aspect = containerRect.width / containerRect.height;
            camera.updateProjectionMatrix();
            renderer.setSize(containerRect.width, containerRect.height);
        }

        function loadCharacter(index) {
            if (isLoading) {
                console.log('æ­£åœ¨åŠ è½½ä¸­ï¼Œè·³è¿‡');
                return;
            }

            isLoading = true;
            // Update character index and thumbnails immediately
            currentCharacterIndex = index;
            updateThumbnails();
            
            const loadingStartTime = Date.now();

            const character = characters[index];
            console.log('ğŸ”„ å¼€å§‹åŠ è½½è§’è‰²:', character.name);
            
            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            showCharacterLoader();

            // æ›´æ–°UI
            const nameElement = document.getElementById('character-name');
            if (nameElement) nameElement.textContent = character.name;
            
            const levelElement = document.getElementById('character-level');
            if (levelElement) levelElement.textContent = character.level;
            
            const displayNameElement = document.getElementById('character-display-name');
            if (displayNameElement) displayNameElement.textContent = character.name;

            // ä¸éœ€è¦å ä½ç¬¦

            // åŠ è½½VRM
            const loader = new GLTFLoader();
            loader.register((parser) => new VRMLoaderPlugin(parser));

            loader.load(
                character.file,
                (gltf) => {
                    console.log('âœ… GLTFåŠ è½½æˆåŠŸ');
                    const vrm = gltf.userData.vrm;
                    
                    if (vrm) {
                        console.log('âœ… VRMæ•°æ®å­˜åœ¨');
                        
                        // ä½¿ç”¨VRM v2å…¼å®¹çš„ä¼˜åŒ–æ–¹æ³•
                        VRMUtils.removeUnnecessaryVertices(gltf.scene);
                        // VRMUtils.combineSkeletons åœ¨ v2 ä¸­å·²ç§»é™¤
                        // VRMUtils.combineMorphs åœ¨ v2 ä¸­å·²ç§»é™¤
                        
                        // æ¸…ç†æ—§VRMï¼ˆä½†ä¿ç•™ç¯å…‰å’Œå ä½ç¬¦ï¼‰
                        if (currentVRM) {
                            scene.remove(currentVRM.scene);
                            VRMUtils.deepDispose(currentVRM.scene);
                            console.log('ğŸ—‘ï¸ æ¸…é™¤æ—§VRM');
                        }

                        // è®¾ç½®æ–°VRM - ä½¿ç”¨ä¸index.htmlç›¸åŒçš„è®¾ç½®
                        currentVRM = vrm;
                        
                        // å°†VRMæ¨¡å‹æ”¾å¤§45% (ä¸index.htmlä¸€è‡´)
                        vrm.scene.scale.set(1.45, 1.45, 1.45);
                        
                        // å°†VRMæ¨¡å‹ä½ç½®å‘ä¸‹ç§»åŠ¨ï¼Œæ›´è´´è¿‘åº•éƒ¨è¾¹ç•Œ
                        vrm.scene.position.y = -0.8;
                        
                        // å…ˆéšè—VRMï¼Œé˜²æ­¢T-poseé—ªç°
                        vrm.scene.visible = false;
                        
                        mixer = new THREE.AnimationMixer(currentVRM.scene);
                        
                        vrm.scene.traverse((obj) => {
                            obj.frustumCulled = false;
                        });
                        
                        // VRMUtils.rotateVRM0 åœ¨ v2 ä¸­å¯èƒ½ä¸éœ€è¦æˆ–å·²æ›´æ”¹
                        // å¦‚æœæ˜¯ VRM 0.x æ ¼å¼ï¼Œå¯èƒ½éœ€è¦æ—‹è½¬ï¼›VRM 1.x æ ¼å¼é€šå¸¸ä¸éœ€è¦
                        try {
                            VRMUtils.rotateVRM0(vrm);
                        } catch (error) {
                            console.log('âš ï¸ VRMUtils.rotateVRM0 ä¸å¯ç”¨ï¼Œè·³è¿‡ (VRM v2å…¼å®¹)');
                        }
                        
                        // æ·»åŠ åˆ°åœºæ™¯
                        scene.add(vrm.scene);
                        
                        // ç«‹å³åŠ è½½é»˜è®¤åŠ¨ç”»ï¼Œç„¶åæ˜¾ç¤ºVRM
                        loadDefaultAnimation().then(() => {
                            // ç­‰å¾…å‡ å¸§ç¡®ä¿åŠ¨ç”»å¼€å§‹æ’­æ”¾ï¼Œç„¶åæ˜¾ç¤ºVRM
                            setTimeout(() => {
                                if (currentVRM && currentVRM.scene) {
                                    currentVRM.scene.visible = true;
                                    // éšè—åŠ è½½å™¨
                                    hideCharacterLoader();
                                }
                            }, 150); // å¢åŠ åˆ°150msç¡®ä¿åŠ¨ç”»å·²ç»åº”ç”¨
                        });
                        
                        console.log('âœ… VRMè®¾ç½®å®Œæˆ:', character.name);
                        console.log('åœºæ™¯ä¸­çš„å¯¹è±¡æ•°é‡:', scene.children.length);
                    } else {
                        console.log('âŒ VRMæ•°æ®ä¸å­˜åœ¨');
                        // VRMæ•°æ®ä¸å­˜åœ¨æ—¶ä¹Ÿè¦éšè—åŠ è½½å™¨
                        hideCharacterLoader();
                    }

                    finishLoading(index, loadingStartTime);
                },
                (progress) => {
                    const percent = Math.round(progress.loaded / progress.total * 100);
                    console.log('åŠ è½½è¿›åº¦:', percent + '%');
                },
                (error) => {
                    console.error('âŒ VRMåŠ è½½å¤±è´¥:', error);
                    // åŠ è½½å¤±è´¥æ—¶éšè—åŠ è½½å™¨
                    hideCharacterLoader();
                    finishLoading(index, loadingStartTime);
                }
            );
        }

        function finishLoading(index, loadingStartTime) {
            const elapsedTime = Date.now() - (loadingStartTime || 0);
            const remainingTime = Math.max(0, 3000 - elapsedTime); // æœ€å°‘3ç§’
            
            setTimeout(() => {
                isLoading = false;
                
                // è°ƒè¯•ä¿¡æ¯
                console.log('åŠ è½½å®Œæˆ');
            }, remainingTime);
        }


        function generateThumbnails() {
            const containerLeft = document.getElementById('character-thumbnails');
            const containerRight = document.getElementById('character-thumbnails-right');
            containerLeft.innerHTML = '';
            containerRight.innerHTML = '';

            const currentIndex = currentCharacterIndex;
            const showCount = 4; // å·¦å³å„æ˜¾ç¤º4ä¸ªè§’è‰²
            
            // å·¦è¾¹çš„è§’è‰² (å½“å‰è§’è‰²ä¹‹å‰çš„3ä¸ª)
            for (let i = showCount; i > 0; i--) {
                const index = (currentIndex - i + characters.length) % characters.length;
                const character = characters[index];
                
                const thumb = document.createElement('div');
                thumb.className = 'character-thumb';
                thumb.onclick = () => selectCharacter(index);
                
                const content = document.createElement('img');
                content.src = getProfilePicture(character.name);
                content.style.width = '100%';
                content.style.height = '100%';
                content.style.objectFit = 'cover';
                content.style.borderRadius = '50%';
                content.alt = character.name;
                
                thumb.appendChild(content);
                containerLeft.appendChild(thumb);
            }
            
            // å³è¾¹çš„è§’è‰² (å½“å‰è§’è‰²ä¹‹åçš„3ä¸ª)
            for (let i = 1; i <= showCount; i++) {
                const index = (currentIndex + i) % characters.length;
                const character = characters[index];
                
                const thumb = document.createElement('div');
                thumb.className = 'character-thumb';
                thumb.onclick = () => selectCharacter(index);
                
                const content = document.createElement('img');
                content.src = getProfilePicture(character.name);
                content.style.width = '100%';
                content.style.height = '100%';
                content.style.objectFit = 'cover';
                content.style.borderRadius = '50%';
                content.alt = character.name;
                
                thumb.appendChild(content);
                containerRight.appendChild(thumb);
            }

        }

        // æ›´æ–°è§’è‰²æ¡£æ¡ˆä¿¡æ¯
        function updateCharacterProfile(character) {
            // è·å–è§’è‰²è¯¦ç»†ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€¼
            const profile = getCharacterProfile(character.name);
            
            document.getElementById('character-name').textContent = character.name;
            document.getElementById('character-age').textContent = profile.age + "æ­³";
            document.getElementById('character-birthday').textContent = profile.birthday;
            document.getElementById('character-zodiac').textContent = profile.zodiac;
            document.getElementById('character-personality').textContent = profile.personality;
            document.getElementById('character-interests').textContent = profile.dailyInterests;
            document.getElementById('character-likes').textContent = profile.likes;
            document.getElementById('character-dislikes').textContent = profile.dislikes;
            document.getElementById('character-food').textContent = profile.favoriteFood;
            document.getElementById('character-music').textContent = profile.favoriteMusic;
            document.getElementById('character-movies').textContent = profile.favoriteMovies;
            document.getElementById('character-games').textContent = profile.favoriteGames;
            
            // æ›´æ–°è¯­éŸ³é€‰æ‹©å™¨
            updateVoiceSelector();
        }

        // æ ¹æ®è§’è‰²åè·å–è¯¦ç»†æ¡£æ¡ˆ - åŸºäºcharacter.mdæ•°æ®
        function getCharacterProfile(name) {
            const profiles = {
                "Alice": {
                    age: 22,
                    birthday: "6æœˆ5æ—¥",
                    zodiac: "åŒå­åº§",
                    personality: "æ´»æ³¼å¤–å‘ï¼Œè°ƒçš®å¯çˆ±",
                    dailyInterests: "è·³èˆã€å”±æ­Œ",
                    likes: "é²œèŠ±å’Œå½©è‰²ç”œç‚¹",
                    dislikes: "å®‰é™å’Œè¿‡äºä¸¥è‚ƒçš„åœºåˆ",
                    favoriteFood: "è‰è“è›‹ç³•ã€é©¬å¡é¾™",
                    favoriteMusic: "æµè¡Œèˆæ›²ã€K-Pop",
                    favoriteMovies: "æµªæ¼«å–œå‰§",
                    favoriteGames: "èŠ‚å¥èˆè¹ˆæ¸¸æˆ"
                },
                "Ash": {
                    age: 24,
                    birthday: "11æœˆ12æ—¥",
                    zodiac: "å¤©èåº§",
                    personality: "å†·é™ã€å†…æ•›ã€é€»è¾‘æ€ç»´å¼º",
                    dailyInterests: "é˜…è¯»ã€ç¼–ç¨‹",
                    likes: "å¤œæ™šå’Œæµ“å’–å•¡",
                    dislikes: "å™ªéŸ³å’Œçªç„¶çš„å¹²æ‰°",
                    favoriteFood: "é»‘å·§å…‹åŠ›",
                    favoriteMusic: "Lo-fiè½»éŸ³ä¹ã€æ°›å›´éŸ³ä¹",
                    favoriteMovies: "ç§‘å¹»ã€æ‚¬ç–‘æƒŠæ‚šç‰‡",
                    favoriteGames: "è§£è°œå†’é™©æ¸¸æˆ"
                },
                "Bobo": {
                    age: 19,
                    birthday: "12æœˆ2æ—¥",
                    zodiac: "å°„æ‰‹åº§",
                    personality: "æ¸©æŸ”ã€å®³ç¾ã€æ•æ„Ÿ",
                    dailyInterests: "æ‰‹ç»˜æ’ç”»",
                    likes: "æŸ”è½¯çš„æ¯›ç»’ç©å…·",
                    dislikes: "æ‹¥æŒ¤çš„åœ°æ–¹",
                    favoriteFood: "æŠ¹èŒ¶æ‹¿é“ã€ç„¦ç³–å¸ƒä¸",
                    favoriteMusic: "è½»æŸ”å™¨ä¹",
                    favoriteMovies: "åŠ¨ç”»ç”µå½±ã€æ¸©æƒ…ç”µå½±",
                    favoriteGames: "çºªå¿µç¢‘è°·"
                },
                "Elinyaa": {
                    age: 18,
                    birthday: "2æœˆ25æ—¥",
                    zodiac: "åŒé±¼åº§",
                    personality: "ç”œç¾ã€æ´»æ³¼ã€ç«¥çœŸ",
                    dailyInterests: "Cosplayã€è§’è‰²æ‰®æ¼”",
                    likes: "å„ç§ç³–æœ",
                    dislikes: "è‹¦å‘³é£Ÿç‰©",
                    favoriteFood: "æ£‰èŠ±ç³–ã€å½©è™¹ç³–",
                    favoriteMusic: "J-Popã€å„¿æ­Œ",
                    favoriteMovies: "å¥‡å¹»å†’é™©",
                    favoriteGames: "è§’è‰²æ‰®æ¼”æ¸¸æˆ"
                },
                "Fliza": {
                    age: 23,
                    birthday: "8æœˆ14æ—¥",
                    zodiac: "ç‹®å­åº§",
                    personality: "æ¸©æš–ã€å…³æ€€ã€å¯Œæœ‰åŒæƒ…å¿ƒ",
                    dailyInterests: "å†œä¸šã€å›­è‰º",
                    likes: "æ—¥å‡ºå’Œæ™¨éœ²",
                    dislikes: "ç¯å¢ƒæ±¡æŸ“",
                    favoriteFood: "æ–°é²œæ°´æœã€èœ‚èœœæŸ æª¬æ°´",
                    favoriteMusic: "æ°‘è°£ã€è‡ªç„¶éŸ³æ™¯",
                    favoriteMovies: "è‡ªç„¶çºªå½•ç‰‡ã€æ¸©é¦¨æ•…äº‹",
                    favoriteGames: "åŠ¨ç‰©æ£®å‹ä¼š"
                },
                "Imeris": {
                    age: 25,
                    birthday: "4æœˆ2æ—¥",
                    zodiac: "ç‰¡ç¾Šåº§",
                    personality: "ç»†å¿ƒã€æ¸©æŸ”ã€ä¹äºåŠ©äºº",
                    dailyInterests: "æŠ¤ç†ç ”ç©¶ã€å¥åº·æ•™è‚²",
                    likes: "æ¨±èŠ±å’ŒæŸ”å’Œçš„ç²‰è‰²è°ƒ",
                    dislikes: "å†²çª",
                    favoriteFood: "æ¨±èŠ±ç³•ç‚¹",
                    favoriteMusic: "æ–°ä¸–çºªéŸ³ä¹ã€é’¢ç´ç‹¬å¥",
                    favoriteMovies: "åŒ»ç–—å‰§ã€æ²»æ„ˆçºªå½•ç‰‡",
                    favoriteGames: "åŒ»é™¢ç®¡ç†æ¨¡æ‹Ÿ"
                },
                "Kyoko": {
                    age: 20,
                    birthday: "10æœˆ30æ—¥",
                    zodiac: "å¤©èåº§",
                    personality: "ç‹¬ç«‹ã€åšéŸ§ã€è‡ªä¿¡",
                    dailyInterests: "å¾’æ­¥ã€æ”€å²©",
                    likes: "æ¸…æ–°çš„å±±é—´ç©ºæ°”",
                    dislikes: "äººç¾¤å’Œå™ªéŸ³",
                    favoriteFood: "çƒ¤é±¼ã€èƒ½é‡æ£’",
                    favoriteMusic: "ç”µå­ã€æ‘‡æ»š",
                    favoriteMovies: "åŠ¨ä½œå†’é™©",
                    favoriteGames: "å¡”é˜²ç­–ç•¥æ¸¸æˆ"
                },
                "Lena": {
                    age: 21,
                    birthday: "5æœˆ9æ—¥",
                    zodiac: "é‡‘ç‰›åº§",
                    personality: "ä¼˜é›…ã€è‡ªä¿¡ã€æœ‰é­…åŠ›",
                    dailyInterests: "æ—¶è£…è®¾è®¡ã€èŠ±è‰º",
                    likes: "çº¢é…’å’Œç²¾è‡´çš„ä¸‹åˆèŒ¶",
                    dislikes: "è¿Ÿåˆ°å’Œç²—é²",
                    favoriteFood: "é»‘æ¾éœ²æ„é¢ã€çº¢é…’",
                    favoriteMusic: "çˆµå£«ä¹",
                    favoriteMovies: "è‰ºæœ¯å‰§æƒ…ç‰‡",
                    favoriteGames: "æ¨¡æ‹Ÿäººç”Ÿ"
                },
                "Lilium": {
                    age: 24,
                    birthday: "1æœˆ15æ—¥",
                    zodiac: "æ‘©ç¾¯åº§",
                    personality: "çƒ­æƒ…ã€å……æ»¡æ´»åŠ›ã€å¤§èƒ†",
                    dailyInterests: "è¡—èˆã€å¥èº«",
                    likes: "ç«é”…å’Œè¾›è¾£é£Ÿç‰©",
                    dislikes: "å†·èœ",
                    favoriteFood: "éº»è¾£ç«é”…ã€è¾£å‘³é›¶é£Ÿ",
                    favoriteMusic: "EDMã€Hip-hop",
                    favoriteMovies: "æµªæ¼«å‰§æƒ…ç‰‡",
                    favoriteGames: "éŸ³ä¹èŠ‚å¥æ¸¸æˆ"
                },
                "Maple": {
                    age: 22,
                    birthday: "9æœˆ25æ—¥",
                    zodiac: "å¤©ç§¤åº§",
                    personality: "æ¸©æš–ã€ç»†å¿ƒã€è€å¿ƒ",
                    dailyInterests: "çƒ˜ç„™ã€æ’èŠ±",
                    likes: "æ«å¶å›¾æ¡ˆ",
                    dislikes: "æ€¥èº",
                    favoriteFood: "æ«ç³–åå¤«é¥¼ã€å—ç“œæ´¾",
                    favoriteMusic: "åŸå£°æ°‘è°£ã€è½»çˆµå£«",
                    favoriteMovies: "åŠ±å¿—åŠ¨ç”»ç”µå½±",
                    favoriteGames: "æ˜Ÿéœ²è°·ç‰©è¯­"
                },
                "Miru": {
                    age: 19,
                    birthday: "12æœˆ29æ—¥",
                    zodiac: "æ‘©ç¾¯åº§",
                    personality: "æ¢¦å¹»ã€å¯çˆ±ã€æœ‰ç‚¹å®³ç¾",
                    dailyInterests: "æ”¶é›†æ¯›ç»’ç©å…·",
                    likes: "äº‘æœµå’ŒæŸ”è½¯çš„è´¨æ„Ÿ",
                    dislikes: "é»‘æš—",
                    favoriteFood: "æ£‰èŠ±ç³–",
                    favoriteMusic: "Lo-fièƒŒæ™¯éŸ³ä¹ã€æ°›å›´éŸ³æ™¯",
                    favoriteMovies: "å¥‡å¹»åŠ¨ç”»",
                    favoriteGames: "ç”Ÿæ´»æ¨¡æ‹Ÿæ¸¸æˆ"
                },
                "Miu Miu": {
                    age: 20,
                    birthday: "3æœˆ8æ—¥",
                    zodiac: "åŒé±¼åº§",
                    personality: "å¤æ€ªã€æœ‰åˆ›æ„ã€çˆ±ç©",
                    dailyInterests: "æ½®æµDIYæ‰‹å·¥",
                    likes: "ç³–æœå’Œé²œè‰³é¢œè‰²",
                    dislikes: "ä¸¥è‚ƒ",
                    favoriteFood: "å½©è™¹ç³–ã€å·§å…‹åŠ›",
                    favoriteMusic: "K-Popã€æµè¡ŒéŸ³ä¹",
                    favoriteMovies: "è½»å–œå‰§ã€åŠ¨ç”»çŸ­ç‰‡",
                    favoriteGames: "ä¸‰æ¶ˆç›Šæ™ºæ¸¸æˆ"
                },
                "Nekona": {
                    age: 18,
                    birthday: "6æœˆ27æ—¥",
                    zodiac: "å·¨èŸ¹åº§",
                    personality: "æ¸©æŸ”ã€ç‹¡é» ã€æœ‰ç‚¹ç¥ç§˜",
                    dailyInterests: "å¤œæ™šæ•£æ­¥ã€æ”¶é›†å¶å­",
                    likes: "å¤œæ™š",
                    dislikes: "ç›´å°„é˜³å…‰",
                    favoriteFood: "èŠ’æœå†°æ²™ã€è“æœæ‹¼ç›˜",
                    favoriteMusic: "è½»æ¾èŠ‚æ‹ã€æ°›å›´éŸ³ä¹",
                    favoriteMovies: "å¿ƒç†æƒŠæ‚šç‰‡",
                    favoriteGames: "è§£è°œå†’é™©"
                },
                "Notia": {
                    age: 23,
                    birthday: "9æœˆ1æ—¥",
                    zodiac: "å¤„å¥³åº§",
                    personality: "æ²‰ç€ã€ä¼˜é›…ã€å¤å…¸",
                    dailyInterests: "èŒ¶é“ã€æ’èŠ±",
                    likes: "èŒ¶é¦™",
                    dislikes: "æµ“å’–å•¡",
                    favoriteFood: "æ—¥å¼ç‚¹å¿ƒã€æŠ¹èŒ¶å†°æ·‡æ·‹",
                    favoriteMusic: "ä¼ ç»Ÿæ°‘ä¹",
                    favoriteMovies: "å†å²å‰§",
                    favoriteGames: "å¡ç‰Œç­–ç•¥"
                },
                "QuQu": {
                    age: 22,
                    birthday: "4æœˆ20æ—¥",
                    zodiac: "é‡‘ç‰›åº§",
                    personality: "å¤§èƒ†ã€ç›´ç‡ã€çƒ­æƒ…",
                    dailyInterests: "æé™è¿åŠ¨",
                    likes: "æˆ·å¤–å†’é™©",
                    dislikes: "é™åˆ¶",
                    favoriteFood: "çƒ¤ä¸²ã€çƒ¤ç‰ç±³",
                    favoriteMusic: "æ‘‡æ»šã€é‡‘å±",
                    favoriteMovies: "åŠ¨ä½œå¤§ç‰‡",
                    favoriteGames: "ç«æŠ€å¤šäººæ¸¸æˆ"
                },
                "Rainy": {
                    age: 21,
                    birthday: "11æœˆ5æ—¥",
                    zodiac: "å¤©èåº§",
                    personality: "å®‰é™ã€æ¸©æŸ”ã€å†…çœ",
                    dailyInterests: "é›¨ä¸­æ¼«æ­¥",
                    likes: "é›¨å£°",
                    dislikes: "ç‚çƒ­æ™´å¤©",
                    favoriteFood: "æ‹‰é¢ã€çƒ­å·§å…‹åŠ›",
                    favoriteMusic: "æ…¢èŠ‚å¥çˆµå£«",
                    favoriteMovies: "è‰ºæœ¯å’Œç‹¬ç«‹ç”µå½±",
                    favoriteGames: "äº’åŠ¨å°è¯´"
                },
                "Rindo": {
                    age: 25,
                    birthday: "2æœˆ1æ—¥",
                    zodiac: "æ°´ç“¶åº§",
                    personality: "å†·é™ã€åšéŸ§ã€åšå®š",
                    dailyInterests: "å‰‘é“ç»ƒä¹ ",
                    likes: "å¯’å†·æ°”å€™",
                    dislikes: "è¿‡ç”œçš„é£Ÿç‰©",
                    favoriteFood: "çƒ¤ç¾Šè‚‰ä¸²",
                    favoriteMusic: "é‡‘å±æ‘‡æ»šã€ç”µå­éŸ³ä¹",
                    favoriteMovies: "æ­¦ä¾ åŠ¨ä½œç‰‡",
                    favoriteGames: "ç¡¬æ ¸åŠ¨ä½œæ¸¸æˆ"
                },
                "Sikirei": {
                    age: 24,
                    birthday: "10æœˆ10æ—¥",
                    zodiac: "å¤©ç§¤åº§",
                    personality: "è¯±äººã€ç¥ç§˜ã€ä¼˜é›…",
                    dailyInterests: "å æ˜Ÿç ”ç©¶",
                    likes: "æ˜Ÿæ˜Ÿå’Œå¤œç©º",
                    dislikes: "å…‰æ±¡æŸ“",
                    favoriteFood: "è“è“å¸ƒä¸ã€èŠ±è‰èŒ¶",
                    favoriteMusic: "æ°›å›´éŸ³æ™¯",
                    favoriteMovies: "ç§‘å¹»æ‚¬ç–‘",
                    favoriteGames: "æ¨¡æ‹Ÿäººç”Ÿ"
                },
                "Vivi": {
                    age: 19,
                    birthday: "8æœˆ25æ—¥",
                    zodiac: "å¤„å¥³åº§",
                    personality: "å¤–å‘ã€å¼€æœ—ã€å–„äºäº¤é™…",
                    dailyInterests: "ç›´æ’­ã€æ”¶é›†æ¼«ç”»",
                    likes: "çƒ­é—¹èšä¼š",
                    dislikes: "å®³ç¾å’Œæ²‰é»˜",
                    favoriteFood: "æŠ«è¨ã€é›¶é£Ÿæ‹¼ç›˜",
                    favoriteMusic: "æµè¡ŒéŸ³ä¹ã€DJæ··éŸ³",
                    favoriteMovies: "å–œå‰§ç‰‡",
                    favoriteGames: "MMOã€ä¼‘é—²æ¸¸æˆ"
                },
                "Wolf": {
                    personality: "é‡æ€§ã€å­¤å‚²ã€æœ¬èƒ½é©±åŠ¨",
                    dailyInterests: "å¤œæ™šæ¢ç´¢ã€é‡å¤–ç”Ÿå­˜",
                    likes: "æ£®æ—å’Œæœˆå…‰",
                    dislikes: "åŸå¸‚å™ªéŸ³",
                    favoriteFood: "çƒ¤é¹¿è‚‰",
                    favoriteMusic: "æ°‘è°£å’ŒåŸå£°å‰ä»–",
                    favoriteMovies: "ææ€–æƒŠæ‚šç‰‡",
                    favoriteGames: "ç”Ÿå­˜åˆ¶ä½œæ¸¸æˆ"
                },
                "Wolferia": {
                    personality: "è‡ªç”±å¥”æ”¾ã€ä¸æ‹˜æŸã€çˆ±å†’é™©",
                    dailyInterests: "æ»‘é›ªã€æé™è¿åŠ¨",
                    likes: "é›ªä¸Šè¿åŠ¨",
                    dislikes: "ç‚½çƒ­é«˜æ¸©",
                    favoriteFood: "å†°æ·‡æ·‹ã€ç”œç­’",
                    favoriteMusic: "è¿·å¹»ç”µéŸ³",
                    favoriteMovies: "å†’é™©å¥‡å¹»",
                    favoriteGames: "å†¬å­£è¿åŠ¨æ¸¸æˆ"
                },
                "Yawl": {
                    personality: "ä¼˜é›…ã€çŸ¥æ€§ã€å†·æ·¡",
                    dailyInterests: "å¤å…¸æ–‡å­¦é‰´èµ",
                    likes: "ç²¾è‡´å’–å•¡å…",
                    dislikes: "æµ“èŒ¶å’Œå™ªéŸ³",
                    favoriteFood: "æ³•å¼ç³•ç‚¹ã€çº¢èŒ¶",
                    favoriteMusic: "å¤å…¸éŸ³ä¹",
                    favoriteMovies: "è‰ºæœ¯å‰§æƒ…ç‰‡",
                    favoriteGames: "è§£è°œæ¨ç†"
                },
                "Yuu Yii": {
                    personality: "ç”œç¾ã€kawaiié£æ ¼ã€ä¹äºåŠ©äºº",
                    dailyInterests: "æ‰‹å·¥åˆ¶ä½œå‘é¥°",
                    likes: "æ³¡æ³¡å’Œç²‰è‰²è°ƒ",
                    dislikes: "ç°å®å‹åŠ›",
                    favoriteFood: "è‰è“æ…•æ–¯ã€æ£‰èŠ±ç³–",
                    favoriteMusic: "J-Popã€å„¿æ­Œ",
                    favoriteMovies: "åŠ¨æ¼«ç”µå½±",
                    favoriteGames: "ç”Ÿæ´»æ¨¡æ‹Ÿæ¸¸æˆ"
                },
                "Zwei": {
                    personality: "ç¨³é‡ã€ä¿æŠ¤æ¬²å¼ºã€å¿ è¯š",
                    dailyInterests: "æ­¦æœ¯è®­ç»ƒ",
                    likes: "å¤œæ™šå’Œå®é™",
                    dislikes: "åˆºçœ¼å…‰çº¿",
                    favoriteFood: "åŒ—äº¬çƒ¤é¸­ã€ç‰›æ’",
                    favoriteMusic: "æ‰“å‡»ä¹èŠ‚å¥",
                    favoriteMovies: "æˆ˜äº‰å²è¯—ã€å¥‡å¹»å²è¯—",
                    favoriteGames: "ç­–ç•¥æ¨¡æ‹Ÿ"
                }
            };
            
            return profiles[name] || {
                age: 20,
                birthday: "4æœˆ15æ—¥",
                zodiac: "ç‰¡ç¾Šåº§", 
                personality: "æ¸©æŸ”ä½“è´´çš„AIå¥³å‹ï¼Œæ€»æ˜¯å…³å¿ƒç€ä½ ",
                dailyInterests: "èŠå¤©ã€æ¸¸æˆ",
                likes: "å’Œä½ åœ¨ä¸€èµ·çš„æ—¶å…‰",
                dislikes: "å­¤å•",
                favoriteFood: "ç”œç‚¹",
                favoriteMusic: "è½»éŸ³ä¹",
                favoriteMovies: "æµªæ¼«ç‰‡",
                favoriteGames: "ä¼‘é—²æ¸¸æˆ"
            };
        }

        function updateThumbnails() {
            // Simply regenerate the thumbnails without calling updateThumbnails again
            const containerLeft = document.getElementById('character-thumbnails');
            const containerRight = document.getElementById('character-thumbnails-right');
            containerLeft.innerHTML = '';
            containerRight.innerHTML = '';

            const currentIndex = currentCharacterIndex;
            const showCount = 4; // å·¦å³å„æ˜¾ç¤º4ä¸ªè§’è‰²
            
            // Update selected character image
            const selectedAvatar = document.getElementById('selected-avatar-img');
            selectedAvatar.src = getProfilePicture(characters[currentIndex].name);
            
            // Update character profile information
            updateCharacterProfile(characters[currentIndex]);
            
            // å·¦è¾¹çš„è§’è‰² (å½“å‰è§’è‰²ä¹‹å‰çš„3ä¸ª)
            for (let i = showCount; i > 0; i--) {
                const index = (currentIndex - i + characters.length) % characters.length;
                const character = characters[index];
                
                const thumb = document.createElement('div');
                thumb.className = 'character-thumb';
                thumb.onclick = () => selectCharacter(index);
                
                const content = document.createElement('img');
                content.src = getProfilePicture(character.name);
                content.style.width = '100%';
                content.style.height = '100%';
                content.style.objectFit = 'cover';
                content.style.borderRadius = '50%';
                content.alt = character.name;
                
                thumb.appendChild(content);
                containerLeft.appendChild(thumb);
            }
            
            // å³è¾¹çš„è§’è‰² (å½“å‰è§’è‰²ä¹‹åçš„3ä¸ª)
            for (let i = 1; i <= showCount; i++) {
                const index = (currentIndex + i) % characters.length;
                const character = characters[index];
                
                const thumb = document.createElement('div');
                thumb.className = 'character-thumb';
                thumb.onclick = () => selectCharacter(index);
                
                const content = document.createElement('img');
                content.src = getProfilePicture(character.name);
                content.style.width = '100%';
                content.style.height = '100%';
                content.style.objectFit = 'cover';
                content.style.borderRadius = '50%';
                content.alt = character.name;
                
                thumb.appendChild(content);
                containerRight.appendChild(thumb);
            }
        }


        function selectCharacter(index) {
            if (index !== currentCharacterIndex && !isLoading) {
                loadCharacter(index);
            }
        }


        async function playVoiceSample(language) {
            // åœæ­¢å½“å‰æ’­æ”¾çš„éŸ³é¢‘
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }

            const character = characters[currentCharacterIndex];
            const sampleText = character.sampleLines?.[language];
            const voiceId = character.voiceId;
            
            if (!sampleText || !voiceId) {
                console.warn(`Missing sample text or voice ID for ${character.name} in ${language}`);
                return;
            }

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateLanguageButtons(language);
            currentLanguage = language;

            // æ˜¾ç¤ºæ’­æ”¾æç¤º
            console.log(`ğŸµ Playing ${character.name}'s ${language} sample: "${sampleText}"`);

            try {
                // ä½¿ç”¨ ElevenLabs API ç”Ÿæˆè¯­éŸ³
                const audioUrl = await generateElevenLabsVoice(sampleText, voiceId);
                
                if (audioUrl) {
                    // æ’­æ”¾ç”Ÿæˆçš„éŸ³é¢‘
                    const audio = new Audio(audioUrl);
                    currentAudio = audio;
                    
                    audio.onended = () => {
                        currentAudio = null;
                        // æ¸…ç†ä¸´æ—¶URL
                        URL.revokeObjectURL(audioUrl);
                    };
                    
                    audio.onerror = () => {
                        console.error('éŸ³é¢‘æ’­æ”¾å¤±è´¥');
                        currentAudio = null;
                        URL.revokeObjectURL(audioUrl);
                    };
                    
                    await audio.play();
                } else {
                    console.error('è¯­éŸ³ç”Ÿæˆå¤±è´¥');
                }
            } catch (error) {
                console.error('âŒ ElevenLabs API è°ƒç”¨å¤±è´¥:', error);
                console.error('ğŸš« è¯­éŸ³æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥APIå¯†é’¥å’Œç½‘ç»œè¿æ¥');
            }
        }

        // é€šè¿‡åç«¯APIè°ƒç”¨TTS
        async function generateElevenLabsVoice(text, voiceId) {
            const url = `${API_URL}/api/tts/generate`;
            
            console.log(`ğŸ”„ æ­£åœ¨è°ƒç”¨ TTS API...`);
            console.log(`ğŸ“ æ–‡æœ¬: "${text}"`);
            console.log(`ğŸ¤ Voice ID: ${voiceId}`);
            
            const requestOptions = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    text: text,
                    voiceId: voiceId,
                    language: currentLanguage
                })
            };

            const response = await fetch(url, requestOptions);
            
            console.log(`ğŸ“¡ API å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);
            
            if (!response.ok) {
                let errorMsg = 'è¯­éŸ³ç”Ÿæˆå¤±è´¥';
                try {
                    const errorData = await response.json();
                    errorMsg = errorData.error || errorMsg;
                } catch (e) {
                    // å¦‚æœä¸æ˜¯JSONå“åº”
                }
                console.error(`âŒ TTS API é”™è¯¯: ${errorMsg}`);
                throw new Error(errorMsg);
            }

            const audioBlob = await response.blob();
            console.log(`âœ… éŸ³é¢‘ç”ŸæˆæˆåŠŸï¼Œå¤§å°: ${(audioBlob.size / 1024).toFixed(2)} KB`);
            return URL.createObjectURL(audioBlob);
        }

        function updateLanguageButtons(activeLanguage) {
            const buttons = document.querySelectorAll('.flag-btn');
            buttons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === activeLanguage) {
                    btn.classList.add('active');
                }
            });
        }

        function updateVoiceSelector() {
            // ç¡®ä¿æŒ‰é’®çŠ¶æ€æ­£ç¡®ï¼Œå¦‚æœcurrentLanguageè¿˜æ²¡åˆå§‹åŒ–åˆ™ä½¿ç”¨é»˜è®¤å€¼
            const language = (typeof currentLanguage !== 'undefined') ? currentLanguage : 'jp';
            updateLanguageButtons(language);
        }

        function previousCharacter() {
            const newIndex = currentCharacterIndex > 0 ? currentCharacterIndex - 1 : characters.length - 1;
            selectCharacter(newIndex);
        }

        function nextCharacter() {
            const newIndex = currentCharacterIndex < characters.length - 1 ? currentCharacterIndex + 1 : 0;
            selectCharacter(newIndex);
        }


        // åŠ è½½å™¨æ§åˆ¶å‡½æ•°
        function showCharacterLoader() {
            const loader = document.getElementById('character-loader');
            loader.style.display = 'flex';
        }

        function hideCharacterLoader() {
            const loader = document.getElementById('character-loader');
            loader.style.display = 'none';
        }

        // å…¨å±€å‡½æ•°
        window.selectCharacter = selectCharacter;
        window.previousCharacter = previousCharacter;
        window.nextCharacter = nextCharacter;
        window.playVoiceSample = playVoiceSample;
        window.startChat = function() {
            // æ£€æŸ¥é’±åŒ…è¿æ¥çŠ¶æ€
            if (!window.modernWalletUI || !window.modernWalletUI.getWalletInfo().isConnected) {
                alert('è¯·å…ˆè¿æ¥é’±åŒ…åå†å¼€å§‹èŠå¤©ï¼');
                // æ˜¾ç¤ºé’±åŒ…è¿æ¥æ¨¡æ€æ¡†
                if (window.modernWalletUI) {
                    window.modernWalletUI.showWalletModal();
                }
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†è§’è‰²
            if (currentCharacterIndex < 0 || !characters[currentCharacterIndex]) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²ï¼');
                return;
            }
            
            // è·å–å½“å‰é’±åŒ…ä¿¡æ¯
            const walletInfo = window.modernWalletUI.getWalletInfo();
            const selectedCharacter = characters[currentCharacterIndex];
            
            // æ·»åŠ é’±åŒ…åœ°å€åˆ°è§’è‰²æ•°æ®ä¸­ï¼Œä»¥ä¾¿éªŒè¯
            const characterWithWallet = {
                ...selectedCharacter,
                walletAddress: walletInfo.wallet.address,
                connectedAt: Date.now()
            };
            
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('selectedCharacter', JSON.stringify(characterWithWallet));
            localStorage.setItem('wallet_address', walletInfo.wallet.address);
            localStorage.setItem('wallet_type', walletInfo.wallet.provider);
            localStorage.setItem('userId', walletInfo.wallet.address); // ä½¿ç”¨é’±åŒ…åœ°å€ä½œä¸ºç”¨æˆ·ID
            
            console.log('ğŸš€ å¼€å§‹èŠå¤©:', selectedCharacter.name, 'é’±åŒ…:', 
                       `${walletInfo.wallet.address.slice(0, 6)}...${walletInfo.wallet.address.slice(-4)}`);
            
            // è·³è½¬åˆ°èŠå¤©ç•Œé¢
            window.location.href = 'index.html';
        };

        // Mixamoåˆ°VRMéª¨éª¼æ˜ å°„ - ä»index.htmlå¤åˆ¶
        const mixamoVRMRigMap = {
            mixamorigHips: 'hips',
            mixamorigSpine: 'spine',
            mixamorigSpine1: 'chest',
            mixamorigSpine2: 'upperChest',
            mixamorigNeck: 'neck',
            mixamorigHead: 'head',
            mixamorigLeftShoulder: 'leftShoulder',
            mixamorigLeftArm: 'leftUpperArm',
            mixamorigLeftForeArm: 'leftLowerArm',
            mixamorigLeftHand: 'leftHand',
            mixamorigLeftHandThumb1: 'leftThumbMetacarpal',
            mixamorigLeftHandThumb2: 'leftThumbProximal',
            mixamorigLeftHandThumb3: 'leftThumbDistal',
            mixamorigLeftHandIndex1: 'leftIndexProximal',
            mixamorigLeftHandIndex2: 'leftIndexIntermediate',
            mixamorigLeftHandIndex3: 'leftIndexDistal',
            mixamorigLeftHandMiddle1: 'leftMiddleProximal',
            mixamorigLeftHandMiddle2: 'leftMiddleIntermediate',
            mixamorigLeftHandMiddle3: 'leftMiddleDistal',
            mixamorigLeftHandRing1: 'leftRingProximal',
            mixamorigLeftHandRing2: 'leftRingIntermediate',
            mixamorigLeftHandRing3: 'leftRingDistal',
            mixamorigLeftHandPinky1: 'leftLittleProximal',
            mixamorigLeftHandPinky2: 'leftLittleIntermediate',
            mixamorigLeftHandPinky3: 'leftLittleDistal',
            mixamorigRightShoulder: 'rightShoulder',
            mixamorigRightArm: 'rightUpperArm',
            mixamorigRightForeArm: 'rightLowerArm',
            mixamorigRightHand: 'rightHand',
            mixamorigRightHandPinky1: 'rightLittleProximal',
            mixamorigRightHandPinky2: 'rightLittleIntermediate',
            mixamorigRightHandPinky3: 'rightLittleDistal',
            mixamorigRightHandRing1: 'rightRingProximal',
            mixamorigRightHandRing2: 'rightRingIntermediate',
            mixamorigRightHandRing3: 'rightRingDistal',
            mixamorigRightHandMiddle1: 'rightMiddleProximal',
            mixamorigRightHandMiddle2: 'rightMiddleIntermediate',
            mixamorigRightHandMiddle3: 'rightMiddleDistal',
            mixamorigRightHandIndex1: 'rightIndexProximal',
            mixamorigRightHandIndex2: 'rightIndexIntermediate',
            mixamorigRightHandIndex3: 'rightIndexDistal',
            mixamorigRightHandThumb1: 'rightThumbMetacarpal',
            mixamorigRightHandThumb2: 'rightThumbProximal',
            mixamorigRightHandThumb3: 'rightThumbDistal',
            mixamorigLeftUpLeg: 'leftUpperLeg',
            mixamorigLeftLeg: 'leftLowerLeg',
            mixamorigLeftFoot: 'leftFoot',
            mixamorigLeftToeBase: 'leftToes',
            mixamorigRightUpLeg: 'rightUpperLeg',
            mixamorigRightLeg: 'rightLowerLeg',
            mixamorigRightFoot: 'rightFoot',
            mixamorigRightToeBase: 'rightToes',
        };

        // ä½¿ç”¨ä¸index.htmlç›¸åŒçš„loadMixamoAnimationå‡½æ•°
        function loadMixamoAnimation(url, vrm) {
            const loader = new FBXLoader();
            return loader.loadAsync(url).then((asset) => {
                const clip = THREE.AnimationClip.findByName(asset.animations, 'mixamo.com');

                if (!clip) {
                    throw new Error('æ‰¾ä¸åˆ° Mixamo åŠ¨ç”»æ•°æ®');
                }

                const tracks = [];
                const restRotationInverse = new THREE.Quaternion();
                const parentRestWorldRotation = new THREE.Quaternion();
                const _quatA = new THREE.Quaternion();

                const motionHipsHeight = asset.getObjectByName('mixamorigHips').position.y;
                const vrmHipsHeight = vrm.humanoid.normalizedRestPose.hips.position[1];
                const hipsPositionScale = vrmHipsHeight / motionHipsHeight;

                clip.tracks.forEach((track) => {
                    const trackSplitted = track.name.split('.');
                    const mixamoRigName = trackSplitted[0];
                    const vrmBoneName = mixamoVRMRigMap[mixamoRigName];
                    const vrmNodeName = vrm.humanoid?.getNormalizedBoneNode(vrmBoneName)?.name;
                    const mixamoRigNode = asset.getObjectByName(mixamoRigName);

                    if (vrmNodeName != null) {
                        const propertyName = trackSplitted[1];

                        mixamoRigNode.getWorldQuaternion(restRotationInverse).invert();
                        mixamoRigNode.parent.getWorldQuaternion(parentRestWorldRotation);

                        if (track instanceof THREE.QuaternionKeyframeTrack) {
                            for (let i = 0; i < track.values.length; i += 4) {
                                const flatQuaternion = track.values.slice(i, i + 4);
                                _quatA.fromArray(flatQuaternion);

                                _quatA
                                    .premultiply(parentRestWorldRotation)
                                    .multiply(restRotationInverse);

                                _quatA.toArray(flatQuaternion);
                                flatQuaternion.forEach((v, index) => {
                                    track.values[index + i] = v;
                                });
                            }

                            tracks.push(
                                new THREE.QuaternionKeyframeTrack(
                                    `${vrmNodeName}.${propertyName}`,
                                    track.times,
                                    track.values.map((v, i) => (vrm.meta?.metaVersion === '0' && i % 2 === 0 ? -v : v)),
                                )
                            );

                        } else if (track instanceof THREE.VectorKeyframeTrack) {
                            const value = track.values.map((v, i) =>
                                (vrm.meta?.metaVersion === '0' && i % 3 !== 1 ? -v : v) * hipsPositionScale
                            );
                            tracks.push(new THREE.VectorKeyframeTrack(`${vrmNodeName}.${propertyName}`, track.times, value));
                        }
                    }
                });

                return new THREE.AnimationClip('vrmAnimation', clip.duration, tracks);
            });
        }

        // åŠ è½½é»˜è®¤åŠ¨ç”»
        async function loadDefaultAnimation() {
            if (!currentVRM || !mixer) return Promise.resolve();

            try {
                console.log('å¼€å§‹åŠ è½½é»˜è®¤åŠ¨ç”»...');
                const clip = await loadMixamoAnimation(encodeURI('mixamo animation/Look Around.fbx'), currentVRM);
                
                if (animationAction) {
                    animationAction.stop();
                }
                
                animationAction = mixer.clipAction(clip);
                animationAction.reset().play();
                animationAction.timeScale = 0.7;
                
                console.log('Bashful åŠ¨ç”»æ’­æ”¾æˆåŠŸ');
                return Promise.resolve();
            } catch (error) {
                console.log('æ’­æ”¾é»˜è®¤åŠ¨ç”»å¤±è´¥:', error);
                return Promise.resolve(); // å³ä½¿å¤±è´¥ä¹Ÿè¦æ˜¾ç¤ºVRM
            }
        }

        // è°ƒè¯•å‡½æ•° - åœ¨æ§åˆ¶å°ä¸­å¯ä»¥è°ƒç”¨
        window.debugScene = function() {
            console.log('åœºæ™¯å¯¹è±¡:', scene.children);
            console.log('å½“å‰VRM:', currentVRM);
            console.log('å½“å‰è§’è‰²ç´¢å¼•:', currentCharacterIndex);
        };
    </script>
    
    <!-- React å’Œ Solana Web3 -->
    <script src="config.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    
    <!-- ç®€åŒ–çš„ Solana é’±åŒ…è¿æ¥ç»„ä»¶ -->
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // ç®€å•çš„é’±åŒ…è¿æ¥ç»„ä»¶
        function WalletConnector() {
            const [isConnected, setIsConnected] = useState(false);
            const [walletAddress, setWalletAddress] = useState(null);
            const [walletType, setWalletType] = useState(null);
            const [balance, setBalance] = useState(0);
            const [showModal, setShowModal] = useState(false);
            const [isConnecting, setIsConnecting] = useState(false);
            
            // æ£€æŸ¥å·²æœ‰è¿æ¥
            useEffect(() => {
                const savedAddress = localStorage.getItem('wallet_address');
                const savedType = localStorage.getItem('wallet_type');
                
                if (savedAddress && savedType) {
                    // å°è¯•é‡æ–°è¿æ¥
                    checkWalletConnection(savedType);
                }
            }, []);
            
            // æ£€æŸ¥é’±åŒ…è¿æ¥çŠ¶æ€
            const checkWalletConnection = async (type) => {
                const provider = getWalletProvider(type);
                if (provider && provider.isConnected) {
                    setIsConnected(true);
                    setWalletAddress(provider.publicKey.toString());
                    setWalletType(type);
                    await updateBalance(provider.publicKey);
                }
            };
            
            // è·å–é’±åŒ…æä¾›è€…
            const getWalletProvider = (type) => {
                switch(type) {
                    case 'phantom':
                        return window.phantom?.solana;
                    case 'solflare':
                        return window.solflare;
                    case 'coinbase':
                        return window.coinbaseSolana;
                    case 'backpack':
                        return window.backpack;
                    case 'okx':
                        return window.okxwallet?.solana;
                    case 'bitget':
                        return window.bitkeep?.solana;
                    case 'tokenpocket':
                        return window.tokenpocket?.solana;
                    default:
                        return null;
                }
            };
            
            // è¿æ¥é’±åŒ…
            const connectWallet = async (walletType) => {
                setIsConnecting(true);
                try {
                    const provider = getWalletProvider(walletType);
                    
                    if (!provider) {
                        alert(`è¯·å…ˆå®‰è£… ${walletType} é’±åŒ…æ‰©å±•`);
                        return;
                    }
                    
                    const response = await provider.connect();
                    const address = response.publicKey.toString();
                    
                    // ä¿å­˜çŠ¶æ€
                    setIsConnected(true);
                    setWalletAddress(address);
                    setWalletType(walletType);
                    setShowModal(false);
                    
                    // ä¿å­˜åˆ° localStorage
                    localStorage.setItem('wallet_address', address);
                    localStorage.setItem('wallet_type', walletType);
                    
                    // è·å–ä½™é¢
                    await updateBalance(response.publicKey);
                    
                    // è§¦å‘å…¨å±€äº‹ä»¶
                    window.dispatchEvent(new CustomEvent('walletConnected', {
                        detail: { address, provider: walletType }
                    }));
                    
                    console.log('âœ… é’±åŒ…è¿æ¥æˆåŠŸ:', address);
                    
                    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦éœ€è¦å¡«å†™èµ„æ–™
                    setTimeout(async () => {
                        console.log('ğŸ” å¼€å§‹æ£€æŸ¥ç”¨æˆ·èµ„æ–™æµç¨‹...');
                        console.log('ğŸ” æ£€æŸ¥profile managerçŠ¶æ€:', !!window.profileManager);
                        
                        if (window.profileManager) {
                            const userId = `wallet_${address}`;
                            const walletAddress = address;
                            console.log('ğŸ‘¤ ç”¨æˆ·ID:', userId);
                            console.log('ğŸ¦ é’±åŒ…åœ°å€:', walletAddress);
                            
                            try {
                                console.log('ğŸš€ æ­£åœ¨ä»APIæ£€æŸ¥ç”¨æˆ·èµ„æ–™...');
                                const existingProfile = await window.profileManager.checkUserProfile(userId);
                                console.log('ğŸ“„ APIè¿”å›çš„ç”¨æˆ·èµ„æ–™:', existingProfile);
                                
                                if (!existingProfile) {
                                    console.log('ğŸ“ æ–°ç”¨æˆ·ï¼šæ²¡æœ‰æ‰¾åˆ°èµ„æ–™ï¼Œæ˜¾ç¤ºæ³¨å†Œé¢æ¿');
                                    console.log('ğŸ“± å³å°†æ˜¾ç¤ºprofile panel...');
                                    
                                    // ç¡®ä¿é¢æ¿å­˜åœ¨
                                    const profilePanel = document.getElementById('user-profile-overlay');
                                    if (profilePanel) {
                                        console.log('âœ… Profile panelå…ƒç´ æ‰¾åˆ°ï¼Œæ˜¾ç¤ºé¢æ¿');
                                        window.profileManager.showProfilePanel();
                                    } else {
                                        console.error('âŒ æ‰¾ä¸åˆ°user-profile-overlayå…ƒç´ ');
                                    }
                                } else {
                                    console.log('ğŸ‘¤ è€ç”¨æˆ·ï¼šæ‰¾åˆ°ç°æœ‰èµ„æ–™ï¼Œæ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯');
                                    console.log('ğŸ“‹ ç”¨æˆ·èµ„æ–™è¯¦æƒ…:', {
                                        nickname: existingProfile.username || existingProfile.nickname,
                                        location: existingProfile.location,
                                        created: existingProfile.created_at
                                    });
                                    
                                    // æ˜¾ç¤ºç”¨æˆ·æ¬¢è¿ä¿¡æ¯
                                    window.profileManager.showUserWelcome(existingProfile);
                                }
                            } catch (error) {
                                console.error('âŒ æ£€æŸ¥ç”¨æˆ·èµ„æ–™å¤±è´¥:', error);
                                console.log('ğŸ”§ å‡ºç°é”™è¯¯ï¼Œé»˜è®¤æ˜¾ç¤ºæ³¨å†Œé¢æ¿');
                                window.profileManager.showProfilePanel();
                            }
                        } else {
                            console.error('âŒ profileManageræœªåˆå§‹åŒ–');
                            console.log('ğŸ’¡ å°è¯•æ‰‹åŠ¨åˆå§‹åŒ–profileManager...');
                            
                            // å°è¯•æ‰‹åŠ¨è§¦å‘åˆå§‹åŒ–
                            if (typeof UserProfileManager !== 'undefined' || window.UserProfileManager) {
                                window.profileManager = new (window.UserProfileManager || UserProfileManager)();
                                console.log('âœ… æ‰‹åŠ¨åˆå§‹åŒ–profileManageræˆåŠŸ');
                                
                                // ç«‹å³é‡æ–°æ‰§è¡Œæ£€æŸ¥ï¼Œæ— éœ€åˆ·æ–°é¡µé¢
                                setTimeout(async () => {
                                    const userId = `wallet_${address}`;
                                    try {
                                        const existingProfile = await window.profileManager.checkUserProfile(userId);
                                        if (!existingProfile) {
                                            console.log('ğŸ“ æ–°ç”¨æˆ·ï¼šæ˜¾ç¤ºæ³¨å†Œé¢æ¿');
                                            window.profileManager.showProfilePanel();
                                        } else {
                                            console.log('âœ… ç”¨æˆ·èµ„æ–™å·²å­˜åœ¨ï¼Œæ­£å¸¸æµç¨‹');
                                            window.profileManager.showUserWelcome(existingProfile);
                                        }
                                    } catch (error) {
                                        console.error('âŒ é‡æ–°æ£€æŸ¥å¤±è´¥:', error);
                                        window.profileManager.showProfilePanel();
                                    }
                                }, 500);
                            } else {
                                console.error('âŒ UserProfileManagerç±»æœªæ‰¾åˆ°ï¼Œé¡µé¢å¯èƒ½æœªå®Œå…¨åŠ è½½');
                            }
                        }
                    }, 1500); // å¢åŠ å»¶è¿Ÿç¡®ä¿æ‰€æœ‰ç»„ä»¶åŠ è½½å®Œæˆ // å»¶è¿Ÿ1ç§’æ˜¾ç¤ºèµ„æ–™é¢æ¿
                } catch (error) {
                    console.error('âŒ è¿æ¥å¤±è´¥:', error);
                    alert('é’±åŒ…è¿æ¥å¤±è´¥: ' + error.message);
                } finally {
                    setIsConnecting(false);
                }
            };
            
            // æ–­å¼€è¿æ¥
            const disconnectWallet = async () => {
                try {
                    const provider = getWalletProvider(walletType);
                    if (provider && provider.disconnect) {
                        await provider.disconnect();
                    }
                    
                    // æ¸…ç†çŠ¶æ€
                    setIsConnected(false);
                    setWalletAddress(null);
                    setWalletType(null);
                    setBalance(0);
                    
                    // æ¸…ç† localStorage
                    localStorage.removeItem('wallet_address');
                    localStorage.removeItem('wallet_type');
                    
                    // è§¦å‘å…¨å±€äº‹ä»¶
                    window.dispatchEvent(new CustomEvent('walletDisconnected'));
                    
                    console.log('ğŸšª é’±åŒ…å·²æ–­å¼€è¿æ¥');
                } catch (error) {
                    console.error('æ–­å¼€è¿æ¥å¤±è´¥:', error);
                }
            };
            
            // æ›´æ–°ä½™é¢
            const updateBalance = async (publicKey) => {
                try {
                    const connection = new window.solanaWeb3.Connection(
                        'https://api.devnet.solana.com',
                        'confirmed'
                    );
                    const balance = await connection.getBalance(publicKey);
                    setBalance(balance / window.solanaWeb3.LAMPORTS_PER_SOL);
                } catch (error) {
                    console.error('è·å–ä½™é¢å¤±è´¥:', error);
                }
            };
            
            // æ ¼å¼åŒ–åœ°å€
            const formatAddress = (address) => {
                if (!address) return '';
                return `${address.slice(0, 6)}...${address.slice(-4)}`;
            };
            
            // è·å–é’±åŒ…å›¾æ ‡ - ä½¿ç”¨å†…åµŒ SVG
            const getWalletIcon = (type) => {
                const walletLogos = {
                    'phantom': {
                        primary: 'https://mintlify.s3.us-west-1.amazonaws.com/phantom-e50e2e68/resources/images/Phantom_SVG_Icon.svg',
                        fallback: 'https://assets.coingecko.com/coins/images/33067/large/phantom.png'
                    },
                    'solflare': {
                        primary: './assets/wallet/solflare.png',
                        fallback: './assets/wallet/solflare.png'
                    },
                    'coinbase': {
                        primary: './assets/wallet/coinbase logo.webp',
                        fallback: './assets/wallet/coinbase logo.webp'
                    },
                    'backpack': {
                        primary: 'https://backpack.app/favicon.ico',
                        fallback: 'https://www.madlads.com/mad_logo.svg'
                    },
                    'okx': {
                        primary: 'https://static.okx.com/cdn/assets/imgs/247/58E63FEA47A2B7D7.png',
                        fallback: 'https://avatars.githubusercontent.com/u/33663881?s=200&v=4'
                    },
                    'bitget': {
                        primary: './assets/wallet/bitget wallet.png',
                        fallback: './assets/wallet/bitget wallet.png'
                    },
                    'tokenpocket': {
                        primary: 'https://tp-statics.tokenpocket.pro/logo/tokenpocket.png',
                        fallback: 'https://avatars.githubusercontent.com/u/29760615?s=200&v=4'
                    }
                };
                
                if (walletLogos[type]) {
                    let currentSrc = walletLogos[type].primary;
                    let fallbackUsed = false;
                    
                    const img = React.createElement('img', {
                        src: currentSrc,
                        alt: type,
                        style: {
                            width: '24px',
                            height: '24px',
                            borderRadius: '6px',
                            objectFit: 'contain'
                        },
                        onError: (e) => {
                            if (!fallbackUsed && walletLogos[type].fallback) {
                                fallbackUsed = true;
                                e.target.src = walletLogos[type].fallback;
                            } else {
                                // æœ€ç»ˆå¤‡ç”¨æ–¹æ¡ˆ - æ˜¾ç¤ºé’±åŒ…åç§°é¦–å­—æ¯
                                const div = document.createElement('div');
                                div.style.cssText = `
                                    width: 24px; height: 24px; 
                                    border-radius: 6px; 
                                    background: linear-gradient(135deg, #8b5cf6, #a855f7); 
                                    display: flex; 
                                    align-items: center; 
                                    justify-content: center; 
                                    font-size: 12px; 
                                    color: white; 
                                    font-weight: 600;
                                `;
                                div.textContent = type.charAt(0).toUpperCase();
                                e.target.style.display = 'none';
                                e.target.parentElement.appendChild(div);
                            }
                        }
                    });
                    
                    return img;
                } else {
                    return React.createElement('div', {
                        style: {
                            width: '24px',
                            height: '24px',
                            borderRadius: '6px',
                            background: 'linear-gradient(135deg, #8b5cf6, #a855f7)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            fontSize: '12px',
                            color: 'white',
                            fontWeight: '600'
                        }
                    }, 'ğŸ’œ');
                }
            };
            
            // æœªè¿æ¥çŠ¶æ€ - æ˜¾ç¤ºè¿æ¥æŒ‰é’®
            if (!isConnected) {
                return (
                    <div>
                        <button
                            onClick={() => setShowModal(true)}
                            style={{
                                background: 'linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%)',
                                border: 'none',
                                borderRadius: '30px',
                                padding: '12px 24px',
                                color: 'white',
                                fontSize: '16px',
                                fontWeight: '600',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px',
                                transition: 'all 0.3s ease',
                                boxShadow: '0 4px 20px rgba(139, 92, 246, 0.3)',
                                minWidth: '120px',
                                justifyContent: 'center'
                            }}
                            disabled={isConnecting}
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 21 21">
                                <g fill="none" fill-rule="evenodd" transform="translate(3 4)">
                                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" d="M.5 2.5h12a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2h-10a2 2 0 0 1-2-2zm1-2h9a1 1 0 0 1 1 1v1H.5v-1a1 1 0 0 1 1-1z"/>
                                    <circle cx="11.5" cy="7.5" r="1" fill="currentColor"/>
                                </g>
                            </svg>
                            <span>{isConnecting ? 'Connecting...' : 'Connect'}</span>
                        </button>
                        
                        {showModal && (
                            <div
                                style={{
                                    position: 'fixed',
                                    top: 0,
                                    left: 0,
                                    right: 0,
                                    bottom: 0,
                                    background: 'rgba(0, 0, 0, 0.9)',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    zIndex: 10000
                                }}
                                onClick={(e) => {
                                    if (e.target === e.currentTarget) {
                                        setShowModal(false);
                                    }
                                }}
                            >
                                <div style={{
                                    background: '#1c1917',
                                    borderRadius: '24px',
                                    padding: '32px',
                                    width: '400px',
                                    maxWidth: '90%',
                                    color: 'white'
                                }}>
                                    <h2 style={{ marginBottom: '8px', fontSize: '24px' }}>Connect wallet</h2>
                                    <p style={{ color: '#888', marginBottom: '24px' }}>
                                        Get started by connecting your preferred wallet below.
                                    </p>
                                    
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                        {[
                                            { 
                                                id: 'phantom', 
                                                name: 'Phantom', 
                                                logo: 'https://mintlify.s3.us-west-1.amazonaws.com/phantom-e50e2e68/resources/images/Phantom_SVG_Icon.svg',
                                                fallback: 'https://assets.coingecko.com/coins/images/33067/large/phantom.png'
                                            },
                                            { 
                                                id: 'solflare', 
                                                name: 'Solflare', 
                                                logo: './assets/wallet/solflare.png',
                                                fallback: './assets/wallet/solflare.png'
                                            },
                                            { 
                                                id: 'coinbase', 
                                                name: 'Coinbase Wallet', 
                                                logo: './assets/wallet/coinbase logo.webp',
                                                fallback: './assets/wallet/coinbase logo.webp'
                                            },
                                            { 
                                                id: 'backpack', 
                                                name: 'Backpack', 
                                                logo: 'https://backpack.app/favicon.ico',
                                                fallback: 'https://www.madlads.com/mad_logo.svg'
                                            },
                                            { 
                                                id: 'okx', 
                                                name: 'OKX Wallet', 
                                                logo: 'https://static.okx.com/cdn/assets/imgs/247/58E63FEA47A2B7D7.png',
                                                fallback: 'https://avatars.githubusercontent.com/u/33663881?s=200&v=4'
                                            },
                                            { 
                                                id: 'bitget', 
                                                name: 'Bitget Wallet', 
                                                logo: './assets/wallet/bitget wallet.png',
                                                fallback: './assets/wallet/bitget wallet.png'
                                            },
                                            { 
                                                id: 'tokenpocket', 
                                                name: 'TokenPocket', 
                                                logo: 'https://tp-statics.tokenpocket.pro/logo/tokenpocket.png',
                                                fallback: 'https://avatars.githubusercontent.com/u/29760615?s=200&v=4'
                                            }
                                        ].map(wallet => (
                                            <button
                                                key={wallet.id}
                                                onClick={() => connectWallet(wallet.id)}
                                                style={{
                                                    background: '#2a2a2a',
                                                    border: '1px solid #333',
                                                    borderRadius: '12px',
                                                    padding: '16px',
                                                    color: 'white',
                                                    fontSize: '16px',
                                                    cursor: 'pointer',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '12px',
                                                    transition: 'all 0.2s'
                                                }}
                                                onMouseOver={(e) => e.currentTarget.style.background = '#333'}
                                                onMouseOut={(e) => e.currentTarget.style.background = '#2a2a2a'}
                                            >
                                                <img 
                                                    src={wallet.logo} 
                                                    alt={wallet.name}
                                                    style={{ 
                                                        width: '32px', 
                                                        height: '32px', 
                                                        borderRadius: '8px',
                                                        objectFit: 'contain'
                                                    }}
                                                    onError={(e) => {
                                                        // å°è¯•fallbackå›¾ç‰‡
                                                        if (wallet.fallback && e.target.src !== wallet.fallback) {
                                                            e.target.src = wallet.fallback;
                                                        } else {
                                                            // å¦‚æœå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºæ–‡å­—å¤‡ç”¨
                                                            e.target.style.display = 'none';
                                                            const div = document.createElement('div');
                                                        div.style.cssText = `
                                                            width: 32px; height: 32px; 
                                                            border-radius: 8px; 
                                                            background: #666; 
                                                            display: flex; 
                                                            align-items: center; 
                                                            justify-content: center; 
                                                            font-size: 12px; 
                                                            color: white;
                                                        `;
                                                            div.textContent = wallet.name.charAt(0);
                                                            e.target.parentElement.insertBefore(div, e.target);
                                                        }
                                                    }}
                                                />
                                                <span style={{ flex: 1, textAlign: 'left' }}>{wallet.name}</span>
                                                <span style={{ color: '#888' }}>â†’</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }
            
            // å·²è¿æ¥çŠ¶æ€ - æ˜¾ç¤ºé’±åŒ…ä¿¡æ¯
            return (
                <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '12px',
                    background: 'rgba(28, 25, 23, 0.95)',
                    border: '1px solid #333333',
                    borderRadius: '16px',
                    padding: '8px 16px',
                    backdropFilter: 'blur(10px)',
                    boxShadow: '0 8px 30px rgba(0, 0, 0, 0.3)',
                    color: 'white'
                }}>
                    <div>
                        {getWalletIcon(walletType)}
                    </div>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '2px' }}>
                        <div style={{ fontSize: '14px', fontWeight: '600', fontFamily: '"Courier New", monospace' }}>
                            {formatAddress(walletAddress)}
                        </div>
                        <div style={{ color: '#888888', fontSize: '12px' }}>
                            {balance.toFixed(4)} SOL
                        </div>
                    </div>
                    <button
                        onClick={disconnectWallet}
                        style={{
                            background: 'transparent',
                            border: '1px solid #444444',
                            borderRadius: '8px',
                            color: '#888888',
                            cursor: 'pointer',
                            padding: '6px 12px',
                            fontSize: '12px'
                        }}
                    >
                        æ–­å¼€
                    </button>
                </div>
            );
        }
        
        // æ¸²æŸ“ React ç»„ä»¶
        const root = ReactDOM.createRoot(document.getElementById('wallet-adapter-root'));
        root.render(React.createElement(WalletConnector));
        
        // å…¨å±€é’±åŒ…çŠ¶æ€ç®¡ç† (å‘åå…¼å®¹)
        let currentWalletState = {
            isConnected: false,
            wallet: null
        };
        
        // ç›‘å¬é’±åŒ…çŠ¶æ€å˜åŒ–
        window.addEventListener('walletConnected', (event) => {
            currentWalletState = {
                isConnected: true,
                wallet: {
                    address: event.detail.address,
                    provider: event.detail.provider,
                    balance: event.detail.balance
                }
            };
        });
        
        window.addEventListener('walletDisconnected', () => {
            currentWalletState = {
                isConnected: false,
                wallet: null
            };
        });
        
        // å…¼å®¹æ¥å£
        window.walletManager = {
            getWalletInfo: () => currentWalletState
        };
        
        window.modernWalletUI = window.walletManager; // å‘åå…¼å®¹
        
        // ç”¨æˆ·èµ„æ–™ç®¡ç†ç³»ç»Ÿ - åœ¨Babelç¯å¢ƒä¸­å®šä¹‰
        console.log('ğŸš€ å¼€å§‹å®šä¹‰UserProfileManagerç±»...');
        class UserProfileManager {
            constructor() {
                this.currentUserId = null;
            }
            
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦éœ€è¦å¡«å†™èµ„æ–™ - çº¯APIé©±åŠ¨ï¼Œæ— localStorage
            async checkUserProfile(userId) {
                // ä»userIdæå–é’±åŒ…åœ°å€
                const walletAddress = userId.replace('wallet_', '');
                
                try {
                    // ä»åç«¯APIè·å–æœ€æ–°èµ„æ–™
                    const apiUrl = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';
                    const response = await fetch(`${apiUrl}/api/profiles/${walletAddress}`);
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.profile) {
                            console.log('âœ… ä»APIè·å–ç”¨æˆ·èµ„æ–™æˆåŠŸ:', result.profile);
                            return result.profile;
                        }
                    }
                    
                    if (response.status === 404) {
                        console.log('ğŸ“ APIç¡®è®¤ï¼šç”¨æˆ·èµ„æ–™ä¸å­˜åœ¨');
                        return null;
                    }
                    
                    console.warn('âš ï¸ APIå“åº”å¼‚å¸¸ï¼ŒçŠ¶æ€ç :', response.status);
                    return null;
                    
                } catch (error) {
                    console.error('âŒ APIè¯·æ±‚å¤±è´¥:', error);
                    return null;
                }
            }
            
            // æ˜¾ç¤ºç”¨æˆ·èµ„æ–™é¢æ¿
            showProfilePanel(userId = null, existingProfile = null) {
                console.log('ğŸ“± æ˜¾ç¤ºç”¨æˆ·èµ„æ–™é¢æ¿');
                const overlay = document.getElementById('user-profile-overlay');
                if (overlay) {
                    // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œå¡«å……ç°æœ‰æ•°æ®
                    if (existingProfile) {
                        this.fillFormWithProfile(existingProfile);
                        // æ›´æ”¹æ ‡é¢˜ä¸ºç¼–è¾‘æ¨¡å¼
                        const title = overlay.querySelector('.profile-panel-title');
                        if (title) title.textContent = 'ç¼–è¾‘èµ„æ–™';
                    } else {
                        // é‡ç½®è¡¨å•
                        this.resetForm();
                        const title = overlay.querySelector('.profile-panel-title');
                        if (title) title.textContent = 'ç”¨æˆ·æ³¨å†Œ';
                    }
                    
                    overlay.style.display = 'flex';
                    console.log('âœ… èµ„æ–™é¢æ¿å·²æ˜¾ç¤º');
                } else {
                    console.error('âŒ æ‰¾ä¸åˆ°user-profile-overlayå…ƒç´ ');
                }
            }
            
            // å¡«å……è¡¨å•æ•°æ®
            fillFormWithProfile(profile) {
                const fields = {
                    'username': profile.nickname || profile.username,
                    'displayName': profile.nickname || profile.first_name || '',
                    'birthYear': profile.birth_year,
                    'birthMonth': profile.birth_month,
                    'birthDay': profile.birth_day,
                    'location': profile.location,
                    'language': profile.language || 'zh-CN'
                };
                
                Object.entries(fields).forEach(([fieldId, value]) => {
                    const field = document.getElementById(fieldId);
                    if (field && value) {
                        field.value = value;
                    }
                });
            }
            
            // é‡ç½®è¡¨å•
            resetForm() {
                const form = document.getElementById('profile-form');
                if (form) {
                    form.reset();
                }
            }
            
            // æ˜¾ç¤ºç”¨æˆ·æ¬¢è¿ä¿¡æ¯
            showUserWelcome(profile) {
                console.log('ğŸ‘‹ æ˜¾ç¤ºç”¨æˆ·æ¬¢è¿ä¿¡æ¯:', profile);
                // è¿™é‡Œå¯ä»¥æ·»åŠ æ¬¢è¿ä¿¡æ¯æ˜¾ç¤ºé€»è¾‘
            }
        }

        // ç¡®ä¿UserProfileManagerç±»å¯å…¨å±€è®¿é—®
        console.log('ğŸ“¤ è®¾ç½®å…¨å±€UserProfileManager...');
        window.UserProfileManager = UserProfileManager;
        
        // ç«‹å³åˆå§‹åŒ–ProfileManagerä»¥ç¡®ä¿åœ¨é’±åŒ…è¿æ¥æ—¶å¯ç”¨
        console.log('ğŸ—ï¸ åˆ›å»ºprofileManagerå®ä¾‹...');
        const profileManager = new UserProfileManager();
        window.profileManager = profileManager;
        console.log('âœ… ProfileManagerå·²åˆå§‹åŒ–');
        
    </script>
                // è¿æ¥æŒ‰é’®ç‚¹å‡»
                const connectButton = document.getElementById('wallet-connect-button');
                if (connectButton) {
                    connectButton.addEventListener('click', () => this.showWalletModal());
                }

                // å…³é—­æ¨¡æ€æ¡†
                const closeBtn = document.getElementById('wallet-close-btn');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => this.hideWalletModal());
                }

                // æ¨¡æ€æ¡†è¦†ç›–å±‚ç‚¹å‡»å…³é—­
                const modal = document.getElementById('wallet-modal');
                if (modal) {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal || e.target.closest('.wallet-modal-overlay')) {
                            if (e.target === modal || e.target === e.target.closest('.wallet-modal-overlay')) {
                                this.hideWalletModal();
                            }
                        }
                    });
                }

                // é’±åŒ…é€‰é¡¹ç‚¹å‡»
                const walletOptions = document.querySelectorAll('.wallet-option');
                walletOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        const provider = option.dataset.provider;
                        this.connectWallet(provider);
                    });
                });

                // é’±åŒ…èœå•æŒ‰é’®
                const menuBtn = document.getElementById('wallet-menu-btn');
                if (menuBtn) {
                    menuBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.toggleDropdown();
                    });
                }

                // å¤åˆ¶åœ°å€
                const copyBtn = document.getElementById('copy-address-btn');
                if (copyBtn) {
                    copyBtn.addEventListener('click', () => this.copyAddress());
                }

                // æ–­å¼€è¿æ¥
                const disconnectBtn = document.getElementById('disconnect-wallet-btn');
                if (disconnectBtn) {
                    disconnectBtn.addEventListener('click', () => this.disconnect());
                }

                // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
                document.addEventListener('click', () => {
                    this.hideDropdown();
                });
            }

            showWalletModal() {
                const modal = document.getElementById('wallet-modal');
                if (modal) {
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                }
            }

            hideWalletModal() {
                const modal = document.getElementById('wallet-modal');
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                }
            }

            async connectWallet(walletName) {
                try {
                    console.log(`ğŸ”— è¿æ¥é’±åŒ…: ${walletName}`);
                    
                    // æŸ¥æ‰¾é’±åŒ…é…ç½®
                    const walletConfig = this.wallets.find(w => w.name.toLowerCase() === walletName.toLowerCase());
                    if (!walletConfig) {
                        throw new Error(`é’±åŒ… ${walletName} æœªæ‰¾åˆ°æˆ–æœªå®‰è£…`);
                    }
                    
                    const adapter = walletConfig.adapter();
                    if (!adapter) {
                        this.showToast(`${walletName} é’±åŒ…æœªå®‰è£…`, 'error');
                        return;
                    }
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    this.updateConnectButton(true);
                    
                    // è¿æ¥é’±åŒ…
                    let response;
                    if (adapter.connect) {
                        response = await adapter.connect();
                    } else if (adapter.publicKey && adapter.isConnected) {
                        response = { publicKey: adapter.publicKey };
                    } else {
                        throw new Error('é’±åŒ…é€‚é…å™¨ä¸æ”¯æŒè¿æ¥');
                    }
                    
                    const address = response.publicKey.toString();
                    
                    // ä¿å­˜è¿æ¥çŠ¶æ€
                    this.selectedWallet = {
                        name: walletName,
                        adapter,
                        address,
                        config: walletConfig
                    };
                    this.isConnected = true;
                    
                    // ä¿å­˜åˆ°localStorage
                    localStorage.setItem('wallet_address', address);
                    localStorage.setItem('wallet_type', walletName.toLowerCase());
                    
                    console.log(`âœ… ${walletName} è¿æ¥æˆåŠŸ:`, address);
                    
                    // æ›´æ–°UI
                    this.updateUI();
                    this.hideWalletModal();
                    this.showToast(`${walletName} è¿æ¥æˆåŠŸ!`, 'success');
                    
                    // è§¦å‘å…¨å±€äº‹ä»¶
                    window.dispatchEvent(new CustomEvent('walletConnected', {
                        detail: { address, provider: walletName.toLowerCase() }
                    }));
                    
                } catch (error) {
                    console.error('âŒ é’±åŒ…è¿æ¥å¤±è´¥:', error);
                    this.updateConnectButton(false);
                    this.showToast(`è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                }
            }

            async disconnect() {
                try {
                    console.log('ğŸšª æ–­å¼€é’±åŒ…è¿æ¥...');

                    if (this.selectedWallet?.adapter?.disconnect) {
                        await this.selectedWallet.adapter.disconnect();
                    }
                    
                    // æ¸…ç†çŠ¶æ€
                    this.selectedWallet = null;
                    this.isConnected = false;

                    // æ¸…ç†localStorage
                    localStorage.removeItem('wallet_address');
                    localStorage.removeItem('wallet_type');
                    localStorage.removeItem('selectedCharacter');

                    // æ›´æ–°UI
                    this.updateUI();
                    this.hideDropdown();
                    this.showToast('é’±åŒ…å·²æ–­å¼€è¿æ¥', 'success');

                    // è§¦å‘å…¨å±€äº‹ä»¶
                    window.dispatchEvent(new CustomEvent('walletDisconnected'));

                } catch (error) {
                    console.error('âŒ æ–­å¼€è¿æ¥å¤±è´¥:', error);
                    // å¼ºåˆ¶æ¸…ç†çŠ¶æ€
                    this.selectedWallet = null;
                    this.isConnected = false;
                    localStorage.clear();
                    this.updateUI();
                }
            }

            checkExistingConnection() {
                const savedAddress = localStorage.getItem('wallet_address');
                const savedType = localStorage.getItem('wallet_type');
                
                if (savedAddress && savedType) {
                    console.log('ğŸ” æ£€æŸ¥å·²ä¿å­˜çš„é’±åŒ…è¿æ¥...');
                    
                    const walletConfig = this.wallets.find(w => w.name.toLowerCase() === savedType.toLowerCase());
                    if (walletConfig) {
                        const adapter = walletConfig.adapter();
                        if (adapter && adapter.isConnected && adapter.publicKey) {
                            this.selectedWallet = {
                                name: walletConfig.name,
                                adapter,
                                address: savedAddress,
                                config: walletConfig
                            };
                            this.isConnected = true;
                            this.updateUI();
                            console.log('âœ… è‡ªåŠ¨é‡è¿æˆåŠŸ:', savedAddress);
                        }
                    }
                }
            }

            updateUI() {
                const connectButton = document.getElementById('wallet-connect-button');
                const walletInfo = document.getElementById('wallet-info');
                const walletAddress = document.getElementById('wallet-address');
                const walletAvatar = document.getElementById('wallet-avatar');

                if (this.isConnected && this.selectedWallet) {
                    // å·²è¿æ¥çŠ¶æ€
                    if (connectButton) connectButton.style.display = 'none';
                    if (walletInfo) walletInfo.style.display = 'flex';
                    if (walletAddress) walletAddress.textContent = this.formatAddress(this.selectedWallet.address);
                    if (walletAvatar) walletAvatar.textContent = this.selectedWallet.config.icon;
                } else {
                    // æ˜¾ç¤ºæœªè¿æ¥çŠ¶æ€
                    if (connectButton) connectButton.style.display = 'flex';
                    if (walletInfo) walletInfo.style.display = 'none';
                }
            }

            updateConnectButton(loading) {
                const button = document.getElementById('wallet-connect-button');
                if (!button) return;

                const textSpan = button.querySelector('.wallet-text');
                if (loading) {
                    button.disabled = true;
                    if (textSpan) textSpan.textContent = 'Connecting...';
                } else {
                    button.disabled = false;
                    if (textSpan) textSpan.textContent = 'Connect';
                }
            }

            toggleDropdown() {
                const dropdown = document.getElementById('wallet-dropdown');
                if (dropdown) {
                    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
                }
            }

            hideDropdown() {
                const dropdown = document.getElementById('wallet-dropdown');
                if (dropdown) {
                    dropdown.style.display = 'none';
                }
            }

            copyAddress() {
                if (this.selectedWallet?.address) {
                    navigator.clipboard.writeText(this.selectedWallet.address).then(() => {
                        this.showToast('åœ°å€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                    }).catch(() => {
                        this.showToast('å¤åˆ¶å¤±è´¥', 'error');
                    });
                }
                this.hideDropdown();
            }

            formatAddress(address) {
                if (!address) return '';
                return `${address.slice(0, 6)}...${address.slice(-4)}`;
            }

            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `wallet-toast wallet-toast-${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }

            // å…¬å…±API
            getWalletInfo() {
                return {
                    isConnected: this.isConnected,
                    wallet: this.selectedWallet
                };
            }
            
            getPublicKey() {
                return this.selectedWallet?.adapter?.publicKey || null;
            }
            
            async signMessage(message) {
                if (!this.selectedWallet?.adapter?.signMessage) {
                    throw new Error('å½“å‰é’±åŒ…ä¸æ”¯æŒæ¶ˆæ¯ç­¾å');
                }
                return await this.selectedWallet.adapter.signMessage(message);
            }
        }

        // ç”¨æˆ·èµ„æ–™ç®¡ç†ç³»ç»Ÿ - ç§»åˆ°è¿™é‡Œç¡®ä¿åœ¨é’±åŒ…åˆå§‹åŒ–ä¹‹å‰å®šä¹‰
        console.log('ğŸš€ å¼€å§‹å®šä¹‰UserProfileManagerç±»...');
        class UserProfileManager {
            constructor() {
                this.currentUserId = null;
            }
            
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦éœ€è¦å¡«å†™èµ„æ–™ - çº¯APIé©±åŠ¨ï¼Œæ— localStorage
            async checkUserProfile(userId) {
                // ä»userIdæå–é’±åŒ…åœ°å€
                const walletAddress = userId.replace('wallet_', '');
                
                try {
                    // ä»åç«¯APIè·å–æœ€æ–°èµ„æ–™
                    const apiUrl = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';
                    const response = await fetch(`${apiUrl}/api/profiles/${walletAddress}`);
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.profile) {
                            console.log('âœ… ä»APIè·å–ç”¨æˆ·èµ„æ–™æˆåŠŸ:', result.profile);
                            return result.profile;
                        }
                    }
                    
                    if (response.status === 404) {
                        console.log('ğŸ“ APIç¡®è®¤ï¼šç”¨æˆ·èµ„æ–™ä¸å­˜åœ¨');
                        return null;
                    }
                    
                    console.warn('âš ï¸ APIå“åº”å¼‚å¸¸ï¼ŒçŠ¶æ€ç :', response.status);
                    return null;
                    
                } catch (error) {
                    console.error('âŒ APIè¯·æ±‚å¤±è´¥:', error);
                    return null;
                }
            }
            
            // æ˜¾ç¤ºç”¨æˆ·èµ„æ–™é¢æ¿
            showProfilePanel(userId = null, existingProfile = null) {
                console.log('ğŸ“± æ˜¾ç¤ºç”¨æˆ·èµ„æ–™é¢æ¿');
                const overlay = document.getElementById('user-profile-overlay');
                if (overlay) {
                    // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œå¡«å……ç°æœ‰æ•°æ®
                    if (existingProfile) {
                        this.fillFormWithProfile(existingProfile);
                        // æ›´æ”¹æ ‡é¢˜ä¸ºç¼–è¾‘æ¨¡å¼
                        const title = overlay.querySelector('.profile-panel-title');
                        if (title) title.textContent = 'ç¼–è¾‘èµ„æ–™';
                    } else {
                        // é‡ç½®è¡¨å•
                        this.resetForm();
                        const title = overlay.querySelector('.profile-panel-title');
                        if (title) title.textContent = 'ç”¨æˆ·æ³¨å†Œ';
                    }
                    
                    overlay.style.display = 'flex';
                    console.log('âœ… èµ„æ–™é¢æ¿å·²æ˜¾ç¤º');
                } else {
                    console.error('âŒ æ‰¾ä¸åˆ°user-profile-overlayå…ƒç´ ');
                }
            }
            
            // å¡«å……è¡¨å•æ•°æ®
            fillFormWithProfile(profile) {
                const fields = {
                    'username': profile.nickname || profile.username,
                    'displayName': profile.nickname || profile.first_name || '',
                    'birthYear': profile.birth_year,
                    'birthMonth': profile.birth_month,
                    'birthDay': profile.birth_day,
                    'location': profile.location,
                    'language': profile.language || 'zh-CN'
                };
                
                Object.entries(fields).forEach(([fieldId, value]) => {
                    const field = document.getElementById(fieldId);
                    if (field && value) {
                        field.value = value;
                    }
                });
            }
            
            // é‡ç½®è¡¨å•
            resetForm() {
                const form = document.getElementById('profile-form');
                if (form) {
                    form.reset();
                }
            }
            
            // æ˜¾ç¤ºç”¨æˆ·æ¬¢è¿ä¿¡æ¯
            showUserWelcome(profile) {
                console.log('ğŸ‘‹ æ˜¾ç¤ºç”¨æˆ·æ¬¢è¿ä¿¡æ¯:', profile);
                // è¿™é‡Œå¯ä»¥æ·»åŠ æ¬¢è¿ä¿¡æ¯æ˜¾ç¤ºé€»è¾‘
            }
        }

        // ç¡®ä¿UserProfileManagerç±»å¯å…¨å±€è®¿é—®
        console.log('ğŸ“¤ è®¾ç½®å…¨å±€UserProfileManager...');
        window.UserProfileManager = UserProfileManager;
        
        // ç«‹å³åˆå§‹åŒ–ProfileManagerä»¥ç¡®ä¿åœ¨é’±åŒ…è¿æ¥æ—¶å¯ç”¨
        console.log('ğŸ—ï¸ åˆ›å»ºprofileManagerå®ä¾‹...');
        const profileManager = new UserProfileManager();
        window.profileManager = profileManager;
        console.log('âœ… ProfileManagerå·²åˆå§‹åŒ–');

        // åˆå§‹åŒ–é’±åŒ…ç®¡ç†å™¨
        let walletManager;
        document.addEventListener('DOMContentLoaded', () => {
            walletManager = new SolanaWalletManager();
            window.walletManager = walletManager; // æš´éœ²åˆ°å…¨å±€
            window.modernWalletUI = walletManager; // å‘åå…¼å®¹
        });

        // å…¼å®¹æ—§çš„å…¨å±€å‡½æ•°
        window.connectWallet = function() {
            if (walletManager) {
                walletManager.showWalletModal();
            }
        };
        
        window.disconnectWallet = function() {
            if (walletManager) {
                walletManager.disconnect();
            }
        };
        
        // ç”¨æˆ·èµ„æ–™ç®¡ç†ç³»ç»Ÿ
        class UserProfileManager {
            constructor() {
                this.currentUserId = null;
            }
            
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦éœ€è¦å¡«å†™èµ„æ–™ - çº¯APIé©±åŠ¨ï¼Œæ— localStorage
            async checkUserProfile(userId) {
                // ä»userIdæå–é’±åŒ…åœ°å€
                const walletAddress = userId.replace('wallet_', '');
                
                try {
                    // ä»åç«¯APIè·å–æœ€æ–°èµ„æ–™
                    const apiUrl = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';
                    const response = await fetch(`${apiUrl}/api/profiles/${walletAddress}`);
                    
                    if (response.ok) {
                        const result = await response.json();
                        const profile = result.profile;
                        console.log('âœ… ä»æ•°æ®åº“è·å–ç”¨æˆ·èµ„æ–™:', profile.username || profile.nickname || 'æœªçŸ¥');
                        return profile;
                    } else if (response.status === 404) {
                        console.log('â„¹ï¸ ç”¨æˆ·èµ„æ–™ä¸å­˜åœ¨ï¼Œéœ€è¦æ³¨å†Œ');
                        return null;
                    } else {
                        console.error('âŒ APIè·å–ç”¨æˆ·èµ„æ–™å¤±è´¥:', response.status);
                        return null;
                    }
                } catch (error) {
                    console.error('âŒ APIè¯·æ±‚å¤±è´¥:', error.message);
                    // ç”Ÿäº§ç¯å¢ƒï¼šAPIå¤±è´¥åº”è¯¥æç¤ºç”¨æˆ·é‡è¯•
                    alert('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œååˆ·æ–°é¡µé¢');
                    return null;
                }
            }
            
            // ä¿å­˜ç”¨æˆ·èµ„æ–™ - çº¯APIé©±åŠ¨ï¼Œæ— localStorageå›é€€
            async saveUserProfile(userId, profileData) {
                const walletAddress = userId.replace('wallet_', '');
                
                // å‡†å¤‡APIæ•°æ®
                const apiData = {
                    walletAddress: walletAddress,
                    nickname: profileData.nickname || profileData.username,
                    age: profileData.age,
                    gender: profileData.gender,
                    birthday: profileData.birthday,
                    location: profileData.location,
                    occupation: profileData.occupation,
                    interests: profileData.interests,
                    bio: profileData.bio
                };
                
                try {
                    // å‘é€åˆ°åç«¯API
                    const apiUrl = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';
                    console.log('ğŸŒ å‘é€APIè¯·æ±‚åˆ°:', `${apiUrl}/api/profiles`);
                    console.log('ğŸ“Š å‘é€æ•°æ®:', apiData);
                    
                    const response = await fetch(`${apiUrl}/api/profiles`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(apiData)
                    });
                    
                    console.log('ğŸ“ˆ APIå“åº”çŠ¶æ€:', response.status);
                    
                    if (response.ok) {
                        const result = await response.json();
                        const savedProfile = result.profile;
                        console.log('âœ… ç”¨æˆ·èµ„æ–™å·²ä¿å­˜åˆ°æ•°æ®åº“:', savedProfile.username || savedProfile.nickname || 'æœªçŸ¥');
                        return savedProfile;
                    } else if (response.status === 409) {
                        // ç”¨æˆ·å·²å­˜åœ¨ï¼Œå°è¯•æ›´æ–°
                        console.log('ğŸ”„ ç”¨æˆ·å·²å­˜åœ¨ï¼Œå°è¯•æ›´æ–°èµ„æ–™');
                        return await this.updateUserProfile(userId, profileData);
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.message || `APIä¿å­˜å¤±è´¥: ${response.status}`);
                    }
                } catch (error) {
                    console.error('âŒ ä¿å­˜ç”¨æˆ·èµ„æ–™å¤±è´¥:', error.message);
                    // ç”Ÿäº§ç¯å¢ƒï¼šæ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
                    alert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•');
                    throw error; // å‘ä¸ŠæŠ›å‡ºé”™è¯¯ï¼Œè®©è°ƒç”¨è€…å¤„ç†
                }
            }
            
            // è·å–ç”¨æˆ·èµ„æ–™
            getUserProfile(userId) {
                return this.checkUserProfile(userId);
            }
            
            // åˆ é™¤ç”¨æˆ·èµ„æ–™ - çº¯APIé©±åŠ¨
            async deleteUserProfile(userId) {
                const walletAddress = userId.replace('wallet_', '');
                
                try {
                    // ä»APIåˆ é™¤
                    const apiUrl = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';
                    const response = await fetch(`${apiUrl}/api/profiles/${walletAddress}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        console.log('âœ… ç”¨æˆ·èµ„æ–™å·²ä»æ•°æ®åº“åˆ é™¤');
                        return true;
                    } else {
                        console.error('âŒ åˆ é™¤å¤±è´¥:', response.status);
                        return false;
                    }
                } catch (error) {
                    console.error('âŒ APIåˆ é™¤å¤±è´¥:', error.message);
                    alert('åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•');
                    return false;
                }
            }
            
            // æ›´æ–°ç”¨æˆ·èµ„æ–™ - çº¯APIé©±åŠ¨
            async updateUserProfile(userId, updates) {
                const walletAddress = userId.replace('wallet_', '');
                
                try {
                    const apiUrl = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';
                    const response = await fetch(`${apiUrl}/api/profiles/${walletAddress}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(updates)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('âœ… ç”¨æˆ·èµ„æ–™å·²æ›´æ–°');
                        return result.profile;
                    } else {
                        console.error('âŒ æ›´æ–°å¤±è´¥:', response.status);
                        return null;
                    }
                } catch (error) {
                    console.error('âŒ APIæ›´æ–°å¤±è´¥:', error.message);
                    alert('æ›´æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•');
                    return null;
                }
            }
            
            
            // è·å–æ‰€æœ‰ç”¨æˆ·èµ„æ–™ - çº¯APIé©±åŠ¨
            async getAllUserProfiles() {
                try {
                    const apiUrl = window.AppConfig ? window.AppConfig.getApiUrl() : 'http://localhost:3000';
                    const response = await fetch(`${apiUrl}/api/profiles`);
                    
                    if (response.ok) {
                        const result = await response.json();
                        return result.profiles || [];
                    } else {
                        console.error('âŒ è·å–æ‰€æœ‰ç”¨æˆ·å¤±è´¥:', response.status);
                        return [];
                    }
                } catch (error) {
                    console.error('âŒ APIè¯·æ±‚å¤±è´¥:', error.message);
                    return [];
                }
            }
            
            // æ˜¾ç¤ºèµ„æ–™æ³¨å†Œé¢æ¿
            showProfilePanel(userId = null, existingProfile = null) {
                const overlay = document.getElementById('user-profile-overlay');
                if (overlay) {
                    // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œå¡«å……ç°æœ‰æ•°æ®
                    if (existingProfile) {
                        this.fillFormWithProfile(existingProfile);
                        // æ›´æ”¹æ ‡é¢˜ä¸ºç¼–è¾‘æ¨¡å¼
                        const title = overlay.querySelector('.profile-panel-title');
                        if (title) title.textContent = 'ç¼–è¾‘èµ„æ–™';
                    } else {
                        // é‡ç½®è¡¨å•
                        this.resetForm();
                        const title = overlay.querySelector('.profile-panel-title');
                        if (title) title.textContent = 'ç”¨æˆ·æ³¨å†Œ';
                    }
                    
                    // åˆå§‹åŒ–æœˆä»½å’Œæ—¥æœŸé€‰æ‹©å™¨
                    setTimeout(() => {
                        this.initDateSelectors();
                    }, 100);
                    overlay.style.display = 'flex';
                    console.log('ğŸ“ æ˜¾ç¤ºç”¨æˆ·èµ„æ–™æ³¨å†Œé¢æ¿');
                }
            }
            
            // éšè—èµ„æ–™æ³¨å†Œé¢æ¿
            hideProfilePanel() {
                const overlay = document.getElementById('user-profile-overlay');
                if (overlay) {
                    overlay.style.display = 'none';
                }
            }
            
            // åˆå§‹åŒ–æœˆä»½å’Œæ—¥æœŸé€‰æ‹©å™¨
            initDateSelectors() {
                const yearSelect = document.getElementById('birthYear');
                const monthSelect = document.getElementById('birthMonth');
                const daySelect = document.getElementById('birthDay');
                
                if (!yearSelect || !monthSelect || !daySelect) {
                    console.error('Date selectors not found');
                    return;
                }
                
                // æ¸…ç©ºå¹¶å¡«å……å¹´ä»½ï¼ˆ1950-2010ï¼Œé€‚åˆæˆå¹´ç”¨æˆ·ï¼‰
                yearSelect.innerHTML = '<option value="">å¹´</option>';
                const currentYear = new Date().getFullYear();
                for (let i = currentYear - 15; i >= 1950; i--) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    yearSelect.appendChild(option);
                }
                
                // æ¸…ç©ºå¹¶å¡«å……æœˆä»½
                monthSelect.innerHTML = '<option value="">æœˆ</option>';
                for (let i = 1; i <= 12; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    monthSelect.appendChild(option);
                }
                
                // æ¸…ç©ºå¹¶å¡«å……æ—¥æœŸï¼ˆé»˜è®¤31å¤©ï¼‰
                daySelect.innerHTML = '<option value="">æ—¥</option>';
                for (let i = 1; i <= 31; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    daySelect.appendChild(option);
                }
                
                // æœˆä»½å˜åŒ–æ—¶æ›´æ–°æ—¥æœŸ
                monthSelect.addEventListener('change', () => {
                    this.updateDayOptions(monthSelect.value);
                });
            }
            
            // æ ¹æ®æœˆä»½æ›´æ–°æ—¥æœŸé€‰é¡¹
            updateDayOptions(month) {
                const daySelect = document.getElementById('birthDay');
                const daysInMonth = [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
                const maxDays = month ? daysInMonth[month - 1] : 31;
                
                daySelect.innerHTML = '<option value="">æ—¥</option>';
                for (let i = 1; i <= maxDays; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    daySelect.appendChild(option);
                }
            }
            
            // ç”¨ç°æœ‰èµ„æ–™å¡«å……è¡¨å•
            fillFormWithProfile(profile) {
                const form = document.getElementById('profile-form');
                if (form && profile) {
                    // å¡«å……åŸºæœ¬ä¿¡æ¯
                    const nickname = form.querySelector('[name="nickname"]');
                    if (nickname) nickname.value = profile.nickname || '';
                    
                    const age = form.querySelector('[name="age"]');
                    if (age) age.value = profile.age || '';
                    
                    const location = form.querySelector('[name="location"]');
                    if (location) location.value = profile.location || '';
                    
                    const occupation = form.querySelector('[name="occupation"]');
                    if (occupation) occupation.value = profile.occupation || '';
                    
                    const interests = form.querySelector('[name="interests"]');
                    if (interests) interests.value = profile.interests || '';
                    
                    const bio = form.querySelector('[name="bio"]');
                    if (bio) bio.value = profile.bio || '';
                    
                    // å¡«å……ç”Ÿæ—¥
                    if (profile.birthday) {
                        const [year, month, day] = profile.birthday.split('-');
                        const birthYear = form.querySelector('#birthYear');
                        const birthMonth = form.querySelector('#birthMonth');
                        const birthDay = form.querySelector('#birthDay');
                        
                        if (birthYear) birthYear.value = year;
                        if (birthMonth) birthMonth.value = parseInt(month);
                        if (birthDay) birthDay.value = parseInt(day);
                    }
                    
                    // å¡«å……æ€§åˆ«
                    if (profile.gender) {
                        const genderRadio = form.querySelector(`[name="gender"][value="${profile.gender}"]`);
                        if (genderRadio) genderRadio.checked = true;
                    }
                }
            }
            
            // é‡ç½®è¡¨å•
            resetForm() {
                const form = document.getElementById('profile-form');
                if (form) {
                    form.reset();
                    // æ¸…é™¤æ—¥æœŸé€‰æ‹©å™¨
                    const birthYear = form.querySelector('#birthYear');
                    const birthMonth = form.querySelector('#birthMonth');
                    const birthDay = form.querySelector('#birthDay');
                    
                    if (birthYear) birthYear.value = '';
                    if (birthMonth) birthMonth.value = '';
                    if (birthDay) birthDay.value = '';
                }
            }
            
            // æ˜¾ç¤ºç”¨æˆ·æ¬¢è¿ä¿¡æ¯
            showUserWelcome(profile) {
                // åˆ›å»ºä¸´æ—¶æ¬¢è¿æ¶ˆæ¯
                const welcomeDiv = document.createElement('div');
                welcomeDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 15px 20px;
                    border-radius: 10px;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                    z-index: 10000;
                    font-family: 'Microsoft YaHei', sans-serif;
                    max-width: 300px;
                    animation: slideInRight 0.5s ease;
                `;
                
                welcomeDiv.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 8px;">ğŸ‰ æ¬¢è¿å›æ¥!</div>
                    <div style="font-size: 14px; opacity: 0.9;">
                        ä½ å¥½, ${profile.nickname || 'ç”¨æˆ·'}! è¿›å…¥AIå¥³å‹ä¸–ç•Œ
                    </div>
                    <button onclick="this.parentElement.remove()" style="
                        position: absolute;
                        top: 5px;
                        right: 8px;
                        background: none;
                        border: none;
                        color: white;
                        cursor: pointer;
                        font-size: 18px;
                        opacity: 0.7;
                    ">Ã—</button>
                `;
                
                document.body.appendChild(welcomeDiv);
                
                // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
                setTimeout(() => {
                    if (welcomeDiv.parentElement) {
                        welcomeDiv.remove();
                    }
                }, 3000);
            }
        }
        
        // ç¡®ä¿UserProfileManagerç±»å¯å…¨å±€è®¿é—®
        window.UserProfileManager = UserProfileManager;
        
        // ç«‹å³åˆå§‹åŒ–ProfileManagerä»¥ç¡®ä¿åœ¨é’±åŒ…è¿æ¥æ—¶å¯ç”¨
        const profileManager = new UserProfileManager();
        window.profileManager = profileManager;
        console.log('âœ… ProfileManagerå·²åˆå§‹åŒ–');
        
        // æäº¤ç”¨æˆ·èµ„æ–™è¡¨å•
        async function submitProfile(event) {
            try {
                console.log('ğŸ”„ è¡¨å•æäº¤å¼€å§‹');
                event.preventDefault();
                console.log('âœ… é˜»æ­¢äº†é»˜è®¤è¡¨å•æäº¤è¡Œä¸º');
                
                const formData = {
                username: document.getElementById('username').value.trim(),
                displayName: document.getElementById('displayName').value.trim(),
                birthYear: document.getElementById('birthYear').value,
                birthMonth: document.getElementById('birthMonth').value,
                birthDay: document.getElementById('birthDay').value,
                location: document.getElementById('location').value.trim(),
                language: document.getElementById('language').value,
                // è®°å¿†ç³»ç»Ÿæ•°æ®
                memory: {
                    favoriteFood: document.getElementById('favoriteFood').value.trim(),
                    favoriteColor: document.getElementById('favoriteColor').value.trim(),
                    hobbies: document.getElementById('hobbies').value.trim()
                }
            };
            
            console.log('ğŸ“Š æ”¶é›†åˆ°çš„è¡¨å•æ•°æ®:', formData);
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            const requiredFields = {
                username: formData.username,
                displayName: formData.displayName,
                birthYear: formData.birthYear,
                birthMonth: formData.birthMonth,
                birthDay: formData.birthDay,
                location: formData.location,
                language: formData.language
            };
            
            const missingFields = Object.entries(requiredFields).filter(([key, value]) => !value).map(([key]) => key);
            if (missingFields.length > 0) {
                console.error('âŒ ç¼ºå°‘å¿…å¡«å­—æ®µ:', missingFields);
                alert(`è¯·å¡«å†™æ‰€æœ‰å¿…å¡«ä¿¡æ¯ï¼ç¼ºå°‘: ${missingFields.join(', ')}`);
                return;
            }
            
            // ä¿å­˜ç”¨æˆ·èµ„æ–™
            const walletAddress = localStorage.getItem('wallet_address');
            if (walletAddress) {
                const userId = `wallet_${walletAddress}`;
                
                // è½¬æ¢æ•°æ®æ ¼å¼ä»¥åŒ¹é…APIæœŸæœ›
                const month = formData.birthMonth.toString().padStart ? formData.birthMonth.padStart(2, '0') : (formData.birthMonth.length === 1 ? '0' + formData.birthMonth : formData.birthMonth);
                const day = formData.birthDay.toString().padStart ? formData.birthDay.padStart(2, '0') : (formData.birthDay.length === 1 ? '0' + formData.birthDay : formData.birthDay);
                
                const apiFormData = {
                    nickname: formData.displayName,
                    username: formData.username,
                    age: new Date().getFullYear() - parseInt(formData.birthYear),
                    birthday: `${formData.birthYear}-${month}-${day}`,
                    location: formData.location,
                    language: formData.language,
                    interests: formData.memory.hobbies,
                    bio: `å–œæ¬¢çš„é£Ÿç‰©: ${formData.memory.favoriteFood}, å–œæ¬¢çš„é¢œè‰²: ${formData.memory.favoriteColor}`
                };
                
                console.log('ğŸ“ å‡†å¤‡ä¿å­˜ç”¨æˆ·èµ„æ–™:', apiFormData);
                
                // ä¿å­˜åˆ°æ•°æ®åº“
                try {
                    await profileManager.saveUserProfile(userId, apiFormData);
                    console.log('âœ… ç”¨æˆ·èµ„æ–™ä¿å­˜æˆåŠŸï¼Œéšè—é¢æ¿');
                    profileManager.hideProfilePanel();
                } catch (error) {
                    console.error('âŒ ä¿å­˜ç”¨æˆ·èµ„æ–™å¤±è´¥:', error);
                    alert('ä¿å­˜ç”¨æˆ·èµ„æ–™å¤±è´¥ï¼Œè¯·é‡è¯•');
                    return;
                }
                
                console.log('âœ… ç”¨æˆ·èµ„æ–™æäº¤å®Œæˆï¼Œå‡†å¤‡é€‰æ‹©è§’è‰²');
                
                // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
                const successMsg = document.createElement('div');
                successMsg.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.9);
                    color: white;
                    padding: 20px 40px;
                    border-radius: 10px;
                    font-size: 16px;
                    z-index: 10001;
                `;
                successMsg.textContent = 'ğŸ‰ æ³¨å†Œå®Œæˆï¼è¯·é€‰æ‹©ä½ çš„AIå¥³å‹è§’è‰²';
                document.body.appendChild(successMsg);
                
                setTimeout(() => {
                    successMsg.remove();
                }, 3000);
                
            } else {
                console.error('âŒ æ— æ³•è·å–é’±åŒ…åœ°å€ï¼Œæ— æ³•ä¿å­˜èµ„æ–™');
            }
            } catch (error) {
                console.error('âŒ è¡¨å•æäº¤è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
                alert('æäº¤å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // handleProfileSubmitä¼šåœ¨æ™®é€šscriptæ ‡ç­¾ä¸­å®šä¹‰
        
        // æš´éœ²å‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
        window.submitProfile = submitProfile;
        
        // æµ‹è¯•å‡½æ•° - å¼ºåˆ¶æ˜¾ç¤ºprofile panel
        window.testShowProfilePanel = function() {
            console.log('ğŸ§ª æµ‹è¯•æ˜¾ç¤ºprofile panel');
            if (window.profileManager) {
                console.log('âœ… profileManagerå­˜åœ¨ï¼Œæ˜¾ç¤ºé¢æ¿');
                window.profileManager.showProfilePanel();
            } else {
                console.error('âŒ profileManagerä¸å­˜åœ¨');
            }
        };
        
        // æ–°å¢ï¼šæµ‹è¯•æ–°ç”¨æˆ·æµç¨‹
        window.testNewUserFlow = function() {
            console.log('ğŸ§ª æ¨¡æ‹Ÿæ–°ç”¨æˆ·æµç¨‹');
            const testAddress = 'TEST_NEW_USER_' + Date.now();
            console.log('ğŸ”„ ä½¿ç”¨æµ‹è¯•åœ°å€:', testAddress);
            
            setTimeout(async () => {
                if (window.profileManager) {
                    const userId = `wallet_${testAddress}`;
                    try {
                        const profile = await window.profileManager.checkUserProfile(userId);
                        console.log('ğŸ“„ æ£€æŸ¥ç»“æœ:', profile);
                        if (!profile) {
                            console.log('ğŸ“ æ–°ç”¨æˆ·ç¡®è®¤ï¼Œæ˜¾ç¤ºé¢æ¿');
                            window.profileManager.showProfilePanel();
                        }
                    } catch (error) {
                        console.log('âŒ APIé”™è¯¯ï¼Œæ˜¾ç¤ºé¢æ¿');
                        window.profileManager.showProfilePanel();
                    }
                }
            }, 500);
        };
        
        // ===================
        // å…¨å±€ç”¨æˆ·ç®¡ç†å‡½æ•°
        // ===================
        
        // æ¸…é™¤å½“å‰ç”¨æˆ·èµ„æ–™ï¼ˆæ¨¡æ‹Ÿé¦–æ¬¡ç™»å½•ï¼‰
        window.clearUserProfile = async function() {
            const walletAddress = localStorage.getItem('wallet_address');
            if (walletAddress) {
                const userId = `wallet_${walletAddress}`;
                console.log('ğŸ§¹ æ­£åœ¨ä»æ•°æ®åº“æ¸…é™¤ç”¨æˆ·èµ„æ–™:', userId);
                
                // çº¯APIåˆ é™¤ï¼Œä¸å†ä½¿ç”¨localStorage
                if (window.profileManager) {
                    const success = await window.profileManager.deleteUserProfile(userId);
                    if (success) {
                        console.log('âœ… ç”¨æˆ·èµ„æ–™å·²ä»æ•°æ®åº“åˆ é™¤ï¼Œåˆ·æ–°é¡µé¢æŸ¥çœ‹æ•ˆæœ');
                        location.reload();
                    } else {
                        console.log('âš ï¸ åˆ é™¤å¤±è´¥ï¼Œå¯èƒ½ç”¨æˆ·ä¸å­˜åœ¨');
                    }
                } else {
                    console.error('âŒ profileManageræœªåˆå§‹åŒ–');
                }
            } else {
                console.log('âš ï¸ æœªè¿æ¥é’±åŒ…ï¼Œæ— éœ€æ¸…é™¤');
            }
        };
        
        // æ¸…é™¤æ‰€æœ‰ç”¨æˆ·èµ„æ–™
        window.clearAllProfiles = function() {
            const profiles = window.profileManager.getAllUserProfiles();
            profiles.forEach(({userId}) => {
                window.profileManager.deleteUserProfile(userId);
            });
            console.log(`âœ… å·²æ¸…é™¤ ${profiles.length} ä¸ªç”¨æˆ·èµ„æ–™`);
        };
        
        // æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·èµ„æ–™
        window.showAllProfiles = function() {
            const profiles = window.profileManager.getAllUserProfiles();
            console.log(`ğŸ“‹ æ€»å…±æœ‰ ${profiles.length} ä¸ªç”¨æˆ·èµ„æ–™:`);
            profiles.forEach(({userId, profile}) => {
                console.log(`ğŸ‘¤ ${userId}:`, profile);
            });
            return profiles;
        };
        
        // ç¼–è¾‘å½“å‰ç”¨æˆ·èµ„æ–™
        window.editCurrentProfile = function() {
            const walletAddress = localStorage.getItem('wallet_address');
            if (walletAddress) {
                const userId = `wallet_${walletAddress}`;
                const profile = window.profileManager.getUserProfile(userId);
                if (profile) {
                    window.profileManager.showProfilePanel(userId, profile);
                    console.log('ğŸ“ æ­£åœ¨ç¼–è¾‘ç”¨æˆ·èµ„æ–™');
                } else {
                    console.log('âš ï¸ æœªæ‰¾åˆ°ç”¨æˆ·èµ„æ–™ï¼Œæ˜¾ç¤ºæ–°ç”¨æˆ·æ³¨å†Œé¢æ¿');
                    window.profileManager.showProfilePanel();
                }
            } else {
                console.log('âš ï¸ æœªè¿æ¥é’±åŒ…');
            }
        };
        
        // è·å–å½“å‰ç”¨æˆ·èµ„æ–™
        window.getCurrentProfile = function() {
            const walletAddress = localStorage.getItem('wallet_address');
            if (walletAddress) {
                const userId = `wallet_${walletAddress}`;
                const profile = window.profileManager.getUserProfile(userId);
                console.log('ğŸ‘¤ å½“å‰ç”¨æˆ·èµ„æ–™:', profile);
                return profile;
            } else {
                console.log('âš ï¸ æœªè¿æ¥é’±åŒ…');
                return null;
            }
        };
        
    </script>
    <!-- ç”¨æˆ·ä¿¡æ¯å¡«å†™é¢æ¿ -->
    <div class="user-profile-overlay" id="user-profile-overlay" style="display: none;">
        <div class="profile-panel">
            <div class="profile-panel-header">
                <h2 class="profile-panel-title">ç”¨æˆ·æ³¨å†Œ</h2>
            </div>
            
            <form class="profile-form">
                <!-- ç”¨æˆ·å -->
                <div class="profile-field">
                    <label class="field-label">ç”¨æˆ·å</label>
                    <input type="text" class="profile-input" id="username" placeholder="æœ€å¤š12ä¸ªå­—ç¬¦" maxlength="12" required>
                    <div class="field-note">å…¶ä»–ç”¨æˆ·å¯ä»¥çœ‹åˆ°ï¼ˆæœ€å¤š12ä¸ªå­—ç¬¦ï¼‰</div>
                </div>
                
                <!-- æ˜µç§°ï¼ˆå§“åï¼‰ -->
                <div class="profile-field">
                    <label class="field-label">ä½ çš„åå­—</label>
                    <input type="text" class="profile-input" id="displayName" placeholder="å§“å" required>
                    <div class="field-note">ã€Œä½ çš„åå­—ã€æ˜¯AIå¥³å‹åœ¨èŠå¤©ä¸­ç§°å‘¼ä½ çš„åå­—ï¼Œå¯¹å…¶ä»–ç”¨æˆ·ä¸å¯è§<br>ã€Œç”¨æˆ·åã€å’Œã€Œä½ çš„åå­—ã€ä»¥åå¯ä»¥åœ¨ä¸ªäººèµ„æ–™ä¸­ä¿®æ”¹ã€‚</div>
                </div>
                
                <!-- ç”Ÿæ—¥ -->
                <div class="profile-field has-multiple-inputs">
                    <label class="field-label">ä½ çš„ç”Ÿæ—¥</label>
                    <div class="birthday-inputs">
                        <select class="profile-select" id="birthYear" required>
                            <option value="">å¹´</option>
                            <option value="2010">2010</option>
                            <option value="2009">2009</option>
                            <option value="2008">2008</option>
                            <option value="2007">2007</option>
                            <option value="2006">2006</option>
                            <option value="2005">2005</option>
                            <option value="2004">2004</option>
                            <option value="2003">2003</option>
                            <option value="2002">2002</option>
                            <option value="2001">2001</option>
                            <option value="2000">2000</option>
                            <option value="1999">1999</option>
                            <option value="1998">1998</option>
                            <option value="1997">1997</option>
                            <option value="1996">1996</option>
                            <option value="1995">1995</option>
                            <option value="1994">1994</option>
                            <option value="1993">1993</option>
                            <option value="1992">1992</option>
                            <option value="1991">1991</option>
                            <option value="1990">1990</option>
                            <option value="1989">1989</option>
                            <option value="1988">1988</option>
                            <option value="1987">1987</option>
                            <option value="1986">1986</option>
                            <option value="1985">1985</option>
                            <option value="1984">1984</option>
                            <option value="1983">1983</option>
                            <option value="1982">1982</option>
                            <option value="1981">1981</option>
                            <option value="1980">1980</option>
                            <option value="1979">1979</option>
                            <option value="1978">1978</option>
                            <option value="1977">1977</option>
                            <option value="1976">1976</option>
                            <option value="1975">1975</option>
                            <option value="1974">1974</option>
                            <option value="1973">1973</option>
                            <option value="1972">1972</option>
                            <option value="1971">1971</option>
                            <option value="1970">1970</option>
                            <option value="1969">1969</option>
                            <option value="1968">1968</option>
                            <option value="1967">1967</option>
                            <option value="1966">1966</option>
                            <option value="1965">1965</option>
                            <option value="1964">1964</option>
                            <option value="1963">1963</option>
                            <option value="1962">1962</option>
                            <option value="1961">1961</option>
                            <option value="1960">1960</option>
                            <option value="1959">1959</option>
                            <option value="1958">1958</option>
                            <option value="1957">1957</option>
                            <option value="1956">1956</option>
                            <option value="1955">1955</option>
                            <option value="1954">1954</option>
                            <option value="1953">1953</option>
                            <option value="1952">1952</option>
                            <option value="1951">1951</option>
                            <option value="1950">1950</option>
                        </select>
                        <select class="profile-select" id="birthMonth" required>
                            <option value="">æœˆ</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                        </select>
                        <select class="profile-select" id="birthDay" required>
                            <option value="">æ—¥</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                            <option value="13">13</option>
                            <option value="14">14</option>
                            <option value="15">15</option>
                            <option value="16">16</option>
                            <option value="17">17</option>
                            <option value="18">18</option>
                            <option value="19">19</option>
                            <option value="20">20</option>
                            <option value="21">21</option>
                            <option value="22">22</option>
                            <option value="23">23</option>
                            <option value="24">24</option>
                            <option value="25">25</option>
                            <option value="26">26</option>
                            <option value="27">27</option>
                            <option value="28">28</option>
                            <option value="29">29</option>
                            <option value="30">30</option>
                            <option value="31">31</option>
                        </select>
                    </div>
                    <div class="field-note">â€»ç”Ÿæ—¥è®¾ç½®åæ— æ³•æ›´æ”¹</div>
                </div>
                
                <!-- å›½å®¶/åŸå¸‚ -->
                <div class="profile-field">
                    <label class="field-label">å±…ä½åœ°</label>
                    <input type="text" class="profile-input" id="location" placeholder="ä¾‹ï¼šåŒ—äº¬ã€ä¸Šæµ·ã€çº½çº¦" required>
                </div>
                
                <!-- è¯­è¨€åå¥½ -->
                <div class="profile-field">
                    <label class="field-label">è¯­è¨€è®¾ç½®</label>
                    <select class="profile-select" id="language" required>
                        <option value="">é€‰æ‹©è¯­è¨€</option>
                        <option value="ä¸­æ–‡">ä¸­æ–‡</option>
                        <option value="English">English</option>
                        <option value="æ—¥æœ¬èª">æ—¥æœ¬èª</option>
                        <option value="í•œêµ­ì–´">í•œêµ­ì–´</option>
                        <option value="EspaÃ±ol">EspaÃ±ol</option>
                        <option value="FranÃ§ais">FranÃ§ais</option>
                    </select>
                </div>
                
                <!-- è®°å¿†ç³»ç»Ÿ -->
                <div class="memory-section">
                    <div class="memory-title">ä¸ªäººåå¥½è®°å¿†</div>
                    
                    <div class="memory-field">
                        <label class="memory-label">å–œæ¬¢çš„é£Ÿç‰©</label>
                        <input type="text" class="memory-input" id="favoriteFood" placeholder="ä¾‹ï¼šç«é”…ã€æ„é¢ã€å¯¿å¸">
                    </div>
                    
                    <div class="memory-field">
                        <label class="memory-label">å–œæ¬¢çš„é¢œè‰²</label>
                        <input type="text" class="memory-input" id="favoriteColor" placeholder="ä¾‹ï¼šè“è‰²ã€ç²‰è‰²ã€ç»¿è‰²">
                    </div>
                    
                    <div class="memory-field">
                        <label class="memory-label">å…´è¶£çˆ±å¥½</label>
                        <input type="text" class="memory-input" id="hobbies" placeholder="ä¾‹ï¼šè¯»ä¹¦ã€å¬éŸ³ä¹ã€æ¸¸æˆ">
                    </div>
                    
                </div>
                
                <button type="button" class="profile-submit-btn" onclick="handleProfileSubmit(event)">OK</button>
            </form>
        </div>
    </div>

<script>
// ç›´æ¥åœ¨è¿™é‡Œå®ç°å®Œæ•´çš„è¡¨å•æäº¤é€»è¾‘
window.handleProfileSubmit = async function(event) {
    try {
        console.log('ğŸ”„ è¡¨å•æäº¤å¼€å§‹');
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        const formData = {
            username: document.getElementById('username').value.trim(),
            displayName: document.getElementById('displayName').value.trim(),
            birthYear: document.getElementById('birthYear').value,
            birthMonth: document.getElementById('birthMonth').value,
            birthDay: document.getElementById('birthDay').value,
            location: document.getElementById('location').value.trim(),
            language: document.getElementById('language').value,
            // è®°å¿†ç³»ç»Ÿæ•°æ®
            memory: {
                favoriteFood: document.getElementById('favoriteFood').value.trim(),
                favoriteColor: document.getElementById('favoriteColor').value.trim(),
                hobbies: document.getElementById('hobbies').value.trim()
            }
        };
        
        console.log('ğŸ“Š æ”¶é›†åˆ°çš„è¡¨å•æ•°æ®:', formData);
        
        // éªŒè¯å¿…å¡«å­—æ®µ
        const requiredFields = {
            username: formData.username,
            displayName: formData.displayName,
            birthYear: formData.birthYear,
            birthMonth: formData.birthMonth,
            birthDay: formData.birthDay,
            location: formData.location,
            language: formData.language
        };
        
        const missingFields = Object.entries(requiredFields).filter(([key, value]) => !value).map(([key]) => key);
        if (missingFields.length > 0) {
            console.error('âŒ ç¼ºå°‘å¿…å¡«å­—æ®µ:', missingFields);
            alert(`è¯·å¡«å†™æ‰€æœ‰å¿…å¡«ä¿¡æ¯ï¼ç¼ºå°‘: ${missingFields.join(', ')}`);
            return;
        }
        
        // ä¿å­˜ç”¨æˆ·èµ„æ–™
        const walletAddress = localStorage.getItem('wallet_address');
        if (walletAddress) {
            const userId = `wallet_${walletAddress}`;
            
            // è½¬æ¢æ•°æ®æ ¼å¼ä»¥åŒ¹é…APIæœŸæœ›
            const month = formData.birthMonth.toString().length === 1 ? '0' + formData.birthMonth : formData.birthMonth;
            const day = formData.birthDay.toString().length === 1 ? '0' + formData.birthDay : formData.birthDay;
            
            const apiFormData = {
                nickname: formData.displayName,
                username: formData.username,
                age: new Date().getFullYear() - parseInt(formData.birthYear),
                birthday: `${formData.birthYear}-${month}-${day}`,
                location: formData.location,
                language: formData.language,
                interests: formData.memory.hobbies,
                bio: `å–œæ¬¢çš„é£Ÿç‰©: ${formData.memory.favoriteFood}, å–œæ¬¢çš„é¢œè‰²: ${formData.memory.favoriteColor}`
            };
            
            console.log('ğŸ“ å‡†å¤‡ä¿å­˜ç”¨æˆ·èµ„æ–™:', apiFormData);
            
            // å‘é€åˆ°åç«¯API
            try {
                const apiUrl = 'http://localhost:3000';
                console.log('ğŸŒ å‘é€APIè¯·æ±‚åˆ°:', `${apiUrl}/api/profiles`);
                console.log('ğŸ“Š å‘é€æ•°æ®:', apiFormData);
                
                const response = await fetch(`${apiUrl}/api/profiles`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        walletAddress: walletAddress,
                        ...apiFormData
                    })
                });
                
                console.log('ğŸ“ˆ APIå“åº”çŠ¶æ€:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('âœ… ç”¨æˆ·èµ„æ–™ä¿å­˜æˆåŠŸ');
                    
                    // éšè—é¢æ¿
                    const overlay = document.getElementById('user-profile-overlay');
                    if (overlay) {
                        overlay.style.display = 'none';
                    }
                    
                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: rgba(0, 0, 0, 0.9);
                        color: white;
                        padding: 20px 40px;
                        border-radius: 10px;
                        font-size: 16px;
                        z-index: 10001;
                    `;
                    successMsg.textContent = 'ğŸ‰ æ³¨å†Œå®Œæˆï¼è¯·é€‰æ‹©ä½ çš„AIå¥³å‹è§’è‰²';
                    document.body.appendChild(successMsg);
                    
                    setTimeout(() => {
                        successMsg.remove();
                    }, 3000);
                    
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `APIä¿å­˜å¤±è´¥: ${response.status}`);
                }
            } catch (error) {
                console.error('âŒ ä¿å­˜ç”¨æˆ·èµ„æ–™å¤±è´¥:', error);
                alert('ä¿å­˜ç”¨æˆ·èµ„æ–™å¤±è´¥ï¼Œè¯·é‡è¯•: ' + error.message);
            }
        } else {
            console.error('âŒ æ— æ³•è·å–é’±åŒ…åœ°å€ï¼Œæ— æ³•ä¿å­˜èµ„æ–™');
            alert('æ— æ³•è·å–é’±åŒ…åœ°å€ï¼Œè¯·é‡æ–°è¿æ¥é’±åŒ…');
        }
    } catch (error) {
        console.error('âŒ è¡¨å•æäº¤è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
        alert('æäº¤å¤±è´¥ï¼š' + error.message);
    }
};
</script>

</body>
</html>